<!doctype html><html lang=zh-TW class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This is my technical blog. For taking learning notes and sharing my experience."><meta name=author content="Hans Tsai"><link href=https://hans-tsai.github.io/hans_blog/cloud/k8s/cka/ rel=canonical><link href=../../aws/saa/ rel=prev><link href=../../../networking/networking/ rel=next><link rel=icon href=../../../assets/favicon.png><meta name=generator content="mkdocs-1.6.0, mkdocs-material-9.5.33"><title>Kubernetes - Hans' blog</title><link rel=stylesheet href=../../../assets/stylesheets/main.3cba04c6.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Poppins:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Poppins";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../assets/stylesheets/custom.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config",""),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><link rel=stylesheet href=../../../assets/stylesheets/custom.f7ec4df2.min.css></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=cyan data-md-color-accent=cyan> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#kubernetes-cka class=md-skip> 跳轉到 </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <button class="md-banner__button md-icon" aria-label=不再顯示此訊息> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> For updates follow <strong>@squidfunk</strong> on <a rel=me href=https://fosstodon.org/@squidfunk> <span class="twemoji mastodon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg> </span> <strong>Fosstodon</strong> </a> and <a href=https://twitter.com/squidfunk> <span class="twemoji twitter"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </span> <strong>Twitter</strong> </a> </div> <script>var content,el=document.querySelector("[data-md-component=announce]");el&&(content=el.querySelector(".md-typeset"),__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0))</script> </aside> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=頁首> <a href=../../.. title="Hans' blog" class="md-header__button md-logo" aria-label="Hans' blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 89 89"> <path d=M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z /> <path d=M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z style="fill-opacity: 0.5"/> <path d=M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z /> <path d=M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z style="fill-opacity: 0.25"/> </svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Hans' blog </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Kubernetes </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=cyan data-md-color-accent=cyan aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=cyan data-md-color-accent=cyan aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜尋 placeholder=搜尋 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=搜尋> <a href=javascript:void(0) class="md-search__icon md-icon" title=分享 aria-label=分享 data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=清除 aria-label=清除 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜尋引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/Hans-Tsai/hans_blog title=前往倉庫 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> hans-tsai/hans_blog </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=導覽列 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="Hans' blog" class="md-nav__button md-logo" aria-label="Hans' blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 89 89"> <path d=M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z /> <path d=M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z style="fill-opacity: 0.5"/> <path d=M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z /> <path d=M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z style="fill-opacity: 0.25"/> </svg> </a> Hans' blog </label> <div class=md-nav__source> <a href=https://github.com/Hans-Tsai/hans_blog title=前往倉庫 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> hans-tsai/hans_blog </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> Programming language </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Programming language </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../programming_language/nodejs/ class=md-nav__link> <span class=md-ellipsis> Node.js </span> </a> </li> <li class=md-nav__item> <a href=../../../programming_language/java/ class=md-nav__link> <span class=md-ellipsis> Java </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Backend </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Backend </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_1> <label class=md-nav__link for=__nav_3_1 id=__nav_3_1_label tabindex=0> <span class=md-ellipsis> Framework </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> Framework </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../backend/framework/spring_boot/ class=md-nav__link> <span class=md-ellipsis> Spring Boot </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex=0> <span class=md-ellipsis> System Design </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> System Design </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../backend/system_design/ddd/ class=md-nav__link> <span class=md-ellipsis> DDD </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Cloud </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Cloud </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1 id=__nav_4_1_label tabindex=0> <span class=md-ellipsis> AWS </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_1_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> AWS </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../aws/saa/ class=md-nav__link> <span class=md-ellipsis> SAA </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Kubernetes </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Kubernetes </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目錄> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目錄 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=#core-concepts class=md-nav__link> <span class=md-ellipsis> Core Concepts </span> </a> <nav class=md-nav aria-label="Core Concepts"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cluster-architecture class=md-nav__link> <span class=md-ellipsis> Cluster Architecture </span> </a> </li> <li class=md-nav__item> <a href=#master-node class=md-nav__link> <span class=md-ellipsis> Master Node </span> </a> <nav class=md-nav aria-label="Master Node"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#etcd class=md-nav__link> <span class=md-ellipsis> etcd </span> </a> </li> <li class=md-nav__item> <a href=#kube-apiserver class=md-nav__link> <span class=md-ellipsis> kube-apiserver </span> </a> </li> <li class=md-nav__item> <a href=#kube-controller-manager class=md-nav__link> <span class=md-ellipsis> kube-controller-manager </span> </a> </li> <li class=md-nav__item> <a href=#kube-scheduler class=md-nav__link> <span class=md-ellipsis> kube-scheduler </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#worker-node class=md-nav__link> <span class=md-ellipsis> Worker Node </span> </a> <nav class=md-nav aria-label="Worker Node"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#kubelet class=md-nav__link> <span class=md-ellipsis> kubelet </span> </a> </li> <li class=md-nav__item> <a href=#kube-proxy class=md-nav__link> <span class=md-ellipsis> kube-proxy </span> </a> </li> <li class=md-nav__item> <a href=#pod class=md-nav__link> <span class=md-ellipsis> Pod </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#replicaset class=md-nav__link> <span class=md-ellipsis> ReplicaSet </span> </a> </li> <li class=md-nav__item> <a href=#deployment class=md-nav__link> <span class=md-ellipsis> Deployment </span> </a> </li> <li class=md-nav__item> <a href=#service class=md-nav__link> <span class=md-ellipsis> Service </span> </a> </li> <li class=md-nav__item> <a href=#namespace class=md-nav__link> <span class=md-ellipsis> Namespace </span> </a> </li> <li class=md-nav__item> <a href=#imperative-vs-declarative class=md-nav__link> <span class=md-ellipsis> Imperative vs. Declarative </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#scheduling class=md-nav__link> <span class=md-ellipsis> Scheduling </span> </a> <nav class=md-nav aria-label=Scheduling> <ul class=md-nav__list> <li class=md-nav__item> <a href=#manual-scheduling class=md-nav__link> <span class=md-ellipsis> Manual Scheduling </span> </a> </li> <li class=md-nav__item> <a href=#labels-selectors-annotations class=md-nav__link> <span class=md-ellipsis> Labels &amp; Selectors &amp; Annotations </span> </a> </li> <li class=md-nav__item> <a href=#taints-tolerations class=md-nav__link> <span class=md-ellipsis> Taints &amp; Tolerations </span> </a> </li> <li class=md-nav__item> <a href=#node-selectors class=md-nav__link> <span class=md-ellipsis> Node Selectors </span> </a> </li> <li class=md-nav__item> <a href=#node-affinity class=md-nav__link> <span class=md-ellipsis> Node Affinity </span> </a> </li> <li class=md-nav__item> <a href=#combine-taints-tolerations-node-affinity class=md-nav__link> <span class=md-ellipsis> combine Taints &amp; Tolerations &amp; Node Affinity </span> </a> </li> <li class=md-nav__item> <a href=#resource-requests-limits class=md-nav__link> <span class=md-ellipsis> Resource requests &amp; limits </span> </a> </li> <li class=md-nav__item> <a href=#daemonset class=md-nav__link> <span class=md-ellipsis> DaemonSet </span> </a> </li> <li class=md-nav__item> <a href=#static-pods class=md-nav__link> <span class=md-ellipsis> Static Pods </span> </a> </li> <li class=md-nav__item> <a href=#multiple-schedulers class=md-nav__link> <span class=md-ellipsis> Multiple Schedulers </span> </a> </li> <li class=md-nav__item> <a href=#configuring-scheduler-profiles class=md-nav__link> <span class=md-ellipsis> Configuring Scheduler Profiles </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#logging-monitoring class=md-nav__link> <span class=md-ellipsis> Logging &amp; Monitoring </span> </a> <nav class=md-nav aria-label="Logging & Monitoring"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#logging class=md-nav__link> <span class=md-ellipsis> Logging </span> </a> </li> <li class=md-nav__item> <a href=#monitoring class=md-nav__link> <span class=md-ellipsis> Monitoring </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#application-lifecycle-management class=md-nav__link> <span class=md-ellipsis> Application Lifecycle Management </span> </a> <nav class=md-nav aria-label="Application Lifecycle Management"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#rolling-updates-and-rollbacks-in-deployments class=md-nav__link> <span class=md-ellipsis> Rolling Updates and Rollbacks in Deployments </span> </a> <nav class=md-nav aria-label="Rolling Updates and Rollbacks in Deployments"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#deployment-rollout-strategy class=md-nav__link> <span class=md-ellipsis> Deployment-Rollout Strategy </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configure-applications class=md-nav__link> <span class=md-ellipsis> Configure Applications </span> </a> <nav class=md-nav aria-label="Configure Applications"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#configmap class=md-nav__link> <span class=md-ellipsis> ConfigMap </span> </a> </li> <li class=md-nav__item> <a href=#secrets class=md-nav__link> <span class=md-ellipsis> Secrets </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#scale-applications class=md-nav__link> <span class=md-ellipsis> Scale Applications </span> </a> <nav class=md-nav aria-label="Scale Applications"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#multi-container-pod class=md-nav__link> <span class=md-ellipsis> Multi-Container Pod </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#self-healing-application class=md-nav__link> <span class=md-ellipsis> Self-Healing Application </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#cluster-maintenance class=md-nav__link> <span class=md-ellipsis> Cluster Maintenance </span> </a> <nav class=md-nav aria-label="Cluster Maintenance"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cluster-upgrade-process class=md-nav__link> <span class=md-ellipsis> Cluster Upgrade Process </span> </a> </li> <li class=md-nav__item> <a href=#operating-system-upgrades class=md-nav__link> <span class=md-ellipsis> Operating System Upgrades </span> </a> </li> <li class=md-nav__item> <a href=#backup-and-restore-methodologies class=md-nav__link> <span class=md-ellipsis> Backup and Restore Methodologies </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#security class=md-nav__link> <span class=md-ellipsis> Security </span> </a> <nav class=md-nav aria-label=Security> <ul class=md-nav__list> <li class=md-nav__item> <a href=#kubernetes-security-primitives class=md-nav__link> <span class=md-ellipsis> Kubernetes Security Primitives </span> </a> </li> <li class=md-nav__item> <a href=#authentication class=md-nav__link> <span class=md-ellipsis> Authentication </span> </a> </li> <li class=md-nav__item> <a href=#tls-certificates-for-cluster-components class=md-nav__link> <span class=md-ellipsis> TLS certificates for cluster components </span> </a> <nav class=md-nav aria-label="TLS certificates for cluster components"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#k8s-certificate-api class=md-nav__link> <span class=md-ellipsis> K8s Certificate API </span> </a> </li> <li class=md-nav__item> <a href=#kubeconfig class=md-nav__link> <span class=md-ellipsis> kubeconfig </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#authorization class=md-nav__link> <span class=md-ellipsis> Authorization </span> </a> <nav class=md-nav aria-label=Authorization> <ul class=md-nav__list> <li class=md-nav__item> <a href=#k8s-api-groups class=md-nav__link> <span class=md-ellipsis> K8s API groups </span> </a> </li> <li class=md-nav__item> <a href=#authorization-mechanisms class=md-nav__link> <span class=md-ellipsis> Authorization Mechanisms </span> </a> </li> <li class=md-nav__item> <a href=#rbac-authorization class=md-nav__link> <span class=md-ellipsis> RBAC authorization </span> </a> </li> <li class=md-nav__item> <a href=#check-access-control class=md-nav__link> <span class=md-ellipsis> Check Access Control </span> </a> </li> <li class=md-nav__item> <a href=#resource-names class=md-nav__link> <span class=md-ellipsis> Resource Names </span> </a> </li> <li class=md-nav__item> <a href=#cluster-roles class=md-nav__link> <span class=md-ellipsis> Cluster Roles </span> </a> </li> <li class=md-nav__item> <a href=#service-account class=md-nav__link> <span class=md-ellipsis> Service Account </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#images-security class=md-nav__link> <span class=md-ellipsis> Images Security </span> </a> </li> <li class=md-nav__item> <a href=#security-contexts class=md-nav__link> <span class=md-ellipsis> Security Contexts </span> </a> </li> <li class=md-nav__item> <a href=#network-policies class=md-nav__link> <span class=md-ellipsis> Network Policies </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#storage class=md-nav__link> <span class=md-ellipsis> Storage </span> </a> <nav class=md-nav aria-label=Storage> <ul class=md-nav__list> <li class=md-nav__item> <a href=#introduction-of-docker-storage class=md-nav__link> <span class=md-ellipsis> Introduction of Docker Storage </span> </a> </li> <li class=md-nav__item> <a href=#volume class=md-nav__link> <span class=md-ellipsis> Volume </span> </a> </li> <li class=md-nav__item> <a href=#persistent-volume class=md-nav__link> <span class=md-ellipsis> Persistent Volume </span> </a> </li> <li class=md-nav__item> <a href=#persistent-volume-claim class=md-nav__link> <span class=md-ellipsis> Persistent Volume Claim </span> </a> </li> <li class=md-nav__item> <a href=#storage-class class=md-nav__link> <span class=md-ellipsis> Storage Class </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#networking class=md-nav__link> <span class=md-ellipsis> Networking </span> </a> <nav class=md-nav aria-label=Networking> <ul class=md-nav__list> <li class=md-nav__item> <a href=#networling-prerequisite class=md-nav__link> <span class=md-ellipsis> Networling Prerequisite </span> </a> </li> <li class=md-nav__item> <a href=#pod-networking class=md-nav__link> <span class=md-ellipsis> Pod Networking </span> </a> </li> <li class=md-nav__item> <a href=#cni-in-k8s class=md-nav__link> <span class=md-ellipsis> CNI in K8s </span> </a> </li> <li class=md-nav__item> <a href=#cni-weaveworks class=md-nav__link> <span class=md-ellipsis> CNI-weaveworks </span> </a> </li> <li class=md-nav__item> <a href=#ip-address-management-weaveworks class=md-nav__link> <span class=md-ellipsis> IP address management-weaveworks </span> </a> </li> <li class=md-nav__item> <a href=#dns-in-k8s class=md-nav__link> <span class=md-ellipsis> DNS in K8s </span> </a> </li> <li class=md-nav__item> <a href=#ingress class=md-nav__link> <span class=md-ellipsis> Ingress </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#design-k8s-cluster class=md-nav__link> <span class=md-ellipsis> Design K8s Cluster </span> </a> </li> <li class=md-nav__item> <a href=#create-k8s-cluster-using-kubeadm-tool class=md-nav__link> <span class=md-ellipsis> Create K8s cluster using kubeadm tool </span> </a> </li> <li class=md-nav__item> <a href=#end-to-end-tests-on-k8s-cluster class=md-nav__link> <span class=md-ellipsis> End to End Tests on K8s Cluster </span> </a> </li> <li class=md-nav__item> <a href=#troubleshooting class=md-nav__link> <span class=md-ellipsis> Troubleshooting </span> </a> <nav class=md-nav aria-label=Troubleshooting> <ul class=md-nav__list> <li class=md-nav__item> <a href=#application-failure class=md-nav__link> <span class=md-ellipsis> Application Failure </span> </a> </li> <li class=md-nav__item> <a href=#control-plane-node-failure class=md-nav__link> <span class=md-ellipsis> Control Plane Node Failure </span> </a> </li> <li class=md-nav__item> <a href=#worker-node-failure class=md-nav__link> <span class=md-ellipsis> Worker Node Failure </span> </a> </li> <li class=md-nav__item> <a href=#networking-failure class=md-nav__link> <span class=md-ellipsis> Networking Failure </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#exam-information class=md-nav__link> <span class=md-ellipsis> Exam Information </span> </a> </li> <li class=md-nav__item> <a href=#exam-tips class=md-nav__link> <span class=md-ellipsis> Exam Tips </span> </a> </li> <li class=md-nav__item> <a href=#reference class=md-nav__link> <span class=md-ellipsis> Reference </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex> <span class=md-ellipsis> Networking </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Networking </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../networking/networking/ class=md-nav__link> <span class=md-ellipsis> Networking </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex> <span class=md-ellipsis> Version Control </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Version Control </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../version_control/git/ class=md-nav__link> <span class=md-ellipsis> Git </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex> <span class=md-ellipsis> Coding Interview </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Coding Interview </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_1> <label class=md-nav__link for=__nav_7_1 id=__nav_7_1_label tabindex=0> <span class=md-ellipsis> Geeks for Geeks </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_1_label aria-expanded=false> <label class=md-nav__title for=__nav_7_1> <span class="md-nav__icon md-icon"></span> Geeks for Geeks </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../coding_interview/geeks_for_geeks/dsa_tutorial/ class=md-nav__link> <span class=md-ellipsis> DSA Tutorial </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_2> <label class=md-nav__link for=__nav_7_2 id=__nav_7_2_label tabindex=0> <span class=md-ellipsis> Tech interview handbook </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_2_label aria-expanded=false> <label class=md-nav__title for=__nav_7_2> <span class="md-nav__icon md-icon"></span> Tech interview handbook </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../coding_interview/tech_interview_handbook/coding_interview_prepararion/ class=md-nav__link> <span class=md-ellipsis> Coding interview preparation </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex> <span class=md-ellipsis> Others </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Others </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../others/others/ class=md-nav__link> <span class=md-ellipsis> Others </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_9> <label class=md-nav__link for=__nav_9 id=__nav_9_label tabindex> <span class=md-ellipsis> MkDocs Info </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_9_label aria-expanded=false> <label class=md-nav__title for=__nav_9> <span class="md-nav__icon md-icon"></span> MkDocs Info </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../mkdocs_info/mkdocs/ class=md-nav__link> <span class=md-ellipsis> MkDocs </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目錄> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目錄 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=#core-concepts class=md-nav__link> <span class=md-ellipsis> Core Concepts </span> </a> <nav class=md-nav aria-label="Core Concepts"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cluster-architecture class=md-nav__link> <span class=md-ellipsis> Cluster Architecture </span> </a> </li> <li class=md-nav__item> <a href=#master-node class=md-nav__link> <span class=md-ellipsis> Master Node </span> </a> <nav class=md-nav aria-label="Master Node"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#etcd class=md-nav__link> <span class=md-ellipsis> etcd </span> </a> </li> <li class=md-nav__item> <a href=#kube-apiserver class=md-nav__link> <span class=md-ellipsis> kube-apiserver </span> </a> </li> <li class=md-nav__item> <a href=#kube-controller-manager class=md-nav__link> <span class=md-ellipsis> kube-controller-manager </span> </a> </li> <li class=md-nav__item> <a href=#kube-scheduler class=md-nav__link> <span class=md-ellipsis> kube-scheduler </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#worker-node class=md-nav__link> <span class=md-ellipsis> Worker Node </span> </a> <nav class=md-nav aria-label="Worker Node"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#kubelet class=md-nav__link> <span class=md-ellipsis> kubelet </span> </a> </li> <li class=md-nav__item> <a href=#kube-proxy class=md-nav__link> <span class=md-ellipsis> kube-proxy </span> </a> </li> <li class=md-nav__item> <a href=#pod class=md-nav__link> <span class=md-ellipsis> Pod </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#replicaset class=md-nav__link> <span class=md-ellipsis> ReplicaSet </span> </a> </li> <li class=md-nav__item> <a href=#deployment class=md-nav__link> <span class=md-ellipsis> Deployment </span> </a> </li> <li class=md-nav__item> <a href=#service class=md-nav__link> <span class=md-ellipsis> Service </span> </a> </li> <li class=md-nav__item> <a href=#namespace class=md-nav__link> <span class=md-ellipsis> Namespace </span> </a> </li> <li class=md-nav__item> <a href=#imperative-vs-declarative class=md-nav__link> <span class=md-ellipsis> Imperative vs. Declarative </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#scheduling class=md-nav__link> <span class=md-ellipsis> Scheduling </span> </a> <nav class=md-nav aria-label=Scheduling> <ul class=md-nav__list> <li class=md-nav__item> <a href=#manual-scheduling class=md-nav__link> <span class=md-ellipsis> Manual Scheduling </span> </a> </li> <li class=md-nav__item> <a href=#labels-selectors-annotations class=md-nav__link> <span class=md-ellipsis> Labels &amp; Selectors &amp; Annotations </span> </a> </li> <li class=md-nav__item> <a href=#taints-tolerations class=md-nav__link> <span class=md-ellipsis> Taints &amp; Tolerations </span> </a> </li> <li class=md-nav__item> <a href=#node-selectors class=md-nav__link> <span class=md-ellipsis> Node Selectors </span> </a> </li> <li class=md-nav__item> <a href=#node-affinity class=md-nav__link> <span class=md-ellipsis> Node Affinity </span> </a> </li> <li class=md-nav__item> <a href=#combine-taints-tolerations-node-affinity class=md-nav__link> <span class=md-ellipsis> combine Taints &amp; Tolerations &amp; Node Affinity </span> </a> </li> <li class=md-nav__item> <a href=#resource-requests-limits class=md-nav__link> <span class=md-ellipsis> Resource requests &amp; limits </span> </a> </li> <li class=md-nav__item> <a href=#daemonset class=md-nav__link> <span class=md-ellipsis> DaemonSet </span> </a> </li> <li class=md-nav__item> <a href=#static-pods class=md-nav__link> <span class=md-ellipsis> Static Pods </span> </a> </li> <li class=md-nav__item> <a href=#multiple-schedulers class=md-nav__link> <span class=md-ellipsis> Multiple Schedulers </span> </a> </li> <li class=md-nav__item> <a href=#configuring-scheduler-profiles class=md-nav__link> <span class=md-ellipsis> Configuring Scheduler Profiles </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#logging-monitoring class=md-nav__link> <span class=md-ellipsis> Logging &amp; Monitoring </span> </a> <nav class=md-nav aria-label="Logging & Monitoring"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#logging class=md-nav__link> <span class=md-ellipsis> Logging </span> </a> </li> <li class=md-nav__item> <a href=#monitoring class=md-nav__link> <span class=md-ellipsis> Monitoring </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#application-lifecycle-management class=md-nav__link> <span class=md-ellipsis> Application Lifecycle Management </span> </a> <nav class=md-nav aria-label="Application Lifecycle Management"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#rolling-updates-and-rollbacks-in-deployments class=md-nav__link> <span class=md-ellipsis> Rolling Updates and Rollbacks in Deployments </span> </a> <nav class=md-nav aria-label="Rolling Updates and Rollbacks in Deployments"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#deployment-rollout-strategy class=md-nav__link> <span class=md-ellipsis> Deployment-Rollout Strategy </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configure-applications class=md-nav__link> <span class=md-ellipsis> Configure Applications </span> </a> <nav class=md-nav aria-label="Configure Applications"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#configmap class=md-nav__link> <span class=md-ellipsis> ConfigMap </span> </a> </li> <li class=md-nav__item> <a href=#secrets class=md-nav__link> <span class=md-ellipsis> Secrets </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#scale-applications class=md-nav__link> <span class=md-ellipsis> Scale Applications </span> </a> <nav class=md-nav aria-label="Scale Applications"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#multi-container-pod class=md-nav__link> <span class=md-ellipsis> Multi-Container Pod </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#self-healing-application class=md-nav__link> <span class=md-ellipsis> Self-Healing Application </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#cluster-maintenance class=md-nav__link> <span class=md-ellipsis> Cluster Maintenance </span> </a> <nav class=md-nav aria-label="Cluster Maintenance"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cluster-upgrade-process class=md-nav__link> <span class=md-ellipsis> Cluster Upgrade Process </span> </a> </li> <li class=md-nav__item> <a href=#operating-system-upgrades class=md-nav__link> <span class=md-ellipsis> Operating System Upgrades </span> </a> </li> <li class=md-nav__item> <a href=#backup-and-restore-methodologies class=md-nav__link> <span class=md-ellipsis> Backup and Restore Methodologies </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#security class=md-nav__link> <span class=md-ellipsis> Security </span> </a> <nav class=md-nav aria-label=Security> <ul class=md-nav__list> <li class=md-nav__item> <a href=#kubernetes-security-primitives class=md-nav__link> <span class=md-ellipsis> Kubernetes Security Primitives </span> </a> </li> <li class=md-nav__item> <a href=#authentication class=md-nav__link> <span class=md-ellipsis> Authentication </span> </a> </li> <li class=md-nav__item> <a href=#tls-certificates-for-cluster-components class=md-nav__link> <span class=md-ellipsis> TLS certificates for cluster components </span> </a> <nav class=md-nav aria-label="TLS certificates for cluster components"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#k8s-certificate-api class=md-nav__link> <span class=md-ellipsis> K8s Certificate API </span> </a> </li> <li class=md-nav__item> <a href=#kubeconfig class=md-nav__link> <span class=md-ellipsis> kubeconfig </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#authorization class=md-nav__link> <span class=md-ellipsis> Authorization </span> </a> <nav class=md-nav aria-label=Authorization> <ul class=md-nav__list> <li class=md-nav__item> <a href=#k8s-api-groups class=md-nav__link> <span class=md-ellipsis> K8s API groups </span> </a> </li> <li class=md-nav__item> <a href=#authorization-mechanisms class=md-nav__link> <span class=md-ellipsis> Authorization Mechanisms </span> </a> </li> <li class=md-nav__item> <a href=#rbac-authorization class=md-nav__link> <span class=md-ellipsis> RBAC authorization </span> </a> </li> <li class=md-nav__item> <a href=#check-access-control class=md-nav__link> <span class=md-ellipsis> Check Access Control </span> </a> </li> <li class=md-nav__item> <a href=#resource-names class=md-nav__link> <span class=md-ellipsis> Resource Names </span> </a> </li> <li class=md-nav__item> <a href=#cluster-roles class=md-nav__link> <span class=md-ellipsis> Cluster Roles </span> </a> </li> <li class=md-nav__item> <a href=#service-account class=md-nav__link> <span class=md-ellipsis> Service Account </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#images-security class=md-nav__link> <span class=md-ellipsis> Images Security </span> </a> </li> <li class=md-nav__item> <a href=#security-contexts class=md-nav__link> <span class=md-ellipsis> Security Contexts </span> </a> </li> <li class=md-nav__item> <a href=#network-policies class=md-nav__link> <span class=md-ellipsis> Network Policies </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#storage class=md-nav__link> <span class=md-ellipsis> Storage </span> </a> <nav class=md-nav aria-label=Storage> <ul class=md-nav__list> <li class=md-nav__item> <a href=#introduction-of-docker-storage class=md-nav__link> <span class=md-ellipsis> Introduction of Docker Storage </span> </a> </li> <li class=md-nav__item> <a href=#volume class=md-nav__link> <span class=md-ellipsis> Volume </span> </a> </li> <li class=md-nav__item> <a href=#persistent-volume class=md-nav__link> <span class=md-ellipsis> Persistent Volume </span> </a> </li> <li class=md-nav__item> <a href=#persistent-volume-claim class=md-nav__link> <span class=md-ellipsis> Persistent Volume Claim </span> </a> </li> <li class=md-nav__item> <a href=#storage-class class=md-nav__link> <span class=md-ellipsis> Storage Class </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#networking class=md-nav__link> <span class=md-ellipsis> Networking </span> </a> <nav class=md-nav aria-label=Networking> <ul class=md-nav__list> <li class=md-nav__item> <a href=#networling-prerequisite class=md-nav__link> <span class=md-ellipsis> Networling Prerequisite </span> </a> </li> <li class=md-nav__item> <a href=#pod-networking class=md-nav__link> <span class=md-ellipsis> Pod Networking </span> </a> </li> <li class=md-nav__item> <a href=#cni-in-k8s class=md-nav__link> <span class=md-ellipsis> CNI in K8s </span> </a> </li> <li class=md-nav__item> <a href=#cni-weaveworks class=md-nav__link> <span class=md-ellipsis> CNI-weaveworks </span> </a> </li> <li class=md-nav__item> <a href=#ip-address-management-weaveworks class=md-nav__link> <span class=md-ellipsis> IP address management-weaveworks </span> </a> </li> <li class=md-nav__item> <a href=#dns-in-k8s class=md-nav__link> <span class=md-ellipsis> DNS in K8s </span> </a> </li> <li class=md-nav__item> <a href=#ingress class=md-nav__link> <span class=md-ellipsis> Ingress </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#design-k8s-cluster class=md-nav__link> <span class=md-ellipsis> Design K8s Cluster </span> </a> </li> <li class=md-nav__item> <a href=#create-k8s-cluster-using-kubeadm-tool class=md-nav__link> <span class=md-ellipsis> Create K8s cluster using kubeadm tool </span> </a> </li> <li class=md-nav__item> <a href=#end-to-end-tests-on-k8s-cluster class=md-nav__link> <span class=md-ellipsis> End to End Tests on K8s Cluster </span> </a> </li> <li class=md-nav__item> <a href=#troubleshooting class=md-nav__link> <span class=md-ellipsis> Troubleshooting </span> </a> <nav class=md-nav aria-label=Troubleshooting> <ul class=md-nav__list> <li class=md-nav__item> <a href=#application-failure class=md-nav__link> <span class=md-ellipsis> Application Failure </span> </a> </li> <li class=md-nav__item> <a href=#control-plane-node-failure class=md-nav__link> <span class=md-ellipsis> Control Plane Node Failure </span> </a> </li> <li class=md-nav__item> <a href=#worker-node-failure class=md-nav__link> <span class=md-ellipsis> Worker Node Failure </span> </a> </li> <li class=md-nav__item> <a href=#networking-failure class=md-nav__link> <span class=md-ellipsis> Networking Failure </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#exam-information class=md-nav__link> <span class=md-ellipsis> Exam Information </span> </a> </li> <li class=md-nav__item> <a href=#exam-tips class=md-nav__link> <span class=md-ellipsis> Exam Tips </span> </a> </li> <li class=md-nav__item> <a href=#reference class=md-nav__link> <span class=md-ellipsis> Reference </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=kubernetes-cka>Kubernetes 一 CKA 證照考試<a class=headerlink href=#kubernetes-cka title="Permanent link">&para;</a></h1> <p>重點整理</p> <div class=toc><span class=toctitle>目錄</span><ul> <li><a href=#kubernetes-cka>Kubernetes 一 CKA 證照考試</a><ul> <li><a href=#introduction>Introduction</a></li> <li><a href=#core-concepts>Core Concepts</a><ul> <li><a href=#cluster-architecture>Cluster Architecture</a></li> <li><a href=#master-node>Master Node</a><ul> <li><a href=#etcd>etcd</a></li> <li><a href=#kube-apiserver>kube-apiserver</a></li> <li><a href=#kube-controller-manager>kube-controller-manager</a></li> <li><a href=#kube-scheduler>kube-scheduler</a></li> </ul> </li> <li><a href=#worker-node>Worker Node</a><ul> <li><a href=#kubelet>kubelet</a></li> <li><a href=#kube-proxy>kube-proxy</a></li> <li><a href=#pod>Pod</a></li> </ul> </li> <li><a href=#replicaset>ReplicaSet</a></li> <li><a href=#deployment>Deployment</a></li> <li><a href=#service>Service</a></li> <li><a href=#namespace>Namespace</a></li> <li><a href=#imperative-vs-declarative>Imperative vs. Declarative</a></li> </ul> </li> <li><a href=#scheduling>Scheduling</a><ul> <li><a href=#manual-scheduling>Manual Scheduling</a></li> <li><a href=#labels-selectors-annotations>Labels &amp; Selectors &amp; Annotations</a></li> <li><a href=#taints-tolerations>Taints &amp; Tolerations</a></li> <li><a href=#node-selectors>Node Selectors</a></li> <li><a href=#node-affinity>Node Affinity</a></li> <li><a href=#combine-taints-tolerations-node-affinity>combine Taints &amp; Tolerations &amp; Node Affinity</a></li> <li><a href=#resource-requests-limits>Resource requests &amp; limits</a></li> <li><a href=#daemonset>DaemonSet</a></li> <li><a href=#static-pods>Static Pods</a></li> <li><a href=#multiple-schedulers>Multiple Schedulers</a></li> <li><a href=#configuring-scheduler-profiles>Configuring Scheduler Profiles</a></li> </ul> </li> <li><a href=#logging-monitoring>Logging &amp; Monitoring</a><ul> <li><a href=#logging>Logging</a></li> <li><a href=#monitoring>Monitoring</a></li> </ul> </li> <li><a href=#application-lifecycle-management>Application Lifecycle Management</a><ul> <li><a href=#rolling-updates-and-rollbacks-in-deployments>Rolling Updates and Rollbacks in Deployments</a><ul> <li><a href=#deployment-rollout-strategy>Deployment-Rollout Strategy</a></li> </ul> </li> <li><a href=#configure-applications>Configure Applications</a><ul> <li><a href=#configmap>ConfigMap</a></li> <li><a href=#secrets>Secrets</a></li> </ul> </li> <li><a href=#scale-applications>Scale Applications</a><ul> <li><a href=#multi-container-pod>Multi-Container Pod</a></li> </ul> </li> <li><a href=#self-healing-application>Self-Healing Application</a></li> </ul> </li> <li><a href=#cluster-maintenance>Cluster Maintenance</a><ul> <li><a href=#cluster-upgrade-process>Cluster Upgrade Process</a></li> <li><a href=#operating-system-upgrades>Operating System Upgrades</a></li> <li><a href=#backup-and-restore-methodologies>Backup and Restore Methodologies</a></li> </ul> </li> <li><a href=#security>Security</a><ul> <li><a href=#kubernetes-security-primitives>Kubernetes Security Primitives</a></li> <li><a href=#authentication>Authentication</a></li> <li><a href=#tls-certificates-for-cluster-components>TLS certificates for cluster components</a><ul> <li><a href=#k8s-certificate-api>K8s Certificate API</a></li> <li><a href=#kubeconfig>kubeconfig</a></li> </ul> </li> <li><a href=#authorization>Authorization</a><ul> <li><a href=#k8s-api-groups>K8s API groups</a></li> <li><a href=#authorization-mechanisms>Authorization Mechanisms</a></li> <li><a href=#rbac-authorization>RBAC authorization</a></li> <li><a href=#check-access-control>Check Access Control</a></li> <li><a href=#resource-names>Resource Names</a></li> <li><a href=#cluster-roles>Cluster Roles</a></li> <li><a href=#service-account>Service Account</a></li> </ul> </li> <li><a href=#images-security>Images Security</a></li> <li><a href=#security-contexts>Security Contexts</a></li> <li><a href=#network-policies>Network Policies</a></li> </ul> </li> <li><a href=#storage>Storage</a><ul> <li><a href=#introduction-of-docker-storage>Introduction of Docker Storage</a></li> <li><a href=#volume>Volume</a></li> <li><a href=#persistent-volume>Persistent Volume</a></li> <li><a href=#persistent-volume-claim>Persistent Volume Claim</a></li> <li><a href=#storage-class>Storage Class</a></li> </ul> </li> <li><a href=#networking>Networking</a><ul> <li><a href=#networling-prerequisite>Networling Prerequisite</a></li> <li><a href=#pod-networking>Pod Networking</a></li> <li><a href=#cni-in-k8s>CNI in K8s</a></li> <li><a href=#cni-weaveworks>CNI-weaveworks</a></li> <li><a href=#ip-address-management-weaveworks>IP address management-weaveworks</a></li> <li><a href=#dns-in-k8s>DNS in K8s</a></li> <li><a href=#ingress>Ingress</a></li> </ul> </li> <li><a href=#design-k8s-cluster>Design K8s Cluster</a></li> <li><a href=#create-k8s-cluster-using-kubeadm-tool>Create K8s cluster using kubeadm tool</a></li> <li><a href=#end-to-end-tests-on-k8s-cluster>End to End Tests on K8s Cluster</a></li> <li><a href=#troubleshooting>Troubleshooting</a><ul> <li><a href=#application-failure>Application Failure</a></li> <li><a href=#control-plane-node-failure>Control Plane Node Failure</a></li> <li><a href=#worker-node-failure>Worker Node Failure</a></li> <li><a href=#networking-failure>Networking Failure</a></li> </ul> </li> <li><a href=#exam-information>Exam Information</a></li> <li><a href=#exam-tips>Exam Tips</a></li> <li><a href=#reference>Reference</a></li> </ul> </li> </ul> </div> <h2 id=introduction>Introduction<a class=headerlink href=#introduction title="Permanent link">&para;</a></h2> <ul> <li>由 CNCF 與 Linux Foundation 合作的 Kubernetes 證照考試<ul> <li>Certified Kubernetes Administrator (<strong>CKA</strong>): 對於 Kubernetes <strong>管理者</strong><ul> <li>Core Concepts</li> <li>HA deployment</li> <li>Kubernetes Scheduler</li> <li>Logging/Monitoring</li> <li>Application Lifecycle</li> <li>Maintenance</li> <li>Security</li> <li>Troubleshooting</li> </ul> </li> <li>Certified Kubernetes Application Developer (<strong>CKAD</strong>): 對於 Kubernetes <strong>開發者</strong><ul> <li>Core Concepts</li> <li>Config Maps, Secrets</li> <li>Multi-Container Pods</li> <li>Readiness and Liveness Probes</li> <li>Logging/Monitoring</li> <li>Pod Design</li> <li>Jobs</li> <li>Services &amp; Networking</li> </ul> </li> <li>參考資訊: <a href=https://docs.linuxfoundation.org/tc-docs/certification/faq-cka-ckad-cks>Frequently Asked Questions: CKA and CKAD &amp; CKS</a></li> </ul> </li> </ul> <h2 id=core-concepts>Core Concepts<a class=headerlink href=#core-concepts title="Permanent link">&para;</a></h2> <h3 id=cluster-architecture>Cluster Architecture<a class=headerlink href=#cluster-architecture title="Permanent link">&para;</a></h3> <ul> <li>Master Node<ul> <li>etcd: 儲存叢集資訊</li> <li>kube-scheduler: 負責排程工作節點上的應用程式或 container</li> <li>kube-controller-manager: 負責管理不同控制器的功能，例如: Node Controller, Replication Controller 等</li> <li>kube-apiserver: 負責協調叢集中的所有操作</li> </ul> </li> <li>Worker Node<ul> <li>kubelet: 監聽來自 kube-apiserver 的指令，來管理節點中的 container </li> <li>kube-proxy: 負責節點之間的網路通訊 <img alt src=../../../assets/pics/k8s/k8s_cluster_architecture.svg> <img alt src=../../../assets/pics/k8s/k8s_cluster_architecture_illustration.png></li> <li><a href=https://www.reddit.com/r/kubernetes/comments/k8kqdr/overview_of_kubernetes_architecture/#lightbox>圖片來源</a></li> </ul> </li> <li>Docker vs. Containerd<ul> <li><strong>Docker</strong>: 提供完整的 container 管理功能，適合從開發到生產環境的整個 container 生命周期管理 </li> <li><strong>Containerd</strong>: 專注於高效管理 container 的執行期間，作為 Docker 引擎的核心元件之一，亦可以獨立使用。<ul> <li>ctr: 管理 container 的 CLI 工具，僅提供基礎的 container 管理功能</li> <li>nerdctl: 類似於 Docker CLI 工具，提供更完整的功能</li> <li><strong>runc</strong>: 是一個實現 OCI 規範的底層執行期間工具，負責實際的 container 創建和運行 <img alt src=../../../assets/pics/k8s/docker_vs_containerd.webp></li> <li><a href=https://www.docker.com/blog/containerd-vs-docker/ >圖片來源</a></li> </ul> </li> </ul> </li> <li>OCI (Open Container Initiative): 由 Linux Foundation 所提出的開放 container 標準，包含 image-spec、runtime-spec<ul> <li><strong>image-spec</strong>: <strong>規範該如何建立 container image</strong>，以確保在不同執行環境中可以<strong>一致地建立 container </strong></li> <li><strong>runtime-spec</strong>: <strong>規範該如何設定 container runtime</strong>，描述如何創建、配置、管理 container ，確保在不同的執行環境中，可以<strong>一致地運行 container </strong></li> </ul> </li> <li>K8s CRI (Container Runtime Interface): 提供 CLI 給所有能與 OCI 標準所相容的 container 執行環境 (e.g. Docker, Containerd, CRI-O)<ul> <li><strong>crictl</strong> CLI: 與 docker CLI 指令相似，用來管理 container 執行環境</li> <li>用途: 檢查、除錯 container 的執行環境; 通常不會用來建立 container <img alt src=../../../assets/pics/k8s/k8s_crictl.png></li> </ul> </li> </ul> <h3 id=master-node>Master Node<a class=headerlink href=#master-node title="Permanent link">&para;</a></h3> <h4 id=etcd>etcd<a class=headerlink href=#etcd title="Permanent link">&para;</a></h4> <ul> <li>用途: 儲存 K8s 叢集的所有資訊 (e.g. nodes, pods, configs, secrets, accounts, roles, bindings 等)<ul> <li>採用 Key-Value 的方式儲存資料</li> <li><code>kubectl get xxx</code> 所取得的資料，都是從 etcd 伺服器中取得</li> <li>預設使用 2379 port</li> </ul> </li> <li>etcdctl: 用來管理 etcd 的 CLI 工具<ul> <li><code>export ETCDCTL_API=3</code>: 設定 etcdctl 的 API 版本的環境變數 (目前最新為 v3，有些指令會跟 v2 不同)</li> </ul> </li> </ul> <h4 id=kube-apiserver>kube-apiserver<a class=headerlink href=#kube-apiserver title="Permanent link">&para;</a></h4> <ul> <li>用途: 提供 K8s API 服務，負責接收來自 Client 的請求，並將請求轉發給其他元件<ul> <li>會先認證使用者的身份，再驗證 API 請求的權限，之後才會執行請求的操作</li> <li>透過 RESTful API 與工作節點進行交流</li> <li>預設使用 6443 port</li> </ul> </li> <li>功能:<ul> <li>認證使用者</li> <li>驗證 API 請求</li> <li>傳遞資料</li> <li><strong>更新 etcd 資訊</strong></li> <li>透過 kubelet 與工作節點進行溝通 <img alt src=../../../assets/pics/k8s/kube_apiserver.png></li> </ul> </li> </ul> <h4 id=kube-controller-manager>kube-controller-manager<a class=headerlink href=#kube-controller-manager title="Permanent link">&para;</a></h4> <ul> <li>用途: (是一個 process)，會持續監控叢集中個工作節點的狀態，並盡力使叢集維持在預期的狀態</li> <li>在主節點上，kube-controller-manager 會包含許多個 contoller，每個 controller 負責管理不同的控制器<ul> <li>Node Controller: 負責管理節點的狀態，採取必要措施以維持叢集正常運行</li> <li>Replication Controller: 負責監控 replicasets 的狀態，並確保在任何時刻下 pods 的數量都符合 replicasets 的設定</li> <li>其它 controllers <img alt src=../../../assets/pics/k8s/other-controllers.png></li> </ul> </li> </ul> <h4 id=kube-scheduler>kube-scheduler<a class=headerlink href=#kube-scheduler title="Permanent link">&para;</a></h4> <ul> <li>用途: 根據各節點的資源狀態，將 pod 排程到適當的節點上<ul> <li>kube-scheduler 僅負責決定 pod 要安排到哪個節點上; 而實際將 pod 放置到節點上的工作，是由 kubelet 完成</li> </ul> </li> <li>排程過程<ul> <li>根據每個節點的資源狀態，<strong>過濾出符合當前資源要求的節點們</strong></li> <li>透過 priority function，計算每個節點的分數，選擇分數最高的節點，優先將 pod 安排到該節點上 <img alt src=../../../assets/pics/k8s/kube_scheduler.png></li> </ul> </li> </ul> <h3 id=worker-node>Worker Node<a class=headerlink href=#worker-node title="Permanent link">&para;</a></h3> <h4 id=kubelet>kubelet<a class=headerlink href=#kubelet title="Permanent link">&para;</a></h4> <ul> <li>用途: 負責管理、監控工作節點內的 pod，以及 pod 中的 container 狀態，並與主節點進行通訊<ul> <li>會定期向主節點回報節點的狀態</li> </ul> </li> <li>流程: kube-scheduler -&gt; kube-apiserver -&gt; kubelet -&gt; Docker <img alt src=../../../assets/pics/k8s/kubelet.png></li> <li>kubeadm 預設<strong>不會部署 kubelet</strong>，需要手動安裝並部署 kubelet<ul> <li>下載 kubelet: <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>wget<span class=w> </span>https://storage.googleapis.com/kubernetes-release/release/v1.13.0/bin/linux/amd64/kubelet
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/install_kubelet.png></li> <li>解壓縮: <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>tar<span class=w> </span>-xvf<span class=w> </span>kubelet
</span></code></pre></div></li> <li>執行 kubelet 服務</li> </ul> </li> </ul> <h4 id=kube-proxy>kube-proxy<a class=headerlink href=#kube-proxy title="Permanent link">&para;</a></h4> <ul> <li>用途: (是一個 process)，會運行在每個工作節點上，負責維護節點之間的網路通訊，並將流量轉發到正確的 pod 上<ul> <li>透過 iptables 規則，將流量轉發到正確的 pod 上</li> </ul> </li> <li>e.g. web server 的 pod，透過 kube-proxy 連線到 db server 的 pod <img alt src=../../../assets/pics/k8s/kube_proxy.png></li> </ul> <h4 id=pod>Pod<a class=headerlink href=#pod title="Permanent link">&para;</a></h4> <ul> <li>用途: 是 K8s 中最小的部署單位，可以包含一個或多個 container (通常會包含一個 container)<ul> <li>Kubernetes 會操作 pod，而不是直接操作 container <img alt src=../../../assets/pics/k8s/pod.png></li> </ul> </li> <li>向上擴展/向下擴展: 增加/減少 pod 的數量<ul> <li>Pod &lt;-&gt; Container : 通常是 1:1 的關係</li> <li>可透過 Deployment 來管理 pod 的數量 <img alt src=../../../assets/pics/k8s/one_node_with_one_pod.png> <img alt src=../../../assets/pics/k8s/pod_scaling.png></li> </ul> </li> <li>multi-containers pods<ul> <li>在某些情境下，我們會建立 helper container(= sidecar container)，來協助主要的 container，例如: 收集 log、監控、資料轉換等 <br> <img alt src=../../../assets/pics/k8s/multi_containers_pods.png></li> <li>一般而言，我們會透過 Docker 分別建立一個個 container、helper container; 然而在 K8s 中，我們可以將這些 container 放在同一個 pod 中，透過 pod 來管理這些 containers <img alt src=../../../assets/pics/k8s/k8s_multi-container_pods.png></li> </ul> </li> <li>Pod 的 YAML 格式的 manifest 設定檔<ul> <li>必填欄位<ul> <li>apiVersion: K8s API 版本</li> <li>kind: 資源類型 (e.g. Pod)</li> <li>metadata: 資源的名稱、標籤等</li> <li>spec: 資源的規格 <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=c1># pod-definition.yaml</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class=w> </span><span class=c1># String 資料型別</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class=w> </span><span class=c1># String 資料型別</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=nt>metadata</span><span class=p>:</span><span class=w> </span><span class=c1># Dictionary 資料型別</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=w>    </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=nt>spec</span><span class=p>:</span><span class=w> </span><span class=c1># Dictionary 資料型別</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span><span class=w> </span><span class=c1># List/Array 資料型別 (因為 Pod 可以包含多個 container)</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx-container</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span></code></pre></div></li> </ul> </li> </ul> </li> <li>Pod 常用指令<ul> <li><code>kubectl get pods</code>: 取得所有 pods 的相關資訊 <img alt src=../../../assets/pics/k8s/kubectl_get_pods.png><ul> <li><code>READY</code>: (在這個 Pod 中)，正在執行的 container 數量/總 container 數量</li> </ul> </li> <li><code>kubectl describe pod &lt;pod-name&gt;</code>: 取得指定 pod 的詳細資訊 <img alt src=../../../assets/pics/k8s/kubectl_describe_pod.png></li> <li><code>kubetctl create -f &lt;pod-definition.yaml&gt;</code>: (根據指定的 YAML manifest 設定檔)，建立 pod</li> <li><code>kubectl apply -f &lt;pod-definition.yaml&gt;</code>: (根據指定的 YAML manifest 設定檔)，建立/更新 pod</li> <li><code>kubectl delete pod &lt;pod-name&gt;</code>: 刪除指定的 pod</li> </ul> </li> </ul> <h3 id=replicaset>ReplicaSet<a class=headerlink href=#replicaset title="Permanent link">&para;</a></h3> <ul> <li>用途: <ul> <li>為了確保系統的高可用性(high availability)，以避免單一節點故障的問題。當某個 pod 發生故障時，ReplicaSet 會自動重啟 pod，以確保 pod 的數量符合設定的 replicas 數量 <img alt src=../../../assets/pics/k8s/replication_controller_ha.png></li> <li>透過自動擴展機制(scaling)，來調整 pod 的數量，以達到 pods 之間的負載平衡(load balancing) <img alt src=../../../assets/pics/k8s/replication_controller_load_balancing_and_scaling.png></li> </ul> </li> <li>運用 template 來定義 pod 的規格 <img alt src=../../../assets/pics/k8s/pod_template_in_replication_controller.png></li> <li>label &amp; selector<ul> <li><strong>label</strong>: 用來標記 pod 的 metadata，以便於辨識、搜尋、選擇 pod</li> <li><strong>selector</strong>: 用來選擇要管理的 pod，透過 label 來選擇要管理的 pod <img alt src=../../../assets/pics/k8s/label_and_selector.png></li> </ul> </li> <li>Replication Controller vs. ReplicaSet<ul> <li><strong>Replication Controller</strong>: 舊版的控制器，僅支援基本的 pod 複製功能 <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=c1># rc-definition.yaml</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class=w> </span><span class=c1># Replication Controller 使用 v1 API 版本</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ReplicationController</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-rc</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=w>    </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=w>    </span><span class=c1># 透過 template 定義 pod 的規格</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=w>    </span><span class=nt>template</span><span class=p>:</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=w>        </span><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=w>        </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=w>            </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a><span class=w>            </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a><span class=w>        </span><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a><span class=w>            </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx-container</span>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a><span class=w>                </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a>
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a><span class=w>    </span><span class=c1># 設定 pod 的副本數量</span>
</span><span id=__span-3-24><a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a><span class=w>    </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/replication_controller_commands.png></li> <li><strong>ReplicaSet</strong>: 新版的控制器，支援更多的 pod 複製功能，例如: 擴展、縮小、更新 pod 等 <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=c1># replicaset-definition.yaml</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span><span class=w> </span><span class=c1># ReplicaSet 使用 apps/v1 API 版本</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ReplicaSet</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-replicaset</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=w>    </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=w>    </span><span class=nt>template</span><span class=p>:</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=w>        </span><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=w>            </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=w>                </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=w>                </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a><span class=w>        </span><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a><span class=w>            </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx-container</span>
</span><span id=__span-4-19><a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a><span class=w>                </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-4-20><a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a>
</span><span id=__span-4-21><a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a><span class=w>    </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span id=__span-4-22><a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a><span class=w>    </span><span class=c1># 只有 ReplicaSet 能支援 selector 的設定，透過 label 來選擇要管理的 pod</span>
</span><span id=__span-4-23><a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a><span class=w>    </span><span class=nt>selector</span><span class=p>:</span>
</span><span id=__span-4-24><a id=__codelineno-4-24 name=__codelineno-4-24 href=#__codelineno-4-24></a><span class=w>        </span><span class=c1># 過濾器: 選擇要管理的 pod</span>
</span><span id=__span-4-25><a id=__codelineno-4-25 name=__codelineno-4-25 href=#__codelineno-4-25></a><span class=w>        </span><span class=nt>matchLabels</span><span class=p>:</span>
</span><span id=__span-4-26><a id=__codelineno-4-26 name=__codelineno-4-26 href=#__codelineno-4-26></a><span class=w>            </span><span class=c1># 指定要管理具有哪些 label 的 pod</span>
</span><span id=__span-4-27><a id=__codelineno-4-27 name=__codelineno-4-27 href=#__codelineno-4-27></a><span class=w>            </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/replicaset_commands.png></li> </ul> </li> <li>ReplicaSet 的擴展機制<ul> <li>法一: 完全替換現有的 ReplicaSet，使用新的設定檔中的所有內容<ul> <li>適用情境: 用於完全替換現有資源，以全面更新資源配置時使用 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>replicaset-definition.yaml
</span></code></pre></div></li> </ul> </li> <li>法二: 會設置 ReplicaSet 的副本數量，但不會修改其他屬性<ul> <li>適用情境: 根據 YAML 文件指定的副本數量進行縮放 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>kubectl<span class=w> </span>scale<span class=w> </span>--replicas<span class=o>=</span><span class=m>6</span><span class=w> </span>-f<span class=w> </span>replicaset-definition.yaml
</span></code></pre></div></li> </ul> </li> <li>法三: 直接在 CLI 中設置指定 ReplicaSet 的副本數量<ul> <li>適用情境: 快速調整副本數量，適合於 CLI 操作 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>kubectl<span class=w> </span>scale<span class=w> </span>--replicas<span class=o>=</span><span class=m>6</span><span class=w> </span>replicaset<span class=w> </span>myapp-replicaset
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/replicaset_scale.png></li> </ul> </li> <li> <p>說明:</p> <ul> <li><code>kubectl scale</code> 指令不會改變 YAML 設定檔中的內容，僅會改變 ReplicaSet 的設定，進而影響叢集中 pod 的數量 </li> <li>上述三種方法在 runtime 都會將 pod 的數量擴展到 6 個; 但是背後的意義不同<ul> <li>Tips: 皆是對 ReplicaSet 做設定; 而不是對 YAML 設定檔中的 replicas 值做設定</li> </ul> </li> </ul> <table> <thead> <tr> <th>CLI 指令</th> <th>執行後 ReplicaSet 的 <code>replicas</code> 數量</th> <th>YAML 設定檔中的 <code>replicas</code> 值</th> </tr> </thead> <tbody> <tr> <td><code>kubectl replace -f replicaset-definition.yaml</code></td> <td>3</td> <td>3</td> </tr> <tr> <td><code>kubectl scale --replicas=6 -f replicaset-definition.yaml</code></td> <td>6</td> <td>3</td> </tr> <tr> <td><code>kubectl scale --replicas=6 replicaset myapp-replicaset</code></td> <td>6</td> <td>3</td> </tr> </tbody> </table> </li> </ul> </li> </ul> <h3 id=deployment>Deployment<a class=headerlink href=#deployment title="Permanent link">&para;</a></h3> <ul> <li>用途: (是一個 K8s 物件)，用來管理 ReplicaSet，並提供了更多的功能，例如: 下載/上傳 container image、滾動更新(rolling update)、回滾(rollback)、暫停 pod、恢復執行 pod 等<ul> <li>Deployment 會自動建立 ReplicaSet，並透過 ReplicaSet 來管理 Pod 的數量 <img alt src=../../../assets/pics/k8s/deployments.png></li> </ul> </li> <li>Deployment 的 YAML 格式的 manifest 設定檔 (<strong>會自動建立 ReplicaSet</strong>) <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=c1># deployment-definition.yaml</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-deployment</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=w>    </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=w>    </span><span class=nt>template</span><span class=p>:</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=w>        </span><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a><span class=w>            </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a><span class=w>                </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a><span class=w>                </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a><span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a><span class=w>        </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-8-19><a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx-container</span>
</span><span id=__span-8-20><a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a><span class=w>            </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-8-21><a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a>
</span><span id=__span-8-22><a id=__codelineno-8-22 name=__codelineno-8-22 href=#__codelineno-8-22></a><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span id=__span-8-23><a id=__codelineno-8-23 name=__codelineno-8-23 href=#__codelineno-8-23></a><span class=nt>selector</span><span class=p>:</span>
</span><span id=__span-8-24><a id=__codelineno-8-24 name=__codelineno-8-24 href=#__codelineno-8-24></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
</span><span id=__span-8-25><a id=__codelineno-8-25 name=__codelineno-8-25 href=#__codelineno-8-25></a><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/deployments_commands.png></li> <li>檢視當前 K8s 中所有的物件 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a>kubectl<span class=w> </span>get<span class=w> </span>all
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/kubectl_get_all.png></li> </ul> <h3 id=service>Service<a class=headerlink href=#service title="Permanent link">&para;</a></h3> <ul> <li>用途: (是一個 K8s 物件)，讓多個 pods 之間能夠互相通訊，有助於微服務架構(micro service)的鬆耦合特性(loose coupling)</li> <li> <p>概念: (假設有個外部使用者，想要存取 pod 的網頁服務)</p> <ul> <li> <p>若我們想存取私有網域中的 pod 時，必須先透過 SSH 連線進入 K8s 叢集中的該工作節點後，再透過 curl 指令來存取 pod 的內網 IP address <img alt src=../../assets/pics/k8s/external_communication_using_ssh.png.png></p> </li> <li> <p>但是一般來說，我們會希望只要存取 K8s 叢集中的該工作節點的 IP address，而無需透過 SSH 連線進入工作節點內部，來存取 pod 的服務</p> <ul> <li>Solution: 這時候我們就可以透過 Service 作為中間的服務，將外部的 client 透過 Service 來存取 pod 的服務</li> <li>可以把 Service 想像成一個節點內的虛擬伺服器，會擁有自己的 IP address、port，並將流量導向到對應的 pod 服務上 <img alt src=../../assets/pics/k8s/external_communication_without_using_ssh.png.png></li> </ul> </li> </ul> </li> <li> <p>在正式環境中，通常會是 multiple pods 的情境</p> <ul> <li> <p>單一節點上有多個 pods</p> <ul> <li>這些 pods 都具有相同的 label，nodePort Service 會透過 label 來選擇要管理的 pods，並將外部流量導向到這些 pods 上<ul> <li>algorithm: random (預設會使用隨機演算法，來決定將流量導向到哪個 pod 上)</li> <li>sessionAffinity: true (會將同一個 session 的流量導向到同一個 pod 上) <img alt src=../../../assets/pics/k8s/single_node_with_multiple_pods_using_service.png></li> </ul> </li> </ul> </li> <li> <p>多個節點上分別有一個 pod</p> <ul> <li>外部使用者可透過任何一個節點的 IP address，與相同的 nodePort 來存取 pod 的服務，達到高可用性、負載均衡的目的 <br> <img alt src=../../../assets/pics/k8s/multiple_nodes_with_one_pod_using_service.png></li> </ul> </li> </ul> </li> <li> <p>三種 Service 類型</p> <p><img alt src=../../../assets/pics/k8s/service_three_types.png></p> <ul> <li> <p><strong>ClusterIP</strong>: 會建立一個虛擬 IP address 以提供內部的 pod 之間通訊，僅能在叢集內部使用</p> <ul> <li>ClusterIP Service 物件，能將一群 pods 視為一個群組，對外提供一個統一的介面來存取該群組中的 pod 服務</li> <li>預設的 Service 類型</li> <li>常見使用情境: 多個 frontend pods 透過 ClusterIP 來存取 backend pods <img alt src=../../../assets/pics/k8s/service_clusterip.png><ul> <li>因為這些 pod 皆有可能隨時被關閉，因此其 IP address 皆不是固定的，故我們不能依賴這些 IP address 來存取 pod 的服務，要使用 Service 來存取 pod 的服務 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=c1># service-definition.yaml</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>apiVersion:<span class=w> </span>v1
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>kind:<span class=w> </span>Service
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>metadata:
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=w>    </span>name:<span class=w> </span>back-end
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a>spec:
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=w>    </span>types:<span class=w> </span>ClusterIP
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a><span class=w>    </span>ports:
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=w>        </span>-<span class=w>   </span>targetPort:<span class=w> </span><span class=m>80</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a><span class=w>            </span>port:<span class=w> </span><span class=m>80</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a>selector:
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a><span class=w>    </span>app:<span class=w> </span>myapp
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a><span class=w>    </span>type:<span class=w> </span>back-end
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/service_clusterip_commands.png></li> </ul> </li> </ul> </li> <li> <p><strong>NodePort</strong>: 會在每個節點上開啟一個 port，讓外部的 client 可以透過節點的 IP address 來存取 pod 的服務</p> <ul> <li>nodePort 的 port: 預設範圍 30000 ～ 32767<ul> <li>若未指定 port，K8s 會自動分配一個 port</li> </ul> </li> <li>port: Service 物件的 port<ul> <li>必填欄位</li> </ul> </li> <li> <p>targetPort: pod 服務的 port</p> <ul> <li>若未提供，預設與 Service 物件的 port 相同 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=c1># service-definition.yaml</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>apiVersion:<span class=w> </span>v1
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>kind:<span class=w> </span>Service
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>metadata:
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=w>    </span>name:<span class=w> </span>myapp-service
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a>spec:
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=w>    </span>types:<span class=w> </span>NodePort<span class=w> </span><span class=c1># Service 類型</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=w>    </span>ports:
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a><span class=w>    </span><span class=c1># - 表示為 List/Array 資料型別的第一個元素</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=w>    </span>-<span class=w>   </span>targetPort:<span class=w> </span><span class=m>80</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=w>        </span>port:<span class=w> </span><span class=m>80</span><span class=w> </span><span class=c1># 必填欄位</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=w>        </span>nodePort:<span class=w> </span><span class=m>30008</span>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a><span class=w>    </span><span class=c1># 透過 selector 來選擇要管理的 pod</span>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a><span class=w>    </span>selector:
</span><span id=__span-11-16><a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a><span class=w>        </span>app:<span class=w> </span>myapp
</span><span id=__span-11-17><a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a><span class=w>        </span>type:<span class=w> </span>front-end
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/service_nodeport.png> <img alt src=../../../assets/pics/k8s/service_nodeport_pod_selector.png></li> </ul> </li> <li> <p>建立 Service 物件 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>service-definition.yaml
</span></code></pre></div></p> </li> <li>列出當前所有的 Service 物件 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a>kubectl<span class=w> </span>get<span class=w> </span>services
</span></code></pre></div></li> <li>透過 CLI 存取 pod 服務 (而非使用瀏覽器) <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=c1># 存取的是節點 IP address 的 nodePort</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>curl<span class=w> </span>http://192.168.1.2:30008
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/service_nodeport_commands.png><ul> <li><strong>LoadBalancer</strong>: 透過雲端提供商上建立一個 load balancer，並將流量導向到 Service 上</li> </ul> </li> <li>常見使用情境: 在多個前端 pods 的前面，加上一個 load balancer，來平衡流量</li> <li>在正式環境中，一般而言，外部使用者會想要直接輸入 url 來存取網站，而不是透過 IP address + port 來存取 <img alt src=../../../assets/pics/k8s/service_load_balancer_voting_app.png><ul> <li>法一: 在 VM 上，手動建立一個 Load Balancer，設定好 port forwarding 規則，後續需要維運 <img alt src=../../../assets/pics/k8s/service_load_balancer_voting_app_using_vm.png></li> <li>法二 (推薦): 使用雲端提供商的 Load Balancer 服務，透過 Service 物件來建立 Load Balancer (e.g. GCP) <img alt src=../../../assets/pics/k8s/service_load_balancer_voting_app_using_gcp.png></li> </ul> </li> </ul> </li> </ul> </li> </ul> <h3 id=namespace>Namespace<a class=headerlink href=#namespace title="Permanent link">&para;</a></h3> <ul> <li>用途: 獨立的命名空間可以用來隔離資源 (isolation)，以存放我們平常建立的 Pods, Deployments, Services</li> <li>K8s 叢集會預設自動建立以下三個 namespace<ul> <li>default: 提供使用者預設使用的命名空間</li> <li>kube-system: 主要是為了維持 K8s 叢集內部運行所需(e.g. networking, DNS service)。也為了避免與使用者建立的物件混淆，同時也能避免使用者誤刪 or 修改這些服務</li> <li>kube-public: 所有使用者皆能使用這個命名空間中的資源</li> <li>另外，我們也能自己手動建立命名空間，例如: dev, prod <img alt src=../../../assets/pics/k8s/default_namespace.png></li> </ul> </li> <li> <p>建立 namespace</p> <ul> <li> <p>法 1: 使用 YAML manifest 設定檔 <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=c1># namespace-dev.yaml</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dev</span>
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>namespace-dev.yaml
</span></code></pre></div> </li> <li> <p>法 2: 使用 kubectl 指令 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a>kubectl<span class=w> </span>create<span class=w> </span>namespace<span class=w> </span>dev
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/create_namespace.png></p> </li> </ul> </li> <li> <p>設定指定的 namespace 中的資源限制: </p> <ul> <li>建立 <strong>ResourceQuota</strong> YAML manifest 設定檔 <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ResourceQuota</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">compute-quota</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=w>    </span><span class=c1># 指定要套用的 namespace</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dev</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=w>    </span><span class=nt>hard</span><span class=p>:</span>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a><span class=w>        </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=s>&quot;10&quot;</span>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a><span class=w>        </span><span class=nt>requests.cpu</span><span class=p>:</span><span class=w> </span><span class=s>&quot;4&quot;</span>
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a><span class=w>        </span><span class=nt>requests.memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5Gi</span>
</span><span id=__span-18-13><a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a><span class=w>        </span><span class=nt>limits.cpu</span><span class=p>:</span><span class=w> </span><span class=s>&quot;10&quot;</span>
</span><span id=__span-18-14><a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a><span class=w>        </span><span class=nt>limits.memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10Gi</span>
</span></code></pre></div></li> <li>套用 ResourceQuota 設定檔 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>compute-quota.yaml
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/resource_quota.png></li> </ul> </li> <li>在指定的 namespace 中建立 pod<ul> <li>法 1: <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>pod-definition.yaml<span class=w> </span>--namespace<span class=o>=</span>dev
</span></code></pre></div></li> <li>法 2: <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=c1># pod-definition.yaml</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a><span class=w>    </span><span class=c1># 指定要套用的 namespace</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dev</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a><span class=w>    </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a>
</span><span id=__span-21-12><a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-21-13><a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-21-14><a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx-container</span>
</span><span id=__span-21-15><a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/create_pod_in_specified_namespace.png></li> </ul> </li> <li>切換預設的 namespace (<code>default</code> namespace -&gt; <code>dev</code> namespace) <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a>kubectl<span class=w> </span>config<span class=w> </span>set-context<span class=w> </span><span class=k>$(</span>kubectl<span class=w> </span>config<span class=w> </span>current-context<span class=k>)</span><span class=w> </span>--namespace<span class=o>=</span>dev
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/switch_namespace.png></li> <li>檢視預設 namespace 中的所有 pods <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a>kubectl<span class=w> </span>get<span class=w> </span>pods
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/get_specified_namespace_pods.png></li> <li>檢視指定的 namespace 中的所有 pods <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>--namespace<span class=o>=</span>kube-system
</span></code></pre></div></li> <li>檢視所有 namespace 中的所有 pods <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>--all-namespaces
</span></code></pre></div></li> </ul> <h3 id=imperative-vs-declarative>Imperative vs. Declarative<a class=headerlink href=#imperative-vs-declarative title="Permanent link">&para;</a></h3> <blockquote> <p>在現代的程式碼即基礎設設施 (Infrastructure as Code, IaC) 中，有以下兩種主要的程式碼管理方式</p> </blockquote> <p><img alt src=../../../assets/pics/k8s/iac_imperative_and_declarative.png></p> <ul> <li> <p><strong>宣告式 (Imperative)</strong>: 透過指令，明確地告訴系統要執行的操作 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=c1># 建立物件</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>nginx.yaml
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=c1># 更新物件 --- 僅對 K8s 叢集中現行物件設定檔 (live object configuration) 做變更</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a>kubectl<span class=w> </span>edit<span class=w> </span>deployment<span class=w> </span>nginx
</span></code></pre></div> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=c1># 更新物件 --- 對原始設定檔 (object configuration file) 做變更後，再將 &quot;變動的部分&quot; 套用到 K8s 叢集中</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a>kubectl<span class=w> </span>replace<span class=w> </span>-f<span class=w> </span>nginx.yaml
</span></code></pre></div> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=c1># 更新物件 --- 對原始設定檔 (object configuration file) 做變更，完全刪除原本的物件後，再重新建立新的物件</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a>kubectl<span class=w> </span>replace<span class=w> </span>--force<span class=w> </span>-f<span class=w> </span>nginx.yaml
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/imperative_yaml.png> <img alt src=../../../assets/pics/k8s/imperative_edit_and_replace.png></p> </li> <li> <p><strong>命令式 (Declarative)</strong>: 透過 YAML manifest 設定檔來描述系統的期望狀態，系統會根據我們的目標，自動設定系統 <img alt src=../../../assets/pics/k8s/declarative_yaml.png></p> </li> </ul> <blockquote> <p>思考: 若建立 pod 到一半，發生系統中斷問題時？</p> <ul> <li>宣告式語法: 需透過許多檢查、除錯指令，才能確定當前的 K8s 叢集狀態，以繼續執行 <br></li> <li>命令式語法: 能夠自動比對當前的 K8s 叢集狀態，根據 object configuration file, last-applied-configuration, live object configuration 的 YAML manifest 設定檔，自動調整以符合我們的目標狀態 <br></li> </ul> </blockquote> <p><img alt src=../../../assets/pics/k8s/kubectl_apply.png></p> <ul> <li>原始設定檔 (object configuration file): 儲存在本地端</li> <li>上次應用的設定檔 (last-applied-configuration): 會轉換成 JSON 格式，儲存在 K8s 叢集中，用來追蹤物件的上次應用設定 <img alt src=../../../assets/pics/k8s/last_applied_configuration_annotation.png></li> <li> <p>K8s 叢集中現行物件設定檔 (live object configuration): 儲存在 Kubernetes memory 中，透過 lastProbeTime, status 來追蹤物件的當前狀態</p> </li> <li> <p>參考資料</p> <ul> <li><a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/object-management/ >Kubernetes Object Management</a></li> <li><a href=https://kubernetes.io/docs/tasks/manage-kubernetes-objects/declarative-config/ >Declarative Management of Kubernetes Objects Using Configuration Files</a></li> </ul> </li> </ul> <h2 id=scheduling>Scheduling<a class=headerlink href=#scheduling title="Permanent link">&para;</a></h2> <h3 id=manual-scheduling>Manual Scheduling<a class=headerlink href=#manual-scheduling title="Permanent link">&para;</a></h3> <blockquote> <p>思考: 若我們沒有 kube-scheduler 在我們的 K8s 叢集中，我們該如何將 pod 排程到指定的節點上？</p> </blockquote> <ul> <li>設定 nodeName 屬性: 指定 pod 要排程到哪個節點上<ul> <li><code>nodeName</code>: 每個 Pod 預設都不會有這個屬性，因為 K8s 叢集的 kube-scheduler 會負責將 pod 排程到適合的節點上 <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=c1># pod-definition.yaml</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-30-5><a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-30-6><a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a><span class=w>    </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-30-7><a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-30-8><a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a>
</span><span id=__span-30-9><a id=__codelineno-30-9 name=__codelineno-30-9 href=#__codelineno-30-9></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-30-10><a id=__codelineno-30-10 name=__codelineno-30-10 href=#__codelineno-30-10></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-30-11><a id=__codelineno-30-11 name=__codelineno-30-11 href=#__codelineno-30-11></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-30-12><a id=__codelineno-30-12 name=__codelineno-30-12 href=#__codelineno-30-12></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-30-13><a id=__codelineno-30-13 name=__codelineno-30-13 href=#__codelineno-30-13></a><span class=w>        </span><span class=nt>ports</span><span class=p>:</span>
</span><span id=__span-30-14><a id=__codelineno-30-14 name=__codelineno-30-14 href=#__codelineno-30-14></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span><span id=__span-30-15><a id=__codelineno-30-15 name=__codelineno-30-15 href=#__codelineno-30-15></a><span class=w>    </span><span class=c1># 指定 pod 要排程到哪個節點上</span>
</span><span id=__span-30-16><a id=__codelineno-30-16 name=__codelineno-30-16 href=#__codelineno-30-16></a><span class=w>    </span><span class=nt>nodeName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">node02</span>
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/manual_scheduling_with_setting_nodename.png></li> </ul> </li> <li> <p>假如 <strong>K8s 叢集中沒有 kube-scheduler</strong>，若我們建立一個 Pod 時，卻未設定 nodeName =&gt; Pod 會維持在 Pending 狀態</p> <ul> <li><strong>Kubernetes 僅接受建立 Pod 之前，就要先在 YAML manifest 設定檔中指定 nodeName</strong>，而不接受再建立 Pod 後才指定 nodeName</li> <li>解決方案 1: 建立 Pod 之前，就要先在 YAML manifest 設定檔中指定 nodeName <img alt src=../../../assets/pics/k8s/manual_scheduling_without_kube_scheduler.png></li> <li> <p>解決方案 2: (若已建立 Pod)，可透過 Binding 物件，將 Pod 排程到指定的節點上</p> <ul> <li> <p>使用 POST 請求，將 request body 以 JSON 格式傳送到 kube-apiserver =&gt; 模擬 kube-scheduler 的實際排程 Pod 的行為 <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Binding</span>
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a><span class=nt>target</span><span class=p>:</span>
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-31-7><a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Node</span>
</span><span id=__span-31-8><a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">node02</span>
</span></code></pre></div></p> <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-32-4><a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-32-5><a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a><span class=w>    </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-32-6><a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-32-7><a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-32-8><a id=__codelineno-32-8 name=__codelineno-32-8 href=#__codelineno-32-8></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-32-9><a id=__codelineno-32-9 name=__codelineno-32-9 href=#__codelineno-32-9></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-32-10><a id=__codelineno-32-10 name=__codelineno-32-10 href=#__codelineno-32-10></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-32-11><a id=__codelineno-32-11 name=__codelineno-32-11 href=#__codelineno-32-11></a><span class=w>        </span><span class=nt>ports</span><span class=p>:</span>
</span><span id=__span-32-12><a id=__codelineno-32-12 name=__codelineno-32-12 href=#__codelineno-32-12></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span></code></pre></div> </li> </ul> <p><img alt src=../../../assets/pics/k8s/manual_scheduling_without_kube_scheduler_binding.png></p> </li> </ul> </li> <li> <p>在 K8s 叢集中，我們<strong>不能將一個運行中的 Pod 移動到另一個節點上</strong>，因為 Pod 的 IP address 是固定的，且 Pod 的狀態是不可變的</p> <ul> <li>觀念: <strong>本質上，Pod (container) 算是系統上的一個 process，而 process 是不可移動的</strong></li> <li>若我們想要將 Pod 移動到另一個節點上，我們必須先刪除 Pod，再重新建立 Pod，並指定 nodeName</li> <li>法 1: 刪除 Pod，再重新建立 Pod <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a>kubectl<span class=w> </span>delete<span class=w> </span>pod<span class=w> </span>nginx
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>pod-definition.yaml
</span></code></pre></div></li> <li>法 2: <strong>強制替換 Pod</strong> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a>kubectl<span class=w> </span>replace<span class=w> </span>--force<span class=w> </span>-f<span class=w> </span>pod-definition.yaml
</span></code></pre></div></li> </ul> </li> </ul> <h3 id=labels-selectors-annotations>Labels &amp; Selectors &amp; Annotations<a class=headerlink href=#labels-selectors-annotations title="Permanent link">&para;</a></h3> <ul> <li>在 K8s 叢集中，有許多資源/物件，我們可以透過 labels, selectors 來對過濾、分群這些資源/物件，以進行管理。例如採用以下方式做分類<ul> <li>根據<strong>資源類型</strong>做分類 <img alt src=../../../assets/pics/k8s/labels_and_selectors_by_resource_type.png></li> <li>根據<strong>應用程式類型</strong>做分類 <img alt src=../../../assets/pics/k8s/labels_and_selectors_by_application_type.png></li> <li>根據<strong>功能</strong>做分類 <img alt src=../../../assets/pics/k8s/labels_and_selectors_by_functionality.png></li> </ul> </li> <li>標籤 (labels): 會附加在 K8s 資源/物件上的 key-value pair，用來識別、分類<ul> <li>建立 labels <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp</span>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=w>    </span><span class=c1># 建立 labels</span>
</span><span id=__span-35-6><a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a><span class=w>    </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-35-7><a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">App1</span>
</span><span id=__span-35-8><a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a><span class=w>        </span><span class=nt>function</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Front-end</span>
</span><span id=__span-35-9><a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a>
</span><span id=__span-35-10><a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-35-11><a id=__codelineno-35-11 name=__codelineno-35-11 href=#__codelineno-35-11></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-35-12><a id=__codelineno-35-12 name=__codelineno-35-12 href=#__codelineno-35-12></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp</span>
</span><span id=__span-35-13><a id=__codelineno-35-13 name=__codelineno-35-13 href=#__codelineno-35-13></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp</span>
</span><span id=__span-35-14><a id=__codelineno-35-14 name=__codelineno-35-14 href=#__codelineno-35-14></a><span class=w>        </span><span class=nt>ports</span><span class=p>:</span>
</span><span id=__span-35-15><a id=__codelineno-35-15 name=__codelineno-35-15 href=#__codelineno-35-15></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/labels.png> <img alt src=../../../assets/pics/k8s/labels_yaml.png></li> </ul> </li> <li>選擇器 (selectors): 針對 labels，來選擇要管理的資源/物件<ul> <li>使用 selectors <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>--selector<span class=w> </span><span class=nv>app</span><span class=o>=</span>App1
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/selectors.png></li> </ul> </li> <li>註解 (annotations): 可附加在 K8s 資源/物件上的 key-value pair，<strong>用來提供/記錄額外的資訊，通常不涉及資源/物件的選擇, 過濾</strong> <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=c1># replicaset-definition.yaml</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ReplicaSet</span>
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5 href=#__codelineno-37-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp</span>
</span><span id=__span-37-6><a id=__codelineno-37-6 name=__codelineno-37-6 href=#__codelineno-37-6></a><span class=w>    </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-37-7><a id=__codelineno-37-7 name=__codelineno-37-7 href=#__codelineno-37-7></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">App1</span>
</span><span id=__span-37-8><a id=__codelineno-37-8 name=__codelineno-37-8 href=#__codelineno-37-8></a><span class=w>        </span><span class=nt>function</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Front-end</span>
</span><span id=__span-37-9><a id=__codelineno-37-9 name=__codelineno-37-9 href=#__codelineno-37-9></a><span class=w>    </span><span class=c1># 建立 annotations</span>
</span><span id=__span-37-10><a id=__codelineno-37-10 name=__codelineno-37-10 href=#__codelineno-37-10></a><span class=w>    </span><span class=nt>annotations</span><span class=p>:</span>
</span><span id=__span-37-11><a id=__codelineno-37-11 name=__codelineno-37-11 href=#__codelineno-37-11></a><span class=w>        </span><span class=nt>buildversion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1.34</span>
</span><span id=__span-37-12><a id=__codelineno-37-12 name=__codelineno-37-12 href=#__codelineno-37-12></a>
</span><span id=__span-37-13><a id=__codelineno-37-13 name=__codelineno-37-13 href=#__codelineno-37-13></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-37-14><a id=__codelineno-37-14 name=__codelineno-37-14 href=#__codelineno-37-14></a><span class=w>    </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span id=__span-37-15><a id=__codelineno-37-15 name=__codelineno-37-15 href=#__codelineno-37-15></a><span class=w>    </span><span class=nt>selector</span><span class=p>:</span>
</span><span id=__span-37-16><a id=__codelineno-37-16 name=__codelineno-37-16 href=#__codelineno-37-16></a><span class=w>        </span><span class=nt>matchLabels</span><span class=p>:</span>
</span><span id=__span-37-17><a id=__codelineno-37-17 name=__codelineno-37-17 href=#__codelineno-37-17></a><span class=w>            </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">App1</span>
</span><span id=__span-37-18><a id=__codelineno-37-18 name=__codelineno-37-18 href=#__codelineno-37-18></a><span class=nt>template</span><span class=p>:</span>
</span><span id=__span-37-19><a id=__codelineno-37-19 name=__codelineno-37-19 href=#__codelineno-37-19></a><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-37-20><a id=__codelineno-37-20 name=__codelineno-37-20 href=#__codelineno-37-20></a><span class=w>        </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-37-21><a id=__codelineno-37-21 name=__codelineno-37-21 href=#__codelineno-37-21></a><span class=w>            </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">App1</span>
</span><span id=__span-37-22><a id=__codelineno-37-22 name=__codelineno-37-22 href=#__codelineno-37-22></a><span class=w>            </span><span class=nt>function</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Front-end</span>
</span><span id=__span-37-23><a id=__codelineno-37-23 name=__codelineno-37-23 href=#__codelineno-37-23></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-37-24><a id=__codelineno-37-24 name=__codelineno-37-24 href=#__codelineno-37-24></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-37-25><a id=__codelineno-37-25 name=__codelineno-37-25 href=#__codelineno-37-25></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp</span>
</span><span id=__span-37-26><a id=__codelineno-37-26 name=__codelineno-37-26 href=#__codelineno-37-26></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp</span><span class=w>   </span>
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/annotations.png></li> <li>對<strong>所有 K8s 叢集中的資源/物件</strong>，使用 labels 做分類 <img alt src=../../../assets/pics/k8s/get_all_objects_using_labels.png></li> <li>對所有 K8s 叢集中的資源/物件，使用<strong>多個 labels 做分類</strong> <img alt src=../../../assets/pics/k8s/using_multiple_labels_to_filter.png></li> <li> <p>labels &amp; selectors 應用</p> <ul> <li> <p>ReplicaSet <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ReplicaSet</span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=c1># ReplicaSet 的 metadata</span>
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-38-5><a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp</span>
</span><span id=__span-38-6><a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a><span class=w>    </span><span class=c1># 建立 labels</span>
</span><span id=__span-38-7><a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a><span class=w>    </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-38-8><a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">App1</span>
</span><span id=__span-38-9><a id=__codelineno-38-9 name=__codelineno-38-9 href=#__codelineno-38-9></a><span class=w>        </span><span class=nt>function</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Front-end</span>
</span><span id=__span-38-10><a id=__codelineno-38-10 name=__codelineno-38-10 href=#__codelineno-38-10></a>
</span><span id=__span-38-11><a id=__codelineno-38-11 name=__codelineno-38-11 href=#__codelineno-38-11></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-38-12><a id=__codelineno-38-12 name=__codelineno-38-12 href=#__codelineno-38-12></a><span class=w>    </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span id=__span-38-13><a id=__codelineno-38-13 name=__codelineno-38-13 href=#__codelineno-38-13></a><span class=w>    </span><span class=c1># 使用 selectors 來選擇要管理的物件</span>
</span><span id=__span-38-14><a id=__codelineno-38-14 name=__codelineno-38-14 href=#__codelineno-38-14></a><span class=w>    </span><span class=nt>selector</span><span class=p>:</span>
</span><span id=__span-38-15><a id=__codelineno-38-15 name=__codelineno-38-15 href=#__codelineno-38-15></a><span class=w>        </span><span class=nt>matchLabels</span><span class=p>:</span>
</span><span id=__span-38-16><a id=__codelineno-38-16 name=__codelineno-38-16 href=#__codelineno-38-16></a><span class=w>            </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">App1</span>
</span><span id=__span-38-17><a id=__codelineno-38-17 name=__codelineno-38-17 href=#__codelineno-38-17></a><span class=w>    </span><span class=nt>template</span><span class=p>:</span>
</span><span id=__span-38-18><a id=__codelineno-38-18 name=__codelineno-38-18 href=#__codelineno-38-18></a><span class=w>        </span><span class=c1># Pod 的 metadata (較重要)</span>
</span><span id=__span-38-19><a id=__codelineno-38-19 name=__codelineno-38-19 href=#__codelineno-38-19></a><span class=w>        </span><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-38-20><a id=__codelineno-38-20 name=__codelineno-38-20 href=#__codelineno-38-20></a><span class=w>                </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">App1</span>
</span><span id=__span-38-21><a id=__codelineno-38-21 name=__codelineno-38-21 href=#__codelineno-38-21></a><span class=w>        </span><span class="w w-Error">    </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-38-22><a id=__codelineno-38-22 name=__codelineno-38-22 href=#__codelineno-38-22></a><span class=w>                </span><span class=nt>function</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Front-end</span>
</span><span id=__span-38-23><a id=__codelineno-38-23 name=__codelineno-38-23 href=#__codelineno-38-23></a><span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-38-24><a id=__codelineno-38-24 name=__codelineno-38-24 href=#__codelineno-38-24></a><span class=w>        </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-38-25><a id=__codelineno-38-25 name=__codelineno-38-25 href=#__codelineno-38-25></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp</span>
</span><span id=__span-38-26><a id=__codelineno-38-26 name=__codelineno-38-26 href=#__codelineno-38-26></a><span class=w>            </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp</span>
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/replicaset_using_labels_and_selectors.png></p> </li> <li> <p>Service <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id=__span-39-3><a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-39-4><a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">my-service</span>
</span><span id=__span-39-5><a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a>
</span><span id=__span-39-6><a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-39-7><a id=__codelineno-39-7 name=__codelineno-39-7 href=#__codelineno-39-7></a><span class=w>    </span><span class=c1># 使用 selectors 來選擇要管理的物件</span>
</span><span id=__span-39-8><a id=__codelineno-39-8 name=__codelineno-39-8 href=#__codelineno-39-8></a><span class=w>    </span><span class=nt>selector</span><span class=p>:</span>
</span><span id=__span-39-9><a id=__codelineno-39-9 name=__codelineno-39-9 href=#__codelineno-39-9></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">App1</span>
</span><span id=__span-39-10><a id=__codelineno-39-10 name=__codelineno-39-10 href=#__codelineno-39-10></a><span class=w>    </span><span class=nt>ports</span><span class=p>:</span>
</span><span id=__span-39-11><a id=__codelineno-39-11 name=__codelineno-39-11 href=#__codelineno-39-11></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</span><span id=__span-39-12><a id=__codelineno-39-12 name=__codelineno-39-12 href=#__codelineno-39-12></a><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id=__span-39-13><a id=__codelineno-39-13 name=__codelineno-39-13 href=#__codelineno-39-13></a><span class=w>        </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">9376</span><span class=w> </span>
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/service_using_labels_and_selectors.png></p> </li> </ul> </li> </ul> <h3 id=taints-tolerations>Taints &amp; Tolerations<a class=headerlink href=#taints-tolerations title="Permanent link">&para;</a></h3> <ul> <li>為了<strong>限制 Node 接受某些 Pod 的排程</strong>，並讓可以 tolerate 特定 taint 的 Pod 被排程到該 Node 上<ul> <li>注意! taints &amp; tolerations 並不會告訴 Pod 去特定的 Node 上，而是<strong>告訴 taint Node 僅能接受具有特定 tolerations 的 Pod</strong></li> <li>taints &amp; tolerations 與安全性或入侵無關，僅是用來限制 Pod 的排程 <img alt src=../../../assets/pics/k8s/taints_and_tolerations.png></li> </ul> </li> <li> <p>taints (污點)</p> <ul> <li>設定於 <strong>Node</strong> 上</li> <li>功能: 可以設定當不能 tolerate 的 Pod 被排程到該 Node 上時，該如何處理？<ul> <li>NoSchedule: 表示新 Pod 不會被排程到這個節點上，除非這些 Pod 有相應的 toleration<ul> <li>用途: 用於<strong>強制性地避免</strong> Pod 被排程到特定節點上</li> </ul> </li> <li>PreferNoSchedule: 表示 Kubernetes 會盡量避免將 Pod 排程到這個節點上，但這<strong>不是強制的</strong>。若沒有其他合適的節點，Pod 仍然可能會被排程到這個節點上<ul> <li>用途: 用於軟性地避免 Pod 排程到特定節點上，但在資源不足或其他情況下允許例外</li> </ul> </li> <li>NoExecute: 表示不僅新 Pod 無法被排程到這個節點上，<strong>已經在這個節點上的 Pod 也會被驅逐 (除非這些 Pod 有相應的 toleration)</strong><ul> <li>用途: 用於在節點狀態改變或需要進行維護時，驅逐不符合條件的 Pod</li> </ul> </li> </ul> </li> <li>設定 taints <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a>kubectl<span class=w> </span>taint<span class=w> </span>nodes<span class=w> </span>node1<span class=w> </span><span class=nv>app</span><span class=o>=</span>blue:NoSchedule
</span></code></pre></div></li> </ul> <p><img alt src=../../../assets/pics/k8s/taints.png></p> <ul> <li>去除 taints <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a>kubectl<span class=w> </span>taint<span class=w> </span>nodes<span class=w> </span>node1<span class=w> </span><span class=nv>app</span><span class=o>=</span>blue:NoSchedule-
</span></code></pre></div></li> </ul> </li> <li> <p>tolerations (容忍)</p> <ul> <li>預設所有 Pod 都不會有 tolerations</li> <li>功能: 設定於 <strong>Pod</strong> 上，概念上如同 taints，只是要寫在 Pod 的 YAML manifest 設定檔中</li> <li>設定 tolerations <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=c1># pod-definition.yaml</span>
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-42-5><a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
</span><span id=__span-42-6><a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a>
</span><span id=__span-42-7><a id=__codelineno-42-7 name=__codelineno-42-7 href=#__codelineno-42-7></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-42-8><a id=__codelineno-42-8 name=__codelineno-42-8 href=#__codelineno-42-8></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-42-9><a id=__codelineno-42-9 name=__codelineno-42-9 href=#__codelineno-42-9></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx-container</span>
</span><span id=__span-42-10><a id=__codelineno-42-10 name=__codelineno-42-10 href=#__codelineno-42-10></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-42-11><a id=__codelineno-42-11 name=__codelineno-42-11 href=#__codelineno-42-11></a>
</span><span id=__span-42-12><a id=__codelineno-42-12 name=__codelineno-42-12 href=#__codelineno-42-12></a><span class=w>    </span><span class=c1># 設定 tolerations，以 key-value pair 表示，其中 value 需加上雙引號 &quot; &quot;</span>
</span><span id=__span-42-13><a id=__codelineno-42-13 name=__codelineno-42-13 href=#__codelineno-42-13></a><span class=w>    </span><span class=nt>tolerations</span><span class=p>:</span>
</span><span id=__span-42-14><a id=__codelineno-42-14 name=__codelineno-42-14 href=#__codelineno-42-14></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s>&quot;app&quot;</span>
</span><span id=__span-42-15><a id=__codelineno-42-15 name=__codelineno-42-15 href=#__codelineno-42-15></a><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Equal&quot;</span>
</span><span id=__span-42-16><a id=__codelineno-42-16 name=__codelineno-42-16 href=#__codelineno-42-16></a><span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s>&quot;blue&quot;</span>
</span><span id=__span-42-17><a id=__codelineno-42-17 name=__codelineno-42-17 href=#__codelineno-42-17></a><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s>&quot;NoSchedule&quot;</span>
</span></code></pre></div></li> </ul> <p><img alt src=../../../assets/pics/k8s/tolerations.png></p> </li> <li> <p>為什麼 K8s 叢集的 master node 不會被排程 Pod？</p> <ul> <li> <p>因為在 K8s 叢集初始化時，<strong>master node 會自動被設定 taints (預設為 NoSchedule)</strong>，且 Pod 未設定 tolerations <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a>kubectl<span class=w> </span>describe<span class=w> </span>node<span class=w> </span>kubemaster<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>Taint
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/master_node_with_taints.png></p> </li> </ul> </li> </ul> <h3 id=node-selectors>Node Selectors<a class=headerlink href=#node-selectors title="Permanent link">&para;</a></h3> <ul> <li>用途: 用來限制 Pod 被排程到指定的 Node 上</li> </ul> <blockquote> <p>情境: 假設有三個 Node (node-1, node-2, node-3)，根據其資源配置分別為 large, medium, small，並分別為其設定 labels</p> </blockquote> <p><img alt src=../../../assets/pics/k8s/node_selectors.png></p> <ul> <li>步驟 1: 分別為 Pod 設定 labels <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a>kubectl<span class=w> </span>label<span class=w> </span>nodes<span class=w> </span>node-1<span class=w> </span><span class=nv>size</span><span class=o>=</span>large
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a>kubectl<span class=w> </span>label<span class=w> </span>nodes<span class=w> </span>node-2<span class=w> </span><span class=nv>size</span><span class=o>=</span>medium
</span><span id=__span-44-3><a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a>kubectl<span class=w> </span>label<span class=w> </span>nodes<span class=w> </span>node-3<span class=w> </span><span class=nv>size</span><span class=o>=</span>small
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/node_selectors_label_nodes.png></li> <li>步驟 2: 建立 Pod 的 YAML manifest 設定檔，並設定 nodeSelector <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a><span class=c1># pod-definition.yaml</span>
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-45-3><a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-45-4><a id=__codelineno-45-4 name=__codelineno-45-4 href=#__codelineno-45-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-45-5><a id=__codelineno-45-5 name=__codelineno-45-5 href=#__codelineno-45-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
</span><span id=__span-45-6><a id=__codelineno-45-6 name=__codelineno-45-6 href=#__codelineno-45-6></a>
</span><span id=__span-45-7><a id=__codelineno-45-7 name=__codelineno-45-7 href=#__codelineno-45-7></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-45-8><a id=__codelineno-45-8 name=__codelineno-45-8 href=#__codelineno-45-8></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-45-9><a id=__codelineno-45-9 name=__codelineno-45-9 href=#__codelineno-45-9></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">data-processor</span>
</span><span id=__span-45-10><a id=__codelineno-45-10 name=__codelineno-45-10 href=#__codelineno-45-10></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">data-processor</span>
</span><span id=__span-45-11><a id=__codelineno-45-11 name=__codelineno-45-11 href=#__codelineno-45-11></a><span class=w>    </span><span class=c1># 根據指定的 label，設定 nodeSelector，以限制 Pod 被排程到指定的 Node 上</span>
</span><span id=__span-45-12><a id=__codelineno-45-12 name=__codelineno-45-12 href=#__codelineno-45-12></a><span class=w>    </span><span class=nt>nodeSelector</span><span class=p>:</span>
</span><span id=__span-45-13><a id=__codelineno-45-13 name=__codelineno-45-13 href=#__codelineno-45-13></a><span class=w>        </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Large</span>
</span></code></pre></div> <img alt src=../../../assets/pics/k8s/node_selectors_create_pods.png></li> <li>步驟 3: 建立 Pod <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>pod-definition.yaml
</span></code></pre></div></li> <li>nodeSelector 的限制<ul> <li>僅能使用等於 (Equal) 運算子</li> <li>若遇到更複雜的需求，就必須使用 Node Affinity 來解決 =&gt; e.g. Large or Medium, NOT Small <img alt src=../../../assets/pics/k8s/node_selectors_limitations.png></li> </ul> </li> </ul> <h3 id=node-affinity>Node Affinity<a class=headerlink href=#node-affinity title="Permanent link">&para;</a></h3> <ul> <li>用途: 確保 Pod 能被排程到指定的 Node 上，以符合特定的需求</li> <li> <p>設定 nodeAffinity <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a><span class=c1># pod-definition.yaml</span>
</span><span id=__span-47-2><a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-47-3><a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-47-4><a id=__codelineno-47-4 name=__codelineno-47-4 href=#__codelineno-47-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-47-5><a id=__codelineno-47-5 name=__codelineno-47-5 href=#__codelineno-47-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
</span><span id=__span-47-6><a id=__codelineno-47-6 name=__codelineno-47-6 href=#__codelineno-47-6></a>
</span><span id=__span-47-7><a id=__codelineno-47-7 name=__codelineno-47-7 href=#__codelineno-47-7></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-47-8><a id=__codelineno-47-8 name=__codelineno-47-8 href=#__codelineno-47-8></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-47-9><a id=__codelineno-47-9 name=__codelineno-47-9 href=#__codelineno-47-9></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">data-processor</span>
</span><span id=__span-47-10><a id=__codelineno-47-10 name=__codelineno-47-10 href=#__codelineno-47-10></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">data-processor</span>
</span><span id=__span-47-11><a id=__codelineno-47-11 name=__codelineno-47-11 href=#__codelineno-47-11></a><span class=w>    </span><span class=c1># 設定 nodeAffinity</span>
</span><span id=__span-47-12><a id=__codelineno-47-12 name=__codelineno-47-12 href=#__codelineno-47-12></a><span class=w>    </span><span class=nt>affinity</span><span class=p>:</span>
</span><span id=__span-47-13><a id=__codelineno-47-13 name=__codelineno-47-13 href=#__codelineno-47-13></a><span class=w>        </span><span class=nt>nodeAffinity</span><span class=p>:</span>
</span><span id=__span-47-14><a id=__codelineno-47-14 name=__codelineno-47-14 href=#__codelineno-47-14></a><span class=w>            </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span>
</span><span id=__span-47-15><a id=__codelineno-47-15 name=__codelineno-47-15 href=#__codelineno-47-15></a><span class=w>                </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span>
</span><span id=__span-47-16><a id=__codelineno-47-16 name=__codelineno-47-16 href=#__codelineno-47-16></a><span class=w>                </span><span class=c1># 可支援更複雜的需求 (表達式)</span>
</span><span id=__span-47-17><a id=__codelineno-47-17 name=__codelineno-47-17 href=#__codelineno-47-17></a><span class=w>                </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>matchExpressions</span><span class=p>:</span>
</span><span id=__span-47-18><a id=__codelineno-47-18 name=__codelineno-47-18 href=#__codelineno-47-18></a><span class=w>                    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">size</span>
</span><span id=__span-47-19><a id=__codelineno-47-19 name=__codelineno-47-19 href=#__codelineno-47-19></a><span class=w>                        </span><span class=c1># 運算子需使用 Pascal Case</span>
</span><span id=__span-47-20><a id=__codelineno-47-20 name=__codelineno-47-20 href=#__codelineno-47-20></a><span class=w>                        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
</span><span id=__span-47-21><a id=__codelineno-47-21 name=__codelineno-47-21 href=#__codelineno-47-21></a><span class=w>                        </span><span class=nt>values</span><span class=p>:</span><span class=w> </span>
</span><span id=__span-47-22><a id=__codelineno-47-22 name=__codelineno-47-22 href=#__codelineno-47-22></a><span class=w>                        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class="l l-Scalar l-Scalar-Plain">Large</span>
</span><span id=__span-47-23><a id=__codelineno-47-23 name=__codelineno-47-23 href=#__codelineno-47-23></a><span class=w>                        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class="l l-Scalar l-Scalar-Plain">Medium</span>
</span></code></pre></div></p> <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-48-1><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-48-2><a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-48-3><a id=__codelineno-48-3 name=__codelineno-48-3 href=#__codelineno-48-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-48-4><a id=__codelineno-48-4 name=__codelineno-48-4 href=#__codelineno-48-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
</span><span id=__span-48-5><a id=__codelineno-48-5 name=__codelineno-48-5 href=#__codelineno-48-5></a>
</span><span id=__span-48-6><a id=__codelineno-48-6 name=__codelineno-48-6 href=#__codelineno-48-6></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-48-7><a id=__codelineno-48-7 name=__codelineno-48-7 href=#__codelineno-48-7></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-48-8><a id=__codelineno-48-8 name=__codelineno-48-8 href=#__codelineno-48-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">data-processor</span>
</span><span id=__span-48-9><a id=__codelineno-48-9 name=__codelineno-48-9 href=#__codelineno-48-9></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">data-processor</span>
</span><span id=__span-48-10><a id=__codelineno-48-10 name=__codelineno-48-10 href=#__codelineno-48-10></a><span class=w>    </span><span class=c1># 設定 nodeAffinity</span>
</span><span id=__span-48-11><a id=__codelineno-48-11 name=__codelineno-48-11 href=#__codelineno-48-11></a><span class=w>    </span><span class=nt>affinity</span><span class=p>:</span>
</span><span id=__span-48-12><a id=__codelineno-48-12 name=__codelineno-48-12 href=#__codelineno-48-12></a><span class=w>        </span><span class=nt>nodeAffinity</span><span class=p>:</span>
</span><span id=__span-48-13><a id=__codelineno-48-13 name=__codelineno-48-13 href=#__codelineno-48-13></a><span class=w>            </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span>
</span><span id=__span-48-14><a id=__codelineno-48-14 name=__codelineno-48-14 href=#__codelineno-48-14></a><span class=w>                </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span>
</span><span id=__span-48-15><a id=__codelineno-48-15 name=__codelineno-48-15 href=#__codelineno-48-15></a><span class=w>                </span><span class=c1># 可支援更複雜的需求 (表達式)</span>
</span><span id=__span-48-16><a id=__codelineno-48-16 name=__codelineno-48-16 href=#__codelineno-48-16></a><span class=w>                </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>matchExpressions</span><span class=p>:</span>
</span><span id=__span-48-17><a id=__codelineno-48-17 name=__codelineno-48-17 href=#__codelineno-48-17></a><span class=w>                    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">size</span>
</span><span id=__span-48-18><a id=__codelineno-48-18 name=__codelineno-48-18 href=#__codelineno-48-18></a><span class=w>                        </span><span class=c1># 運算子需使用 Pascal Case</span>
</span><span id=__span-48-19><a id=__codelineno-48-19 name=__codelineno-48-19 href=#__codelineno-48-19></a><span class=w>                        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">NotIn</span>
</span><span id=__span-48-20><a id=__codelineno-48-20 name=__codelineno-48-20 href=#__codelineno-48-20></a><span class=w>                        </span><span class=nt>values</span><span class=p>:</span><span class=w> </span>
</span><span id=__span-48-21><a id=__codelineno-48-21 name=__codelineno-48-21 href=#__codelineno-48-21></a><span class=w>                        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class="l l-Scalar l-Scalar-Plain">Small</span>
</span></code></pre></div> <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-49-1><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-49-2><a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-49-3><a id=__codelineno-49-3 name=__codelineno-49-3 href=#__codelineno-49-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-49-4><a id=__codelineno-49-4 name=__codelineno-49-4 href=#__codelineno-49-4></a><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
</span><span id=__span-49-5><a id=__codelineno-49-5 name=__codelineno-49-5 href=#__codelineno-49-5></a>
</span><span id=__span-49-6><a id=__codelineno-49-6 name=__codelineno-49-6 href=#__codelineno-49-6></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-49-7><a id=__codelineno-49-7 name=__codelineno-49-7 href=#__codelineno-49-7></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-49-8><a id=__codelineno-49-8 name=__codelineno-49-8 href=#__codelineno-49-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">data-processor</span>
</span><span id=__span-49-9><a id=__codelineno-49-9 name=__codelineno-49-9 href=#__codelineno-49-9></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">data-processor</span>
</span><span id=__span-49-10><a id=__codelineno-49-10 name=__codelineno-49-10 href=#__codelineno-49-10></a>
</span><span id=__span-49-11><a id=__codelineno-49-11 name=__codelineno-49-11 href=#__codelineno-49-11></a><span class=w>    </span><span class=c1># 設定 nodeAffinity</span>
</span><span id=__span-49-12><a id=__codelineno-49-12 name=__codelineno-49-12 href=#__codelineno-49-12></a><span class=w>    </span><span class=nt>affinity</span><span class=p>:</span>
</span><span id=__span-49-13><a id=__codelineno-49-13 name=__codelineno-49-13 href=#__codelineno-49-13></a><span class=w>        </span><span class=nt>nodeAffinity</span><span class=p>:</span>
</span><span id=__span-49-14><a id=__codelineno-49-14 name=__codelineno-49-14 href=#__codelineno-49-14></a><span class=w>            </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span>
</span><span id=__span-49-15><a id=__codelineno-49-15 name=__codelineno-49-15 href=#__codelineno-49-15></a><span class=w>                </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span>
</span><span id=__span-49-16><a id=__codelineno-49-16 name=__codelineno-49-16 href=#__codelineno-49-16></a><span class=w>                    </span><span class=c1># 可支援更複雜的需求 (表達式)</span>
</span><span id=__span-49-17><a id=__codelineno-49-17 name=__codelineno-49-17 href=#__codelineno-49-17></a><span class=w>                    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>matchExpressions</span><span class=p>:</span>
</span><span id=__span-49-18><a id=__codelineno-49-18 name=__codelineno-49-18 href=#__codelineno-49-18></a><span class=w>                        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">size</span>
</span><span id=__span-49-19><a id=__codelineno-49-19 name=__codelineno-49-19 href=#__codelineno-49-19></a><span class=w>                            </span><span class=c1># 可使用 Exists 運算子</span>
</span><span id=__span-49-20><a id=__codelineno-49-20 name=__codelineno-49-20 href=#__codelineno-49-20></a><span class=w>                            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Exists</span>
</span></code></pre></div> </li> <li> <p>nodeAffinity 的類型</p> <ul> <li> <p>目前已可用的</p> <ul> <li>Type 1 <code>requiredDuringSchedulingIgnoredDuringExecution</code>: 這是強制性的 Node Affinity。<strong>kube-scheduler 只會將 Pod 排程到滿足所有指定 Node Affinity 條件的節點上</strong>。若沒有滿足條件的節點，Pod 就無法被排程</li> <li>Type 2 <code>preferredDuringSchedulingIgnoredDuringExecution</code>: 這是有彈性的 Node Affinity。<strong>kube-scheduler 會盡量將 Pod 排程到滿足條件的節點上</strong>。但如果沒有符合條件的節點，Pod 仍然可以被排程到其他節點 <img alt src=../../../assets/pics/k8s/node_affinity_types_available.png></li> </ul> </li> <li> <p>未來正在規劃中的</p> <ul> <li>Type 3 <code>requiredDuringSchedulingRequiredDuringExecution</code>: 這是一個計劃中的功能，目前尚未實現。kube-scheduler <strong>只會</strong>將 Pod 排程到符合條件的節點上。<strong>而在 Pod 運行期間，若節點不再符合條件，Pod 會被驅逐</strong></li> <li>Type 4 <code>preferredDuringSchedulingRequiredDuringExecution</code>: 這是一個計劃中的功能，目前尚未實現。kube-scheduler 會<strong>盡量</strong>將 Pod 排程到符合條件的節點上。<strong>而在 Pod 運行期間，如果節點不再符合條件，Pod 會被驅逐</strong> <img alt src=../../../assets/pics/k8s/node_affinity_types_planned.png></li> </ul> </li> </ul> </li> <li> <p>參考資料</p> <ul> <li><a href=https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes-using-node-affinity/#schedule-a-pod-using-required-node-affinity>Schedule a Pod using required node affinity</a> </li> <li><a href=https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#node-affinity>Node affinity</a></li> </ul> </li> </ul> <h3 id=combine-taints-tolerations-node-affinity>combine Taints &amp; Tolerations &amp; Node Affinity<a class=headerlink href=#combine-taints-tolerations-node-affinity title="Permanent link">&para;</a></h3> <blockquote> <p>情境: 假設有五個 Node (Blue, Red, Green, Gray, Gray)，並且有五個 Pods (blue, red, green, gray, gray)。<br> 我們希望將 blue Pod 排程到 Blue Node 上，red Pod 排程到 Red Node 上，green Pod 排程到 Green Node 上，gray Pod 排程到 Gray Node 上。<br> 也就是說，在每個顏色的 Node 上，僅能排程對應顏色的 Pod。<br></p> </blockquote> <p><img alt src=../../../assets/pics/k8s/taints_tolerations_node_affinity_circumstance.png></p> <ul> <li>Taints &amp; Tolerations: <strong>無法確保 Pod 僅會被排程到指定的 Node 上</strong>，僅能限制不具備指定 tolerations 的 Pod 不會被排程到指定 taints 的 Node 上 (因此仍然可能會發生非預期的錯誤結果)<ul> <li>設定 Node 的 taints <img alt src=../../../assets/pics/k8s/taints_on_color_nodes.png></li> <li>設定 Pod 的 tolerations <img alt src=../../../assets/pics/k8s/tolerations_on_color_pods.png></li> <li>結果 (仍然可能會發生 Pod 排程到錯誤的 Node 上 =&gt; 非預期結果) <img alt src=../../../assets/pics/k8s/taints_and_toleations_unworked_situation.png></li> </ul> </li> <li>Node Selectors: 僅能限制指定的 Pod 會被排程到指定的 Node 上，但無法限制其他 Pod 也被排程到指定的 Node 上 <img alt src=../../../assets/pics/k8s/node_selectors_unworked-situation-1.png><ul> <li>結果 (仍然可能會發生 Pod 排程到錯誤的 Node 上 =&gt; 非預期結果) <img alt src=../../../assets/pics/k8s/node_selectors_unworked-situation-2.png></li> </ul> </li> <li>正確解法: 使用 Taints &amp; Tolerations 防止其它 Pod 放到錯誤的 Node 上。再使用 Node Affinity 防止 Pod 放到錯誤的 Node 上<ul> <li>結果 (Pod 會被正確地排程到指定的 Node 上) <img alt src=../../../assets/pics/k8s/taints_tolerations_node_affinity_worked-situation.png></li> </ul> </li> </ul> <h3 id=resource-requests-limits>Resource requests &amp; limits<a class=headerlink href=#resource-requests-limits title="Permanent link">&para;</a></h3> <ul> <li> <p>用途: 用來限制 Pod 使用的 CPU 和 memory 資源</p> <ul> <li>資源類型<ul> <li>CPU: 以 CPU 單位 (<strong>vCPU</strong>) 來表示<ul> <li>最佳實踐: 設定 CPU requests 就好 <img alt src=../../../assets/pics/k8s/set_cpu_requests.png></li> </ul> </li> <li>Memory: 以 memory 單位 (<strong>MiB</strong>) 來表示</li> </ul> </li> <li> <p>資源請求與限制</p> <ul> <li><strong>requests</strong>: 代表容器正常運行時，<strong>所需的最低資源下限</strong><ul> <li>K8s 預設每個 Pod 的 resource requests: CPU = 0.5 vCPU, memory = 256 MiB <img alt src=../../../assets/pics/k8s/resource_requests.png></li> </ul> </li> <li><strong>limits</strong>: 代表容器運行過程中，<strong>能使用的最多資源上限</strong><ul> <li>K8s 預設每個 Pod 的 resource limits: CPU = 1 vCPU, memory = 512 MiB <img alt src=../../../assets/pics/k8s/resource_limits.png></li> </ul> </li> </ul> <p><img alt src=../../../assets/pics/k8s/k8s_resource_requests_and_limits_illustration.png> <br> <a href=https://www.densify.com/kubernetes-autoscaling/kubernetes-resource-quota/ >圖片出處</a></p> <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-50-1><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a><span class=c1># pod-definition.yaml</span>
</span><span id=__span-50-2><a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-50-3><a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-50-4><a id=__codelineno-50-4 name=__codelineno-50-4 href=#__codelineno-50-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-50-5><a id=__codelineno-50-5 name=__codelineno-50-5 href=#__codelineno-50-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp-color</span>
</span><span id=__span-50-6><a id=__codelineno-50-6 name=__codelineno-50-6 href=#__codelineno-50-6></a><span class=w>    </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-50-7><a id=__codelineno-50-7 name=__codelineno-50-7 href=#__codelineno-50-7></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp-color</span>
</span><span id=__span-50-8><a id=__codelineno-50-8 name=__codelineno-50-8 href=#__codelineno-50-8></a>
</span><span id=__span-50-9><a id=__codelineno-50-9 name=__codelineno-50-9 href=#__codelineno-50-9></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-50-10><a id=__codelineno-50-10 name=__codelineno-50-10 href=#__codelineno-50-10></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-50-11><a id=__codelineno-50-11 name=__codelineno-50-11 href=#__codelineno-50-11></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp-color</span>
</span><span id=__span-50-12><a id=__codelineno-50-12 name=__codelineno-50-12 href=#__codelineno-50-12></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp-color</span>
</span><span id=__span-50-13><a id=__codelineno-50-13 name=__codelineno-50-13 href=#__codelineno-50-13></a>
</span><span id=__span-50-14><a id=__codelineno-50-14 name=__codelineno-50-14 href=#__codelineno-50-14></a><span class=w>        </span><span class=nt>ports</span><span class=p>:</span>
</span><span id=__span-50-15><a id=__codelineno-50-15 name=__codelineno-50-15 href=#__codelineno-50-15></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>containerPort</span><span class=p>:</span><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span><span id=__span-50-16><a id=__codelineno-50-16 name=__codelineno-50-16 href=#__codelineno-50-16></a>
</span><span id=__span-50-17><a id=__codelineno-50-17 name=__codelineno-50-17 href=#__codelineno-50-17></a><span class=w>        </span><span class=c1># 設定 resource requests &amp; limits</span>
</span><span id=__span-50-18><a id=__codelineno-50-18 name=__codelineno-50-18 href=#__codelineno-50-18></a><span class=w>        </span><span class=nt>resources</span><span class=p>:</span>
</span><span id=__span-50-19><a id=__codelineno-50-19 name=__codelineno-50-19 href=#__codelineno-50-19></a><span class=w>            </span><span class=nt>requests</span><span class=p>:</span>
</span><span id=__span-50-20><a id=__codelineno-50-20 name=__codelineno-50-20 href=#__codelineno-50-20></a><span class=w>                </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s>&quot;1Gi&quot;</span>
</span><span id=__span-50-21><a id=__codelineno-50-21 name=__codelineno-50-21 href=#__codelineno-50-21></a><span class=w>                </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s>&quot;1&quot;</span>
</span><span id=__span-50-22><a id=__codelineno-50-22 name=__codelineno-50-22 href=#__codelineno-50-22></a><span class=w>            </span><span class=nt>limits</span><span class=p>:</span>
</span><span id=__span-50-23><a id=__codelineno-50-23 name=__codelineno-50-23 href=#__codelineno-50-23></a><span class=w>                </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s>&quot;2Gi&quot;</span>
</span><span id=__span-50-24><a id=__codelineno-50-24 name=__codelineno-50-24 href=#__codelineno-50-24></a><span class=w>                </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s>&quot;2&quot;</span>
</span></code></pre></div> </li> </ul> </li> <li> <p>設定 Resource LimitRange: 幫助我們<strong>定義每個 Pod 的預設資源請求與限制</strong></p> <ul> <li>會套用在未來建立的 Pod 上，但不會套用於正在執行中的 Pod 上</li> </ul> <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-51-1><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a><span class=c1># limit-range-cpu.yaml</span>
</span><span id=__span-51-2><a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-51-3><a id=__codelineno-51-3 name=__codelineno-51-3 href=#__codelineno-51-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">LimitRange</span>
</span><span id=__span-51-4><a id=__codelineno-51-4 name=__codelineno-51-4 href=#__codelineno-51-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-51-5><a id=__codelineno-51-5 name=__codelineno-51-5 href=#__codelineno-51-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cpu-resource-constraint</span>
</span><span id=__span-51-6><a id=__codelineno-51-6 name=__codelineno-51-6 href=#__codelineno-51-6></a>
</span><span id=__span-51-7><a id=__codelineno-51-7 name=__codelineno-51-7 href=#__codelineno-51-7></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-51-8><a id=__codelineno-51-8 name=__codelineno-51-8 href=#__codelineno-51-8></a><span class=w>    </span><span class=nt>limits</span><span class=p>:</span>
</span><span id=__span-51-9><a id=__codelineno-51-9 name=__codelineno-51-9 href=#__codelineno-51-9></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>  </span><span class=nt>default</span><span class=p>:</span><span class=w> </span><span class=c1># limit</span>
</span><span id=__span-51-10><a id=__codelineno-51-10 name=__codelineno-51-10 href=#__codelineno-51-10></a><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">500m</span><span class=w> </span><span class=c1># 0.5 vCPU</span>
</span><span id=__span-51-11><a id=__codelineno-51-11 name=__codelineno-51-11 href=#__codelineno-51-11></a><span class=w>       </span><span class="w w-Error"> </span><span class=nt>defaultRequest</span><span class=p>:</span><span class=w> </span><span class=c1># request</span>
</span><span id=__span-51-12><a id=__codelineno-51-12 name=__codelineno-51-12 href=#__codelineno-51-12></a><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">500m</span><span class=w> </span><span class=c1># 0.5 vCPU</span>
</span><span id=__span-51-13><a id=__codelineno-51-13 name=__codelineno-51-13 href=#__codelineno-51-13></a><span class=w>        </span><span class=nt>max</span><span class=p>:</span><span class=w> </span><span class=c1># limit</span>
</span><span id=__span-51-14><a id=__codelineno-51-14 name=__codelineno-51-14 href=#__codelineno-51-14></a><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class=w> </span><span class=c1># 1 vCPU</span>
</span><span id=__span-51-15><a id=__codelineno-51-15 name=__codelineno-51-15 href=#__codelineno-51-15></a><span class=w>        </span><span class=nt>min</span><span class=p>:</span><span class=w> </span><span class=c1># request</span>
</span><span id=__span-51-16><a id=__codelineno-51-16 name=__codelineno-51-16 href=#__codelineno-51-16></a><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">100m</span><span class=w> </span><span class=c1># 0.1 vCPU</span>
</span><span id=__span-51-17><a id=__codelineno-51-17 name=__codelineno-51-17 href=#__codelineno-51-17></a><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Container</span>
</span></code></pre></div> <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-52-1><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a><span class=c1># limit-range-memory.yaml</span>
</span><span id=__span-52-2><a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-52-3><a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">LimitRange</span>
</span><span id=__span-52-4><a id=__codelineno-52-4 name=__codelineno-52-4 href=#__codelineno-52-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-52-5><a id=__codelineno-52-5 name=__codelineno-52-5 href=#__codelineno-52-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">memory-resource-constraint</span>
</span><span id=__span-52-6><a id=__codelineno-52-6 name=__codelineno-52-6 href=#__codelineno-52-6></a>
</span><span id=__span-52-7><a id=__codelineno-52-7 name=__codelineno-52-7 href=#__codelineno-52-7></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-52-8><a id=__codelineno-52-8 name=__codelineno-52-8 href=#__codelineno-52-8></a><span class=w>    </span><span class=nt>limits</span><span class=p>:</span>
</span><span id=__span-52-9><a id=__codelineno-52-9 name=__codelineno-52-9 href=#__codelineno-52-9></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>default</span><span class=p>:</span><span class=w> </span><span class=c1># limit</span>
</span><span id=__span-52-10><a id=__codelineno-52-10 name=__codelineno-52-10 href=#__codelineno-52-10></a><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span><span class=w> </span><span class=c1># 1 GiB</span>
</span><span id=__span-52-11><a id=__codelineno-52-11 name=__codelineno-52-11 href=#__codelineno-52-11></a><span class=w>        </span><span class=nt>defaultRequest</span><span class=p>:</span><span class=w> </span><span class=c1># request</span>
</span><span id=__span-52-12><a id=__codelineno-52-12 name=__codelineno-52-12 href=#__codelineno-52-12></a><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span><span class=w> </span><span class=c1># 1 GiB</span>
</span><span id=__span-52-13><a id=__codelineno-52-13 name=__codelineno-52-13 href=#__codelineno-52-13></a><span class=w>        </span><span class=nt>max</span><span class=p>:</span><span class=w> </span><span class=c1># limit</span>
</span><span id=__span-52-14><a id=__codelineno-52-14 name=__codelineno-52-14 href=#__codelineno-52-14></a><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span><span class=w> </span><span class=c1># 1 GiB</span>
</span><span id=__span-52-15><a id=__codelineno-52-15 name=__codelineno-52-15 href=#__codelineno-52-15></a><span class=w>        </span><span class=nt>min</span><span class=p>:</span><span class=w> </span><span class=c1># request</span>
</span><span id=__span-52-16><a id=__codelineno-52-16 name=__codelineno-52-16 href=#__codelineno-52-16></a><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">500Mi</span><span class=w> </span><span class=c1># 500 MiB</span>
</span><span id=__span-52-17><a id=__codelineno-52-17 name=__codelineno-52-17 href=#__codelineno-52-17></a><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Container</span>
</span></code></pre></div> </li> <li> <p>設定 Resource Quota: 用來<strong>設定整個 Namespace 的資源請求與限制</strong> <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-53-1><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a><span class=c1># resource-quota.yaml</span>
</span><span id=__span-53-2><a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-53-3><a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ResourceQuota</span>
</span><span id=__span-53-4><a id=__codelineno-53-4 name=__codelineno-53-4 href=#__codelineno-53-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-53-5><a id=__codelineno-53-5 name=__codelineno-53-5 href=#__codelineno-53-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">my-resource-quota</span>
</span><span id=__span-53-6><a id=__codelineno-53-6 name=__codelineno-53-6 href=#__codelineno-53-6></a>
</span><span id=__span-53-7><a id=__codelineno-53-7 name=__codelineno-53-7 href=#__codelineno-53-7></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-53-8><a id=__codelineno-53-8 name=__codelineno-53-8 href=#__codelineno-53-8></a><span class=w>    </span><span class=nt>hard</span><span class=p>:</span>
</span><span id=__span-53-9><a id=__codelineno-53-9 name=__codelineno-53-9 href=#__codelineno-53-9></a><span class=w>        </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=s>&quot;10&quot;</span>
</span><span id=__span-53-10><a id=__codelineno-53-10 name=__codelineno-53-10 href=#__codelineno-53-10></a><span class=w>        </span><span class=nt>requests.cpu</span><span class=p>:</span><span class=w> </span><span class=s>&quot;4&quot;</span>
</span><span id=__span-53-11><a id=__codelineno-53-11 name=__codelineno-53-11 href=#__codelineno-53-11></a><span class=w>        </span><span class=nt>requests.memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">4Gi</span>
</span><span id=__span-53-12><a id=__codelineno-53-12 name=__codelineno-53-12 href=#__codelineno-53-12></a><span class=w>        </span><span class=nt>limits.cpu</span><span class=p>:</span><span class=w> </span><span class=s>&quot;10&quot;</span>
</span><span id=__span-53-13><a id=__codelineno-53-13 name=__codelineno-53-13 href=#__codelineno-53-13></a><span class=w>        </span><span class=nt>limits.memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10Gi</span>
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/resource_quota_illustration.png> <img alt src=../../../assets/pics/k8s/resource_quota.png></p> </li> <li> <p>當超過 resource limits 的限制時</p> <ul> <li><strong>CPU</strong>: 會被限制在指定的 CPU 數量上，<strong>超過的部分會被暫停 (throttle)</strong><ul> <li>Pod 會顯示處於 Pending 狀態，因為 kube-scheduler 找不到具有足夠 CPU 來排程 <img alt src=../../../assets/pics/k8s/pod_pending_with_insufficient_cpu.png></li> </ul> </li> <li><strong>Memory</strong>: 會被限制在指定的 memory 上，<strong>超過的部分會被刪除 (terminate)</strong><ul> <li>因為我們無法節流 (throttle) memory，因此當超過 memory limits 時，僅能透過刪除 Pod 來釋放 memory</li> <li>會拋出 <strong>OOM 錯誤 (Out Of Memory)</strong> <img alt src=../../../assets/pics/k8s/pod_pending_with_insufficient_memory.png></li> </ul> </li> </ul> </li> </ul> <h3 id=daemonset>DaemonSet<a class=headerlink href=#daemonset title="Permanent link">&para;</a></h3> <ul> <li>用途: 類似 ReplicaSet，能幫助我們在各個 Node 上部署多個相同的 Pod 副本。但是 DaemonSet 僅會在各個 Node 上運行一個 Pod 副本<ul> <li>當有新的 Node 加入 K8s 叢集時，DaemonSet 會自動在新的 Node 上部署一個 Pod 副本</li> <li>當有 Node 從 K8s 叢集中移除時，DaemonSet 會自動刪除該 Node 上的 Pod 副本 <img alt src=../../../assets/pics/k8s/daemonset_illustration.png></li> </ul> </li> <li>常見應用情境: <strong>Monitoring solution, Logs viewer</strong>, kube-proxy, Networking solution <img alt src=../../../assets/pics/k8s/daemonset_use_cases.png> <img alt src=../../../assets/pics/k8s/daemonset_use_cases_kube_proxy.png> <img alt src=../../../assets/pics/k8s/daemonset_use_cases_networking.png></li> <li> <p>建立 DaemonSet</p> <ul> <li>類似於 ReplicaSet 的 YAML manifest 設定檔，但是 kind 要改成 DaemonSet <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-54-1><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a><span class=c1># daemonset-definition.yaml</span>
</span><span id=__span-54-2><a id=__codelineno-54-2 name=__codelineno-54-2 href=#__codelineno-54-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id=__span-54-3><a id=__codelineno-54-3 name=__codelineno-54-3 href=#__codelineno-54-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span>
</span><span id=__span-54-4><a id=__codelineno-54-4 name=__codelineno-54-4 href=#__codelineno-54-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-54-5><a id=__codelineno-54-5 name=__codelineno-54-5 href=#__codelineno-54-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">monitoring-daemon</span>
</span><span id=__span-54-6><a id=__codelineno-54-6 name=__codelineno-54-6 href=#__codelineno-54-6></a><span class=w>    </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-54-7><a id=__codelineno-54-7 name=__codelineno-54-7 href=#__codelineno-54-7></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-54-8><a id=__codelineno-54-8 name=__codelineno-54-8 href=#__codelineno-54-8></a>
</span><span id=__span-54-9><a id=__codelineno-54-9 name=__codelineno-54-9 href=#__codelineno-54-9></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-54-10><a id=__codelineno-54-10 name=__codelineno-54-10 href=#__codelineno-54-10></a><span class=w>    </span><span class=nt>selector</span><span class=p>:</span>
</span><span id=__span-54-11><a id=__codelineno-54-11 name=__codelineno-54-11 href=#__codelineno-54-11></a><span class=w>        </span><span class=nt>matchLabels</span><span class=p>:</span>
</span><span id=__span-54-12><a id=__codelineno-54-12 name=__codelineno-54-12 href=#__codelineno-54-12></a><span class=w>            </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">monitoring-agent</span>
</span><span id=__span-54-13><a id=__codelineno-54-13 name=__codelineno-54-13 href=#__codelineno-54-13></a><span class=w>    </span><span class=nt>template</span><span class=p>:</span>
</span><span id=__span-54-14><a id=__codelineno-54-14 name=__codelineno-54-14 href=#__codelineno-54-14></a><span class=w>        </span><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-54-15><a id=__codelineno-54-15 name=__codelineno-54-15 href=#__codelineno-54-15></a><span class=w>            </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-54-16><a id=__codelineno-54-16 name=__codelineno-54-16 href=#__codelineno-54-16></a><span class=w>                </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">monitoring-agent</span>
</span><span id=__span-54-17><a id=__codelineno-54-17 name=__codelineno-54-17 href=#__codelineno-54-17></a><span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-54-18><a id=__codelineno-54-18 name=__codelineno-54-18 href=#__codelineno-54-18></a><span class=w>        </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-54-19><a id=__codelineno-54-19 name=__codelineno-54-19 href=#__codelineno-54-19></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">monitoring-agent</span>
</span><span id=__span-54-20><a id=__codelineno-54-20 name=__codelineno-54-20 href=#__codelineno-54-20></a><span class=w>            </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">monitoring-agent</span>
</span></code></pre></div></li> </ul> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-55-1><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>daemonset-definition.yaml
</span></code></pre></div> </li> <li> <p>檢視在所有的 Namespace 中，目前所有的 DaemonSet <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-56-1><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a>kubectl<span class=w> </span>get<span class=w> </span>daemonsets<span class=w> </span>-A
</span></code></pre></div></p> </li> <li> <p>詳細檢視指定 DaemonSet 的資訊 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-57-1><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a>kubectl<span class=w> </span>describe<span class=w> </span>daemonsets<span class=w> </span>monitoring-daemon
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/view_daemonsets.png></p> </li> <li> <p>DaemonSet 是如何將 Pod 分別排程到各個 Node 上的？</p> <ul> <li>在 K8s v1.12 之前: 使用 nodeSelector</li> <li>在 K8s v1.12 之後: 使用 Node Affinity, default kube-scheduler <img alt src=../../../assets/pics/k8s/how_does_daemonset_works.png></li> </ul> </li> </ul> <h3 id=static-pods>Static Pods<a class=headerlink href=#static-pods title="Permanent link">&para;</a></h3> <ul> <li>Static Pod: 在 K8s 叢集中，由 kubelet 直接管理的 Pod，而不是透過 kube-apiserver 來建立、管理<ul> <li>kubelet 會自動監控、啟動這些 Static Pod</li> <li>不會被記錄在 etcd 中，因此不能透過 <code>kubectl</code> 指令來管理</li> </ul> </li> <li> <p>假設沒有 K8s 叢集，也沒有 Master Node，也沒有 kube-apiserver。那麼 Worker Node 會如何運作？</p> <ul> <li>Ans: kubelet 會透過預設在 <code>/etc/kubernetes/manifests</code> 目錄下的 YAML manifest 設定檔，來建立 Static Pods<ul> <li>法 1: 透過 CLI 的 <code>--pod-manifest-path</code> 選項，通知 kubelet 建立 Static Pods <img alt src=../../../assets/pics/k8s/static_pods_kubelet_service.png></li> <li>法 2: 編輯 kubeconfig.yaml 設定檔，加入 <code>staticPodPath: /etc/kubernetes/manifests</code> 設定，通知 kubelet 建立 Static Pods <img alt src=../../../assets/pics/k8s/static_pods_kubeconfig.png></li> </ul> </li> <li> <p>這時候，若要檢視當前有哪些 Static Pods，因為我們沒有一個完整的 K8s 叢集，因此只能透過 Docker 指令來查看 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-58-1><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a>docker<span class=w> </span>ps
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/view_static_pods_by_docker_ps.png></p> </li> </ul> </li> <li> <p>kubelet 可以透過以下兩種方式，建立 Pod (兩種 Pods 都可以經由 <code>kubectl get pods</code> 查看)</p> <ul> <li>由 <strong>kube-apiserver</strong> 運用 HTTP request，通知 kubelet 建立 <strong>Pod</strong></li> <li>kubelet 根據 <code>/etc/kubernetes/manifests</code> 目錄下的 YAML manifest 設定檔，建立 <strong>Static Pods</strong><ul> <li>其實，當建立 Static Pod 時，也會在 kube-apiserver 建立一個 read-only mirror object。因此，如果要編輯這個 Static Pod，還是必須到 Worker Node 的 <code>/etc/kubernetes/manifests</code> 目錄下編輯 YAML manifest 設定檔 <img alt src=../../../assets/pics/k8s/static_pods_on_kube_apiserver_mirror_object.png></li> </ul> </li> </ul> </li> <li> <p>Static Pod 的應用情境</p> <ul> <li>kubeadm 設定 K8s 叢集的方式: 因為 Static Pod 不需要依賴 K8s 叢集的特性，因此可在各節點上，透過 kubelet 建立 Static Pod，來運行各種系統服務 (e.g. controller-manager, apiserver, etcd, scheduler)。並且 kubelet 會自動管理這些系統服務，確保其持續運行 <img alt src=../../../assets/pics/k8s/static_pods_use_cases.png> <img alt src=../../../assets/pics/k8s/static_pods_use_cases_get_pods.png></li> </ul> </li> <li> <p>檢視所有 Namespace 中有幾個 Static Pods</p> <ul> <li>查看 <strong>Pod name 的後綴，會帶有 Node name</strong> 的就是 Static Pods <img alt src=../../../assets/pics/k8s/static_pods_with_suffix_node_name.png></li> <li>檢視 Static Pods 的詳細資訊: <strong>ownerReferences.kind = Node</strong> <img alt src=../../../assets/pics/k8s/static_pod_ownerreferences_kind.png></li> </ul> </li> <li>Static Pod 的 YAML manifest 設定檔會存放在哪？<ul> <li>步驟 1: 檢視 kubelet 的 <code>/var/lib/kubelet/config.yaml</code> 設定檔內容，確認 <strong>staticPodPath: /etc/kubernetes/manifests</strong> 的路徑位置<ul> <li>預設會放在 Node 上的 <code>/etc/kubernetes/manifests</code> 目錄下</li> </ul> </li> <li>步驟 2: 到 staticPodPath 確認當前 kubelet 有哪些關於 Static Pod 的設定檔 <img alt src=../../../assets/pics/k8s/kubelet_static_pod_path.png></li> </ul> </li> <li>Static Pods vs. DaemonSets <img alt src=../../../assets/pics/k8s/static_pods_vs_daemonsets.png></li> </ul> <h3 id=multiple-schedulers>Multiple Schedulers<a class=headerlink href=#multiple-schedulers title="Permanent link">&para;</a></h3> <ul> <li>用途: 可以在 K8s 叢集中，同時部署多個 scheduler <img alt src=../../../assets/pics/k8s/multiple_schedulers.png></li> <li>手動建立一個自定義的 scheduler<ul> <li>法 1: 透過 scheduler 的 binary 檔，建立 scheduler<ul> <li>下載 scheduler 的 binary 檔 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-59-1><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a>wget<span class=w> </span>https://storage.googleapis.com/kubernetes-release/release/v1.12.0/bin/linux/amd64/kube-scheduler
</span></code></pre></div></li> <li>指定 scheduler 名稱，以及 scheduler 的 YAML manifest 設定檔 <img alt src=../../../assets/pics/k8s/deploy_additional_scheduler.png></li> </ul> </li> <li>法 2: 將 scheduler 視為一個 Pod，先建立 scheduler-config 檔後，再宣告 <code>--config</code> 選項來指定 scheduler 的 YAML manifest 設定檔的路徑<ul> <li><code>leaderElect</code>: true 表示這個 scheduler 會選舉一個 leader，並且只有 leader 才會執行任務 (因為在 K8s 叢集中，一次只能有一個 scheduler 處於 active 狀態，以避免排程演算法的決策衝突問題) <img alt src=../../../assets/pics/k8s/deploy_additional_scheduler_as_a_pod.png></li> <li>建立 scheduler Pod <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-60-1><a id=__codelineno-60-1 name=__codelineno-60-1 href=#__codelineno-60-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>my-custom-scheduler.yaml
</span></code></pre></div></li> </ul> </li> </ul> </li> <li>檢視指定 Namespace 中的所有 Scheduler Pods <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-61-1><a id=__codelineno-61-1 name=__codelineno-61-1 href=#__codelineno-61-1></a>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=w> </span>kube-system
</span></code></pre></div></li> <li> <p>運用剛剛建立的 scheduler，建立一個 Pod: 設定 <code>schedulerName</code> 參數值 <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-62-1><a id=__codelineno-62-1 name=__codelineno-62-1 href=#__codelineno-62-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-62-2><a id=__codelineno-62-2 name=__codelineno-62-2 href=#__codelineno-62-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-62-3><a id=__codelineno-62-3 name=__codelineno-62-3 href=#__codelineno-62-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-62-4><a id=__codelineno-62-4 name=__codelineno-62-4 href=#__codelineno-62-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-62-5><a id=__codelineno-62-5 name=__codelineno-62-5 href=#__codelineno-62-5></a>
</span><span id=__span-62-6><a id=__codelineno-62-6 name=__codelineno-62-6 href=#__codelineno-62-6></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-62-7><a id=__codelineno-62-7 name=__codelineno-62-7 href=#__codelineno-62-7></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-62-8><a id=__codelineno-62-8 name=__codelineno-62-8 href=#__codelineno-62-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-62-9><a id=__codelineno-62-9 name=__codelineno-62-9 href=#__codelineno-62-9></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-62-10><a id=__codelineno-62-10 name=__codelineno-62-10 href=#__codelineno-62-10></a><span class=w>    </span><span class=c1># 指定使用自定義的 scheduler</span>
</span><span id=__span-62-11><a id=__codelineno-62-11 name=__codelineno-62-11 href=#__codelineno-62-11></a><span class=w>    </span><span class=nt>schedulerName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">my-custom-scheduler</span>
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/use_custom_scheduler.png></p> </li> <li> <p>如何查詢哪個 scheduler 負責排程哪些 Pods？ <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-63-1><a id=__codelineno-63-1 name=__codelineno-63-1 href=#__codelineno-63-1></a>kubectl<span class=w> </span>get<span class=w> </span>events<span class=w> </span>-o<span class=o>=</span>wide
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/multiple_schedulers_view_events.png></p> </li> <li> <p>如何查詢 scheduler 的排程記錄 log？ <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-64-1><a id=__codelineno-64-1 name=__codelineno-64-1 href=#__codelineno-64-1></a>kubectl<span class=w> </span>logs<span class=w> </span>my-custom-scheduler<span class=w> </span>-n<span class=o>=</span>kube-system
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/multiple_schedulers_view_scheduler_logs.png></p> </li> </ul> <h3 id=configuring-scheduler-profiles>Configuring Scheduler Profiles<a class=headerlink href=#configuring-scheduler-profiles title="Permanent link">&para;</a></h3> <ul> <li>每個 scheduler 都會具備以下幾個擴展點 (extension points)，能透過加入插件 (plugin) 的方式，來擴展 scheduler 的功能<ul> <li>擴展點 (extension points): 表示<strong>排程過程中的特定階段</strong>，這些階段能允許使用者插入自定義插件邏輯，以修改 or 擴展 scheduler 的行為</li> <li>插件 (plugins): 附加在<strong>scheduler 的擴展點上，用來自定義 or 擴展 scheduler 的行為</strong> <img alt src=../../../assets/pics/k8s/scheduling_framework_extension_points.png> <img alt src=../../../assets/pics/k8s/scheduler_extension_points.png></li> </ul> </li> <li>從 K8s v.1.18 以後，能透過 <strong>KubeSchedulerConfiguration</strong> 物件，在同一份 scheduler 設定檔中，設定多個 scheduler profiles<ul> <li><code>profiles</code>: 能指定多個 schedulerName，以設定多個 scheduler profiles<ul> <li><code>plugins</code>: 可分別設定各個 scheduler 的 plugins 內容 <img alt src=../../../assets/pics/k8s/KubeSchedulerConfiguration.png></li> </ul> </li> </ul> </li> </ul> <h2 id=logging-monitoring>Logging &amp; Monitoring<a class=headerlink href=#logging-monitoring title="Permanent link">&para;</a></h2> <h3 id=logging>Logging<a class=headerlink href=#logging title="Permanent link">&para;</a></h3> <ul> <li> <p>Docker: 執行一個模擬產生 log 的程式，並實時查看 log 資訊 <img alt src=../../../assets/pics/k8s/loggin_event_simulator.png></p> <p><code>-f</code> 參數: 表示 follow，用來實時追蹤 log 輸出資訊，類似於 Linux 中的 tail -f 命令 <img alt src=../../../assets/pics/k8s/logging_docker_logs.png></p> </li> <li> <p>Kubernetes: 建立並執行一個模擬產生 log 的 Pod，並實時查看 log 資訊 <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-65-1><a id=__codelineno-65-1 name=__codelineno-65-1 href=#__codelineno-65-1></a><span class=c1># pod-definition.yaml</span>
</span><span id=__span-65-2><a id=__codelineno-65-2 name=__codelineno-65-2 href=#__codelineno-65-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-65-3><a id=__codelineno-65-3 name=__codelineno-65-3 href=#__codelineno-65-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-65-4><a id=__codelineno-65-4 name=__codelineno-65-4 href=#__codelineno-65-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-65-5><a id=__codelineno-65-5 name=__codelineno-65-5 href=#__codelineno-65-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">event-simulator-pod</span>
</span><span id=__span-65-6><a id=__codelineno-65-6 name=__codelineno-65-6 href=#__codelineno-65-6></a>
</span><span id=__span-65-7><a id=__codelineno-65-7 name=__codelineno-65-7 href=#__codelineno-65-7></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-65-8><a id=__codelineno-65-8 name=__codelineno-65-8 href=#__codelineno-65-8></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-65-9><a id=__codelineno-65-9 name=__codelineno-65-9 href=#__codelineno-65-9></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">event-simulator</span>
</span><span id=__span-65-10><a id=__codelineno-65-10 name=__codelineno-65-10 href=#__codelineno-65-10></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kodekloud/event-simulator</span>
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-66-1><a id=__codelineno-66-1 name=__codelineno-66-1 href=#__codelineno-66-1></a>kubectl<span class=w> </span>logs<span class=w> </span>-f<span class=w> </span>event-simulator-pod
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/logging_k8s_logs.png></p> </li> <li> <p>若在一個 Pod 中，有多個 container，則需指定 container name <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-67-1><a id=__codelineno-67-1 name=__codelineno-67-1 href=#__codelineno-67-1></a><span class=c1># kubectl logs -f &lt;pod-name&gt; -c &lt;container-name&gt;</span>
</span><span id=__span-67-2><a id=__codelineno-67-2 name=__codelineno-67-2 href=#__codelineno-67-2></a>kubectl<span class=w> </span>logs<span class=w> </span>-f<span class=w> </span>even-simulator-pod<span class=w> </span>-c<span class=w> </span>event-simulator
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/logging_specified_container_in_pod.png></p> </li> </ul> <h3 id=monitoring>Monitoring<a class=headerlink href=#monitoring title="Permanent link">&para;</a></h3> <ul> <li> <p>截至目前(2024)，K8s 官方並無內建的<strong>全功能監控工具</strong>，因此需要透過第三方開源工具來監控 K8s 叢集 <img alt src=../../../assets/pics/k8s/k8s_open_source_monitoring_tools.png></p> </li> <li> <p>Heapster 曾經是 K8s 官方的監控工具，但在 K8s v1.11 之後，已經被淘汰。<strong>現已由 Metrics Server 取代</strong> <img alt src=../../../assets/pics/k8s/metrics_server.png></p> </li> <li> <p>Metrics Server</p> <ul> <li>僅提供基本的監控功能 (e.g. CPU, Memory 使用率)，並不提供進階的監控功能 (log 收集、進階分析、視覺化顯示)</li> <li>僅會將各個 Node 上的 metrics 資料，儲存在 <strong>in-memory</strong> 中，而不會儲存在硬碟中，因此我們無法透過 Metrics Server 查詢歷史監控資料</li> </ul> <p><img alt src=../../../assets/pics/k8s/metrics_server_in_memory.png></p> </li> <li> <p>每個 Node 是如何收集監控指標的資料呢？</p> <ul> <li>透過 kubelet 的 cAdvisor 來收集 Pod 的監控指標資料，並定期向 Metrics Server 回報</li> </ul> <p><img alt src=../../../assets/pics/k8s/metrics_server_cAdvisor.png></p> </li> <li> <p>啟動 Metrics Server</p> <ul> <li>法 1 (minikube): <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-68-1><a id=__codelineno-68-1 name=__codelineno-68-1 href=#__codelineno-68-1></a>minikube<span class=w> </span>addons<span class=w> </span><span class=nb>enable</span><span class=w> </span>metrics-server
</span></code></pre></div></li> <li> <p>法 2 (其它情況): <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-69-1><a id=__codelineno-69-1 name=__codelineno-69-1 href=#__codelineno-69-1></a>git<span class=w> </span>clone<span class=w> </span>https://github.com/kubernetes-incubator/metrics-server.git
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-70-1><a id=__codelineno-70-1 name=__codelineno-70-1 href=#__codelineno-70-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>metric-server/deploy/1.8+/
</span></code></pre></div> </li> </ul> <p><img alt src=../../../assets/pics/k8s/metrics_server_enable.png></p> </li> <li> <p>監控 Node-level 的指標</p> <ul> <li>正在運行中的節點數量</li> <li>CPU 使用率</li> <li>Memory 使用率</li> <li>Disk 使用率</li> <li>Network 使用率</li> </ul> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-71-1><a id=__codelineno-71-1 name=__codelineno-71-1 href=#__codelineno-71-1></a>kubectl<span class=w> </span>top<span class=w> </span>node
</span></code></pre></div> </li> <li> <p>監控 Pod-level 的指標</p> <ul> <li>正在運行中的 Pod 數量</li> <li>CPU 使用率</li> <li>Memory 使用率</li> <li>Disk 使用率</li> <li>Network 使用率</li> </ul> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-72-1><a id=__codelineno-72-1 name=__codelineno-72-1 href=#__codelineno-72-1></a>kubectl<span class=w> </span>top<span class=w> </span>pod
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/k8s_monitoring_top_command.png></p> </li> </ul> <h2 id=application-lifecycle-management>Application Lifecycle Management<a class=headerlink href=#application-lifecycle-management title="Permanent link">&para;</a></h2> <h3 id=rolling-updates-and-rollbacks-in-deployments>Rolling Updates and Rollbacks in Deployments<a class=headerlink href=#rolling-updates-and-rollbacks-in-deployments title="Permanent link">&para;</a></h3> <ul> <li>當我們第一次建立 Deployment，會觸發一個 Rollout，產生一個 Revision。而之後的每次更新，都會觸發一個新的 Rollout，產生一個新的 Revision <img alt src=../../../assets/pics/k8s/rollout_and_versioning.png></li> </ul> <h4 id=deployment-rollout-strategy>Deployment-Rollout Strategy<a class=headerlink href=#deployment-rollout-strategy title="Permanent link">&para;</a></h4> <ul> <li>建立 Deployment <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-73-1><a id=__codelineno-73-1 name=__codelineno-73-1 href=#__codelineno-73-1></a>kubectl<span class=w> </span>create<span class=w> </span>deployment<span class=w> </span>nginx<span class=w> </span>--image<span class=o>=</span>nginx
</span></code></pre></div></li> <li>查看當前 Deployment 的滾動更新狀態，告訴我們新的 Pod 是否已經就緒 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-74-1><a id=__codelineno-74-1 name=__codelineno-74-1 href=#__codelineno-74-1></a>kubectl<span class=w> </span>rollout<span class=w> </span>status<span class=w> </span>deployment/myapp-deployment
</span></code></pre></div></li> <li> <p>查看 Deployment 的歷史記錄，包含每次變更的修訂版本、變更原因 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-75-1><a id=__codelineno-75-1 name=__codelineno-75-1 href=#__codelineno-75-1></a>kubectl<span class=w> </span>rollout<span class=w> </span><span class=nb>history</span><span class=w> </span>deployment/myapp-deployment
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/rollout_command.png> <img alt src=../../../assets/pics/k8s/recreate_vs_rollingupdate.png></p> </li> <li> <p>Deployment 的兩種 Rollout 策略</p> <ul> <li>Recreate: 先刪除舊的 Pod，再建立新的 Pod</li> <li><strong>RollingUpdate</strong> (預設): 滾動更新，逐步刪除舊的 Pod，並建立新的 Pod<ul> <li><code>maxUnavailable</code>: 一次最多刪除多少個 Pod</li> <li><code>maxSurge</code>: 一次最多新增多少個 Pod <img alt src=../../../assets/pics/k8s/deployment_strategy.png></li> </ul> </li> </ul> </li> <li> <p>更新 Deployment 的 Rollout 策略</p> <ul> <li> <p>法 1: 透過 <code>kubectl edit</code> 指令，編輯 Deployment 的 YAML manifest 設定檔 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-76-1><a id=__codelineno-76-1 name=__codelineno-76-1 href=#__codelineno-76-1></a>kubectl<span class=w> </span>edit<span class=w> </span>deployment-definition.yaml
</span></code></pre></div></p> <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-77-1><a id=__codelineno-77-1 name=__codelineno-77-1 href=#__codelineno-77-1></a><span class=c1># deployment-definition.yaml</span>
</span><span id=__span-77-2><a id=__codelineno-77-2 name=__codelineno-77-2 href=#__codelineno-77-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id=__span-77-3><a id=__codelineno-77-3 name=__codelineno-77-3 href=#__codelineno-77-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id=__span-77-4><a id=__codelineno-77-4 name=__codelineno-77-4 href=#__codelineno-77-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-77-5><a id=__codelineno-77-5 name=__codelineno-77-5 href=#__codelineno-77-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-deployment</span>
</span><span id=__span-77-6><a id=__codelineno-77-6 name=__codelineno-77-6 href=#__codelineno-77-6></a><span class=w>    </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-77-7><a id=__codelineno-77-7 name=__codelineno-77-7 href=#__codelineno-77-7></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-77-8><a id=__codelineno-77-8 name=__codelineno-77-8 href=#__codelineno-77-8></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-77-9><a id=__codelineno-77-9 name=__codelineno-77-9 href=#__codelineno-77-9></a><span class=w>    </span><span class=nt>template</span><span class=p>:</span>
</span><span id=__span-77-10><a id=__codelineno-77-10 name=__codelineno-77-10 href=#__codelineno-77-10></a><span class=w>        </span><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-77-11><a id=__codelineno-77-11 name=__codelineno-77-11 href=#__codelineno-77-11></a><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myap-pod</span>
</span><span id=__span-77-12><a id=__codelineno-77-12 name=__codelineno-77-12 href=#__codelineno-77-12></a><span class=w>            </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-77-13><a id=__codelineno-77-13 name=__codelineno-77-13 href=#__codelineno-77-13></a><span class=w>                </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
</span><span id=__span-77-14><a id=__codelineno-77-14 name=__codelineno-77-14 href=#__codelineno-77-14></a><span class=w>                </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
</span><span id=__span-77-15><a id=__codelineno-77-15 name=__codelineno-77-15 href=#__codelineno-77-15></a><span class=w>        </span><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-77-16><a id=__codelineno-77-16 name=__codelineno-77-16 href=#__codelineno-77-16></a><span class=w>            </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-77-17><a id=__codelineno-77-17 name=__codelineno-77-17 href=#__codelineno-77-17></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx-container</span>
</span><span id=__span-77-18><a id=__codelineno-77-18 name=__codelineno-77-18 href=#__codelineno-77-18></a><span class=w>                </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx:1.7.1</span>
</span><span id=__span-77-19><a id=__codelineno-77-19 name=__codelineno-77-19 href=#__codelineno-77-19></a>
</span><span id=__span-77-20><a id=__codelineno-77-20 name=__codelineno-77-20 href=#__codelineno-77-20></a><span class=w>    </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span id=__span-77-21><a id=__codelineno-77-21 name=__codelineno-77-21 href=#__codelineno-77-21></a><span class=w>    </span><span class=nt>selector</span><span class=p>:</span>
</span><span id=__span-77-22><a id=__codelineno-77-22 name=__codelineno-77-22 href=#__codelineno-77-22></a><span class=w>        </span><span class=nt>matchLabels</span><span class=p>:</span>
</span><span id=__span-77-23><a id=__codelineno-77-23 name=__codelineno-77-23 href=#__codelineno-77-23></a><span class=w>            </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
</span></code></pre></div> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-78-1><a id=__codelineno-78-1 name=__codelineno-78-1 href=#__codelineno-78-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>deployment-definition.yaml
</span></code></pre></div> </li> <li> <p>法 2: 透過 <code>kubectl set</code> 指令，設定 Deployment 的 Rollout 策略 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-79-1><a id=__codelineno-79-1 name=__codelineno-79-1 href=#__codelineno-79-1></a>kubectl<span class=w> </span><span class=nb>set</span><span class=w> </span>image<span class=w> </span>deployment/myapp-deployment<span class=w> </span><span class=nv>nginx</span><span class=o>=</span>nginx:1.9.1
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/update_deployment_rollout_settings.png></p> </li> </ul> </li> <li> <p>升級 Deployment 的版本: K8s 叢集會建立一個新的 ReplicaSet 來建立新的 Pods <img alt src=../../../assets/pics/k8s/upgrade_deployment.png></p> </li> <li> <p>回滾 Deployment 的版本: 運用 <code>kubectl rollout undo</code> 指令，K8s 叢集會將新的 ReplicaSet 中的 Pods 刪除，並重新建立舊的 ReplicaSet 中的 Pods <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-80-1><a id=__codelineno-80-1 name=__codelineno-80-1 href=#__codelineno-80-1></a>kubectl<span class=w> </span>rollout<span class=w> </span>undo<span class=w> </span>deployment/myapp-deployment
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/rollback_deployment.png></p> </li> <li> <p>統整: 關於 Deployment 的常見 kubectl 指令 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-81-1><a id=__codelineno-81-1 name=__codelineno-81-1 href=#__codelineno-81-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>deployment-definition.yaml
</span><span id=__span-81-2><a id=__codelineno-81-2 name=__codelineno-81-2 href=#__codelineno-81-2></a>kubectl<span class=w> </span>get<span class=w> </span>deployments
</span><span id=__span-81-3><a id=__codelineno-81-3 name=__codelineno-81-3 href=#__codelineno-81-3></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>deployment-definition.yaml
</span><span id=__span-81-4><a id=__codelineno-81-4 name=__codelineno-81-4 href=#__codelineno-81-4></a>kubectl<span class=w> </span><span class=nb>set</span><span class=w> </span>image<span class=w> </span>deployment/myapp-deployment<span class=w> </span><span class=nv>nginx</span><span class=o>=</span>nginx:1.9.1
</span><span id=__span-81-5><a id=__codelineno-81-5 name=__codelineno-81-5 href=#__codelineno-81-5></a>kubectl<span class=w> </span>rollout<span class=w> </span>status<span class=w> </span>deployment/myapp-deployment
</span><span id=__span-81-6><a id=__codelineno-81-6 name=__codelineno-81-6 href=#__codelineno-81-6></a>kubectl<span class=w> </span>rollout<span class=w> </span><span class=nb>history</span><span class=w> </span>deployment/myapp-deployment
</span><span id=__span-81-7><a id=__codelineno-81-7 name=__codelineno-81-7 href=#__codelineno-81-7></a>kubectl<span class=w> </span>rollout<span class=w> </span>undo<span class=w> </span>deployment/myapp-deployment
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/summarize_deployment_commands.png></p> </li> </ul> <h3 id=configure-applications>Configure Applications<a class=headerlink href=#configure-applications title="Permanent link">&para;</a></h3> <ul> <li>設定應用程式的 Command &amp; Arguments<ul> <li>container 不是用來託管作業系統（operating system）的，而是用來執行特定任務 or 進程（process），例如: 網頁伺服器、應用程式伺服器、資料庫伺服器...等<ul> <li>當任務完成後，container 會自動結束（亦即，containter 僅在其內部的 process 處於 active 狀態時，才會存在）</li> <li>預設情況下，Docker 在執行時，不會將 terminal 附加到 container 上 <img alt src=../../../assets/pics/k8s/container_use_cases.png></li> </ul> </li> </ul> </li> <li>如何指定不同的指令，來啟動 container 呢？<ul> <li>法 1 (臨時作法): 當 Docker 執行時，在 CLI 加上指定的執行選項 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-82-1><a id=__codelineno-82-1 name=__codelineno-82-1 href=#__codelineno-82-1></a>docker<span class=w> </span>run<span class=w> </span>ubuntu<span class=w> </span>sleep<span class=w> </span><span class=m>5</span>
</span></code></pre></div></li> <li>法 2 (永久作法): 可透過設定 Dockerfile 的 <code>ENTRYPOINT</code>、<code>CMD</code> 指令<ul> <li><code>ENTRYPOINT</code>: 定義 container 啟動時，一定要先執行的指令</li> <li><code>CMD</code>: 定義 container 啟動時，要執行的指令<ul> <li>Tips: 必須用陣列 <code>[ ]</code> 來表示，且其中的元素都必須用雙括弧 <code>" "</code> 來表示，陣列元素之間需用逗號 <code>,</code> 做分隔 <img alt src=../../../assets/pics/k8s/dockerfile_command_arguments_format.png> <img alt src=../../../assets/pics/k8s/dockerfile_from_cmd.png></li> </ul> </li> <li>建立 Dockerfile <div class="language-dockerfile highlight"><span class=filename>Docker</span><pre><span></span><code><span id=__span-83-1><a id=__codelineno-83-1 name=__codelineno-83-1 href=#__codelineno-83-1></a><span class=k>FROM</span><span class=w> </span><span class=s>ubuntu</span>
</span><span id=__span-83-2><a id=__codelineno-83-2 name=__codelineno-83-2 href=#__codelineno-83-2></a><span class=k>CMD</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;sleep&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;5&quot;</span><span class=p>]</span>
</span></code></pre></div></li> <li>建立 Docker image <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-84-1><a id=__codelineno-84-1 name=__codelineno-84-1 href=#__codelineno-84-1></a>docker<span class=w> </span>build<span class=w> </span>-t<span class=w> </span>ubuntu-sleeper<span class=w> </span>.
</span></code></pre></div></li> <li>執行 Docker container <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-85-1><a id=__codelineno-85-1 name=__codelineno-85-1 href=#__codelineno-85-1></a>docker<span class=w> </span>run<span class=w> </span>ubuntu-sleeper
</span></code></pre></div></li> </ul> </li> </ul> </li> <li> <p>Dockerfile <code>CMD</code> vs. <code>ENTRYPOINT</code> 的應用</p> <ul> <li>情況 1: 僅宣告 <code>CMD</code>。當 Docker 執行容器時，可透過 CLI 傳遞指令、參數，來覆寫 <code>CMD</code> 指令</li> <li>情況 2: 僅宣告 <code>ENTRYPOINT</code>。當 Docker 執行容器時，只要傳遞參數即可</li> <li> <p>情況 3: 僅宣告 <code>ENTRYPOINT</code>，但 Docker 執行容器時，未傳遞參數 =&gt; 會報錯（missing operand） <img alt src=../../../assets/pics/k8s/cmd_and_entrypoint_illustration1.png></p> </li> <li> <p>情況 4: 同時宣告 <code>ENTRYPOINT</code> 與 <code>CMD</code>。當 Docker 執行容器時，<code>CMD</code> 指令會作為參數，傳遞給 <code>ENTRYPOINT</code> 指令</p> </li> <li>情況 5: 同時宣告 <code>ENTRYPOINT</code> 與 <code>CMD</code>，且當 Docker 執行容器時，透過 CLI 傳遞參數，會覆寫原本的 <code>CMD</code> 指令</li> <li>情況 6: 同時宣告 <code>ENTRYPOINT</code> 與 <code>CMD</code>，且當 Docker 執行容器時，透過 CLI 傳遞參數，會覆寫原本的 <code>ENTRYPOINT</code> 指令 <img alt src=../../../assets/pics/k8s/cmd_and_entrypoint_illustration2.png></li> </ul> </li> <li> <p>Dockerfile vs. Kubernetes Pod YAML manifest 設定檔</p> <ul> <li>Dockerfile <div class="language-dockerfile highlight"><span class=filename>Docker</span><pre><span></span><code><span id=__span-86-1><a id=__codelineno-86-1 name=__codelineno-86-1 href=#__codelineno-86-1></a><span class=k>FROM</span><span class=w> </span><span class=s>ubuntu</span>
</span><span id=__span-86-2><a id=__codelineno-86-2 name=__codelineno-86-2 href=#__codelineno-86-2></a><span class=k>ENTRYPOINT</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;sleep&quot;</span><span class=p>]</span>
</span><span id=__span-86-3><a id=__codelineno-86-3 name=__codelineno-86-3 href=#__codelineno-86-3></a><span class=k>CMD</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;5&quot;</span><span class=p>]</span>
</span></code></pre></div></li> <li>K8s Pod 的 YAML manifest 設定檔 <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-87-1><a id=__codelineno-87-1 name=__codelineno-87-1 href=#__codelineno-87-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-87-2><a id=__codelineno-87-2 name=__codelineno-87-2 href=#__codelineno-87-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-87-3><a id=__codelineno-87-3 name=__codelineno-87-3 href=#__codelineno-87-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-87-4><a id=__codelineno-87-4 name=__codelineno-87-4 href=#__codelineno-87-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-sleeper-pod</span>
</span><span id=__span-87-5><a id=__codelineno-87-5 name=__codelineno-87-5 href=#__codelineno-87-5></a>
</span><span id=__span-87-6><a id=__codelineno-87-6 name=__codelineno-87-6 href=#__codelineno-87-6></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-87-7><a id=__codelineno-87-7 name=__codelineno-87-7 href=#__codelineno-87-7></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-87-8><a id=__codelineno-87-8 name=__codelineno-87-8 href=#__codelineno-87-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-sleeper</span>
</span><span id=__span-87-9><a id=__codelineno-87-9 name=__codelineno-87-9 href=#__codelineno-87-9></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-sleeper</span>
</span><span id=__span-87-10><a id=__codelineno-87-10 name=__codelineno-87-10 href=#__codelineno-87-10></a><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;sleep2.0&quot;</span><span class="p p-Indicator">]</span>
</span><span id=__span-87-11><a id=__codelineno-87-11 name=__codelineno-87-11 href=#__codelineno-87-11></a><span class=w>        </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;10&quot;</span><span class="p p-Indicator">]</span>
</span></code></pre></div></li> <li><strong>注意! Dockerfile 中的 <code>ENTRYPOINT</code> 指令，會對應到 K8s Pod YAML manifest 設定檔中的 <code>command</code> 欄位; 而 <code>CMD</code> 指令，則會對應到 <code>args</code> 欄位</strong> <img alt src=../../../assets/pics/k8s/dockerfile_and_k8s_pod_yaml_command_args.png> <img alt src=../../../assets/pics/k8s/dockerfile_and_k8s_pod_yaml_command_args_comparison.png></li> </ul> </li> <li> <p>設定環境變數</p> <ul> <li>法 1: 運用單純的 key-value 鍵值對，設定環境變數</li> <li>法 2: 運用 K8s ConfigMap，設定環境變數。需用陣列 <code>[ ]</code> 表示，以及使用 <code>valueFrom.configMapKeyRef</code> 來給定 ConfigMap</li> <li>法 3: 運用 K8s Secrets，設定環境變數。需用陣列 <code>[ ]</code> 表示，以及使用 <code>valueFrom.secretKeyRef</code> 來給定 Secrets <img alt src=../../../assets/pics/k8s/three_ways_set_env_variables.png></li> </ul> </li> </ul> <h4 id=configmap>ConfigMap<a class=headerlink href=#configmap title="Permanent link">&para;</a></h4> <ul> <li>用途: 儲存應用程式的設定資料</li> <li> <p>建立 ConfigMap</p> <ul> <li> <p>命令式 (Imperative): <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-88-1><a id=__codelineno-88-1 name=__codelineno-88-1 href=#__codelineno-88-1></a><span class=c1># 在 CLI 上，直接給定 key-value 對，來建立 ConfigMap</span>
</span><span id=__span-88-2><a id=__codelineno-88-2 name=__codelineno-88-2 href=#__codelineno-88-2></a>kubectl<span class=w> </span>create<span class=w> </span>configmap<span class=w> </span>app-config<span class=w> </span>--from-literal<span class=o>=</span><span class=nv>APP_COLOR</span><span class=o>=</span>blue<span class=w> </span>--from-literal<span class=o>=</span><span class=nv>APP_MODE</span><span class=o>=</span>prod
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-89-1><a id=__codelineno-89-1 name=__codelineno-89-1 href=#__codelineno-89-1></a><span class=c1># 透過檔案來建立 ConfigMap</span>
</span><span id=__span-89-2><a id=__codelineno-89-2 name=__codelineno-89-2 href=#__codelineno-89-2></a>kubectl<span class=w> </span>create<span class=w> </span>configmap<span class=w> </span>app-config<span class=w> </span>--from-file<span class=o>=</span>app_config.properties
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/create_configmap_imperative.png></p> </li> <li> <p>宣告式 (Declarative): <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-90-1><a id=__codelineno-90-1 name=__codelineno-90-1 href=#__codelineno-90-1></a><span class=c1># configmap-definition.yaml</span>
</span><span id=__span-90-2><a id=__codelineno-90-2 name=__codelineno-90-2 href=#__codelineno-90-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-90-3><a id=__codelineno-90-3 name=__codelineno-90-3 href=#__codelineno-90-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
</span><span id=__span-90-4><a id=__codelineno-90-4 name=__codelineno-90-4 href=#__codelineno-90-4></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
</span><span id=__span-90-5><a id=__codelineno-90-5 name=__codelineno-90-5 href=#__codelineno-90-5></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">app-config</span>
</span><span id=__span-90-6><a id=__codelineno-90-6 name=__codelineno-90-6 href=#__codelineno-90-6></a><span class="w w-Error">    </span><span class=nt>data</span><span class=p>:</span>
</span><span id=__span-90-7><a id=__codelineno-90-7 name=__codelineno-90-7 href=#__codelineno-90-7></a><span class=w>        </span><span class=nt>APP_COLOR</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">blue</span>
</span><span id=__span-90-8><a id=__codelineno-90-8 name=__codelineno-90-8 href=#__codelineno-90-8></a><span class=w>        </span><span class=nt>APP_MODE</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">prod</span>
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-91-1><a id=__codelineno-91-1 name=__codelineno-91-1 href=#__codelineno-91-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>configmap-definition.yaml
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/create_configmap_declarative.png> <img alt src=../../../assets/pics/k8s/create_configmap_in_real_world.png></p> </li> </ul> </li> <li> <p>注入 ConfigMap 到 Pod 中</p> <ul> <li> <p><code>envFrom.configMapRef</code>: 適用於需要將所有 ConfigMap 的 key-value 對，都作為環境變數的情況 <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-92-1><a id=__codelineno-92-1 name=__codelineno-92-1 href=#__codelineno-92-1></a><span class=c1># pod-definition.yaml</span>
</span><span id=__span-92-2><a id=__codelineno-92-2 name=__codelineno-92-2 href=#__codelineno-92-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-92-3><a id=__codelineno-92-3 name=__codelineno-92-3 href=#__codelineno-92-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-92-4><a id=__codelineno-92-4 name=__codelineno-92-4 href=#__codelineno-92-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-92-5><a id=__codelineno-92-5 name=__codelineno-92-5 href=#__codelineno-92-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp-color</span>
</span><span id=__span-92-6><a id=__codelineno-92-6 name=__codelineno-92-6 href=#__codelineno-92-6></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-92-7><a id=__codelineno-92-7 name=__codelineno-92-7 href=#__codelineno-92-7></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-92-8><a id=__codelineno-92-8 name=__codelineno-92-8 href=#__codelineno-92-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp-color</span>
</span><span id=__span-92-9><a id=__codelineno-92-9 name=__codelineno-92-9 href=#__codelineno-92-9></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp-color</span>
</span><span id=__span-92-10><a id=__codelineno-92-10 name=__codelineno-92-10 href=#__codelineno-92-10></a><span class=w>        </span><span class=nt>ports</span><span class=p>:</span>
</span><span id=__span-92-11><a id=__codelineno-92-11 name=__codelineno-92-11 href=#__codelineno-92-11></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span><span id=__span-92-12><a id=__codelineno-92-12 name=__codelineno-92-12 href=#__codelineno-92-12></a>
</span><span id=__span-92-13><a id=__codelineno-92-13 name=__codelineno-92-13 href=#__codelineno-92-13></a><span class=w>        </span><span class=c1># 注入 ConfigMap 到 Pod 中 (`envFrom` 採用陣列表示)</span>
</span><span id=__span-92-14><a id=__codelineno-92-14 name=__codelineno-92-14 href=#__codelineno-92-14></a><span class=w>        </span><span class=nt>envFrom</span><span class=p>:</span>
</span><span id=__span-92-15><a id=__codelineno-92-15 name=__codelineno-92-15 href=#__codelineno-92-15></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>configMapRef</span><span class=p>:</span>
</span><span id=__span-92-16><a id=__codelineno-92-16 name=__codelineno-92-16 href=#__codelineno-92-16></a><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">app-config</span>
</span></code></pre></div></p> <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-93-1><a id=__codelineno-93-1 name=__codelineno-93-1 href=#__codelineno-93-1></a><span class=c1># configmap-definition.yaml</span>
</span><span id=__span-93-2><a id=__codelineno-93-2 name=__codelineno-93-2 href=#__codelineno-93-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-93-3><a id=__codelineno-93-3 name=__codelineno-93-3 href=#__codelineno-93-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
</span><span id=__span-93-4><a id=__codelineno-93-4 name=__codelineno-93-4 href=#__codelineno-93-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-93-5><a id=__codelineno-93-5 name=__codelineno-93-5 href=#__codelineno-93-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">app-config</span>
</span><span id=__span-93-6><a id=__codelineno-93-6 name=__codelineno-93-6 href=#__codelineno-93-6></a><span class=nt>data</span><span class=p>:</span>
</span><span id=__span-93-7><a id=__codelineno-93-7 name=__codelineno-93-7 href=#__codelineno-93-7></a><span class=w>    </span><span class=nt>APP_COLOR</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">blue</span>
</span><span id=__span-93-8><a id=__codelineno-93-8 name=__codelineno-93-8 href=#__codelineno-93-8></a><span class=w>    </span><span class=nt>APP_MODE</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">prod</span>
</span></code></pre></div> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-94-1><a id=__codelineno-94-1 name=__codelineno-94-1 href=#__codelineno-94-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>pod-definition.yaml
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/configmap_in_pod_envfrom.png></p> </li> <li> <p>其它方式</p> <ul> <li><code>env.valueFrom.configMapKeyRef</code>: 適用於只需要特定 ConfigMap 的 key-value 對，作為環境變數的情況</li> <li><code>volumes.configMap</code>: 適用於應用程式，需要 volume 形式的設定資料，作為環境變數的情況 <img alt src=../../../assets/pics/k8s/configmap_in_pod_other_ways.png></li> </ul> </li> </ul> </li> <li> <p>查詢目前有哪些 ConfigMaps <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-95-1><a id=__codelineno-95-1 name=__codelineno-95-1 href=#__codelineno-95-1></a>kubectl<span class=w> </span>get<span class=w> </span>configmaps<span class=w> </span>
</span><span id=__span-95-2><a id=__codelineno-95-2 name=__codelineno-95-2 href=#__codelineno-95-2></a><span class=c1># (or)</span>
</span><span id=__span-95-3><a id=__codelineno-95-3 name=__codelineno-95-3 href=#__codelineno-95-3></a><span class=c1># kubectl get cm</span>
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/view_configmap.png></p> </li> <li> <p>詳細檢視指定的 ConfigMap <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-96-1><a id=__codelineno-96-1 name=__codelineno-96-1 href=#__codelineno-96-1></a>kubectl<span class=w> </span>describe<span class=w> </span>configmap<span class=w> </span>app-config<span class=w> </span>-o<span class=o>=</span>yaml
</span></code></pre></div></p> </li> </ul> <h4 id=secrets>Secrets<a class=headerlink href=#secrets title="Permanent link">&para;</a></h4> <ul> <li>用途: 儲存系統的機敏資料</li> <li> <p>注意! <strong>K8s 的 Secrets 只是用 base64 編碼 (encode) 過的資料而已，這並不算是真正的加密 (encrypt)</strong>。任何人只要知道 base64 編碼的解碼 (decode) 方法，就能解碼 Secrets</p> <ul> <li> <p>安全性概念: 儘管 <strong>K8s 官方文件將 Secrets 視為存儲敏感數據的 "更安全選擇 (safer option)"</strong>，這主要是因為它們比純文字 (plain text) 較安全，可以降低意外洩漏密碼、其他機敏資料的風險。<strong>真正的安全性來自於如何使用和管理這些 Secrets，而不是 Secrets 本身的安全性</strong> <img alt src=../../../assets/pics/k8s/k8s_docs_secrets_unencrypted.png></p> </li> <li> <p>可參考 <a href=https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/ >K8s 官方文件: Encrypting Confidential Data at Rest</a></p> </li> <li>建立 Secret</li> <li> <p>命令式 (Imperative): <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-97-1><a id=__codelineno-97-1 name=__codelineno-97-1 href=#__codelineno-97-1></a><span class=c1># 在 CLI 上，直接給定 key-value 對，來建立 Secret</span>
</span><span id=__span-97-2><a id=__codelineno-97-2 name=__codelineno-97-2 href=#__codelineno-97-2></a>kubectl<span class=w> </span>create<span class=w> </span>secret<span class=w> </span>generic<span class=w> </span>app-secret<span class=w> </span>--from-literal<span class=o>=</span><span class=nv>DB_Host</span><span class=o>=</span>mysql<span class=w> </span>--from-literal<span class=o>=</span><span class=nv>DB_User</span><span class=o>=</span>root<span class=w> </span>--from-literal<span class=o>=</span><span class=nv>DB_Password</span><span class=o>=</span>paswrd
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-98-1><a id=__codelineno-98-1 name=__codelineno-98-1 href=#__codelineno-98-1></a><span class=c1># 透過檔案來建立 Secret</span>
</span><span id=__span-98-2><a id=__codelineno-98-2 name=__codelineno-98-2 href=#__codelineno-98-2></a>kubectl<span class=w> </span>create<span class=w> </span>secret<span class=w> </span>generic<span class=w> </span>app-secret<span class=w> </span>--from-file<span class=o>=</span>app_secret.properties
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/create_secret_imperative.png></p> </li> <li> <p>宣告式 (Declarative):</p> <ul> <li> <p>將原始機敏資料，運用 base64 編碼 (非加密) <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-99-1><a id=__codelineno-99-1 name=__codelineno-99-1 href=#__codelineno-99-1></a><span class=nb>echo</span><span class=w> </span>-n<span class=w> </span><span class=s2>&quot;mysql&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>base64
</span><span id=__span-99-2><a id=__codelineno-99-2 name=__codelineno-99-2 href=#__codelineno-99-2></a><span class=nb>echo</span><span class=w> </span>-n<span class=w> </span><span class=s2>&quot;root&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>base64
</span><span id=__span-99-3><a id=__codelineno-99-3 name=__codelineno-99-3 href=#__codelineno-99-3></a><span class=nb>echo</span><span class=w> </span>-n<span class=w> </span><span class=s2>&quot;paswrd&quot;</span><span class=p>|</span><span class=w> </span>base64
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/base64_encode_secret.png></p> </li> <li> <p>建立 Secret 的 YAML manifest 設定檔 <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-100-1><a id=__codelineno-100-1 name=__codelineno-100-1 href=#__codelineno-100-1></a><span class=c1># secret-data.yaml</span>
</span><span id=__span-100-2><a id=__codelineno-100-2 name=__codelineno-100-2 href=#__codelineno-100-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-100-3><a id=__codelineno-100-3 name=__codelineno-100-3 href=#__codelineno-100-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
</span><span id=__span-100-4><a id=__codelineno-100-4 name=__codelineno-100-4 href=#__codelineno-100-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-100-5><a id=__codelineno-100-5 name=__codelineno-100-5 href=#__codelineno-100-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">app-secret</span>
</span><span id=__span-100-6><a id=__codelineno-100-6 name=__codelineno-100-6 href=#__codelineno-100-6></a><span class=nt>data</span><span class=p>:</span>
</span><span id=__span-100-7><a id=__codelineno-100-7 name=__codelineno-100-7 href=#__codelineno-100-7></a><span class=w>    </span><span class=nt>DB_Host</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">bX1zcWw=</span>
</span><span id=__span-100-8><a id=__codelineno-100-8 name=__codelineno-100-8 href=#__codelineno-100-8></a><span class=w>    </span><span class=nt>DB_User</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cm9vdA==</span>
</span><span id=__span-100-9><a id=__codelineno-100-9 name=__codelineno-100-9 href=#__codelineno-100-9></a><span class=w>    </span><span class=nt>DB_Password</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cGFzd3Jk</span>
</span></code></pre></div></p> </li> <li>建立 Secret <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-101-1><a id=__codelineno-101-1 name=__codelineno-101-1 href=#__codelineno-101-1></a>$<span class=w> </span>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>secret-data.yaml
</span></code></pre></div></li> </ul> <p><img alt src=../../../assets/pics/k8s/create_secret_declarative.png></p> </li> </ul> </li> <li> <p>注入 Secret 到 Pod 中</p> <ul> <li> <p><code>envFrom.secretRef</code>: 適用於需要使用所有 Secret 的 key-value 對 <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-102-1><a id=__codelineno-102-1 name=__codelineno-102-1 href=#__codelineno-102-1></a><span class=c1># secret-definition.yaml</span>
</span><span id=__span-102-2><a id=__codelineno-102-2 name=__codelineno-102-2 href=#__codelineno-102-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-102-3><a id=__codelineno-102-3 name=__codelineno-102-3 href=#__codelineno-102-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
</span><span id=__span-102-4><a id=__codelineno-102-4 name=__codelineno-102-4 href=#__codelineno-102-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-102-5><a id=__codelineno-102-5 name=__codelineno-102-5 href=#__codelineno-102-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">app-secret</span>
</span><span id=__span-102-6><a id=__codelineno-102-6 name=__codelineno-102-6 href=#__codelineno-102-6></a><span class=nt>data</span><span class=p>:</span>
</span><span id=__span-102-7><a id=__codelineno-102-7 name=__codelineno-102-7 href=#__codelineno-102-7></a><span class=w>    </span><span class=nt>DB_Host</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">bX1zcWw=</span>
</span><span id=__span-102-8><a id=__codelineno-102-8 name=__codelineno-102-8 href=#__codelineno-102-8></a><span class=w>    </span><span class=nt>DB_User</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cm9vdA==</span>
</span><span id=__span-102-9><a id=__codelineno-102-9 name=__codelineno-102-9 href=#__codelineno-102-9></a><span class=w>    </span><span class=nt>DB_Password</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cGFzd3Jk</span>
</span></code></pre></div></p> <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-103-1><a id=__codelineno-103-1 name=__codelineno-103-1 href=#__codelineno-103-1></a><span class=c1># pod-definition.yaml</span>
</span><span id=__span-103-2><a id=__codelineno-103-2 name=__codelineno-103-2 href=#__codelineno-103-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-103-3><a id=__codelineno-103-3 name=__codelineno-103-3 href=#__codelineno-103-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-103-4><a id=__codelineno-103-4 name=__codelineno-103-4 href=#__codelineno-103-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-103-5><a id=__codelineno-103-5 name=__codelineno-103-5 href=#__codelineno-103-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp-color</span>
</span><span id=__span-103-6><a id=__codelineno-103-6 name=__codelineno-103-6 href=#__codelineno-103-6></a>
</span><span id=__span-103-7><a id=__codelineno-103-7 name=__codelineno-103-7 href=#__codelineno-103-7></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-103-8><a id=__codelineno-103-8 name=__codelineno-103-8 href=#__codelineno-103-8></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-103-9><a id=__codelineno-103-9 name=__codelineno-103-9 href=#__codelineno-103-9></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp-color</span>
</span><span id=__span-103-10><a id=__codelineno-103-10 name=__codelineno-103-10 href=#__codelineno-103-10></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp-color</span>
</span><span id=__span-103-11><a id=__codelineno-103-11 name=__codelineno-103-11 href=#__codelineno-103-11></a><span class=w>        </span><span class=nt>ports</span><span class=p>:</span>
</span><span id=__span-103-12><a id=__codelineno-103-12 name=__codelineno-103-12 href=#__codelineno-103-12></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span><span id=__span-103-13><a id=__codelineno-103-13 name=__codelineno-103-13 href=#__codelineno-103-13></a>
</span><span id=__span-103-14><a id=__codelineno-103-14 name=__codelineno-103-14 href=#__codelineno-103-14></a><span class=w>        </span><span class=c1># 注入 Secret 到 Pod 中 (`envFrom` 採用陣列表示)</span>
</span><span id=__span-103-15><a id=__codelineno-103-15 name=__codelineno-103-15 href=#__codelineno-103-15></a><span class=w>        </span><span class=nt>envFrom</span><span class=p>:</span>
</span><span id=__span-103-16><a id=__codelineno-103-16 name=__codelineno-103-16 href=#__codelineno-103-16></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>secretRef</span><span class=p>:</span>
</span><span id=__span-103-17><a id=__codelineno-103-17 name=__codelineno-103-17 href=#__codelineno-103-17></a><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">app-secret</span>
</span></code></pre></div> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-104-1><a id=__codelineno-104-1 name=__codelineno-104-1 href=#__codelineno-104-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>pod-definition.yaml
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/secret_in_pod_envfrom.png></p> </li> <li> <p>其它方式</p> <ul> <li><code>env.valueFrom.secretKeyRef</code>: 適用於只需要使用特定 Secret 的 key-value 對</li> <li><code>volumes.secret</code>: 適用於應用程式，需要使用 volume 形式的設定資料<ul> <li>Secret 中的每個屬性，都會被建立為一個檔案，且每個檔案的名稱就是 Secret 的鍵 (key)，檔案的內容就是 Secret 的值 (value) <img alt src=../../../assets/pics/k8s/secret_in_pod_volumes.png></li> </ul> </li> </ul> <p><img alt src=../../../assets/pics/k8s/secret_in_pod_other_ways.png></p> </li> </ul> </li> <li> <p>base64 解碼 (decode) <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-105-1><a id=__codelineno-105-1 name=__codelineno-105-1 href=#__codelineno-105-1></a><span class=nb>echo</span><span class=w> </span>-n<span class=w> </span><span class=s2>&quot;bX1zcWw=&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>base64<span class=w> </span>--decode
</span><span id=__span-105-2><a id=__codelineno-105-2 name=__codelineno-105-2 href=#__codelineno-105-2></a><span class=nb>echo</span><span class=w> </span>-n<span class=w> </span><span class=s2>&quot;cm9vdA==&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>base64<span class=w> </span>--decode
</span><span id=__span-105-3><a id=__codelineno-105-3 name=__codelineno-105-3 href=#__codelineno-105-3></a><span class=nb>echo</span><span class=w> </span>-n<span class=w> </span><span class=s2>&quot;cGFzd3Jk&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>base64<span class=w> </span>--decode
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/base64_decode_secret.png></p> </li> <li> <p>查詢目前有哪些 Secrets <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-106-1><a id=__codelineno-106-1 name=__codelineno-106-1 href=#__codelineno-106-1></a>kubectl<span class=w> </span>get<span class=w> </span>secrets
</span></code></pre></div></p> </li> <li> <p>詳細檢視指定的 Secret <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-107-1><a id=__codelineno-107-1 name=__codelineno-107-1 href=#__codelineno-107-1></a>kubectl<span class=w> </span>describe<span class=w> </span>secret<span class=w> </span>app-secret<span class=w> </span>-o<span class=o>=</span>yaml
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/view_secret.png></p> </li> <li> <p>Secret 的最佳實踐 <img alt src=../../../assets/pics/k8s/secrets_best_practice.png></p> </li> </ul> <h3 id=scale-applications>Scale Applications<a class=headerlink href=#scale-applications title="Permanent link">&para;</a></h3> <h4 id=multi-container-pod>Multi-Container Pod<a class=headerlink href=#multi-container-pod title="Permanent link">&para;</a></h4> <ul> <li> <p>用途: 有時，我們可能會需要兩種服務一起運作，例如: 網頁伺服器 + log 代理</p> <ul> <li>解決方式: 我們可以在一個 Pod 中包含多個 containers，這樣 containers 之間就能視為同一個本地端 (local)，亦能共享同一個 Networking, Storage 等</li> </ul> <p><img alt src=../../../assets/pics/k8s/multi_containers_in_pod_sidecar.png> <img alt src=../../../assets/pics/k8s/multi_containers_in_pod_share_network_and_storage.png></p> </li> <li> <p>建立 Multi-Container Pod <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-108-1><a id=__codelineno-108-1 name=__codelineno-108-1 href=#__codelineno-108-1></a><span class=c1># pod-definition.yaml</span>
</span><span id=__span-108-2><a id=__codelineno-108-2 name=__codelineno-108-2 href=#__codelineno-108-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-108-3><a id=__codelineno-108-3 name=__codelineno-108-3 href=#__codelineno-108-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-108-4><a id=__codelineno-108-4 name=__codelineno-108-4 href=#__codelineno-108-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-108-5><a id=__codelineno-108-5 name=__codelineno-108-5 href=#__codelineno-108-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp</span>
</span><span id=__span-108-6><a id=__codelineno-108-6 name=__codelineno-108-6 href=#__codelineno-108-6></a><span class=w>    </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-108-7><a id=__codelineno-108-7 name=__codelineno-108-7 href=#__codelineno-108-7></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp</span>
</span><span id=__span-108-8><a id=__codelineno-108-8 name=__codelineno-108-8 href=#__codelineno-108-8></a>
</span><span id=__span-108-9><a id=__codelineno-108-9 name=__codelineno-108-9 href=#__codelineno-108-9></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-108-10><a id=__codelineno-108-10 name=__codelineno-108-10 href=#__codelineno-108-10></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-108-11><a id=__codelineno-108-11 name=__codelineno-108-11 href=#__codelineno-108-11></a><span class=w>    </span><span class=c1># 第一個 container</span>
</span><span id=__span-108-12><a id=__codelineno-108-12 name=__codelineno-108-12 href=#__codelineno-108-12></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp</span>
</span><span id=__span-108-13><a id=__codelineno-108-13 name=__codelineno-108-13 href=#__codelineno-108-13></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">simple-webapp</span>
</span><span id=__span-108-14><a id=__codelineno-108-14 name=__codelineno-108-14 href=#__codelineno-108-14></a><span class=w>        </span><span class=nt>ports</span><span class=p>:</span>
</span><span id=__span-108-15><a id=__codelineno-108-15 name=__codelineno-108-15 href=#__codelineno-108-15></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>ContainerPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</span><span id=__span-108-16><a id=__codelineno-108-16 name=__codelineno-108-16 href=#__codelineno-108-16></a>
</span><span id=__span-108-17><a id=__codelineno-108-17 name=__codelineno-108-17 href=#__codelineno-108-17></a><span class=w>    </span><span class=c1># 第二個 container</span>
</span><span id=__span-108-18><a id=__codelineno-108-18 name=__codelineno-108-18 href=#__codelineno-108-18></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">log-agent</span>
</span><span id=__span-108-19><a id=__codelineno-108-19 name=__codelineno-108-19 href=#__codelineno-108-19></a><span class=w>        </span><span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">log-agent</span>
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/create_multi_containers_in_pod_yaml_array.png> <img alt src=../../../assets/pics/k8s/create_multi_containers_in_pod.png></p> </li> <li> <p>Multi-container Pods 的三大設計模式 (Design Patterns)</p> <ul> <li><strong>Sidecar (邊車模式)</strong>: 主要 container 負責應用程式的主要邏輯，而 <strong>sidecar container 負責支援性的工作</strong><ul> <li>e.g. Logging, Monitoring 等</li> </ul> </li> <li><strong>Adapter (適配器模式)</strong>: 主要 container 負責應用程式的主要邏輯，而 <strong>adapter container 負責轉換主要 container 的輸出</strong><ul> <li>e.g. 把資料從 JSON 轉換為 YAML 格式</li> </ul> </li> <li><strong>Ambassador (大使模式)</strong>: 主要 container 負責應用程式的主要邏輯，而 <strong>ambassador container 負責代理主要 container 的網路請求</strong><ul> <li>e.g. 代理服務 (Proxy)、負載均衡 (Load Balance)、安全認證 <img alt src=../../../assets/pics/k8s/multi_containers_in_pod_three_design_patterns.png></li> </ul> </li> </ul> </li> <li> <p>在 Kubernetes 中，多容器 Pod 中的每個容器都預期會在 Pod 的生命週期內保持運行。例如: 網頁伺服器 + log 代理 都會需要持續運行。若其中任何一個 container 失效，Pod 就會重新啟動</p> <ul> <li>在 Kubernetes 中，<strong>sidecar container</strong> 是<strong>在主要的 container 之前就會啟動，並持續運行</strong></li> </ul> </li> <li> <p>Init Container (初始化容器)</p> <ul> <li>特性:<ul> <li><strong>初始化容器總是會執行到成功為止</strong>，若執行失敗，kubelet 會重複執行初始化容器，直到執行成功為止</li> <li>每個初始化容器<strong>必須完成執行成功後，才能執行下一個初始化容器</strong></li> </ul> </li> </ul> <table> <thead> <tr> <th style="text-align: center;">Feature</th> <th style="text-align: center;">Init Containers (初始化容器)</th> <th style="text-align: center;">Sidecar Containers (邊車容器)</th> </tr> </thead> <tbody> <tr> <td style="text-align: center;">運行時間</td> <td style="text-align: center;">主應用容器啟動前完成</td> <td style="text-align: center;">與主應用容器同時運行</td> </tr> <tr> <td style="text-align: center;">執行順序</td> <td style="text-align: center;">順序完成，主容器等所有 init 容器完成後才啟動</td> <td style="text-align: center;">與主容器並行執行</td> </tr> <tr> <td style="text-align: center;">支援 Probe 類型</td> <td style="text-align: center;">不支援 <code>lifecycle</code>、<code>livenessProbe</code>、<code>readinessProbe</code>、<code>startupProbe</code></td> <td style="text-align: center;">支援 <code>lifecycle</code>、<code>livenessProbe</code>、<code>readinessProbe</code>、<code>startupProbe</code></td> </tr> <tr> <td style="text-align: center;">資源共享</td> <td style="text-align: center;">共享資源（CPU、記憶體、網路）但不直接互動，可使用 shared volume 來進行資料交換</td> <td style="text-align: center;">共享資源（CPU、記憶體、網路）並可直接互動</td> </tr> </tbody> </table> <ul> <li> <p>範例: <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-109-1><a id=__codelineno-109-1 name=__codelineno-109-1 href=#__codelineno-109-1></a><span class=c1># init-container-pod-definition.yaml</span>
</span><span id=__span-109-2><a id=__codelineno-109-2 name=__codelineno-109-2 href=#__codelineno-109-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-109-3><a id=__codelineno-109-3 name=__codelineno-109-3 href=#__codelineno-109-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-109-4><a id=__codelineno-109-4 name=__codelineno-109-4 href=#__codelineno-109-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-109-5><a id=__codelineno-109-5 name=__codelineno-109-5 href=#__codelineno-109-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
</span><span id=__span-109-6><a id=__codelineno-109-6 name=__codelineno-109-6 href=#__codelineno-109-6></a><span class=w>    </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-109-7><a id=__codelineno-109-7 name=__codelineno-109-7 href=#__codelineno-109-7></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
</span><span id=__span-109-8><a id=__codelineno-109-8 name=__codelineno-109-8 href=#__codelineno-109-8></a>
</span><span id=__span-109-9><a id=__codelineno-109-9 name=__codelineno-109-9 href=#__codelineno-109-9></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-109-10><a id=__codelineno-109-10 name=__codelineno-109-10 href=#__codelineno-109-10></a><span class=w>    </span><span class=c1># 設定初始化容器</span>
</span><span id=__span-109-11><a id=__codelineno-109-11 name=__codelineno-109-11 href=#__codelineno-109-11></a><span class=w>    </span><span class=nt>initContainers</span><span class=p>:</span>
</span><span id=__span-109-12><a id=__codelineno-109-12 name=__codelineno-109-12 href=#__codelineno-109-12></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">init-myservice</span>
</span><span id=__span-109-13><a id=__codelineno-109-13 name=__codelineno-109-13 href=#__codelineno-109-13></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
</span><span id=__span-109-14><a id=__codelineno-109-14 name=__codelineno-109-14 href=#__codelineno-109-14></a><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&#39;sh&#39;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&#39;-c&#39;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&#39;git</span><span class=nv> </span><span class=s>clone</span><span class=nv> </span><span class=s>&lt;some-repository-that-will-be-used-by-application&gt;</span><span class=nv> </span><span class=s>;</span><span class=nv> </span><span class=s>done;&#39;</span><span class="p p-Indicator">]</span>
</span><span id=__span-109-15><a id=__codelineno-109-15 name=__codelineno-109-15 href=#__codelineno-109-15></a>
</span><span id=__span-109-16><a id=__codelineno-109-16 name=__codelineno-109-16 href=#__codelineno-109-16></a><span class=w>    </span><span class=c1># 設定主要容器</span>
</span><span id=__span-109-17><a id=__codelineno-109-17 name=__codelineno-109-17 href=#__codelineno-109-17></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-109-18><a id=__codelineno-109-18 name=__codelineno-109-18 href=#__codelineno-109-18></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-container</span>
</span><span id=__span-109-19><a id=__codelineno-109-19 name=__codelineno-109-19 href=#__codelineno-109-19></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">busybox:1.28</span>
</span><span id=__span-109-20><a id=__codelineno-109-20 name=__codelineno-109-20 href=#__codelineno-109-20></a><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&#39;sh&#39;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&#39;-c&#39;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&#39;echo</span><span class=nv> </span><span class=s>The</span><span class=nv> </span><span class=s>app</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>running!</span><span class=nv> </span><span class=s>&amp;&amp;</span><span class=nv> </span><span class=s>sleep</span><span class=nv> </span><span class=s>3600&#39;</span><span class="p p-Indicator">]</span><span class=w> </span>
</span></code></pre></div></p> <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-110-1><a id=__codelineno-110-1 name=__codelineno-110-1 href=#__codelineno-110-1></a><span class=c1># multi-init-container-pod-definition.yaml</span>
</span><span id=__span-110-2><a id=__codelineno-110-2 name=__codelineno-110-2 href=#__codelineno-110-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-110-3><a id=__codelineno-110-3 name=__codelineno-110-3 href=#__codelineno-110-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-110-4><a id=__codelineno-110-4 name=__codelineno-110-4 href=#__codelineno-110-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-110-5><a id=__codelineno-110-5 name=__codelineno-110-5 href=#__codelineno-110-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
</span><span id=__span-110-6><a id=__codelineno-110-6 name=__codelineno-110-6 href=#__codelineno-110-6></a><span class=w>    </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-110-7><a id=__codelineno-110-7 name=__codelineno-110-7 href=#__codelineno-110-7></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
</span><span id=__span-110-8><a id=__codelineno-110-8 name=__codelineno-110-8 href=#__codelineno-110-8></a>
</span><span id=__span-110-9><a id=__codelineno-110-9 name=__codelineno-110-9 href=#__codelineno-110-9></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-110-10><a id=__codelineno-110-10 name=__codelineno-110-10 href=#__codelineno-110-10></a><span class=w>    </span><span class=c1># 設定初始化容器</span>
</span><span id=__span-110-11><a id=__codelineno-110-11 name=__codelineno-110-11 href=#__codelineno-110-11></a><span class=w>    </span><span class=nt>initContainers</span><span class=p>:</span>
</span><span id=__span-110-12><a id=__codelineno-110-12 name=__codelineno-110-12 href=#__codelineno-110-12></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">init-myservice</span>
</span><span id=__span-110-13><a id=__codelineno-110-13 name=__codelineno-110-13 href=#__codelineno-110-13></a><span class=w>            </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">busybox:1.28</span>
</span><span id=__span-110-14><a id=__codelineno-110-14 name=__codelineno-110-14 href=#__codelineno-110-14></a><span class=w>            </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&#39;sh&#39;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&#39;-c&#39;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&#39;until</span><span class=nv> </span><span class=s>nslookup</span><span class=nv> </span><span class=s>myservice;</span><span class=nv> </span><span class=s>do</span><span class=nv> </span><span class=s>echo</span><span class=nv> </span><span class=s>waiting</span><span class=nv> </span><span class=s>for</span><span class=nv> </span><span class=s>myservice;</span><span class=nv> </span><span class=s>sleep</span><span class=nv> </span><span class=s>2;</span><span class=nv> </span><span class=s>done;&#39;</span><span class="p p-Indicator">]</span>
</span><span id=__span-110-15><a id=__codelineno-110-15 name=__codelineno-110-15 href=#__codelineno-110-15></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">init-mydb</span>
</span><span id=__span-110-16><a id=__codelineno-110-16 name=__codelineno-110-16 href=#__codelineno-110-16></a><span class=w>            </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">busybox:1.28</span>
</span><span id=__span-110-17><a id=__codelineno-110-17 name=__codelineno-110-17 href=#__codelineno-110-17></a><span class=w>            </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&#39;sh&#39;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&#39;-c&#39;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&#39;until</span><span class=nv> </span><span class=s>nslookup</span><span class=nv> </span><span class=s>mydb;</span><span class=nv> </span><span class=s>do</span><span class=nv> </span><span class=s>echo</span><span class=nv> </span><span class=s>waiting</span><span class=nv> </span><span class=s>for</span><span class=nv> </span><span class=s>mydb;</span><span class=nv> </span><span class=s>sleep</span><span class=nv> </span><span class=s>2;</span><span class=nv> </span><span class=s>done;&#39;</span><span class="p p-Indicator">]</span>
</span><span id=__span-110-18><a id=__codelineno-110-18 name=__codelineno-110-18 href=#__codelineno-110-18></a>
</span><span id=__span-110-19><a id=__codelineno-110-19 name=__codelineno-110-19 href=#__codelineno-110-19></a><span class=w>    </span><span class=c1># 設定主要容器</span>
</span><span id=__span-110-20><a id=__codelineno-110-20 name=__codelineno-110-20 href=#__codelineno-110-20></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-110-21><a id=__codelineno-110-21 name=__codelineno-110-21 href=#__codelineno-110-21></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-container</span>
</span><span id=__span-110-22><a id=__codelineno-110-22 name=__codelineno-110-22 href=#__codelineno-110-22></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">busybox:1.28</span>
</span><span id=__span-110-23><a id=__codelineno-110-23 name=__codelineno-110-23 href=#__codelineno-110-23></a><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&#39;sh&#39;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&#39;-c&#39;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&#39;echo</span><span class=nv> </span><span class=s>The</span><span class=nv> </span><span class=s>app</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>running!</span><span class=nv> </span><span class=s>&amp;&amp;</span><span class=nv> </span><span class=s>sleep</span><span class=nv> </span><span class=s>3600&#39;</span><span class="p p-Indicator">]</span>
</span></code></pre></div> </li> </ul> </li> </ul> <h3 id=self-healing-application>Self-Healing Application<a class=headerlink href=#self-healing-application title="Permanent link">&para;</a></h3> <ul> <li>Kubernetes 透過 ReplicaSets 和 Replication Controllers 支援自我修復的應用程式 (Self-Healing Application)<ul> <li>Replication Controller 能確保當 POD 內的應用程式失效時，能夠自動重新建立該 POD，以確保應用程式的副本數量 (replicas) 始終保持在所需的數量</li> </ul> </li> <li>Kubernetes 亦提供額外的方法，來檢查在 POD 內運行的應用程式 container 的健康狀況，並通過 <strong>Liveness Probes</strong> 和 <strong>Readiness Probes</strong> 來確保應用程式的正常運作<ul> <li><strong>Liveness Probes</strong>: <strong>用於檢查應用程式是否正在運行</strong>，並在應用程式失效時，自動重新啟動該應用程式</li> <li><strong>Readiness Probes</strong>: <strong>用於檢查應用程式是否已經準備好接收流量</strong>，並在應用程式尚未準備好接收流量時，將該應用程式從服務中移除 <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-111-1><a id=__codelineno-111-1 name=__codelineno-111-1 href=#__codelineno-111-1></a><span class=c1># pod-definition.yaml</span>
</span><span id=__span-111-2><a id=__codelineno-111-2 name=__codelineno-111-2 href=#__codelineno-111-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-111-3><a id=__codelineno-111-3 name=__codelineno-111-3 href=#__codelineno-111-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-111-4><a id=__codelineno-111-4 name=__codelineno-111-4 href=#__codelineno-111-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-111-5><a id=__codelineno-111-5 name=__codelineno-111-5 href=#__codelineno-111-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
</span><span id=__span-111-6><a id=__codelineno-111-6 name=__codelineno-111-6 href=#__codelineno-111-6></a><span class=w>    </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-111-7><a id=__codelineno-111-7 name=__codelineno-111-7 href=#__codelineno-111-7></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
</span><span id=__span-111-8><a id=__codelineno-111-8 name=__codelineno-111-8 href=#__codelineno-111-8></a>
</span><span id=__span-111-9><a id=__codelineno-111-9 name=__codelineno-111-9 href=#__codelineno-111-9></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-111-10><a id=__codelineno-111-10 name=__codelineno-111-10 href=#__codelineno-111-10></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-111-11><a id=__codelineno-111-11 name=__codelineno-111-11 href=#__codelineno-111-11></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myapp-container</span>
</span><span id=__span-111-12><a id=__codelineno-111-12 name=__codelineno-111-12 href=#__codelineno-111-12></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
</span><span id=__span-111-13><a id=__codelineno-111-13 name=__codelineno-111-13 href=#__codelineno-111-13></a><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&#39;sh&#39;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&#39;-c&#39;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&#39;echo</span><span class=nv> </span><span class=s>The</span><span class=nv> </span><span class=s>app</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>running!</span><span class=nv> </span><span class=s>&amp;&amp;</span><span class=nv> </span><span class=s>sleep</span><span class=nv> </span><span class=s>3600&#39;</span><span class="p p-Indicator">]</span>
</span><span id=__span-111-14><a id=__codelineno-111-14 name=__codelineno-111-14 href=#__codelineno-111-14></a>
</span><span id=__span-111-15><a id=__codelineno-111-15 name=__codelineno-111-15 href=#__codelineno-111-15></a><span class=w>        </span><span class=c1># 設定 livenessProbe: 用於檢查應用程式是否正在運行</span>
</span><span id=__span-111-16><a id=__codelineno-111-16 name=__codelineno-111-16 href=#__codelineno-111-16></a><span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span>
</span><span id=__span-111-17><a id=__codelineno-111-17 name=__codelineno-111-17 href=#__codelineno-111-17></a><span class=w>            </span><span class=nt>exec</span><span class=p>:</span>
</span><span id=__span-111-18><a id=__codelineno-111-18 name=__codelineno-111-18 href=#__codelineno-111-18></a><span class=w>                </span><span class=nt>command</span><span class=p>:</span>
</span><span id=__span-111-19><a id=__codelineno-111-19 name=__codelineno-111-19 href=#__codelineno-111-19></a><span class=w>                </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cat</span>
</span><span id=__span-111-20><a id=__codelineno-111-20 name=__codelineno-111-20 href=#__codelineno-111-20></a><span class=w>                </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/healthy</span>
</span><span id=__span-111-21><a id=__codelineno-111-21 name=__codelineno-111-21 href=#__codelineno-111-21></a><span class=w>            </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</span><span id=__span-111-22><a id=__codelineno-111-22 name=__codelineno-111-22 href=#__codelineno-111-22></a><span class=w>            </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</span><span id=__span-111-23><a id=__codelineno-111-23 name=__codelineno-111-23 href=#__codelineno-111-23></a>
</span><span id=__span-111-24><a id=__codelineno-111-24 name=__codelineno-111-24 href=#__codelineno-111-24></a><span class=w>        </span><span class=c1># 設定 readinessProbe: 用於檢查應用程式是否已經準備好接收流量</span>
</span><span id=__span-111-25><a id=__codelineno-111-25 name=__codelineno-111-25 href=#__codelineno-111-25></a><span class=w>        </span><span class=nt>readinessProbe</span><span class=p>:</span>
</span><span id=__span-111-26><a id=__codelineno-111-26 name=__codelineno-111-26 href=#__codelineno-111-26></a><span class=w>            </span><span class=nt>exec</span><span class=p>:</span>
</span><span id=__span-111-27><a id=__codelineno-111-27 name=__codelineno-111-27 href=#__codelineno-111-27></a><span class=w>                </span><span class=nt>command</span><span class=p>:</span>
</span><span id=__span-111-28><a id=__codelineno-111-28 name=__codelineno-111-28 href=#__codelineno-111-28></a><span class=w>                </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cat</span>
</span><span id=__span-111-29><a id=__codelineno-111-29 name=__codelineno-111-29 href=#__codelineno-111-29></a><span class=w>                </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/healthy</span>
</span><span id=__span-111-30><a id=__codelineno-111-30 name=__codelineno-111-30 href=#__codelineno-111-30></a><span class=w>            </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</span><span id=__span-111-31><a id=__codelineno-111-31 name=__codelineno-111-31 href=#__codelineno-111-31></a><span class=w>            </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</span></code></pre></div></li> </ul> </li> </ul> <h2 id=cluster-maintenance>Cluster Maintenance<a class=headerlink href=#cluster-maintenance title="Permanent link">&para;</a></h2> <h3 id=cluster-upgrade-process>Cluster Upgrade Process<a class=headerlink href=#cluster-upgrade-process title="Permanent link">&para;</a></h3> <ul> <li> <p>檢視 K8s 叢集的版本 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-112-1><a id=__codelineno-112-1 name=__codelineno-112-1 href=#__codelineno-112-1></a>kubectl<span class=w> </span>get<span class=w> </span>nodes
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/check_k8s_cluster_version.png></p> </li> <li> <p>語意化版本管理 (Semantic Versioning)</p> <ul> <li><code>major.minor.patch</code><ul> <li>major: 主要版本，當 K8s 叢集有<strong>重大變更 (breaking changes)</strong>時，會增加此版本號</li> <li>minor: 次要版本，當 K8s 叢集有<strong>新功能 (feature)</strong>時，會增加此版本號</li> <li>patch: 修補版本，當 K8s 叢集有<strong>錯誤修正 (bug fix)</strong>時，會增加此版本號 <img alt src=../../../assets/pics/k8s/k8s-semantic_verison.png></li> </ul> </li> <li>在正式發布版本之前，軟體通常會經歷多個開發階段。這些版本被稱為先行版本，標示為 alpha, beta 等<ul> <li>alpha: 初始測試版本，通常在功能開發的早期階段釋出。它可能包含一些新功能，但這些功能尚未完全實現 or 尚未通過完整測試<ul> <li>e.g. <code>v1.0.0-alpha</code></li> </ul> </li> <li>beta: 是在 Alpha 版本之後釋出的，通常表示功能已基本完成，並且已進行了初步測試。beta 版本會提供給更廣泛的使用者進行測試，以收集回饋，並發現潛在問題<ul> <li>e.g. <code>v1.0.0-beta</code> <img alt src=../../../assets/pics/k8s/k8s_release_note_semantic_versioning_alpha_and_beta.png></li> </ul> </li> </ul> </li> </ul> </li> <li> <p>K8s 叢集中各物件的版本號</p> <ul> <li>K8s 叢集中的各物件，<strong>沒有強制ㄧ定要使用相同的版本號</strong>，但是核心物件 (e.g. Kube-apiserver, Kube-controller-manager, Kube-scheduler, Kubelet, Kube-proxy) 通常會使用相同的版本號</li> <li>K8s 叢集中的各物件，對於當前的 K8s 叢集版本號，分別會有可支援的版本號範圍 <img alt src=../../../assets/pics/k8s/k8s_cluster_all_objects_version-support_range.png></li> <li>K8s 叢集中的各物件，例如: Pod, Deployment, Service 等，都有自己的版本號。當 K8s 叢集升級時，這些物件的版本號也會隨之升級<ul> <li><strong>etcd cluster, CoreDNS 因為是獨立專案，因此會有其自己的版本號</strong>。因此，當 K8s 叢集升級時，也<strong>需要注意 K8s 叢集與 etcd cluster, CoreDNS 的版本相容性</strong></li> <li><strong>kubectl</strong> 因為是 Kubernetes 的 CLI 工具，通常會安裝在使用者的本地端環境中，而不是 K8s 叢集的 Node 上。因此，<strong>kubectl 會需要手動進行升級版本號</strong> <img alt src=../../../assets/pics/k8s/k8s_cluster_object_version.png></li> </ul> </li> </ul> </li> <li> <p>升級 K8s 叢集的版本號</p> <ul> <li>在任何時間點，K8s 只支援最近的 3 個次要版本 (minor version)</li> <li> <p>最佳實踐: 建議的方法是一次升級一個次要版本 <img alt src=../../../assets/pics/k8s/upgrade_k8s_cluster_version_every_minor_version.png></p> </li> <li> <p>常見的升級 K8s 叢集方法:</p> <ul> <li>法 1: 使用<strong>公有雲 (e.g. GCP, AWS, Azure)，可以在 GUI 上進行升級</strong></li> <li>法 2: 使用 <strong>kubeadm 工具，透過 CLI 指令進行升級</strong></li> <li>法 3: 手動部署 K8s 叢集，就只能透過手動方式進行升級 <img alt src=../../../assets/pics/k8s/options_to_upgrade_k8s_cluster.png></li> </ul> </li> <li> <p>升級 K8s 叢集的三種主要策略</p> <ul> <li>Recreate: 先刪除舊的 <strong>Node</strong>，再建立新的 <strong>Node</strong>。這樣的方式，會導致服務中斷 <img alt src=../../../assets/pics/k8s/upgrade_k8s_cluster_recreate.png></li> <li>RollingUpdate (預設): 滾動更新，一次升級一個 Node。亦即，逐步刪除舊的 <strong>Node</strong>，並建立新的 <strong>Node</strong>。這樣的方式，<strong>不會導致服務中斷</strong> <img alt src=../../../assets/pics/k8s/upgrade_k8s_cluster_rollingupdate.png></li> <li>Add new Node: 新增新的 <strong>Node</strong>，並將舊的 <strong>Node</strong> 逐步刪除。這樣的方式，<strong>不會導致服務中斷</strong> <img alt src=../../../assets/pics/k8s/upgrade_k8s_cluster_add_new_node.png></li> </ul> </li> </ul> </li> <li> <p>檢視當前的作業系統版本 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-113-1><a id=__codelineno-113-1 name=__codelineno-113-1 href=#__codelineno-113-1></a>cat<span class=w> </span>/etc/*release
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/view_current_os_version.png></p> </li> <li> <p>運用 kubeadm，升級 Master Node</p> <ul> <li> <p>檢查並計劃升級。這將確保所有前置條件，都已滿足並告知需要升級的內容 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-114-1><a id=__codelineno-114-1 name=__codelineno-114-1 href=#__codelineno-114-1></a>kubeadm<span class=w> </span>upgrade<span class=w> </span>plan
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/kubeadm_upgrade_plan.png></p> </li> <li> <p>升級 kubeadm 工具的版本號 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-115-1><a id=__codelineno-115-1 name=__codelineno-115-1 href=#__codelineno-115-1></a>apt-get<span class=w> </span>upgrade<span class=w> </span>-y<span class=w> </span><span class=nv>kubeadm</span><span class=o>=</span><span class=m>1</span>.12.0-00
</span></code></pre></div></p> </li> <li> <p>升級 K8s 叢集 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-116-1><a id=__codelineno-116-1 name=__codelineno-116-1 href=#__codelineno-116-1></a>kubeadm<span class=w> </span>upgrade<span class=w> </span>apply<span class=w> </span>v1.12.0
</span></code></pre></div></p> </li> <li> <p>升級 K8s 叢集成功後，這時候若我們檢視當前的 Node 仍顯示舊的版本號 <img alt src=../../../assets/pics/k8s/kubeadm_upgrade_master_node_old.png></p> </li> <li> <p>升級 kubelet 物件 (這裡是指 master node 上的) <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-117-1><a id=__codelineno-117-1 name=__codelineno-117-1 href=#__codelineno-117-1></a>apt-get<span class=w> </span>upgrade<span class=w> </span><span class=nv>kubelet</span><span class=o>=</span><span class=m>1</span>.12.0-00
</span></code></pre></div></p> </li> <li> <p>重新啟動 kubelet 物件 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-118-1><a id=__codelineno-118-1 name=__codelineno-118-1 href=#__codelineno-118-1></a>systemctl<span class=w> </span>restart<span class=w> </span>kubelet
</span></code></pre></div></p> </li> <li> <p>這時候，再檢視當前的 Node，就會正確顯示升級後的新版本號 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-119-1><a id=__codelineno-119-1 name=__codelineno-119-1 href=#__codelineno-119-1></a>kubectl<span class=w> </span>get<span class=w> </span>nodes
</span></code></pre></div></p> <p><img alt src=../../assets/pics/k8s/kubeadm_upgrade_master_node_new.png></p> </li> </ul> </li> <li> <p>運用 kubeadm，升級 Worker Node</p> <ul> <li> <p>要先連線到 worker node 中，才可以開始進行升級 (可以用 Node name 或 Internal IP 來連線) <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-120-1><a id=__codelineno-120-1 name=__codelineno-120-1 href=#__codelineno-120-1></a>ssh<span class=w> </span>node01
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-121-1><a id=__codelineno-121-1 name=__codelineno-121-1 href=#__codelineno-121-1></a>ssh<span class=w> </span><span class=m>10</span>.244.0.4
</span></code></pre></div> </li> <li> <p>先將當前 worker node 上，所有 Pod 工作負載 (workload) 都排出 (drain) <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-122-1><a id=__codelineno-122-1 name=__codelineno-122-1 href=#__codelineno-122-1></a>kubectl<span class=w> </span>drain<span class=w> </span>node01<span class=w> </span>--ignore-daemonsets
</span></code></pre></div></p> </li> <li> <p>升級 kubeadm、kubelet packages 的版本號 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-123-1><a id=__codelineno-123-1 name=__codelineno-123-1 href=#__codelineno-123-1></a>apt-get<span class=w> </span>upgrade<span class=w> </span>-y<span class=w> </span><span class=nv>kubeadm</span><span class=o>=</span><span class=m>1</span>.12.0-00
</span><span id=__span-123-2><a id=__codelineno-123-2 name=__codelineno-123-2 href=#__codelineno-123-2></a>apt-get<span class=w> </span>upgrade<span class=w> </span>-y<span class=w> </span><span class=nv>kubelet</span><span class=o>=</span><span class=m>1</span>.12.0-00
</span></code></pre></div></p> </li> <li> <p>更新 Worker Node 的設定檔，以符合新的版本號 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-124-1><a id=__codelineno-124-1 name=__codelineno-124-1 href=#__codelineno-124-1></a>kubeadm<span class=w> </span>upgrade<span class=w> </span>node<span class=w> </span>config<span class=w> </span>--kubelet-version<span class=w> </span>v1.12.0
</span></code></pre></div></p> </li> <li> <p>重新啟動 kubelet 服務 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-125-1><a id=__codelineno-125-1 name=__codelineno-125-1 href=#__codelineno-125-1></a>systemctl<span class=w> </span>restart<span class=w> </span>kubelet
</span></code></pre></div></p> </li> <li> <p>將升級後的 Node 標記為可排程 (schedulable) <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-126-1><a id=__codelineno-126-1 name=__codelineno-126-1 href=#__codelineno-126-1></a>kubectl<span class=w> </span>uncordon<span class=w> </span>node-1
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/kubeadm_upgrade_worker_node.png></p> </li> <li> <p>接下來，<strong>需逐一升級每一個 Worker Node，直到所有 Worker Node 都完成升級</strong> <img alt src=../../../assets/pics/k8s/kubeadm_upgrade_worker_node_individually.png></p> </li> </ul> </li> <li> <p>參考資料:</p> <ul> <li><a href=https://github.com/kubernetes/kubernetes/releases>K8s 官方文件: release note</a></li> <li><a href=https://v1-29.docs.kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/ >K8s 官方文件: Upgrading kubeadm clusters</a><ul> <li>步驟 1: Changing the package repository</li> <li>步驟 2: Determine which version to upgrade to</li> <li>步驟 3: Upgrading control plane nodes</li> <li>步驟 4: Upgrade worker nodes</li> <li>步驟 5: Verify the status of the cluster</li> </ul> </li> </ul> </li> </ul> <h3 id=operating-system-upgrades>Operating System Upgrades<a class=headerlink href=#operating-system-upgrades title="Permanent link">&para;</a></h3> <ul> <li> <p>在預設情況下，若一個 Node 在 5 分鐘內沒有恢復正常狀態，K8s 叢集將會開始驅逐該 Node 上的 Pod <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-127-1><a id=__codelineno-127-1 name=__codelineno-127-1 href=#__codelineno-127-1></a>kube-controller-manager<span class=w> </span>--pod-eviction-timeout<span class=o>=</span>5m0s
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/os_upgrade_pod_eviction_timeout.png></p> </li> <li> <p><strong>Drain Node (排出)</strong>: 將 Node 上的所有 Pod 驅逐（預設除了 DaemonSet 管理的 Pod 外），並<strong>將 Node 標記為不可排程 (unschedulable) 的狀態</strong></p> <ul> <li>目的: 將 Node 上的所有 Pod 安全地遷移到其他 Node 上，以便進行 Node 維護, 升級, 移除</li> <li> <p>使用情境: 進行 Node 維護, 升級 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-128-1><a id=__codelineno-128-1 name=__codelineno-128-1 href=#__codelineno-128-1></a>kubectl<span class=w> </span>drain<span class=w> </span>node-1<span class=w> </span>--ignore-daemonsets
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/drain_ignore_daemonsets.png></p> </li> <li> <p>注意! 若 Pod 不是由 Deployment, ReplicaSet, StatefulSet 等控制器管理，則在執行 <code>kubectl drain</code> 指令時，會出現錯誤訊息，因為 K8s 叢集為了防範我們誤刪 Pod，而無法復原</p> <ul> <li>此時，我們可以透過 <code>--force</code> 選項，強制執行 <code>kubectl drain</code> 指令 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-129-1><a id=__codelineno-129-1 name=__codelineno-129-1 href=#__codelineno-129-1></a>kubectl<span class=w> </span>drain<span class=w> </span>node-1<span class=w> </span>--ignore-daemonsets<span class=w> </span>--force
</span></code></pre></div></li> </ul> <p><img alt src=../../../assets/pics/k8s/drain_force.png></p> </li> </ul> </li> <li> <p><strong>Cordon/Uncordon Node (警戒/解除警戒)</strong></p> <ul> <li><strong>Cordon</strong>: 用於標記 Node 為不可排程 (unschedulable)，即不再接受新的 Pod。<strong>但現有 Pod 不會受到影響</strong><ul> <li>使用情境: 在需要進行 Node 維護時，防止新的 Pod 被排程到該節點上</li> </ul> </li> <li><strong>Uncordon</strong>: 用於標記 Node 為可排程 (schedulable)，即可以接受新的 Pod<ul> <li>使用情境: Node 維護, 升級完成後，重新允許該 Node 接收新的 Pod</li> </ul> </li> </ul> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-130-1><a id=__codelineno-130-1 name=__codelineno-130-1 href=#__codelineno-130-1></a>kubectl<span class=w> </span>cordon<span class=w> </span>node-1
</span><span id=__span-130-2><a id=__codelineno-130-2 name=__codelineno-130-2 href=#__codelineno-130-2></a>kubectl<span class=w> </span>uncordon<span class=w> </span>node-1
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/uncordon.png></p> </li> </ul> <h3 id=backup-and-restore-methodologies>Backup and Restore Methodologies<a class=headerlink href=#backup-and-restore-methodologies title="Permanent link">&para;</a></h3> <ul> <li> <p>若我們要備份 K8s 叢集時，會需要備份以下三種資源</p> <ul> <li><strong>Resource Configuration</strong>: 包含所有 Kubernetes 叢集中的所有資源的設定，能確保在需要時能夠快速恢復 K8s 叢集狀態</li> <li><strong>etcd Cluster</strong>: 儲存 K8s 叢集中所有狀態的資料，包括所有設定、資源設定、資料，是 K8s 叢集運行的核心</li> <li><strong>Persistent Volume</strong>: 儲存應用程式的持久化資料，對於有狀態的應用程式 (e.g. 資料庫、重要文件) 非常重要，這些資料需要被可靠地備份，以防遺失 <img alt src=../../../assets/pics/k8s/k8s_cluster_back_three_condidates.png></li> </ul> </li> <li> <p><strong>Backup-Resource Configuration</strong></p> <ul> <li> <p>最佳實踐: 將所有資源設定儲存到 Git Repository 中，以便能夠快速恢復 K8s 叢集狀態 <img alt src=../../../assets/pics/k8s/save_resource_configuration_on_github.png></p> </li> <li> <p>快速導出多種 K8s 叢集中核心資源的設定檔，並儲存到指定的 YAML manifest 設定檔中</p> <ul> <li><strong>僅支援</strong>匯出以下資源的設定檔: <strong>Pod, Service, Deployment, ReplicaSet, StatefulSet, DaemonSet, Job, CronJob</strong> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-131-1><a id=__codelineno-131-1 name=__codelineno-131-1 href=#__codelineno-131-1></a><span class=c1># (only for few resource groups)</span>
</span><span id=__span-131-2><a id=__codelineno-131-2 name=__codelineno-131-2 href=#__codelineno-131-2></a>kubectl<span class=w> </span>get<span class=w> </span>all<span class=w> </span>--all-namespaces<span class=w> </span>-o<span class=w> </span>yaml<span class=w> </span>&gt;<span class=w> </span>all-deploy-services.yaml
</span></code></pre></div></li> <li> <p><strong>不支援</strong>匯出以下資源的設定檔: <strong>ConfigMap, Secret, PersistentVolume</strong>, PersistentVolumeClaim, <strong>Ingress</strong>, Custom Resource Definitions（CRD）及其實例 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-132-1><a id=__codelineno-132-1 name=__codelineno-132-1 href=#__codelineno-132-1></a>kubectl<span class=w> </span>get<span class=w> </span>configmap<span class=w> </span>--all-namespaces<span class=w> </span>-o<span class=w> </span>yaml<span class=w> </span>&gt;&gt;<span class=w> </span>all-deploy-services.yaml
</span><span id=__span-132-2><a id=__codelineno-132-2 name=__codelineno-132-2 href=#__codelineno-132-2></a>kubectl<span class=w> </span>get<span class=w> </span>secret<span class=w> </span>--all-namespaces<span class=w> </span>-o<span class=w> </span>yaml<span class=w> </span>&gt;&gt;<span class=w> </span>all-deploy-services.yaml
</span><span id=__span-132-3><a id=__codelineno-132-3 name=__codelineno-132-3 href=#__codelineno-132-3></a>kubectl<span class=w> </span>get<span class=w> </span>pv<span class=w> </span>--all-namespaces<span class=w> </span>-o<span class=w> </span>yaml<span class=w> </span>&gt;&gt;<span class=w> </span>all-deploy-services.yaml
</span><span id=__span-132-4><a id=__codelineno-132-4 name=__codelineno-132-4 href=#__codelineno-132-4></a>kubectl<span class=w> </span>get<span class=w> </span>pvc<span class=w> </span>--all-namespaces<span class=w> </span>-o<span class=w> </span>yaml<span class=w> </span>&gt;&gt;<span class=w> </span>all-deploy-services.yaml
</span><span id=__span-132-5><a id=__codelineno-132-5 name=__codelineno-132-5 href=#__codelineno-132-5></a>kubectl<span class=w> </span>get<span class=w> </span>ingress<span class=w> </span>--all-namespaces<span class=w> </span>-o<span class=w> </span>yaml<span class=w> </span>&gt;&gt;<span class=w> </span>all-deploy-services.yaml
</span><span id=__span-132-6><a id=__codelineno-132-6 name=__codelineno-132-6 href=#__codelineno-132-6></a>kubectl<span class=w> </span>get<span class=w> </span>crd<span class=w> </span>--all-namespaces<span class=w> </span>-o<span class=w> </span>yaml<span class=w> </span>&gt;&gt;<span class=w> </span>all-deploy-services.yaml
</span></code></pre></div></p> </li> <li> <p>Velero: 是一個強大的開源工具，用於備份、恢復、遷移 K8s 叢集中的資源 &amp; PersistentVolume。它支持定期備份、基於策略的備份管理</p> </li> </ul> <p><img alt src=../../../assets/pics/k8s/export_backup_resource_configuration.png></p> </li> </ul> </li> <li> <p><strong>Backup-etcd Cluster</strong></p> <ul> <li>實務上，我們會備份 etcd cluster 的資料，而不是對於每個 K8s 叢集中的資源逐一備份</li> <li> <p>可指定匯出的 etcd cluster 備份檔案要儲存在什麼路徑位置 <img alt src=../../../assets/pics/k8s/backup_etcd_cluster_data_dir.png></p> </li> <li> <p><strong>etcdctl</strong>: 用於與 etcd cluster 進行互動的 CLI 指令工具，包括備份、還原、查詢等操作</p> <ul> <li> <p>備份 (backup)</p> <ul> <li> <p><strong>需先指定 etcdctl 的 API 版本號</strong> (必要) <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-133-1><a id=__codelineno-133-1 name=__codelineno-133-1 href=#__codelineno-133-1></a><span class=nb>export</span><span class=w> </span><span class=nv>ETCDCTL_API</span><span class=o>=</span><span class=m>3</span>
</span></code></pre></div></p> </li> <li> <p>建立 etcd cluster 的快照備份 (snapshot) <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-134-1><a id=__codelineno-134-1 name=__codelineno-134-1 href=#__codelineno-134-1></a>etcdctl<span class=w> </span>snapshot<span class=w> </span>save<span class=w> </span>snapshot.db
</span></code></pre></div></p> </li> <li> <p>查詢 etcd cluster 的快照狀態 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-135-1><a id=__codelineno-135-1 name=__codelineno-135-1 href=#__codelineno-135-1></a>etcdctl<span class=w> </span>snapshot<span class=w> </span>status<span class=w> </span>snapshot.db
</span></code></pre></div></p> </li> </ul> <p><img alt src=../../../assets/pics/k8s/etcdctl_snapshot_save.png></p> </li> <li> <p>還原 (restore)</p> <ul> <li> <p>先暫停 kube-apiserver 服務，以透過 etcd cluster 還原 K8s 叢集 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-136-1><a id=__codelineno-136-1 name=__codelineno-136-1 href=#__codelineno-136-1></a>service<span class=w> </span>kube-apiserver<span class=w> </span>stop
</span></code></pre></div></p> </li> <li> <p>復原 etcd cluster 的快照備份 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-137-1><a id=__codelineno-137-1 name=__codelineno-137-1 href=#__codelineno-137-1></a>etcdctl<span class=w> </span>snapshot<span class=w> </span>restore
</span></code></pre></div></p> </li> <li> <p>更新 etcd 服務的設定檔內容</p> <ul> <li>預設路徑: <code>/etc/kubernetes/manifests/etcd.yaml</code> 中的 <code>spec.containers.command</code> 欄位</li> </ul> </li> <li> <p>重新載入系統設定檔 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-138-1><a id=__codelineno-138-1 name=__codelineno-138-1 href=#__codelineno-138-1></a>systemctl<span class=w> </span>daemon-reload
</span></code></pre></div></p> </li> <li> <p>重啟 etcd 服務 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-139-1><a id=__codelineno-139-1 name=__codelineno-139-1 href=#__codelineno-139-1></a>service<span class=w> </span>etcd<span class=w> </span>restart
</span></code></pre></div></p> </li> <li> <p>重啟 kube-apiserver <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-140-1><a id=__codelineno-140-1 name=__codelineno-140-1 href=#__codelineno-140-1></a>service<span class=w> </span>kube-apiserver<span class=w> </span>start
</span></code></pre></div></p> </li> </ul> <p><img alt src=../../../assets/pics/k8s/restore_etcd_cluster.png></p> </li> </ul> </li> </ul> </li> <li> <p>Tips: <strong>每個 etcdctl 指令，都必須指定 endpoint, cacert, cert,key 四個選項值，用來驗證權限</strong></p> <ul> <li><code>--endpoints</code>: 指定 etcd 伺服器的 IP address, port</li> <li><code>--cacert</code>: 指定 CA (證書授權機構) 的證書，用來驗證 etcd 伺服器的證書是否由受信任的 CA 所簽發</li> <li><code>--cert</code>: 指定客戶端 (etcdctl) 證書，用來證明 etcdctl 的身份，讓 etcd 伺服器可以驗證它是否為受信任的實體</li> <li><code>--key</code>: 指定客戶端 (etcdctl) 私鑰，用來解密 etcdctl 證書的內容，以便在 TLS handshake 過程中能證明 etcdctl 的身份</li> </ul> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-141-1><a id=__codelineno-141-1 name=__codelineno-141-1 href=#__codelineno-141-1></a>etcdctl<span class=w> </span><span class=se>\</span>
</span><span id=__span-141-2><a id=__codelineno-141-2 name=__codelineno-141-2 href=#__codelineno-141-2></a>snapshot<span class=w> </span>save<span class=w> </span>/tmp/snapshot.db<span class=w> </span><span class=se>\</span>
</span><span id=__span-141-3><a id=__codelineno-141-3 name=__codelineno-141-3 href=#__codelineno-141-3></a>--endpoints<span class=o>=</span>https://127.0.0.1:2379<span class=w> </span><span class=se>\</span>
</span><span id=__span-141-4><a id=__codelineno-141-4 name=__codelineno-141-4 href=#__codelineno-141-4></a>--cacert<span class=o>=</span>/etc/kubernetes/pki/etcd/ca.crt<span class=w> </span><span class=se>\</span>
</span><span id=__span-141-5><a id=__codelineno-141-5 name=__codelineno-141-5 href=#__codelineno-141-5></a>--cert<span class=o>=</span>/etc/kubernetes/pki/etcd/etcd-server.crt<span class=w> </span><span class=se>\</span>
</span><span id=__span-141-6><a id=__codelineno-141-6 name=__codelineno-141-6 href=#__codelineno-141-6></a>--key<span class=o>=</span>/etc/kubernetes/pki/etcd/etcd-server.key
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/etcdctl_four_required_options_for_authentication.png></p> </li> <li> <p>參考資料: <a href=https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/ >K8s 官方文件: Operating etcd clusters for Kubernetes</a></p> </li> </ul> <h2 id=security>Security<a class=headerlink href=#security title="Permanent link">&para;</a></h2> <h3 id=kubernetes-security-primitives>Kubernetes Security Primitives<a class=headerlink href=#kubernetes-security-primitives title="Permanent link">&para;</a></h3> <ul> <li> <p>通常會對 kube-apiserver 設定 Secure Host</p> <ul> <li> <p>禁用純密碼存取，並啟用 SSH key 認證 <img alt src=../../../assets/pics/k8s/secure_hosts.png></p> </li> <li> <p>認證 (Authentication): 決定誰能存取？</p> <ul> <li>使用者帳戶/密碼</li> <li>使用者名稱/token</li> <li>Certificate</li> <li>外部認證提供者 (e.g. LDAP)</li> <li>服務帳戶 (Service Account)</li> </ul> </li> <li>授權 (Authorization): 決定誰能做什麼？<ul> <li>基於角色存取控制機制 (Role-Based Access Control, RBAC): 基於角色來控制存取權限</li> <li>基於屬性存取控制機制 (Attribute-Based Access Control, ABAC): 基於使用者的屬性來控制存取權限</li> <li>Node Authorization: 決定 Node 是否能加入 K8s 叢集</li> <li>Webhook Mode: 透過 Webhook 服務來授權 <img alt src=../../../assets/pics/k8s/secure_kubernetes.png></li> </ul> </li> </ul> </li> <li> <p>TLS 證書: 用於加密通訊</p> <ul> <li>在 K8s 叢集中的各物件之間，都會使用 TLS 證書來加密通訊 <img alt src=../../../assets/pics/k8s/k8s_tls_certificates.png></li> </ul> </li> <li> <p>Networking: 讓 K8s 叢集中的 Pods 能夠互相通訊</p> <ul> <li>預設 K8s 叢集中的 Pods 能夠互相通訊</li> <li>可使用 Network Policies 來控制流量 <img alt src=../../../assets/pics/k8s/k8s_network_policies.png></li> </ul> </li> </ul> <h3 id=authentication>Authentication<a class=headerlink href=#authentication title="Permanent link">&para;</a></h3> <ul> <li> <p>K8s 叢集中會有存在以下使用者帳號:</p> <ul> <li>管理者</li> <li>開發者</li> <li>終端使用者 (由應用程式內部作管理，故暫不討論)</li> <li>第三方應用程式 (Bots) <img alt src=../../../assets/pics/k8s/k8s_different_user_accounts.png></li> </ul> </li> <li> <p>上述的四種使用者帳戶，可以大致劃分成以下兩類:</p> <ul> <li>人類: 管理者、開發者</li> <li>機器: 其他需要存取 K8s 叢集的 process/service/application</li> </ul> </li> <li> <p>K8s 叢集無法建立/查詢使用者帳號，只能透過外部認證提供者 (e.g. LDAP) 來建立/查詢使用者帳號 <img alt src=../../../assets/pics/k8s/k8s_service_accounts.png></p> </li> <li> <p>所有使用者的存取權限都是由 kube-apiserver 進行管理，並且所有的 API 請求都會經過 kube-apiserver 來處理 <img alt src=../../../assets/pics/k8s/kube_apiserver_manage_api_requests.png></p> </li> <li> <p>kube-apiserver 會透過以下 4 種方法來認證使用者 <img alt src=../../../assets/pics/k8s/auth_mechanisms.png></p> <ul> <li> <p>基本的使用者名稱/密碼 (已於 K8s v1.19 版本後停用)</p> <ul> <li> <p>法一: 在 CLI 上，執行時透過選項設定 <img alt src=../../../assets/pics/k8s/authentication_mechanisms_basic.png></p> </li> <li> <p>法二: 使用 kubeadm，在 kube-apiserver YAML manifest 設定檔中，設定使用者名稱/密碼 <img alt src=../../../assets/pics/k8s/authentication_mechanisms_basic_config.png></p> </li> </ul> </li> </ul> </li> <li> <p>透過 CLI 指令的選項，認證使用者 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-142-1><a id=__codelineno-142-1 name=__codelineno-142-1 href=#__codelineno-142-1></a>curl<span class=w> </span>-v<span class=w> </span>-k<span class=w> </span>http://master-node-ip:6443/api/v1/pods<span class=w> </span>-u<span class=w> </span><span class=s2>&quot;user1:password123&quot;</span>
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/authenticate_user_using_password.png></p> </li> <li> <p>透過 token 認證使用者 <img alt src=../../assets/pics/k8s/authentication_mechanism_using_token.png.png></p> </li> </ul> <h3 id=tls-certificates-for-cluster-components>TLS certificates for cluster components<a class=headerlink href=#tls-certificates-for-cluster-components title="Permanent link">&para;</a></h3> <ul> <li>非對稱加密法 (Asymmetric Encryption)<ul> <li>可透過公鑰 (Public Key) 加密，私鑰 (Private Key) 解密</li> </ul> </li> <li> <p>建立公私鑰對 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-143-1><a id=__codelineno-143-1 name=__codelineno-143-1 href=#__codelineno-143-1></a>ssh-keygen<span class=w> </span>-t<span class=w> </span>rsa<span class=w> </span>-b<span class=w> </span><span class=m>2048</span><span class=w> </span>-f<span class=w> </span>mykey
</span></code></pre></div></p> </li> <li> <p>檢視公鑰 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-144-1><a id=__codelineno-144-1 name=__codelineno-144-1 href=#__codelineno-144-1></a>cat<span class=w> </span>~/.ssh/id_rsa.pub
</span></code></pre></div></p> </li> <li> <p>指定私鑰的本地端路徑，登入遠端系統 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-145-1><a id=__codelineno-145-1 name=__codelineno-145-1 href=#__codelineno-145-1></a>ssh<span class=w> </span>-i<span class=w> </span>/path/to/id_rsa<span class=w> </span>user1@server1
</span></code></pre></div></p> </li> <li> <p>同一個使用者，可以使用私鑰，對多個遠端系統的公鑰進行認證，來登入系統 <img alt src=../../../assets/pics/k8s/asymmetric_encryption_ssh_multiple_public_keys.png></p> </li> <li> <p>也可以使用 OpenSSL 工具，產生公私鑰對 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-146-1><a id=__codelineno-146-1 name=__codelineno-146-1 href=#__codelineno-146-1></a>openssl<span class=w> </span>genrsa<span class=w> </span>-out<span class=w> </span>my-bank.key<span class=w> </span><span class=m>1024</span>
</span><span id=__span-146-2><a id=__codelineno-146-2 name=__codelineno-146-2 href=#__codelineno-146-2></a>openssl<span class=w> </span>rsa<span class=w> </span>-in<span class=w> </span>my-bank.key<span class=w> </span>-pubout<span class=w> </span>&gt;<span class=w> </span>mybank.pem
</span></code></pre></div></p> </li> <li> <p>憑證機構 (Certificate Authority, CA)</p> <ul> <li> <p>e.g. Symantec, DigiCert, Comodo, GlobalSign 等 <img alt src=../../../assets/pics/k8s/ca_illustration.png></p> </li> <li> <p>需要用私鑰來產生 CSR 文件</p> </li> <li> <p>CSR (Certificate Signing Request) 是一個發送給 CA 的文件，用於請求頒發憑證。CSR 會包含一些關鍵訊息，例如: 組織名稱、域名、公鑰、其他識別信息。</p> </li> <li> <p>簽署 SSL/TLS 證書的流程</p> <ul> <li> <p>Certificate Signing Request (CSR)：產生一個包含申請者訊息的 CSR 文件 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-147-1><a id=__codelineno-147-1 name=__codelineno-147-1 href=#__codelineno-147-1></a>openssl<span class=w> </span>req<span class=w> </span>-new<span class=w> </span>-key<span class=w> </span>my-bank.key<span class=w> </span>-out<span class=w> </span>my-bank.csr<span class=w> </span>-subj<span class=w> </span><span class=s2>&quot;/C=US/ST=CA/O=MyOrg, Inc./CN=my-bank.com&quot;</span>
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/ca_generate_csr_file.png></p> </li> <li> <p>Validate Information：憑證機構（CA）會驗證申請者提供的訊息 <img alt src=../../../assets/pics/k8s/ca_validate_information.png></p> </li> <li> <p>Sign and Send Certificate：CA 簽名，並發送正式的證書給申請者 <img alt src=../../../assets/pics/k8s/ca_sign_and_send_certification.png></p> </li> </ul> </li> </ul> </li> <li> <p>公共鍵值基礎建設 (Public Key Infrastructure, PKI)</p> <ul> <li>用於建立、管理、儲存、分發、撤銷數位證書</li> <li>用於確保數位證書的安全性 <img alt src=../../../assets/pics/k8s/pki_illustration.png></li> </ul> </li> <li> <p>公私鑰的慣用命名風格</p> <ul> <li>公鑰: <code>.crt</code>, <code>.cert</code>, <code>.pem</code> 結尾</li> <li>私鑰: 含有 <code>.key</code></li> </ul> <p><img alt src=../../../assets/pics/k8s/public_key_and_private_key_naming_convention.png></p> </li> <li> <p>在 K8s 叢集中，關於 TLS 加密傳輸通常會有以下兩個要求</p> <ul> <li> <p>伺服器端證書 (Server Certificates): 需要使用伺服器證書來驗證它們的身份</p> <ul> <li>kube-apiserver server: <strong>用於證明自己是合法的 kube-apiserver</strong>，讓其他客戶端如 kubectl、kubelet 可以信任並與其安全通訊</li> <li>etcd server: <strong>用於證明自己是合法的 etcd 伺服器</strong>，讓 kube-apiserver 和其他客戶端可以信任並與其安全通訊</li> <li>kubelet server: <strong>用於證明自己是合法的 kubelet 伺服器</strong>，讓 kube-apiserver 和其他客戶端可以信任並與其安全通訊 <img alt src=../../../assets/pics/k8s/client_tls_certifications.png></li> </ul> </li> <li> <p>客戶端證書 (Client Certificates): 需要使用客戶端證書來證明它們的身份</p> <ul> <li>admin</li> <li>kube-scheduler</li> <li>kube-controller-manager</li> <li>kube-proxy</li> <li>kube-apiserver client: 當 kube-apiserver 需要與 etcd 等其他服務通訊時，<strong>用於證明自己的身份</strong></li> <li>etcd client: 當 etcd 需要與其他服務通信時，如 K8s 叢集內的其他 etcd 節點，<strong>用於證明自己的身份</strong></li> <li>kubelet client: 當 kubelet 需要與 kube-apiserver 或其他服務通訊時，<strong>用於證明自己的身份</strong> <img alt src=../../../assets/pics/k8s/server_tls_certifications.png></li> </ul> </li> <li> <p>統整概念: <img alt src=../../../assets/pics/k8s/tls_certifications_in_k8s.png> <img alt src=../../../assets/pics/k8s/tls_in_k8s_bewteen_kube_apiserver_and_kube_scheduler.png> <img alt src=../../../assets/pics/k8s/tls_certifications_in_k8s_summary.png></p> </li> </ul> </li> <li> <p>建立 TLS 證書</p> <ul> <li> <p>CA (憑證機構本身)</p> <ul> <li> <p>Step 1: 產生公私鑰對 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-148-1><a id=__codelineno-148-1 name=__codelineno-148-1 href=#__codelineno-148-1></a>openssl<span class=w> </span>genrsa<span class=w> </span>-out<span class=w> </span>ca.key<span class=w> </span><span class=m>2048</span>
</span></code></pre></div></p> </li> <li> <p>Step 2: 產生 CSR 文件 <div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-149-1><a id=__codelineno-149-1 name=__codelineno-149-1 href=#__codelineno-149-1></a>openssl req -new -key ca.key -subj &quot;/CN=KUBERNETES-CA&quot; -out ca.csr
</span></code></pre></div></p> </li> <li> <p>Step 3: 簽署證書 <div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-150-1><a id=__codelineno-150-1 name=__codelineno-150-1 href=#__codelineno-150-1></a>openssl x509 -req -in ca.csr -signkey ca.key -out ca.crt
</span></code></pre></div></p> </li> </ul> <p><img alt src=../../../assets/pics/k8s/ca_create_tls_certification.png></p> </li> <li> <p>Server Certificates</p> <ul> <li> <p>kube-apiserver server: <img alt src=../../../assets/pics/k8s/kube_apiserver_create_tls_certification_1.png> <img alt src=../../../assets/pics/k8s/kube_apiserver_create_tls_certification_2.png></p> </li> <li> <p>etcd server <img alt src=../../../assets/pics/k8s/etcd_server_create_tls_certification_1.png> <img alt src=../../../assets/pics/k8s/etcd_server_create_tls_certification_2.png></p> </li> <li> <p>kubelet server: <img alt src=../../../assets/pics/k8s/kubelet_server_create_tls_certification.png></p> </li> </ul> </li> <li> <p>Client Certificates</p> <ul> <li> <p>admin </p> <ul> <li> <p>Step 1: 產生公私鑰對 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-151-1><a id=__codelineno-151-1 name=__codelineno-151-1 href=#__codelineno-151-1></a>openssl<span class=w> </span>genrsa<span class=w> </span>-out<span class=w> </span>admin.key<span class=w> </span><span class=m>2048</span>
</span></code></pre></div></p> </li> <li> <p>Step 2: 產生 CSR 文件 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-152-1><a id=__codelineno-152-1 name=__codelineno-152-1 href=#__codelineno-152-1></a>openssl<span class=w> </span>req<span class=w> </span>-new<span class=w> </span>-key<span class=w> </span>admin.key<span class=w> </span>-subj<span class=w> </span><span class=s2>&quot;/CN=kube-admin&quot;</span><span class=w> </span>-out<span class=w> </span>admin.csr
</span></code></pre></div></p> </li> <li> <p>Step 3: 簽署證書 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-153-1><a id=__codelineno-153-1 name=__codelineno-153-1 href=#__codelineno-153-1></a>openssl<span class=w> </span>x509<span class=w> </span>-req<span class=w> </span>-in<span class=w> </span>admin.csr<span class=w> </span>-CA<span class=w> </span>ca.crt<span class=w> </span>-CAkey<span class=w> </span>ca.key<span class=w> </span>-out<span class=w> </span>admin.crt
</span></code></pre></div></p> </li> <li> <p>Step 4: 授權給 admin 使用 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-154-1><a id=__codelineno-154-1 name=__codelineno-154-1 href=#__codelineno-154-1></a>openssl<span class=w> </span>req<span class=w> </span>-new<span class=w> </span>-key<span class=w> </span>admin.key<span class=w> </span>-subj<span class=w> </span><span class=s2>&quot;/CN=kube-admin/O=system:masters&quot;</span><span class=w> </span>-out<span class=w> </span>admin.csr
</span></code></pre></div></p> </li> </ul> <p><img alt src=../../../assets/pics/k8s/admin_create_tls_certification.png></p> </li> <li> <p>kube-scheduler <img alt src=../../../assets/pics/k8s/kube_scheduler_create_tls_certification.png></p> </li> <li> <p>kube-controller-manager <img alt src=../../../assets/pics/k8s/kube_controller_manager_create_tls_certification.png></p> </li> <li> <p>kube-proxy <img alt src=../../../assets/pics/k8s/kube_proxy_create_tls_certification.png></p> </li> <li> <p>kubelet client: <img alt src=../../../assets/pics/k8s/kubelet_client_create_tls_certification.png></p> </li> <li> <p>統整: <img alt src=../../assets/pics/k8s/clients_tls_certifications.png></p> </li> </ul> </li> </ul> </li> <li> <p>設定 TLS 證書給 K8s 叢集中的各元件</p> <ul> <li>手動設定 --- 不推薦，較複雜</li> <li>透過 <strong>kubeadm</strong> 工具設定 --- <strong>推薦作法</strong> <img alt src=../../../assets/pics/k8s/set_certifications_in_k8s.png></li> </ul> </li> <li> <p>可透過 kube-apiserver 的 YAML manifest 設定檔，來檢視 kube-apiserver 的證書 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-155-1><a id=__codelineno-155-1 name=__codelineno-155-1 href=#__codelineno-155-1></a>cat<span class=w> </span>/etc/kubernetes/manifests/kube-apiserver.yaml
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/view_certifications_in_k8s.png></p> </li> <li> <p>檢視 TLS 證書的內容 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-156-1><a id=__codelineno-156-1 name=__codelineno-156-1 href=#__codelineno-156-1></a>openssl<span class=w> </span>x509<span class=w> </span>-in<span class=w> </span>/etc/kubernetes/pki/apiserver.crt<span class=w> </span>-text<span class=w> </span>-noout
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/view_certifications_content.png></p> </li> <li> <p>檢視 K8s 叢集中各元件的 TLS 證書內容: 檢查 TLS 證書是否皆由正確的 CA 簽發，且是否在有效期限內 <img alt src=../../../assets/pics/k8s/view_certifications_content_in_k8s.png></p> </li> <li> <p>檢視 K8s 叢集的啟動狀態</p> <ul> <li> <p>法一: 假設使用 kubeadm 建立 K8s 叢集，可查看 etcd 的 log <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-157-1><a id=__codelineno-157-1 name=__codelineno-157-1 href=#__codelineno-157-1></a>kubectl<span class=w> </span>logs<span class=w> </span>etcd-master
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/view_k8s_logs_by_etcd.png></p> </li> <li> <p>法二: 若 K8s 叢集未正確啟動 (e.g. kube-apiserver || etcd 服務未正常啟動)，導致 kubectl 指令無法使用時，可檢視 container 的 log <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-158-1><a id=__codelineno-158-1 name=__codelineno-158-1 href=#__codelineno-158-1></a>docker<span class=w> </span>ps<span class=w> </span>-a
</span></code></pre></div></p> <div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-159-1><a id=__codelineno-159-1 name=__codelineno-159-1 href=#__codelineno-159-1></a>docker logs &lt;container-id&gt;
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/view_k8s_logs_by_docker.png></p> </li> </ul> </li> </ul> <h4 id=k8s-certificate-api>K8s Certificate API<a class=headerlink href=#k8s-certificate-api title="Permanent link">&para;</a></h4> <ul> <li> <p>K8s Certificate API</p> <ul> <li> <p>K8s 叢集會由 kube-controller-manager 擔任 CA 的角色，負責簽署 K8s 叢集內部各元件的 TLS 證書 <img alt src=../../../assets/pics/k8s/kube_controller_manager_ca_role.png> <img alt src=../../../assets/pics/k8s/kube_controller_manager_ca_role_yaml.png></p> </li> <li> <p>簽署 TLS 證書的流程: 將 CSR 文件，透過 K8s Certificate API 送至 kube-controller-manager，由其簽署證書 <img alt src=../../../assets/pics/k8s/k8s_certificate_api_processes.png></p> <ul> <li> <p>Step 1: 使用者建立新的私鑰 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-160-1><a id=__codelineno-160-1 name=__codelineno-160-1 href=#__codelineno-160-1></a>openssl<span class=w> </span>genrsa<span class=w> </span>-out<span class=w> </span>jane.key<span class=w> </span><span class=m>2048</span>
</span></code></pre></div></p> </li> <li> <p>Step 2: 產生一個 CSR 文件 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-161-1><a id=__codelineno-161-1 name=__codelineno-161-1 href=#__codelineno-161-1></a>openssl<span class=w> </span>req<span class=w> </span>-new<span class=w> </span>-key<span class=w> </span>jane.key<span class=w> </span>-subj<span class=w> </span><span class=s2>&quot;/CN=jane&quot;</span><span class=w> </span>-out<span class=w> </span>jane.csr<span class=w> </span>
</span></code></pre></div></p> </li> <li> <p>Step 3: 使用者將 CSR 文件發送給 admin，由 admin 將 CSR 文件轉換成 CSR 物件，並將其運用 base64 編碼後儲存 <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-162-1><a id=__codelineno-162-1 name=__codelineno-162-1 href=#__codelineno-162-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">certificates.k8s.io/v1beta1</span>
</span><span id=__span-162-2><a id=__codelineno-162-2 name=__codelineno-162-2 href=#__codelineno-162-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CertificateSigningRequest</span>
</span><span id=__span-162-3><a id=__codelineno-162-3 name=__codelineno-162-3 href=#__codelineno-162-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-162-4><a id=__codelineno-162-4 name=__codelineno-162-4 href=#__codelineno-162-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jane</span>
</span><span id=__span-162-5><a id=__codelineno-162-5 name=__codelineno-162-5 href=#__codelineno-162-5></a>
</span><span id=__span-162-6><a id=__codelineno-162-6 name=__codelineno-162-6 href=#__codelineno-162-6></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-162-7><a id=__codelineno-162-7 name=__codelineno-162-7 href=#__codelineno-162-7></a><span class=w>    </span><span class=nt>groups</span><span class=p>:</span>
</span><span id=__span-162-8><a id=__codelineno-162-8 name=__codelineno-162-8 href=#__codelineno-162-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class="l l-Scalar l-Scalar-Plain">system:authenticated</span>
</span><span id=__span-162-9><a id=__codelineno-162-9 name=__codelineno-162-9 href=#__codelineno-162-9></a><span class=w>    </span><span class=nt>usages</span><span class=p>:</span>
</span><span id=__span-162-10><a id=__codelineno-162-10 name=__codelineno-162-10 href=#__codelineno-162-10></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class="l l-Scalar l-Scalar-Plain">digital signature</span>
</span><span id=__span-162-11><a id=__codelineno-162-11 name=__codelineno-162-11 href=#__codelineno-162-11></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class="l l-Scalar l-Scalar-Plain">key encipherment</span>
</span><span id=__span-162-12><a id=__codelineno-162-12 name=__codelineno-162-12 href=#__codelineno-162-12></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class="l l-Scalar l-Scalar-Plain">server auth</span>
</span><span id=__span-162-13><a id=__codelineno-162-13 name=__codelineno-162-13 href=#__codelineno-162-13></a><span class=nt>request</span><span class=p>:</span>
</span><span id=__span-162-14><a id=__codelineno-162-14 name=__codelineno-162-14 href=#__codelineno-162-14></a><span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">&lt;certificate-goes-here&gt;</span>
</span></code></pre></div></p> <ul> <li> <p>檢視 CSR 文件的內容 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-163-1><a id=__codelineno-163-1 name=__codelineno-163-1 href=#__codelineno-163-1></a>cat<span class=w> </span>jane.csr<span class=w> </span><span class=p>|</span><span class=w> </span>base64
</span></code></pre></div></p> </li> <li> <p>建立 CertificateSigningRequest 物件 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-164-1><a id=__codelineno-164-1 name=__codelineno-164-1 href=#__codelineno-164-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>jane.yaml
</span></code></pre></div></p> </li> </ul> <p><img alt src=../../../assets/pics/k8s/cat_jane_csr.png></p> </li> <li> <p>Step 4: 列出目前所有的 CSR 文件 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-165-1><a id=__codelineno-165-1 name=__codelineno-165-1 href=#__codelineno-165-1></a>kubectl<span class=w> </span>get<span class=w> </span>csr
</span></code></pre></div></p> </li> <li> <p>Step 5: 允許簽署 CSR 文件 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-166-1><a id=__codelineno-166-1 name=__codelineno-166-1 href=#__codelineno-166-1></a>kubectl<span class=w> </span>certificate<span class=w> </span>approve<span class=w> </span>jane
</span></code></pre></div></p> <ul> <li> <p>也可以拒絕簽署 CSR 文件 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-167-1><a id=__codelineno-167-1 name=__codelineno-167-1 href=#__codelineno-167-1></a>kubectl<span class=w> </span>certificate<span class=w> </span>deny<span class=w> </span>jane
</span></code></pre></div></p> </li> <li> <p>也可以刪除 CSR 文件 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-168-1><a id=__codelineno-168-1 name=__codelineno-168-1 href=#__codelineno-168-1></a>kubectl<span class=w> </span>delete<span class=w> </span>csr<span class=w> </span>jane
</span></code></pre></div></p> </li> </ul> </li> <li> <p>Step 6: 檢視 TLS 證書的內容 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-169-1><a id=__codelineno-169-1 name=__codelineno-169-1 href=#__codelineno-169-1></a>kubectl<span class=w> </span>get<span class=w> </span>csr<span class=w> </span>jane<span class=w> </span>-o<span class=o>=</span>yaml
</span></code></pre></div></p> <ul> <li>檢視 TLS 證書的內容 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-170-1><a id=__codelineno-170-1 name=__codelineno-170-1 href=#__codelineno-170-1></a><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;&lt;certificate&gt;&quot;</span><span class=w> </span><span class=p>|</span><span class=w> </span>base64<span class=w> </span>--decode
</span></code></pre></div></li> </ul> <p><img alt src=../../../assets/pics/k8s/k8s_certificate_api.png></p> </li> </ul> </li> </ul> </li> </ul> <h4 id=kubeconfig>kubeconfig<a class=headerlink href=#kubeconfig title="Permanent link">&para;</a></h4> <ul> <li> <p>kubeconfig</p> <ul> <li> <p>當我們要存取 K8s 叢集的資源時，需提供相關認證資訊。但如果每次都這麼做，會有點麻煩。因此，我們可以設定 kubeconfig 檔案，來存放這些認證資訊 <img alt src=../../assets/pics/k8s/not_using_kubeconfig.png.png></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-171-1><a id=__codelineno-171-1 name=__codelineno-171-1 href=#__codelineno-171-1></a>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>--kubeconfig<span class=w> </span>&lt;config-file-name&gt;
</span></code></pre></div> </li> <li> <p>kubeconfig 檔案會包含以下三個部分</p> <ul> <li>Cluster: 關於 K8s 叢集的資訊</li> <li>Context: 關於使用者如何存取 K8s 叢集的資訊 (將 Cluster &amp; User 結合在一起)</li> <li>User: 關於使用者的資訊 <img alt src=../../../assets/pics/k8s/kubeconfig_structure.png> <img alt src=../../../assets/pics/k8s/kubeconfig_yaml.png></li> </ul> </li> <li> <p>檢視當前 K8s 叢集正在使用的 kubeconfig 設定檔內容 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-172-1><a id=__codelineno-172-1 name=__codelineno-172-1 href=#__codelineno-172-1></a>kubectl<span class=w> </span>config<span class=w> </span>view
</span></code></pre></div></p> <p><img alt src=../../assets/pics/k8s/view_kubeconfig_content.png></p> </li> <li> <p>檢視指定路徑下的 kubeconfig 設定檔內容 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-173-1><a id=__codelineno-173-1 name=__codelineno-173-1 href=#__codelineno-173-1></a>kubectl<span class=w> </span>config<span class=w> </span>veiw<span class=w> </span>--kubeconfig<span class=o>=</span>my-custom-config
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/view_kubeconfig_file_content.png></p> </li> <li> <p>更新當前使用的 kubeconfig context 設定 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-174-1><a id=__codelineno-174-1 name=__codelineno-174-1 href=#__codelineno-174-1></a>kubectl<span class=w> </span>config<span class=w> </span>use-context<span class=w> </span>&lt;context-name&gt;
</span><span id=__span-174-2><a id=__codelineno-174-2 name=__codelineno-174-2 href=#__codelineno-174-2></a>kubectl<span class=w> </span>config<span class=w> </span>use-context<span class=w> </span>prod-user@production
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/update_kubeconfig_current_context.png></p> </li> <li> <p>設定 kubeconfig 中 context 的 namespace <img alt src=../../../assets/pics/k8s/set_kubeconfig_context_namespace.png></p> </li> <li> <p>設定 kubeconfig 中 context 的 TLS 證書</p> <ul> <li> <p>法一: 可指定 TLS 證書的路徑位置 <img alt src=../../../assets/pics/k8s/set_tls_certificate_in_kubeconfig_by_file_path.png></p> </li> <li> <p>法二: 可指定 TLS 證書的 base64 編碼內容 <img alt src=../../../assets/pics/k8s/set_tls_certificate_in_kubeconfig_by_base64_content_1.png> <img alt src=../../../assets/pics/k8s/set_tls_certificate_in_kubeconfig_by_base64_content_2.png></p> </li> </ul> </li> </ul> </li> </ul> <h3 id=authorization>Authorization<a class=headerlink href=#authorization title="Permanent link">&para;</a></h3> <h4 id=k8s-api-groups>K8s API groups<a class=headerlink href=#k8s-api-groups title="Permanent link">&para;</a></h4> <ul> <li> <p>檢視當前 K8s 叢集的版本號 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-175-1><a id=__codelineno-175-1 name=__codelineno-175-1 href=#__codelineno-175-1></a>curl<span class=w> </span>https://kube-master:6443/version
</span></code></pre></div></p> </li> <li> <p>檢視當前 K8s 叢集有哪些 Pods <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-176-1><a id=__codelineno-176-1 name=__codelineno-176-1 href=#__codelineno-176-1></a>curl<span class=w> </span>https://kube-master:6443/api/v1/pods
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/curl_get_k8s_version_and_pods.png></p> </li> <li> <p>K8s 叢集的 APIs 會根據用途劃分為以下的群組:</p> <ul> <li><code>/metrics</code>: 提供系統性能、資源使用的指標數據，常用於監控</li> <li><code>/healthz</code>: 提供應用程序的健康狀態檢查，用於確認應用程式是否正常運行</li> <li><code>/version</code>: 顯示 kube-apiserver 的版本資訊</li> <li> <p><code>/api</code>: 核心 API 的入口，處理基本的 K8s 資源 <img alt src=../../../assets/pics/k8s/api_group_core_group.png></p> </li> <li> <p><code>/apis</code>: 擴展 API 的入口，處理更專門的 K8s 資源 <img alt src=../../../assets/pics/k8s/api_group_named_group.png></p> </li> <li> <p><code>/logs</code>: 提供 log 數據，通常用於除錯、監控 <img alt src=../../../assets/pics/k8s/k8s_api_groups.png></p> </li> </ul> </li> <li> <p>列出所有的 API groups <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-177-1><a id=__codelineno-177-1 name=__codelineno-177-1 href=#__codelineno-177-1></a>curl<span class=w> </span>http://localhost:6443<span class=w> </span>-k
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-178-1><a id=__codelineno-178-1 name=__codelineno-178-1 href=#__codelineno-178-1></a>curl<span class=w> </span>http://localhost:6443/apis<span class=w> </span>-k<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s2>&quot;name&quot;</span>
</span></code></pre></div> <ul> <li><code>-k</code>: 用於告訴 curl 忽略 SSL 證書的驗證，通常用於本地端 or 測試環境 <img alt src=../../../assets/pics/k8s/list_all_api_groups.png></li> </ul> </li> <li> <p>存取 kube-apiserver 的方法</p> <ul> <li> <p>法一: curl 指令 + TLS 證書 (較複雜) <img alt src=../../../assets/pics/k8s/access_kube_apiserver_using_tls_certification_option.png></p> </li> <li> <p>法二: kubectl-proxy 作為代理伺服器，來存取 kube-apiserver <img alt src=../../../assets/pics/k8s/kubectl_proxy.png></p> <ul> <li>注意! <strong>kube-proxy 不等於 kubectl-proxy</strong> <img alt src=../../../assets/pics/k8s/kube_proxy_is_not_equal_to_kubectl_proxy.png></li> </ul> </li> </ul> </li> </ul> <h4 id=authorization-mechanisms>Authorization Mechanisms<a class=headerlink href=#authorization-mechanisms title="Permanent link">&para;</a></h4> <ul> <li> <p>K8s 叢集支援以下幾種授權機制，來控制 K8s API 的存取權限</p> <ul> <li> <p>Node Authorization: 決定 Node 是否能加入 K8s 叢集 <img alt src=../../../assets/pics/k8s/node_authorization.png></p> </li> <li> <p>ABAC (Attribute-Based Access Control): 基於使用者的屬性來控制存取權限 <img alt src=../../../assets/pics/k8s/abac.png></p> </li> <li> <p>RBAC (Role-Based Access Control): 基於角色來控制存取權限 <img alt src=../../../assets/pics/k8s/rbac.png></p> </li> <li> <p>Webhook Mode: 透過 Webhook 服務，由 K8s 叢集外部的服務進行授權決策 <img alt src=../../../assets/pics/k8s/webhook.png></p> </li> <li> <p>AlwaysAllow: 無論任何情況，都允許存取</p> <ul> <li>這是 <strong>K8s 叢集的預設授權機制</strong> <img alt src=../../../assets/pics/k8s/always_allow.png></li> </ul> </li> <li> <p>AlwaysDeny: 無論任何情況，都拒絕存取</p> </li> </ul> </li> <li> <p>若同時使用多種授權機制，K8s 叢集會按照所列出的順序，進行授權決策</p> <ul> <li>若前一個授權機制拒絕請求的話，就由下一個授權機制進行授權決策，依此類推</li> <li>一旦某個授權機制允許請求，就不會再繼續往下進行授權決策 <img alt src=../../../assets/pics/k8s/authorization_mode_multiple_options.png></li> </ul> </li> </ul> <h4 id=rbac-authorization>RBAC authorization<a class=headerlink href=#rbac-authorization title="Permanent link">&para;</a></h4> <ul> <li>每個 Role 會包含三個區塊<ul> <li>apiGroups: 指定使用 API 群組<ul> <li><code>""</code>: 表示 core API 群組</li> <li><code>apps</code>: 表示 named API 群組</li> </ul> </li> <li>resources: 指定可存取的 K8s 物件有哪些</li> <li>verbs: 指定對資源可執行的操作有哪些</li> </ul> </li> <li> <p>建立 Role <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-179-1><a id=__codelineno-179-1 name=__codelineno-179-1 href=#__codelineno-179-1></a><span class=c1># developer-role.yaml</span>
</span><span id=__span-179-2><a id=__codelineno-179-2 name=__codelineno-179-2 href=#__codelineno-179-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
</span><span id=__span-179-3><a id=__codelineno-179-3 name=__codelineno-179-3 href=#__codelineno-179-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Role</span>
</span><span id=__span-179-4><a id=__codelineno-179-4 name=__codelineno-179-4 href=#__codelineno-179-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-179-5><a id=__codelineno-179-5 name=__codelineno-179-5 href=#__codelineno-179-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">developer</span>
</span><span id=__span-179-6><a id=__codelineno-179-6 name=__codelineno-179-6 href=#__codelineno-179-6></a>
</span><span id=__span-179-7><a id=__codelineno-179-7 name=__codelineno-179-7 href=#__codelineno-179-7></a><span class=c1># 指定授權的規則</span>
</span><span id=__span-179-8><a id=__codelineno-179-8 name=__codelineno-179-8 href=#__codelineno-179-8></a><span class=nt>rules</span><span class=p>:</span>
</span><span id=__span-179-9><a id=__codelineno-179-9 name=__codelineno-179-9 href=#__codelineno-179-9></a><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span><span class=w>        </span><span class=c1># &quot;&quot; indicates the core API group</span>
</span><span id=__span-179-10><a id=__codelineno-179-10 name=__codelineno-179-10 href=#__codelineno-179-10></a><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;pods&quot;</span><span class="p p-Indicator">]</span>
</span><span id=__span-179-11><a id=__codelineno-179-11 name=__codelineno-179-11 href=#__codelineno-179-11></a><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;update&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;delete&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">]</span>
</span><span id=__span-179-12><a id=__codelineno-179-12 name=__codelineno-179-12 href=#__codelineno-179-12></a>
</span><span id=__span-179-13><a id=__codelineno-179-13 name=__codelineno-179-13 href=#__codelineno-179-13></a><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
</span><span id=__span-179-14><a id=__codelineno-179-14 name=__codelineno-179-14 href=#__codelineno-179-14></a><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;ConfigMap&quot;</span><span class="p p-Indicator">]</span>
</span><span id=__span-179-15><a id=__codelineno-179-15 name=__codelineno-179-15 href=#__codelineno-179-15></a><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">]</span>
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-180-1><a id=__codelineno-180-1 name=__codelineno-180-1 href=#__codelineno-180-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>developer-role.yaml
</span></code></pre></div> </li> <li> <p>根據 Role，建立 RoleBinding <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-181-1><a id=__codelineno-181-1 name=__codelineno-181-1 href=#__codelineno-181-1></a><span class=c1># developer-role-binding.yaml</span>
</span><span id=__span-181-2><a id=__codelineno-181-2 name=__codelineno-181-2 href=#__codelineno-181-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
</span><span id=__span-181-3><a id=__codelineno-181-3 name=__codelineno-181-3 href=#__codelineno-181-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">RoleBinding</span>
</span><span id=__span-181-4><a id=__codelineno-181-4 name=__codelineno-181-4 href=#__codelineno-181-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-181-5><a id=__codelineno-181-5 name=__codelineno-181-5 href=#__codelineno-181-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">devuser-developer-binding</span>
</span><span id=__span-181-6><a id=__codelineno-181-6 name=__codelineno-181-6 href=#__codelineno-181-6></a>
</span><span id=__span-181-7><a id=__codelineno-181-7 name=__codelineno-181-7 href=#__codelineno-181-7></a><span class=c1># 指定要授權的使用者</span>
</span><span id=__span-181-8><a id=__codelineno-181-8 name=__codelineno-181-8 href=#__codelineno-181-8></a><span class=nt>subjects</span><span class=p>:</span>
</span><span id=__span-181-9><a id=__codelineno-181-9 name=__codelineno-181-9 href=#__codelineno-181-9></a><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">User</span>
</span><span id=__span-181-10><a id=__codelineno-181-10 name=__codelineno-181-10 href=#__codelineno-181-10></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dev-user</span><span class=w> </span><span class=c1># &quot;name&quot; is case sensitive</span>
</span><span id=__span-181-11><a id=__codelineno-181-11 name=__codelineno-181-11 href=#__codelineno-181-11></a><span class=w>    </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
</span><span id=__span-181-12><a id=__codelineno-181-12 name=__codelineno-181-12 href=#__codelineno-181-12></a>
</span><span id=__span-181-13><a id=__codelineno-181-13 name=__codelineno-181-13 href=#__codelineno-181-13></a><span class=c1># 指定要授予的 Role</span>
</span><span id=__span-181-14><a id=__codelineno-181-14 name=__codelineno-181-14 href=#__codelineno-181-14></a><span class=nt>roleRef</span><span class=p>:</span>
</span><span id=__span-181-15><a id=__codelineno-181-15 name=__codelineno-181-15 href=#__codelineno-181-15></a><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Role</span>
</span><span id=__span-181-16><a id=__codelineno-181-16 name=__codelineno-181-16 href=#__codelineno-181-16></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">developer</span>
</span><span id=__span-181-17><a id=__codelineno-181-17 name=__codelineno-181-17 href=#__codelineno-181-17></a><span class=w>    </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-182-1><a id=__codelineno-182-1 name=__codelineno-182-1 href=#__codelineno-182-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>devuser-developer-binding.yaml
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/rbac_create_role_and_rolebinding.png></p> </li> <li> <p>列出當前所有 RBAC 的 Role <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-183-1><a id=__codelineno-183-1 name=__codelineno-183-1 href=#__codelineno-183-1></a>kubectl<span class=w> </span>get<span class=w> </span>roles
</span></code></pre></div></p> </li> <li> <p>詳細檢視指定 Role 的資訊 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-184-1><a id=__codelineno-184-1 name=__codelineno-184-1 href=#__codelineno-184-1></a>kubectl<span class=w> </span>describe<span class=w> </span>role<span class=w> </span>developer
</span></code></pre></div></p> </li> <li> <p>列出當前所有 RBAC 的 RoleBinding <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-185-1><a id=__codelineno-185-1 name=__codelineno-185-1 href=#__codelineno-185-1></a>kubectl<span class=w> </span>get<span class=w> </span>rolebindings
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/get_all_rolebindings.png></p> </li> <li> <p>詳細檢視指定 RoleBinding 的資訊 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-186-1><a id=__codelineno-186-1 name=__codelineno-186-1 href=#__codelineno-186-1></a>kubectl<span class=w> </span>describe<span class=w> </span>rolebinding<span class=w> </span>devuser-developer-binding
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/describe_rolebinding.png></p> </li> </ul> <h4 id=check-access-control>Check Access Control<a class=headerlink href=#check-access-control title="Permanent link">&para;</a></h4> <ul> <li> <p>檢視當前使用者的<strong>對於某個操作的存取權限</strong> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-187-1><a id=__codelineno-187-1 name=__codelineno-187-1 href=#__codelineno-187-1></a>kubectl<span class=w> </span>auth<span class=w> </span>can-i<span class=w> </span>create<span class=w> </span>deployments
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-188-1><a id=__codelineno-188-1 name=__codelineno-188-1 href=#__codelineno-188-1></a>kubectl<span class=w> </span>auth<span class=w> </span>can-i<span class=w> </span>delete<span class=w> </span>nodes
</span></code></pre></div> </li> <li> <p><strong>以指定使用者的身份</strong>，檢視其對於某個操作的存取權限 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-189-1><a id=__codelineno-189-1 name=__codelineno-189-1 href=#__codelineno-189-1></a>kubectl<span class=w> </span>auth<span class=w> </span>can-i<span class=w> </span>create<span class=w> </span>deployments<span class=w> </span>--as<span class=o>=</span>dev-user
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-190-1><a id=__codelineno-190-1 name=__codelineno-190-1 href=#__codelineno-190-1></a>kubectl<span class=w> </span>auth<span class=w> </span>can-i<span class=w> </span>create<span class=w> </span>pods<span class=w> </span>--as<span class=o>=</span>dev-user
</span></code></pre></div> </li> <li> <p>在指定的 namespace 中，以指定的使用者身份，檢視其對於某個操作的存取權限 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-191-1><a id=__codelineno-191-1 name=__codelineno-191-1 href=#__codelineno-191-1></a>kubectl<span class=w> </span>auth<span class=w> </span>can-i<span class=w> </span>create<span class=w> </span>pods<span class=w> </span>--as<span class=w> </span>dev-user<span class=w> </span>--namespace<span class=o>=</span><span class=nb>test</span>
</span></code></pre></div></p> </li> </ul> <p><img alt src=../../../assets/pics/k8s/check_rbac_access_control.png></p> <h4 id=resource-names>Resource Names<a class=headerlink href=#resource-names title="Permanent link">&para;</a></h4> <ul> <li> <p>指定哪些 K8s 資源可以被存取</p> <ul> <li>e.g. Pods</li> </ul> <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-192-1><a id=__codelineno-192-1 name=__codelineno-192-1 href=#__codelineno-192-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
</span><span id=__span-192-2><a id=__codelineno-192-2 name=__codelineno-192-2 href=#__codelineno-192-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Role</span>
</span><span id=__span-192-3><a id=__codelineno-192-3 name=__codelineno-192-3 href=#__codelineno-192-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-192-4><a id=__codelineno-192-4 name=__codelineno-192-4 href=#__codelineno-192-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">developer</span>
</span><span id=__span-192-5><a id=__codelineno-192-5 name=__codelineno-192-5 href=#__codelineno-192-5></a>
</span><span id=__span-192-6><a id=__codelineno-192-6 name=__codelineno-192-6 href=#__codelineno-192-6></a><span class=c1># 指定授權的規則</span>
</span><span id=__span-192-7><a id=__codelineno-192-7 name=__codelineno-192-7 href=#__codelineno-192-7></a><span class=nt>rules</span><span class=p>:</span>
</span><span id=__span-192-8><a id=__codelineno-192-8 name=__codelineno-192-8 href=#__codelineno-192-8></a><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span><span class=w>      </span><span class=c1># &quot;&quot; indicates the core API group</span>
</span><span id=__span-192-9><a id=__codelineno-192-9 name=__codelineno-192-9 href=#__codelineno-192-9></a><span class=w>    </span><span class=c1># 指定可以存取的 K8s 資源</span>
</span><span id=__span-192-10><a id=__codelineno-192-10 name=__codelineno-192-10 href=#__codelineno-192-10></a><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;pods&quot;</span><span class="p p-Indicator">]</span><span class=w> </span>
</span><span id=__span-192-11><a id=__codelineno-192-11 name=__codelineno-192-11 href=#__codelineno-192-11></a><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;update&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">]</span>
</span><span id=__span-192-12><a id=__codelineno-192-12 name=__codelineno-192-12 href=#__codelineno-192-12></a><span class=w>    </span><span class=nt>resourceNames</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;blue&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;orange&quot;</span><span class="p p-Indicator">]</span>
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/resource_names.png></p> </li> </ul> <h4 id=cluster-roles>Cluster Roles<a class=headerlink href=#cluster-roles title="Permanent link">&para;</a></h4> <ul> <li> <p>一般的 Role 是針對某個 namespace 來進行授權 <img alt src=../../../assets/pics/k8s/roles_with_namespace.png></p> </li> <li> <p>而 <strong>Cluster Role 是針對整個 K8s 叢集來進行授權</strong></p> <ul> <li>e.g. 我們無法對 Node 進行資源隔離，因為 Node 是屬於整個 K8s 叢集的，而不是隸屬於某個 namespace 的 <img alt src=../../../assets/pics/k8s/cluster_roles_cannot_use_namespace.png></li> </ul> </li> <li> <p>因此，K8s 叢集中的所有資源可分為以下兩種</p> <ul> <li> <p>Namespaced Resources: 只能在特定的 namespace 中存取 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-193-1><a id=__codelineno-193-1 name=__codelineno-193-1 href=#__codelineno-193-1></a>kubectl<span class=w> </span>api-resources<span class=w> </span>--namespaced<span class=o>=</span><span class=nb>true</span>
</span></code></pre></div></p> </li> <li> <p>Cluster-scoped Resources: 可在整個 K8s 叢集中存取 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-194-1><a id=__codelineno-194-1 name=__codelineno-194-1 href=#__codelineno-194-1></a>kubectl<span class=w> </span>api-resources<span class=w> </span>--namespaced<span class=o>=</span><span class=nb>false</span>
</span></code></pre></div></p> </li> </ul> <p><img alt src=../../../assets/pics/k8s/namespaced_and_cluster_scoped_resources.png></p> </li> <li> <p>建立 Cluster Role <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-195-1><a id=__codelineno-195-1 name=__codelineno-195-1 href=#__codelineno-195-1></a><span class=c1># cluster-role.yaml</span>
</span><span id=__span-195-2><a id=__codelineno-195-2 name=__codelineno-195-2 href=#__codelineno-195-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
</span><span id=__span-195-3><a id=__codelineno-195-3 name=__codelineno-195-3 href=#__codelineno-195-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
</span><span id=__span-195-4><a id=__codelineno-195-4 name=__codelineno-195-4 href=#__codelineno-195-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-195-5><a id=__codelineno-195-5 name=__codelineno-195-5 href=#__codelineno-195-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cluster-administrator</span>
</span><span id=__span-195-6><a id=__codelineno-195-6 name=__codelineno-195-6 href=#__codelineno-195-6></a>
</span><span id=__span-195-7><a id=__codelineno-195-7 name=__codelineno-195-7 href=#__codelineno-195-7></a><span class=c1># 指定授權的規則</span>
</span><span id=__span-195-8><a id=__codelineno-195-8 name=__codelineno-195-8 href=#__codelineno-195-8></a><span class=nt>rules</span><span class=p>:</span>
</span><span id=__span-195-9><a id=__codelineno-195-9 name=__codelineno-195-9 href=#__codelineno-195-9></a><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span><span class=w> </span><span class=c1># &quot;&quot; indicates the core API group</span>
</span><span id=__span-195-10><a id=__codelineno-195-10 name=__codelineno-195-10 href=#__codelineno-195-10></a><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;nodes&quot;</span><span class="p p-Indicator">]</span>
</span><span id=__span-195-11><a id=__codelineno-195-11 name=__codelineno-195-11 href=#__codelineno-195-11></a><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;delete&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">]</span>
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-196-1><a id=__codelineno-196-1 name=__codelineno-196-1 href=#__codelineno-196-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>cluster-admin-role.yaml
</span></code></pre></div> </li> <li> <p>建立 Cluster RoleBinding <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-197-1><a id=__codelineno-197-1 name=__codelineno-197-1 href=#__codelineno-197-1></a><span class=c1># cluster-admin-role-binding.yaml</span>
</span><span id=__span-197-2><a id=__codelineno-197-2 name=__codelineno-197-2 href=#__codelineno-197-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
</span><span id=__span-197-3><a id=__codelineno-197-3 name=__codelineno-197-3 href=#__codelineno-197-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
</span><span id=__span-197-4><a id=__codelineno-197-4 name=__codelineno-197-4 href=#__codelineno-197-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-197-5><a id=__codelineno-197-5 name=__codelineno-197-5 href=#__codelineno-197-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cluster-admin-role-binding</span>
</span><span id=__span-197-6><a id=__codelineno-197-6 name=__codelineno-197-6 href=#__codelineno-197-6></a>
</span><span id=__span-197-7><a id=__codelineno-197-7 name=__codelineno-197-7 href=#__codelineno-197-7></a><span class=c1># 指定要授權的使用者</span>
</span><span id=__span-197-8><a id=__codelineno-197-8 name=__codelineno-197-8 href=#__codelineno-197-8></a><span class=nt>subjects</span><span class=p>:</span>
</span><span id=__span-197-9><a id=__codelineno-197-9 name=__codelineno-197-9 href=#__codelineno-197-9></a><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">User</span>
</span><span id=__span-197-10><a id=__codelineno-197-10 name=__codelineno-197-10 href=#__codelineno-197-10></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cluster-admin</span>
</span><span id=__span-197-11><a id=__codelineno-197-11 name=__codelineno-197-11 href=#__codelineno-197-11></a><span class=w>    </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
</span><span id=__span-197-12><a id=__codelineno-197-12 name=__codelineno-197-12 href=#__codelineno-197-12></a>
</span><span id=__span-197-13><a id=__codelineno-197-13 name=__codelineno-197-13 href=#__codelineno-197-13></a><span class=c1># 指定要授予的 Cluster Role</span>
</span><span id=__span-197-14><a id=__codelineno-197-14 name=__codelineno-197-14 href=#__codelineno-197-14></a><span class=nt>roleRef</span><span class=p>:</span>
</span><span id=__span-197-15><a id=__codelineno-197-15 name=__codelineno-197-15 href=#__codelineno-197-15></a><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
</span><span id=__span-197-16><a id=__codelineno-197-16 name=__codelineno-197-16 href=#__codelineno-197-16></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cluster-administrator</span>
</span><span id=__span-197-17><a id=__codelineno-197-17 name=__codelineno-197-17 href=#__codelineno-197-17></a><span class=w>    </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-198-1><a id=__codelineno-198-1 name=__codelineno-198-1 href=#__codelineno-198-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>cluster-admin-role-binding.yaml
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/cluster_role_and_cluster_rolebinding.png></p> </li> </ul> <h4 id=service-account>Service Account<a class=headerlink href=#service-account title="Permanent link">&para;</a></h4> <ul> <li> <p>一般的 User Account 供人類使用; 而 Service Account 供應用程式使用 <img alt src=../../../assets/pics/k8s/user_account_and_service_account.png></p> </li> <li> <p>在 K8s v1.24 版之後的更新</p> <ul> <li> <p>建立 Service Account 時，不會再自動建立 token，而是<strong>需要透過 TokenRequest API，建立 Service Account 的 token</strong> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-199-1><a id=__codelineno-199-1 name=__codelineno-199-1 href=#__codelineno-199-1></a><span class=c1># 建立 Service Account</span>
</span><span id=__span-199-2><a id=__codelineno-199-2 name=__codelineno-199-2 href=#__codelineno-199-2></a>kubectl<span class=w> </span>create<span class=w> </span>serviceaccount<span class=w> </span>dashboard-sa
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-200-1><a id=__codelineno-200-1 name=__codelineno-200-1 href=#__codelineno-200-1></a><span class=c1># 透過 TokenRequest API，建立 Service Account 的 token</span>
</span><span id=__span-200-2><a id=__codelineno-200-2 name=__codelineno-200-2 href=#__codelineno-200-2></a>kubectl<span class=w> </span>create<span class=w> </span>token<span class=w> </span>dashboard-sa
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/service_account_generate_token.png></p> </li> <li> <p>解碼 Service Account 的 token <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-201-1><a id=__codelineno-201-1 name=__codelineno-201-1 href=#__codelineno-201-1></a>jq<span class=w> </span>-R<span class=w> </span><span class=s1>&#39;split(&quot;.&quot;) | select(length &gt; 0) | .[0], .[1] | @base64d | fromjson&#39;</span><span class=w> </span><span class=o>&lt;&lt;&lt;</span><span class=w> </span>eyJhbGciOiJSUzI...
</span></code></pre></div></p> </li> <li> <p>Service token 具有有效期限</p> <ul> <li><code>exp</code>: token 的過期時間<ul> <li>預設: 1 小時</li> </ul> </li> </ul> <p><img alt src=../../../assets/pics/k8s/decode_service_account_token.png></p> </li> <li> <p>若想建立一個永久有效的 token，可建立一個 Secret 物件，並將 token 儲存綁定 Service Account <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-202-1><a id=__codelineno-202-1 name=__codelineno-202-1 href=#__codelineno-202-1></a><span class=c1># secret-definition.yaml</span>
</span><span id=__span-202-2><a id=__codelineno-202-2 name=__codelineno-202-2 href=#__codelineno-202-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-202-3><a id=__codelineno-202-3 name=__codelineno-202-3 href=#__codelineno-202-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
</span><span id=__span-202-4><a id=__codelineno-202-4 name=__codelineno-202-4 href=#__codelineno-202-4></a><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/service-account-token</span>
</span><span id=__span-202-5><a id=__codelineno-202-5 name=__codelineno-202-5 href=#__codelineno-202-5></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-202-6><a id=__codelineno-202-6 name=__codelineno-202-6 href=#__codelineno-202-6></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mysecretname</span>
</span><span id=__span-202-7><a id=__codelineno-202-7 name=__codelineno-202-7 href=#__codelineno-202-7></a><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
</span><span id=__span-202-8><a id=__codelineno-202-8 name=__codelineno-202-8 href=#__codelineno-202-8></a>
</span><span id=__span-202-9><a id=__codelineno-202-9 name=__codelineno-202-9 href=#__codelineno-202-9></a><span class=w>    </span><span class=c1># 綁定 Service Account</span>
</span><span id=__span-202-10><a id=__codelineno-202-10 name=__codelineno-202-10 href=#__codelineno-202-10></a><span class=w>    </span><span class=nt>annotations</span><span class=p>:</span>
</span><span id=__span-202-11><a id=__codelineno-202-11 name=__codelineno-202-11 href=#__codelineno-202-11></a><span class=w>        </span><span class=nt>kubernetes.io/service-account.name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dashboard-sa</span>
</span><span id=__span-202-12><a id=__codelineno-202-12 name=__codelineno-202-12 href=#__codelineno-202-12></a>
</span><span id=__span-202-13><a id=__codelineno-202-13 name=__codelineno-202-13 href=#__codelineno-202-13></a><span class=c1># 給定 secret token 值</span>
</span><span id=__span-202-14><a id=__codelineno-202-14 name=__codelineno-202-14 href=#__codelineno-202-14></a><span class=nt>stringData</span><span class=p>:</span>
</span><span id=__span-202-15><a id=__codelineno-202-15 name=__codelineno-202-15 href=#__codelineno-202-15></a><span class=w>    </span><span class=nt>token</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">eyJhbGciOi</span>
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-203-1><a id=__codelineno-203-1 name=__codelineno-203-1 href=#__codelineno-203-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>secret-definition.yaml
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/service_account_generate_token_using_k8s_secret.png></p> </li> </ul> </li> </ul> <h3 id=images-security>Images Security<a class=headerlink href=#images-security title="Permanent link">&para;</a></h3> <ul> <li> <p>檢視 container 所使用的 image <img alt src=../../../assets/pics/k8s/container_image_name.png></p> </li> <li> <p>image name 的完整格式</p> <ul> <li>username/account: 預設是 library，是 Docker Hub 的預設 public namespace，用來儲存一些知名且常用的官方 image <img alt src=../../../assets/pics/k8s/container_image_name_fqdn.png></li> </ul> </li> <li> <p>若要<strong>使用 Docker</strong> 登入 private registry，並使用 private image <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-204-1><a id=__codelineno-204-1 name=__codelineno-204-1 href=#__codelineno-204-1></a>docker<span class=w> </span>login<span class=w> </span>&lt;private-registry.io&gt;
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-205-1><a id=__codelineno-205-1 name=__codelineno-205-1 href=#__codelineno-205-1></a>docker<span class=w> </span>run<span class=w> </span>&lt;private-registry.io/apps/internal-app&gt;
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/docker_login_private_registry.png></p> </li> <li> <p><strong>在 K8s 中，需先建立一個 docker-registry secret 物件</strong>，來存放登入 private registry 的認證資訊 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-206-1><a id=__codelineno-206-1 name=__codelineno-206-1 href=#__codelineno-206-1></a>kubectl<span class=w> </span>create<span class=w> </span>secret<span class=w> </span>docker-registry<span class=w> </span>regcred<span class=w> </span><span class=se>\</span>
</span><span id=__span-206-2><a id=__codelineno-206-2 name=__codelineno-206-2 href=#__codelineno-206-2></a><span class=w>    </span>--docker-server<span class=o>=</span>private-registry.io<span class=w> </span><span class=se>\ </span>
</span><span id=__span-206-3><a id=__codelineno-206-3 name=__codelineno-206-3 href=#__codelineno-206-3></a><span class=w>    </span>--docker-username<span class=o>=</span>registry-user<span class=w> </span><span class=se>\</span>
</span><span id=__span-206-4><a id=__codelineno-206-4 name=__codelineno-206-4 href=#__codelineno-206-4></a><span class=w>    </span>--docker-password<span class=o>=</span>registry-password<span class=w> </span><span class=se>\</span>
</span><span id=__span-206-5><a id=__codelineno-206-5 name=__codelineno-206-5 href=#__codelineno-206-5></a><span class=w>    </span>--docker-email<span class=o>=</span>registry-user@org.com
</span></code></pre></div></p> <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-207-1><a id=__codelineno-207-1 name=__codelineno-207-1 href=#__codelineno-207-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-207-2><a id=__codelineno-207-2 name=__codelineno-207-2 href=#__codelineno-207-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-207-3><a id=__codelineno-207-3 name=__codelineno-207-3 href=#__codelineno-207-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-207-4><a id=__codelineno-207-4 name=__codelineno-207-4 href=#__codelineno-207-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx-pod</span>
</span><span id=__span-207-5><a id=__codelineno-207-5 name=__codelineno-207-5 href=#__codelineno-207-5></a>
</span><span id=__span-207-6><a id=__codelineno-207-6 name=__codelineno-207-6 href=#__codelineno-207-6></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-207-7><a id=__codelineno-207-7 name=__codelineno-207-7 href=#__codelineno-207-7></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-207-8><a id=__codelineno-207-8 name=__codelineno-207-8 href=#__codelineno-207-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-207-9><a id=__codelineno-207-9 name=__codelineno-207-9 href=#__codelineno-207-9></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">private-registry.io/apps/internal-app</span>
</span><span id=__span-207-10><a id=__codelineno-207-10 name=__codelineno-207-10 href=#__codelineno-207-10></a>
</span><span id=__span-207-11><a id=__codelineno-207-11 name=__codelineno-207-11 href=#__codelineno-207-11></a><span class=w>    </span><span class=c1># 指定要使用的 docker-registry secret</span>
</span><span id=__span-207-12><a id=__codelineno-207-12 name=__codelineno-207-12 href=#__codelineno-207-12></a><span class=w>    </span><span class=nt>imagePullSecrets</span><span class=p>:</span>
</span><span id=__span-207-13><a id=__codelineno-207-13 name=__codelineno-207-13 href=#__codelineno-207-13></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">regcred</span>
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/k8s_secret_docker_registry.png></p> </li> </ul> <h3 id=security-contexts>Security Contexts<a class=headerlink href=#security-contexts title="Permanent link">&para;</a></h3> <ul> <li> <p>Docker Security 先備知識</p> <ul> <li> <p>container 與 host 共享相同的 O.S. kernel，因此不算是完全的資源隔離</p> <ul> <li> <p>在 Linux 中，container 是透過 namespace, cgroup 來實現資源隔離</p> <ul> <li>namespace: 用於隔離 process</li> <li>cgroup: 用於分配資源<blockquote> <p>不同 namespace 的情況下，可以存在相同的 process ID 不會互相干擾</p> </blockquote> </li> </ul> </li> <li> <p>container 與 host 使用不同的 namespace</p> </li> <li>所有在 container 中運行的 process 實際上都是在 host 上執行的，<strong>但是在 container 自己的 namespace 中運行</strong></li> <li>docker container 位於自己的 namespace 中，並且只能看到自己的 namespace 中的 process <img alt src=../../../assets/pics/k8s/container_process.png></li> <li> <p>對於 host 而言，container 中的 process 就像是 host 上的其他 process 一樣 <img alt src=../../../assets/pics/k8s/host_process.png></p> </li> <li> <p>Host 預設會使用 root 身份，來執行 container 中的 process</p> <ul> <li> <p>可透過 <code>--user</code> 選項，來指定 container 中的 process 使用者身份 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-208-1><a id=__codelineno-208-1 name=__codelineno-208-1 href=#__codelineno-208-1></a>docker<span class=w> </span>run<span class=w> </span>--user<span class=o>=</span><span class=m>1000</span><span class=w> </span>ubuntu<span class=w> </span>sleep<span class=w> </span><span class=m>3600</span>
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/docker_run_setting_user.png></p> </li> <li> <p>也可透過 Dockerfile 指定使用者身份，未來當 container 執行這個 image 時，就會預設用這個使用者身份 <div class="language-dockerfile highlight"><span class=filename>Docker</span><pre><span></span><code><span id=__span-209-1><a id=__codelineno-209-1 name=__codelineno-209-1 href=#__codelineno-209-1></a><span class=c># my-ubuntu-image.Dockerfile</span>
</span><span id=__span-209-2><a id=__codelineno-209-2 name=__codelineno-209-2 href=#__codelineno-209-2></a><span class=k>FROM</span><span class=w> </span><span class=s>ubuntu</span>
</span><span id=__span-209-3><a id=__codelineno-209-3 name=__codelineno-209-3 href=#__codelineno-209-3></a><span class=k>USER</span><span class=w> </span><span class=s>1</span>
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-210-1><a id=__codelineno-210-1 name=__codelineno-210-1 href=#__codelineno-210-1></a>docker<span class=w> </span>build<span class=w> </span>-t<span class=w> </span>my-ubuntu-image<span class=w> </span>.
</span></code></pre></div> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-211-1><a id=__codelineno-211-1 name=__codelineno-211-1 href=#__codelineno-211-1></a>docker<span class=w> </span>run<span class=w> </span>my-ubuntu-image<span class=w> </span>sleep<span class=w> </span><span class=m>3600</span>
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/dockerfile_setting_user.png></p> </li> <li> <p>透過 Docker 為我們實作的安全機制，<strong>container 中的 root 身份不同於 host 中的 root 身份，能限制其權限</strong></p> <ul> <li>e.g. 在 container 中的 root 身份，無法直接存取 host 中的檔案</li> <li> <p>Docker 實際上運用的是 Linux capability 來實作安全機制的 <img alt src=../../../assets/pics/k8s/linux_capability.png></p> </li> <li> <p>賦予 container 中的 process 某些 Linux capability 權限 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-212-1><a id=__codelineno-212-1 name=__codelineno-212-1 href=#__codelineno-212-1></a>docker<span class=w> </span>run<span class=w> </span>--cap-add<span class=o>=</span>NET_ADMIN<span class=w> </span>ubuntu<span class=w> </span>sleep<span class=w> </span><span class=m>3600</span>
</span></code></pre></div></p> </li> <li> <p>限制 container 中的 process 某些 Linux capability 權限 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-213-1><a id=__codelineno-213-1 name=__codelineno-213-1 href=#__codelineno-213-1></a>docker<span class=w> </span>run<span class=w> </span>--cap-drop<span class=o>=</span>NET_ADMIN<span class=w> </span>ubuntu<span class=w> </span>sleep<span class=w> </span><span class=m>3600</span>
</span></code></pre></div></p> </li> <li> <p>開放 container 中的 process 所有 Linux capability 權限 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-214-1><a id=__codelineno-214-1 name=__codelineno-214-1 href=#__codelineno-214-1></a>docker<span class=w> </span>run<span class=w> </span>--privileged<span class=w> </span>ubuntu<span class=w> </span>sleep<span class=w> </span><span class=m>3600</span>
</span></code></pre></div></p> </li> </ul> </li> </ul> </li> </ul> </li> </ul> </li> <li> <p>K8s Security</p> <ul> <li> <p>可以設定 <strong>Kubernetes Security 於 Pod level 或 container level</strong></p> <ul> <li>Pod Security Context: 設定整個 Pod 的安全性</li> <li>Container Security Context: 設定單一個 container 的安全性<blockquote> <p><strong>若兩個同時都有設定，則以 Container Security Context 為主</strong></p> </blockquote> </li> </ul> <p><img alt src=../../../assets/pics/k8s/k8s_security_pod_level_and_container_level.png></p> </li> <li> <p>Pod Level <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-215-1><a id=__codelineno-215-1 name=__codelineno-215-1 href=#__codelineno-215-1></a><span class=c1># pod-security-context.yaml</span>
</span><span id=__span-215-2><a id=__codelineno-215-2 name=__codelineno-215-2 href=#__codelineno-215-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-215-3><a id=__codelineno-215-3 name=__codelineno-215-3 href=#__codelineno-215-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-215-4><a id=__codelineno-215-4 name=__codelineno-215-4 href=#__codelineno-215-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-215-5><a id=__codelineno-215-5 name=__codelineno-215-5 href=#__codelineno-215-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">web-pod</span>
</span><span id=__span-215-6><a id=__codelineno-215-6 name=__codelineno-215-6 href=#__codelineno-215-6></a>
</span><span id=__span-215-7><a id=__codelineno-215-7 name=__codelineno-215-7 href=#__codelineno-215-7></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-215-8><a id=__codelineno-215-8 name=__codelineno-215-8 href=#__codelineno-215-8></a><span class=w>    </span><span class=c1># 設定 Pod level 的 security context</span>
</span><span id=__span-215-9><a id=__codelineno-215-9 name=__codelineno-215-9 href=#__codelineno-215-9></a><span class=w>    </span><span class=nt>securityContext</span><span class=p>:</span>
</span><span id=__span-215-10><a id=__codelineno-215-10 name=__codelineno-215-10 href=#__codelineno-215-10></a><span class=w>        </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
</span><span id=__span-215-11><a id=__codelineno-215-11 name=__codelineno-215-11 href=#__codelineno-215-11></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-215-12><a id=__codelineno-215-12 name=__codelineno-215-12 href=#__codelineno-215-12></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
</span><span id=__span-215-13><a id=__codelineno-215-13 name=__codelineno-215-13 href=#__codelineno-215-13></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
</span><span id=__span-215-14><a id=__codelineno-215-14 name=__codelineno-215-14 href=#__codelineno-215-14></a><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;sleep&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;3600&quot;</span><span class="p p-Indicator">]</span>
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/set_k8s_pod_level_security_context.png></p> </li> <li> <p>container Level <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-216-1><a id=__codelineno-216-1 name=__codelineno-216-1 href=#__codelineno-216-1></a><span class=c1># container-security-context.yaml</span>
</span><span id=__span-216-2><a id=__codelineno-216-2 name=__codelineno-216-2 href=#__codelineno-216-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-216-3><a id=__codelineno-216-3 name=__codelineno-216-3 href=#__codelineno-216-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-216-4><a id=__codelineno-216-4 name=__codelineno-216-4 href=#__codelineno-216-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-216-5><a id=__codelineno-216-5 name=__codelineno-216-5 href=#__codelineno-216-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">web-pod</span>
</span><span id=__span-216-6><a id=__codelineno-216-6 name=__codelineno-216-6 href=#__codelineno-216-6></a>
</span><span id=__span-216-7><a id=__codelineno-216-7 name=__codelineno-216-7 href=#__codelineno-216-7></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-216-8><a id=__codelineno-216-8 name=__codelineno-216-8 href=#__codelineno-216-8></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-216-9><a id=__codelineno-216-9 name=__codelineno-216-9 href=#__codelineno-216-9></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
</span><span id=__span-216-10><a id=__codelineno-216-10 name=__codelineno-216-10 href=#__codelineno-216-10></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
</span><span id=__span-216-11><a id=__codelineno-216-11 name=__codelineno-216-11 href=#__codelineno-216-11></a><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;sleep&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;3600&quot;</span><span class="p p-Indicator">]</span>
</span><span id=__span-216-12><a id=__codelineno-216-12 name=__codelineno-216-12 href=#__codelineno-216-12></a><span class=w>        </span><span class=c1># 設定 container level 的 security context</span>
</span><span id=__span-216-13><a id=__codelineno-216-13 name=__codelineno-216-13 href=#__codelineno-216-13></a><span class=w>        </span><span class=nt>securityContext</span><span class=p>:</span>
</span><span id=__span-216-14><a id=__codelineno-216-14 name=__codelineno-216-14 href=#__codelineno-216-14></a><span class=w>            </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
</span><span id=__span-216-15><a id=__codelineno-216-15 name=__codelineno-216-15 href=#__codelineno-216-15></a><span class=w>            </span><span class=c1># 設定 container 的 linux capability 權限</span>
</span><span id=__span-216-16><a id=__codelineno-216-16 name=__codelineno-216-16 href=#__codelineno-216-16></a><span class=w>            </span><span class=nt>capabilities</span><span class=p>:</span><span class=w> </span>
</span><span id=__span-216-17><a id=__codelineno-216-17 name=__codelineno-216-17 href=#__codelineno-216-17></a><span class=w>                </span><span class=nt>add</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;MAC_ADMIN&quot;</span><span class="p p-Indicator">]</span>
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/set_k8s_container_level_security_context.png></p> </li> </ul> </li> </ul> <h3 id=network-policies>Network Policies<a class=headerlink href=#network-policies title="Permanent link">&para;</a></h3> <ul> <li><strong>Network Policies 算是一種 K8s 物件</strong></li> <li> <p>Network Policies 有以下兩種 traffic</p> <ul> <li>Ingress (入口): 進入 Pod 的 traffic</li> <li>Egress (出口): 從 Pod 離開的 traffic <img alt src=../../../assets/pics/k8s/network_policies_two_types.png> <img alt src=../../../assets/pics/k8s/network_policies_ingress_and_egress_illustration.png></li> </ul> </li> <li> <p>K8s 預設是允許所有的 traffic 進出 Pod; 若想要限制 traffic，則需設定 Network Policies</p> </li> <li> <p>為了簡化 K8s 的流量管理，一旦某個 Ingress traffic 被允許進入 Pod，相關的 Egress traffic 也會被預設允許，除非有明確的 Network Policies 限制該 Egress traffic</p> </li> <li> <p>無論我們使用哪種 Networking 解決方案，都應該要預設使 K8s 叢集中的各個 Pod 能夠彼此通訊</p> <ul> <li>相當於所有 Pods 都在同一個虛擬私有網路 (VPN) 中，而該虛擬私有網路會橫跨 K8s 叢集中的所有 Nodes <img alt src=../../../assets/pics/k8s/k8s_networking_between_nodes.png></li> </ul> </li> <li> <p>建立 Network Policies</p> <ul> <li> <p>可以使用 label, podSelector, namespaceSelector 來指定 Network Policies <img alt src=../../../assets/pics/k8s/network_policy_selectors.png></p> </li> <li> <p>可以設定 Ingress, Egress traffic 的規則</p> <ul> <li>Ingress: 用 from 陣列開頭，來指定 traffic 來源</li> <li>Egress: 用 to 陣列開頭，來指定 traffic 目的地 <img alt src=../../../assets/pics/k8s/network_policy_rules.png></li> </ul> </li> <li> <p>可以設定 ipBlock 來限制外部服務的 IP address 存取權限</p> <ul> <li>因為外部服務不在 K8s 叢集中，因此無法使用 label, podSelector, namespaceSelector 來設定 Network Policies <img alt src=../../../assets/pics/k8s/network_policy_ingress_ipblock.png> <img alt src=../../../assets/pics/k8s/network_policy_egress_ipblock.png></li> </ul> </li> <li> <p>Tips: 設定 Ingress, Egress traffic 規則時，需注意 <code>-</code> 陣列的表示方式</p> <ul> <li> <p><strong>當一個 <code>-</code> 陣列中，包含多個規則時</strong>，表示這些規則是 <strong>AND</strong> 關係，需同時符合 <img alt src=../../../assets/pics/k8s/network_policy_ingress_and_%20operator.png></p> </li> <li> <p><strong>當多個 <code>-</code> 陣列中，並列表示規則時</strong>，表示這些規則是 <strong>OR</strong> 關係，只要符合其中一個即可 <img alt src=../../../assets/pics/k8s/network_policy_ingress_or_%20operator.png></p> </li> </ul> </li> </ul> <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-217-1><a id=__codelineno-217-1 name=__codelineno-217-1 href=#__codelineno-217-1></a><span class=c1># network-policy-definition.yaml</span>
</span><span id=__span-217-2><a id=__codelineno-217-2 name=__codelineno-217-2 href=#__codelineno-217-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span id=__span-217-3><a id=__codelineno-217-3 name=__codelineno-217-3 href=#__codelineno-217-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">NetworkPolicy</span>
</span><span id=__span-217-4><a id=__codelineno-217-4 name=__codelineno-217-4 href=#__codelineno-217-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-217-5><a id=__codelineno-217-5 name=__codelineno-217-5 href=#__codelineno-217-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">db-policy</span>
</span><span id=__span-217-6><a id=__codelineno-217-6 name=__codelineno-217-6 href=#__codelineno-217-6></a>
</span><span id=__span-217-7><a id=__codelineno-217-7 name=__codelineno-217-7 href=#__codelineno-217-7></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-217-8><a id=__codelineno-217-8 name=__codelineno-217-8 href=#__codelineno-217-8></a><span class=w>    </span><span class=nt>podSelector</span><span class=p>:</span>
</span><span id=__span-217-9><a id=__codelineno-217-9 name=__codelineno-217-9 href=#__codelineno-217-9></a><span class=w>        </span><span class=nt>matchLabels</span><span class=p>:</span>
</span><span id=__span-217-10><a id=__codelineno-217-10 name=__codelineno-217-10 href=#__codelineno-217-10></a><span class=w>        </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">db</span>
</span><span id=__span-217-11><a id=__codelineno-217-11 name=__codelineno-217-11 href=#__codelineno-217-11></a>
</span><span id=__span-217-12><a id=__codelineno-217-12 name=__codelineno-217-12 href=#__codelineno-217-12></a><span class=w>    </span><span class=c1># 設定要限制的 traffic 類型</span>
</span><span id=__span-217-13><a id=__codelineno-217-13 name=__codelineno-217-13 href=#__codelineno-217-13></a><span class=w>    </span><span class=nt>policyTypes</span><span class=p>:</span>
</span><span id=__span-217-14><a id=__codelineno-217-14 name=__codelineno-217-14 href=#__codelineno-217-14></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id=__span-217-15><a id=__codelineno-217-15 name=__codelineno-217-15 href=#__codelineno-217-15></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class="l l-Scalar l-Scalar-Plain">Egress</span>
</span><span id=__span-217-16><a id=__codelineno-217-16 name=__codelineno-217-16 href=#__codelineno-217-16></a>
</span><span id=__span-217-17><a id=__codelineno-217-17 name=__codelineno-217-17 href=#__codelineno-217-17></a><span class=w>    </span><span class=c1># 設定 Ingress traffic 規則</span>
</span><span id=__span-217-18><a id=__codelineno-217-18 name=__codelineno-217-18 href=#__codelineno-217-18></a><span class=w>    </span><span class=nt>ingress</span><span class=p>:</span>
</span><span id=__span-217-19><a id=__codelineno-217-19 name=__codelineno-217-19 href=#__codelineno-217-19></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>from</span><span class=p>:</span>
</span><span id=__span-217-20><a id=__codelineno-217-20 name=__codelineno-217-20 href=#__codelineno-217-20></a><span class=w>        </span><span class=c1># 多個 `-` 陣列中，並列表示規則，表示這些規則是 OR 關係，只要符合其中一個即可</span>
</span><span id=__span-217-21><a id=__codelineno-217-21 name=__codelineno-217-21 href=#__codelineno-217-21></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>ipBlock</span><span class=p>:</span>
</span><span id=__span-217-22><a id=__codelineno-217-22 name=__codelineno-217-22 href=#__codelineno-217-22></a><span class=w>            </span><span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">172.17.0.0/16</span>
</span><span id=__span-217-23><a id=__codelineno-217-23 name=__codelineno-217-23 href=#__codelineno-217-23></a><span class=w>            </span><span class=nt>except</span><span class=p>:</span>
</span><span id=__span-217-24><a id=__codelineno-217-24 name=__codelineno-217-24 href=#__codelineno-217-24></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">172.17.1.0/24</span>
</span><span id=__span-217-25><a id=__codelineno-217-25 name=__codelineno-217-25 href=#__codelineno-217-25></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>namespaceSelector</span><span class=p>:</span>
</span><span id=__span-217-26><a id=__codelineno-217-26 name=__codelineno-217-26 href=#__codelineno-217-26></a><span class=w>            </span><span class=nt>matchLabels</span><span class=p>:</span>
</span><span id=__span-217-27><a id=__codelineno-217-27 name=__codelineno-217-27 href=#__codelineno-217-27></a><span class=w>                </span><span class=nt>project</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myproject</span>
</span><span id=__span-217-28><a id=__codelineno-217-28 name=__codelineno-217-28 href=#__codelineno-217-28></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>podSelector</span><span class=p>:</span>
</span><span id=__span-217-29><a id=__codelineno-217-29 name=__codelineno-217-29 href=#__codelineno-217-29></a><span class=w>            </span><span class=nt>matchLabels</span><span class=p>:</span>
</span><span id=__span-217-30><a id=__codelineno-217-30 name=__codelineno-217-30 href=#__codelineno-217-30></a><span class=w>                </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">frontend</span>
</span><span id=__span-217-31><a id=__codelineno-217-31 name=__codelineno-217-31 href=#__codelineno-217-31></a>
</span><span id=__span-217-32><a id=__codelineno-217-32 name=__codelineno-217-32 href=#__codelineno-217-32></a><span class=w>        </span><span class=nt>ports</span><span class=p>:</span>
</span><span id=__span-217-33><a id=__codelineno-217-33 name=__codelineno-217-33 href=#__codelineno-217-33></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</span><span id=__span-217-34><a id=__codelineno-217-34 name=__codelineno-217-34 href=#__codelineno-217-34></a><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">6379</span>
</span><span id=__span-217-35><a id=__codelineno-217-35 name=__codelineno-217-35 href=#__codelineno-217-35></a><span class=w>    </span><span class=c1># 設定 Egress traffic 規則</span>
</span><span id=__span-217-36><a id=__codelineno-217-36 name=__codelineno-217-36 href=#__codelineno-217-36></a><span class=w>    </span><span class=nt>egress</span><span class=p>:</span>
</span><span id=__span-217-37><a id=__codelineno-217-37 name=__codelineno-217-37 href=#__codelineno-217-37></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>to</span><span class=p>:</span>
</span><span id=__span-217-38><a id=__codelineno-217-38 name=__codelineno-217-38 href=#__codelineno-217-38></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>ipBlock</span><span class=p>:</span>
</span><span id=__span-217-39><a id=__codelineno-217-39 name=__codelineno-217-39 href=#__codelineno-217-39></a><span class=w>            </span><span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10.0.0.0/24</span>
</span><span id=__span-217-40><a id=__codelineno-217-40 name=__codelineno-217-40 href=#__codelineno-217-40></a>
</span><span id=__span-217-41><a id=__codelineno-217-41 name=__codelineno-217-41 href=#__codelineno-217-41></a><span class=w>        </span><span class=nt>ports</span><span class=p>:</span>
</span><span id=__span-217-42><a id=__codelineno-217-42 name=__codelineno-217-42 href=#__codelineno-217-42></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</span><span id=__span-217-43><a id=__codelineno-217-43 name=__codelineno-217-43 href=#__codelineno-217-43></a><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5978</span>
</span></code></pre></div> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-218-1><a id=__codelineno-218-1 name=__codelineno-218-1 href=#__codelineno-218-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>network-policy-definition.yaml
</span></code></pre></div> </li> <li> <p>實務上，我們可能會需要頻繁地切換 cluster, namespace，因此我們可以使用 kubectx, kubens 工具來輔助我們達成目標</p> <ul> <li>kubectx: 輔助快速地切換 K8s cluster</li> <li>kubens: 輔助快速地切換 K8s namespace</li> <li>參考連結: <a href=https://github.com/ahmetb/kubectx>GitHub: kubectx + kubens: Power tools for kubectl</a></li> </ul> </li> </ul> <h2 id=storage>Storage<a class=headerlink href=#storage title="Permanent link">&para;</a></h2> <h3 id=introduction-of-docker-storage>Introduction of Docker Storage<a class=headerlink href=#introduction-of-docker-storage title="Permanent link">&para;</a></h3> <ul> <li><strong>Docker Storage Driver 負責管理 container 檔案系統，可決定 container 如何儲存、讀取資料</strong>，以下是兩種主要的類型<ul> <li>Storage Driver: 用於管理 container 的 storage<ul> <li>e.g. Overlay2（目前 Docker 預設使用）, AUFS, Btrfs, ZFS, DeviceMapper</li> </ul> </li> <li>Volume Driver: 用於管理 container 的 volume<ul> <li>e.g. local（預設的 Volume Driver）, nfs, glusterfs, flocker, rexray</li> <li>e.g. (第三方): Azure file storage, DigitalOcean, Google Compute Persistent Disks, VMware vSphere storage</li> </ul> </li> </ul> </li> <li> <p>當安裝 Docker 後，它會自動建立以下的目錄結構</p> <ul> <li><code>/var/lib/docker/</code>: 是 Docker container 預設儲存資料的地方<ul> <li><code>aufs</code>: 儲存 AUFS storage driver 的資料</li> <li><code>containers</code>: 儲存 container 的資料</li> <li><code>image</code>: 儲存 container image 的資料</li> <li><code>volumes</code>: 儲存 container volume 的資料</li> </ul> </li> </ul> <p><img alt src=../../assets/pics/docker_storage_file_system_folder_structure.png></p> </li> <li> <p>Docker image 的分層架構</p> <ul> <li><strong>Dockerfile 的每一行都會在 Docker image 中建立一個新的層 (layer)</strong></li> <li>Docker image 是由多個分層組成，<strong>每一層都是唯讀的</strong></li> <li> <p><strong>每一層都會基於前一層的基礎上進行修改</strong>，因此這也會反映在 image layer 的檔案大小上 <img alt src=../../assets/pics/docker_image_layerd_architecture.png></p> </li> <li> <p><strong>Docker 建立 image 時，會重複使用快取中的 image layer</strong>，以加速 image 的建立，同時也能節省硬碟使用空間</p> <ul> <li>e.g. 以下圖為例，兩個 Dockerfile 內容重複的部分 (Layer 1 ~ Layer 3)，Docker 會從快取中重複使用已經建立過的 image layer <img alt src=../../../assets/pics/k8s/docker_image_layer_reuse_cache.png></li> </ul> </li> </ul> </li> <li> <p>說明 Docker 透過 image，建立、執行、刪除 container 的過程</p> <ul> <li> <p>Step 1: <strong>建立唯讀的(read-only) image layer</strong> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-219-1><a id=__codelineno-219-1 name=__codelineno-219-1 href=#__codelineno-219-1></a>docker<span class=w> </span>build<span class=w> </span>Dockerfile<span class=w> </span>-t<span class=w> </span>&lt;myimage&gt;
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/docker_image_layer_readonly.png></p> </li> <li> <p>Step 2: <strong>執行 image 時，建立一個可寫的(writeable) container layer，用來儲存 container 產生的資料</strong>，例如: 應用程式產生的 log 資料，或是 container 產生的 temp 資料 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-220-1><a id=__codelineno-220-1 name=__codelineno-220-1 href=#__codelineno-220-1></a>docker<span class=w> </span>run<span class=w> </span>&lt;myimage&gt;
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/docker_image_container_layer_writeable.png></p> <ul> <li><strong>copy-on-write 機制</strong>: 若我們想要編輯 image layer 的程式碼，<strong>Docker 會幫我們在 container layer 建立一個副本，讓我們可以進行編輯</strong> (e.g. app.py) <img alt src=../../../assets/pics/k8s/docker_image_copy_on_write_mechanism.png></li> </ul> </li> <li> <p>Step 3: <strong>當 container 被刪除時，container layer 所儲存的資料也會被一併刪除</strong></p> <ul> <li>注意! <strong>若多個 container 使用相同的 image，則這些 container layer 會共享相同的 image layer</strong></li> </ul> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-221-1><a id=__codelineno-221-1 name=__codelineno-221-1 href=#__codelineno-221-1></a>docker<span class=w> </span>rm<span class=w> </span>&lt;mycontainer&gt;
</span></code></pre></div> </li> </ul> </li> <li> <p>Docker 建立永久儲存資料的 container</p> <ul> <li> <p>法一 (Volume mounting): 由 Docker 自行管理的掛載點</p> <ul> <li> <p>Step 1: 建立 Volume 在 <code>/var/lib/docker/volumes/</code> 資料夾中 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-222-1><a id=__codelineno-222-1 name=__codelineno-222-1 href=#__codelineno-222-1></a>docker<span class=w> </span>volume<span class=w> </span>create<span class=w> </span>&lt;data_volume&gt;
</span></code></pre></div></p> </li> <li> <p>Step 2: 將 Volume 掛載到 container 中。這樣，當 container 被刪除時，Volume 中的資料可繼續保留</p> <ul> <li>註: <code>/var/lib/mysql</code> 是 MySQL container 預設儲存資料的地方</li> </ul> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-223-1><a id=__codelineno-223-1 name=__codelineno-223-1 href=#__codelineno-223-1></a>docker<span class=w> </span>run<span class=w> </span>-v<span class=w> </span>&lt;data_volume&gt;:/var/lib/mysql<span class=w> </span>mysql
</span></code></pre></div> </li> <li> <p>可檢視當前所有的 Volume <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-224-1><a id=__codelineno-224-1 name=__codelineno-224-1 href=#__codelineno-224-1></a>docker<span class=w> </span>volume<span class=w> </span>ls
</span></code></pre></div></p> </li> </ul> </li> <li> <p>法二 (Bind mounting): 直接將宿主機的儲存空間掛載到 container 上，可指定宿主機的儲存空間的完整路徑</p> <ul> <li> <p>Step 1: 建立外部資料儲存位置 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-225-1><a id=__codelineno-225-1 name=__codelineno-225-1 href=#__codelineno-225-1></a>mkdir<span class=w> </span>-p<span class=w> </span>/data/mysql
</span></code></pre></div></p> </li> <li> <p>Step 2: 將外部資料儲存位置掛載到 container 中 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-226-1><a id=__codelineno-226-1 name=__codelineno-226-1 href=#__codelineno-226-1></a>docker<span class=w> </span>run<span class=w> </span>--mount<span class=w> </span><span class=nv>type</span><span class=o>=</span>bind,source<span class=o>=</span>/data/mysql,target<span class=o>=</span>/var/lib/mysql<span class=w> </span>mysql
</span></code></pre></div></p> </li> </ul> <p><img alt src=../../../assets/pics/k8s/docker_container_volume.png></p> </li> </ul> </li> <li> <p>Storage Driver 功能</p> <ul> <li><strong>維護 container image 的分層架構</strong></li> <li>建立可讀寫的 container layer</li> <li><strong>支援 copy-on-write 機制</strong></li> </ul> </li> <li> <p>常見的 Storage Driver 類型: AUFS, ZFS, BTRFS, Device Mapper, Overlay, Overlay2</p> <ul> <li>Docker 會根據當前 container 所在的底層作業系統(O.S.)，自動地選出最適合的 Storage Driver 來使用</li> </ul> </li> <li> <p>當 Docker 運行 container 時，可以指定要使用的 Volume driver，這樣會建立一個 container 並掛載指定的 AWS EBS volume <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-227-1><a id=__codelineno-227-1 name=__codelineno-227-1 href=#__codelineno-227-1></a>docker<span class=w> </span>run<span class=w> </span>-it<span class=w> </span>--name<span class=w> </span>mysql<span class=w> </span>--volume-driver<span class=w> </span>rexray/ebs<span class=w> </span>--mount<span class=w> </span><span class=nv>src</span><span class=o>=</span>ebs-vol,target<span class=o>=</span>/var/lib/mysql<span class=w> </span>mysql
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/volume_driver_aws_ebs.png></p> </li> <li> <p>Container Interface: 用來定義 Orchestration 系統與 container 之間的溝通方式</p> <ul> <li>orchestration 系統: 用來管理 container 的系統，例如: Kubernetes, Docker Swarm, Mesos</li> <li>container runtime: 用來執行 container 的系統，例如: Docker, containerd, CRI-O, rkt</li> <li>CRI (Container Runtime Interface)</li> <li>CNI (Container Network Interface)</li> <li>CSI (Container Storage Interface): 定義了一組 RPC 供 Orchestration 系統來呼叫，並且這些 RPC 必須由 storage driver 實作 <img alt src=../../../assets/pics/k8s/container_storage_interface.png></li> </ul> </li> </ul> <h3 id=volume>Volume<a class=headerlink href=#volume title="Permanent link">&para;</a></h3> <ul> <li>在 K8s 的世界中，Pod 的生命週期總是短暫的。因此，我們可以建立 Volume 來儲存 Pod 的資料，以便在 Pod 被刪除後，資料仍然可以被保留</li> <li> <p>我們可以在 Pod 的 YAML manifest 設定檔中，指定 Volume 路徑位置 <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-228-1><a id=__codelineno-228-1 name=__codelineno-228-1 href=#__codelineno-228-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-228-2><a id=__codelineno-228-2 name=__codelineno-228-2 href=#__codelineno-228-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-228-3><a id=__codelineno-228-3 name=__codelineno-228-3 href=#__codelineno-228-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-228-4><a id=__codelineno-228-4 name=__codelineno-228-4 href=#__codelineno-228-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">random-number-generator</span>
</span><span id=__span-228-5><a id=__codelineno-228-5 name=__codelineno-228-5 href=#__codelineno-228-5></a>
</span><span id=__span-228-6><a id=__codelineno-228-6 name=__codelineno-228-6 href=#__codelineno-228-6></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-228-7><a id=__codelineno-228-7 name=__codelineno-228-7 href=#__codelineno-228-7></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-228-8><a id=__codelineno-228-8 name=__codelineno-228-8 href=#__codelineno-228-8></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">alpine</span>
</span><span id=__span-228-9><a id=__codelineno-228-9 name=__codelineno-228-9 href=#__codelineno-228-9></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">alpine</span>
</span><span id=__span-228-10><a id=__codelineno-228-10 name=__codelineno-228-10 href=#__codelineno-228-10></a><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;/bin/sh&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;-c&quot;</span><span class="p p-Indicator">]</span>
</span><span id=__span-228-11><a id=__codelineno-228-11 name=__codelineno-228-11 href=#__codelineno-228-11></a><span class=w>        </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;shuf</span><span class=nv> </span><span class=s>-i</span><span class=nv> </span><span class=s>0-100</span><span class=nv> </span><span class=s>-n</span><span class=nv> </span><span class=s>1</span><span class=nv> </span><span class=s>&gt;&gt;</span><span class=nv> </span><span class=s>/opt/number.out&quot;</span><span class="p p-Indicator">]</span>
</span><span id=__span-228-12><a id=__codelineno-228-12 name=__codelineno-228-12 href=#__codelineno-228-12></a><span class=w>        </span><span class=c1># 定義 container 掛載點</span>
</span><span id=__span-228-13><a id=__codelineno-228-13 name=__codelineno-228-13 href=#__codelineno-228-13></a><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span>
</span><span id=__span-228-14><a id=__codelineno-228-14 name=__codelineno-228-14 href=#__codelineno-228-14></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/opt</span>
</span><span id=__span-228-15><a id=__codelineno-228-15 name=__codelineno-228-15 href=#__codelineno-228-15></a><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">data-volume</span>
</span><span id=__span-228-16><a id=__codelineno-228-16 name=__codelineno-228-16 href=#__codelineno-228-16></a>
</span><span id=__span-228-17><a id=__codelineno-228-17 name=__codelineno-228-17 href=#__codelineno-228-17></a><span class=w>    </span><span class=c1># 定義 Pod 所使用的 Volume</span>
</span><span id=__span-228-18><a id=__codelineno-228-18 name=__codelineno-228-18 href=#__codelineno-228-18></a><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span>
</span><span id=__span-228-19><a id=__codelineno-228-19 name=__codelineno-228-19 href=#__codelineno-228-19></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">data-volume</span>
</span><span id=__span-228-20><a id=__codelineno-228-20 name=__codelineno-228-20 href=#__codelineno-228-20></a><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span>
</span><span id=__span-228-21><a id=__codelineno-228-21 name=__codelineno-228-21 href=#__codelineno-228-21></a><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/data</span>
</span><span id=__span-228-22><a id=__codelineno-228-22 name=__codelineno-228-22 href=#__codelineno-228-22></a><span class=w>            </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Directory</span>
</span></code></pre></div></p> </li> <li> <p>舉例來說，我們建立一個可以產生隨機數字的 Pod，並將 Volume 掛載到 container 內的 <code>/opt</code> 路徑上。之後，當 container 運行時，所產生的隨機數字會被寫入 Volume 中，而實際是儲存到宿主機的 <code>/data</code> 資料夾中</p> <ul> <li>這樣，當 Pod 被刪除時，Volume 中的資料仍然可以被保留 <img alt src=../../../assets/pics/k8s/k8s_volume_mounting.png></li> </ul> </li> <li> <p>Volume 的 Storage option: 因為 Volume 的 hostPath 是代表宿主機的路徑，因此不適用於 multi-node cluster，這時我們就要使用外部的 Storage 來解決這個問題</p> <ul> <li>e.g. NFS, GlusterFS, CephFS</li> <li>e.g. (三大公有雲) AWS EBS, Azure Disk, Google's Persistent Disk <img alt src=../../../assets/pics/k8s/k8s_volume_storage_option.png></li> </ul> <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-229-1><a id=__codelineno-229-1 name=__codelineno-229-1 href=#__codelineno-229-1></a><span class=c1># volume-storage-option.yaml</span>
</span><span id=__span-229-2><a id=__codelineno-229-2 name=__codelineno-229-2 href=#__codelineno-229-2></a><span class=c1># ...略</span>
</span><span id=__span-229-3><a id=__codelineno-229-3 name=__codelineno-229-3 href=#__codelineno-229-3></a><span class=nt>volumes</span><span class=p>:</span>
</span><span id=__span-229-4><a id=__codelineno-229-4 name=__codelineno-229-4 href=#__codelineno-229-4></a><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">data-volume</span>
</span><span id=__span-229-5><a id=__codelineno-229-5 name=__codelineno-229-5 href=#__codelineno-229-5></a><span class=w>    </span><span class=nt>awsElasticBlockStore</span><span class=p>:</span>
</span><span id=__span-229-6><a id=__codelineno-229-6 name=__codelineno-229-6 href=#__codelineno-229-6></a><span class=w>        </span><span class=nt>volumeID</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;volume-id&gt;</span>
</span><span id=__span-229-7><a id=__codelineno-229-7 name=__codelineno-229-7 href=#__codelineno-229-7></a><span class=w>        </span><span class=nt>fsType</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ext4</span>
</span></code></pre></div> </li> </ul> <h3 id=persistent-volume>Persistent Volume<a class=headerlink href=#persistent-volume title="Permanent link">&para;</a></h3> <ul> <li>Persistent Volume (PV): 是 K8s 叢集中的一個物件，用來提供存 cluster 級別的儲存空間公池<ul> <li>使用者可透過 Persistent Volume Claim (PVC) 來存取 PV</li> <li>PV 可有效降低使用者在每次建立 Pod 時，需要手動指定 Volume 的負擔</li> </ul> </li> <li> <p>建立 Persistent Volume <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-230-1><a id=__codelineno-230-1 name=__codelineno-230-1 href=#__codelineno-230-1></a><span class=c1># pv-definition.yaml</span>
</span><span id=__span-230-2><a id=__codelineno-230-2 name=__codelineno-230-2 href=#__codelineno-230-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-230-3><a id=__codelineno-230-3 name=__codelineno-230-3 href=#__codelineno-230-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
</span><span id=__span-230-4><a id=__codelineno-230-4 name=__codelineno-230-4 href=#__codelineno-230-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-230-5><a id=__codelineno-230-5 name=__codelineno-230-5 href=#__codelineno-230-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">pv-vol1</span>
</span><span id=__span-230-6><a id=__codelineno-230-6 name=__codelineno-230-6 href=#__codelineno-230-6></a>
</span><span id=__span-230-7><a id=__codelineno-230-7 name=__codelineno-230-7 href=#__codelineno-230-7></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-230-8><a id=__codelineno-230-8 name=__codelineno-230-8 href=#__codelineno-230-8></a><span class=w>    </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>&quot;ReadWriteOnce&quot;</span><span class=w> </span><span class="p p-Indicator">]</span>
</span><span id=__span-230-9><a id=__codelineno-230-9 name=__codelineno-230-9 href=#__codelineno-230-9></a><span class=w>    </span><span class=nt>capacity</span><span class=p>:</span>
</span><span id=__span-230-10><a id=__codelineno-230-10 name=__codelineno-230-10 href=#__codelineno-230-10></a><span class=w>        </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span><span id=__span-230-11><a id=__codelineno-230-11 name=__codelineno-230-11 href=#__codelineno-230-11></a><span class=w>    </span><span class=nt>hostPath</span><span class=p>:</span>
</span><span id=__span-230-12><a id=__codelineno-230-12 name=__codelineno-230-12 href=#__codelineno-230-12></a><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/data</span>
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-231-1><a id=__codelineno-231-1 name=__codelineno-231-1 href=#__codelineno-231-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>pv-definition.yaml
</span></code></pre></div> </li> <li> <p>檢視 Persistent Volume <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-232-1><a id=__codelineno-232-1 name=__codelineno-232-1 href=#__codelineno-232-1></a>kubectl<span class=w> </span>get<span class=w> </span>pv
</span></code></pre></div></p> </li> <li> <p>刪除 Persistent Volume <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-233-1><a id=__codelineno-233-1 name=__codelineno-233-1 href=#__codelineno-233-1></a>kubectl<span class=w> </span>delete<span class=w> </span>pv<span class=w> </span>pv-vol1
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/k8s_persistent_volume.png></p> </li> </ul> <h3 id=persistent-volume-claim>Persistent Volume Claim<a class=headerlink href=#persistent-volume-claim title="Permanent link">&para;</a></h3> <ul> <li>Persistent Volume Claim (PVC): 是 K8s 叢集中的一個物件，用來存取 Persistent Volume (PV)</li> <li> <p>一旦建立 PVC，K8s 會自動根據 PVC 的需求和屬性，將 PV 綁定到 PVC 上; <strong>若 PVC 的設定要求無法與任何 PV 匹配</strong>，則 PVC 會保持在 <strong>Pending</strong> 狀態 <img alt src=../../../assets/pics/k8s/k8s_persistent_volume_claims.png></p> </li> <li> <p>宣告 PVC, PV 的 YAML manifest 設定檔 <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-234-1><a id=__codelineno-234-1 name=__codelineno-234-1 href=#__codelineno-234-1></a><span class=c1># pv-definition.yaml</span>
</span><span id=__span-234-2><a id=__codelineno-234-2 name=__codelineno-234-2 href=#__codelineno-234-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
</span><span id=__span-234-3><a id=__codelineno-234-3 name=__codelineno-234-3 href=#__codelineno-234-3></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-234-4><a id=__codelineno-234-4 name=__codelineno-234-4 href=#__codelineno-234-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-234-5><a id=__codelineno-234-5 name=__codelineno-234-5 href=#__codelineno-234-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">pv-vol1</span>
</span><span id=__span-234-6><a id=__codelineno-234-6 name=__codelineno-234-6 href=#__codelineno-234-6></a>
</span><span id=__span-234-7><a id=__codelineno-234-7 name=__codelineno-234-7 href=#__codelineno-234-7></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-234-8><a id=__codelineno-234-8 name=__codelineno-234-8 href=#__codelineno-234-8></a><span class=w>    </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>&quot;ReadWriteOnce&quot;</span><span class=w> </span><span class="p p-Indicator">]</span>
</span><span id=__span-234-9><a id=__codelineno-234-9 name=__codelineno-234-9 href=#__codelineno-234-9></a><span class=w>    </span><span class=nt>capacity</span><span class=p>:</span>
</span><span id=__span-234-10><a id=__codelineno-234-10 name=__codelineno-234-10 href=#__codelineno-234-10></a><span class=w>        </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span><span id=__span-234-11><a id=__codelineno-234-11 name=__codelineno-234-11 href=#__codelineno-234-11></a><span class=w>    </span><span class=nt>hostPath</span><span class=p>:</span>
</span><span id=__span-234-12><a id=__codelineno-234-12 name=__codelineno-234-12 href=#__codelineno-234-12></a><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/data</span>
</span></code></pre></div></p> <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-235-1><a id=__codelineno-235-1 name=__codelineno-235-1 href=#__codelineno-235-1></a><span class=c1># pvc-definition.yaml</span>
</span><span id=__span-235-2><a id=__codelineno-235-2 name=__codelineno-235-2 href=#__codelineno-235-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-235-3><a id=__codelineno-235-3 name=__codelineno-235-3 href=#__codelineno-235-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
</span><span id=__span-235-4><a id=__codelineno-235-4 name=__codelineno-235-4 href=#__codelineno-235-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-235-5><a id=__codelineno-235-5 name=__codelineno-235-5 href=#__codelineno-235-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myclaim</span>
</span><span id=__span-235-6><a id=__codelineno-235-6 name=__codelineno-235-6 href=#__codelineno-235-6></a>
</span><span id=__span-235-7><a id=__codelineno-235-7 name=__codelineno-235-7 href=#__codelineno-235-7></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-235-8><a id=__codelineno-235-8 name=__codelineno-235-8 href=#__codelineno-235-8></a><span class=w>    </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>&quot;ReadWriteOnce&quot;</span><span class=w> </span><span class="p p-Indicator">]</span>
</span><span id=__span-235-9><a id=__codelineno-235-9 name=__codelineno-235-9 href=#__codelineno-235-9></a><span class=w>    </span><span class=nt>resources</span><span class=p>:</span>
</span><span id=__span-235-10><a id=__codelineno-235-10 name=__codelineno-235-10 href=#__codelineno-235-10></a><span class=w>        </span><span class=nt>requests</span><span class=p>:</span>
</span><span id=__span-235-11><a id=__codelineno-235-11 name=__codelineno-235-11 href=#__codelineno-235-11></a><span class=w>            </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span></code></pre></div> </li> <li> <p>建立並檢視 PV <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-236-1><a id=__codelineno-236-1 name=__codelineno-236-1 href=#__codelineno-236-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>pv-definition.yaml
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-237-1><a id=__codelineno-237-1 name=__codelineno-237-1 href=#__codelineno-237-1></a>kubectl<span class=w> </span>get<span class=w> </span>pv
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/k8s_create_pv.png></p> </li> <li> <p>建立並檢視 PVC <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-238-1><a id=__codelineno-238-1 name=__codelineno-238-1 href=#__codelineno-238-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>pvc-definition.yaml
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-239-1><a id=__codelineno-239-1 name=__codelineno-239-1 href=#__codelineno-239-1></a>kubectl<span class=w> </span>get<span class=w> </span>pvc
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/k8s_create_pvc.png></p> </li> <li> <p>在 Pod 的 YAML manifest 設定檔中，指定 PVC 的名稱 <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-240-1><a id=__codelineno-240-1 name=__codelineno-240-1 href=#__codelineno-240-1></a><span class=c1># pod-definition.yaml</span>
</span><span id=__span-240-2><a id=__codelineno-240-2 name=__codelineno-240-2 href=#__codelineno-240-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-240-3><a id=__codelineno-240-3 name=__codelineno-240-3 href=#__codelineno-240-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-240-4><a id=__codelineno-240-4 name=__codelineno-240-4 href=#__codelineno-240-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-240-5><a id=__codelineno-240-5 name=__codelineno-240-5 href=#__codelineno-240-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mypod</span>
</span><span id=__span-240-6><a id=__codelineno-240-6 name=__codelineno-240-6 href=#__codelineno-240-6></a>
</span><span id=__span-240-7><a id=__codelineno-240-7 name=__codelineno-240-7 href=#__codelineno-240-7></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-240-8><a id=__codelineno-240-8 name=__codelineno-240-8 href=#__codelineno-240-8></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-240-9><a id=__codelineno-240-9 name=__codelineno-240-9 href=#__codelineno-240-9></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myfrontend</span>
</span><span id=__span-240-10><a id=__codelineno-240-10 name=__codelineno-240-10 href=#__codelineno-240-10></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-240-11><a id=__codelineno-240-11 name=__codelineno-240-11 href=#__codelineno-240-11></a><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span>
</span><span id=__span-240-12><a id=__codelineno-240-12 name=__codelineno-240-12 href=#__codelineno-240-12></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=s>&quot;/var/www/html&quot;</span>
</span><span id=__span-240-13><a id=__codelineno-240-13 name=__codelineno-240-13 href=#__codelineno-240-13></a><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mypd</span>
</span><span id=__span-240-14><a id=__codelineno-240-14 name=__codelineno-240-14 href=#__codelineno-240-14></a><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span>
</span><span id=__span-240-15><a id=__codelineno-240-15 name=__codelineno-240-15 href=#__codelineno-240-15></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mypd</span>
</span><span id=__span-240-16><a id=__codelineno-240-16 name=__codelineno-240-16 href=#__codelineno-240-16></a><span class=w>        </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span>
</span><span id=__span-240-17><a id=__codelineno-240-17 name=__codelineno-240-17 href=#__codelineno-240-17></a><span class=w>            </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myclaim</span>
</span></code></pre></div></p> </li> <li> <p>刪除 PVC <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-241-1><a id=__codelineno-241-1 name=__codelineno-241-1 href=#__codelineno-241-1></a>kubectl<span class=w> </span>delete<span class=w> </span>pvc<span class=w> </span>myclaim
</span></code></pre></div></p> </li> <li> <p>刪除 PV <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-242-1><a id=__codelineno-242-1 name=__codelineno-242-1 href=#__codelineno-242-1></a>kubectl<span class=w> </span>delete<span class=w> </span>pv<span class=w> </span>pv-vol1
</span></code></pre></div></p> </li> <li> <p>PV, PVC, Pod 之間的關係圖 <img alt src=../../../assets/pics/k8s/k8s_pv_pvc_pod_relationship.png></p> </li> </ul> <h3 id=storage-class>Storage Class<a class=headerlink href=#storage-class title="Permanent link">&para;</a></h3> <ul> <li>Storage Class: 是 K8s 叢集中的一個物件，用來定義 Persistent Volume (PV) 的屬性<ul> <li>Storage Class 可以定義 PV 的屬性，例如: 儲存類型、儲存大小、儲存位置等</li> </ul> </li> <li> <p>Static Provisioning: 是指在建立 PV 時，直接指定 PV 的屬性</p> <ul> <li>需在建立 PV 時，都要手動指定 PV 的屬性 =&gt; 較麻煩 <img alt src=../../../assets/pics/k8s/k8s_storage_class_static_provisioning.png></li> </ul> </li> <li> <p>Dynamic Provisioning: 是指在建立 PVC 時，K8s <strong>會自動根據 PVC 的需求、屬性，來建立 PV</strong></p> <ul> <li>當我們建立 Storage Class 物件後，PV 會自動建立，我們就不再需要定義 PV =&gt; <strong>較方便</strong> <img alt src=../../../assets/pics/k8s/k8s_storage_class_dynamic_provisioning.png></li> </ul> </li> <li> <p>建立 Storage Class <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-243-1><a id=__codelineno-243-1 name=__codelineno-243-1 href=#__codelineno-243-1></a><span class=c1># sc-definition.yaml</span>
</span><span id=__span-243-2><a id=__codelineno-243-2 name=__codelineno-243-2 href=#__codelineno-243-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">storage.k8s.io/v1</span>
</span><span id=__span-243-3><a id=__codelineno-243-3 name=__codelineno-243-3 href=#__codelineno-243-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">StorageClass</span>
</span><span id=__span-243-4><a id=__codelineno-243-4 name=__codelineno-243-4 href=#__codelineno-243-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-243-5><a id=__codelineno-243-5 name=__codelineno-243-5 href=#__codelineno-243-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">google-storage</span>
</span><span id=__span-243-6><a id=__codelineno-243-6 name=__codelineno-243-6 href=#__codelineno-243-6></a>
</span><span id=__span-243-7><a id=__codelineno-243-7 name=__codelineno-243-7 href=#__codelineno-243-7></a><span class=c1># Storage Class 的 Dynamic Provisioning 設定</span>
</span><span id=__span-243-8><a id=__codelineno-243-8 name=__codelineno-243-8 href=#__codelineno-243-8></a><span class=nt>provisioner</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/gce-pd</span>
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-244-1><a id=__codelineno-244-1 name=__codelineno-244-1 href=#__codelineno-244-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>sc-definition.yaml
</span></code></pre></div> </li> <li> <p>檢視 Storage Class <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-245-1><a id=__codelineno-245-1 name=__codelineno-245-1 href=#__codelineno-245-1></a>kubectl<span class=w> </span>get<span class=w> </span>sc
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/k8s_get_storage_class.png></p> </li> <li> <p>建立 Persistent Volume Claim (PVC) 時，指定 Storage Class <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-246-1><a id=__codelineno-246-1 name=__codelineno-246-1 href=#__codelineno-246-1></a><span class=c1># pvc-definition.yaml</span>
</span><span id=__span-246-2><a id=__codelineno-246-2 name=__codelineno-246-2 href=#__codelineno-246-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-246-3><a id=__codelineno-246-3 name=__codelineno-246-3 href=#__codelineno-246-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
</span><span id=__span-246-4><a id=__codelineno-246-4 name=__codelineno-246-4 href=#__codelineno-246-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-246-5><a id=__codelineno-246-5 name=__codelineno-246-5 href=#__codelineno-246-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myclaim</span>
</span><span id=__span-246-6><a id=__codelineno-246-6 name=__codelineno-246-6 href=#__codelineno-246-6></a>
</span><span id=__span-246-7><a id=__codelineno-246-7 name=__codelineno-246-7 href=#__codelineno-246-7></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-246-8><a id=__codelineno-246-8 name=__codelineno-246-8 href=#__codelineno-246-8></a><span class=w>    </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>&quot;ReadWriteOnce&quot;</span><span class=w> </span><span class="p p-Indicator">]</span>
</span><span id=__span-246-9><a id=__codelineno-246-9 name=__codelineno-246-9 href=#__codelineno-246-9></a><span class=w>    </span><span class=c1># 指定要使用的 Storage Class 物件</span>
</span><span id=__span-246-10><a id=__codelineno-246-10 name=__codelineno-246-10 href=#__codelineno-246-10></a><span class=w>    </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">google-storage</span><span class=w>       </span>
</span><span id=__span-246-11><a id=__codelineno-246-11 name=__codelineno-246-11 href=#__codelineno-246-11></a><span class=w>    </span><span class=nt>resources</span><span class=p>:</span>
</span><span id=__span-246-12><a id=__codelineno-246-12 name=__codelineno-246-12 href=#__codelineno-246-12></a><span class=w>        </span><span class=nt>requests</span><span class=p>:</span>
</span><span id=__span-246-13><a id=__codelineno-246-13 name=__codelineno-246-13 href=#__codelineno-246-13></a><span class=w>            </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">500Mi</span>
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-247-1><a id=__codelineno-247-1 name=__codelineno-247-1 href=#__codelineno-247-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>pvc-definition.yaml
</span></code></pre></div> </li> <li> <p>建立 Pod <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-248-1><a id=__codelineno-248-1 name=__codelineno-248-1 href=#__codelineno-248-1></a><span class=c1># pod-definition.yaml</span>
</span><span id=__span-248-2><a id=__codelineno-248-2 name=__codelineno-248-2 href=#__codelineno-248-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-248-3><a id=__codelineno-248-3 name=__codelineno-248-3 href=#__codelineno-248-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
</span><span id=__span-248-4><a id=__codelineno-248-4 name=__codelineno-248-4 href=#__codelineno-248-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-248-5><a id=__codelineno-248-5 name=__codelineno-248-5 href=#__codelineno-248-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mypod</span>
</span><span id=__span-248-6><a id=__codelineno-248-6 name=__codelineno-248-6 href=#__codelineno-248-6></a>
</span><span id=__span-248-7><a id=__codelineno-248-7 name=__codelineno-248-7 href=#__codelineno-248-7></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-248-8><a id=__codelineno-248-8 name=__codelineno-248-8 href=#__codelineno-248-8></a><span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-248-9><a id=__codelineno-248-9 name=__codelineno-248-9 href=#__codelineno-248-9></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">frontend</span>
</span><span id=__span-248-10><a id=__codelineno-248-10 name=__codelineno-248-10 href=#__codelineno-248-10></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</span><span id=__span-248-11><a id=__codelineno-248-11 name=__codelineno-248-11 href=#__codelineno-248-11></a><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span>
</span><span id=__span-248-12><a id=__codelineno-248-12 name=__codelineno-248-12 href=#__codelineno-248-12></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=s>&quot;/var/www/html&quot;</span>
</span><span id=__span-248-13><a id=__codelineno-248-13 name=__codelineno-248-13 href=#__codelineno-248-13></a><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
</span><span id=__span-248-14><a id=__codelineno-248-14 name=__codelineno-248-14 href=#__codelineno-248-14></a>
</span><span id=__span-248-15><a id=__codelineno-248-15 name=__codelineno-248-15 href=#__codelineno-248-15></a><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span>
</span><span id=__span-248-16><a id=__codelineno-248-16 name=__codelineno-248-16 href=#__codelineno-248-16></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
</span><span id=__span-248-17><a id=__codelineno-248-17 name=__codelineno-248-17 href=#__codelineno-248-17></a><span class=w>        </span><span class=c1># 指定要使用的 PVC</span>
</span><span id=__span-248-18><a id=__codelineno-248-18 name=__codelineno-248-18 href=#__codelineno-248-18></a><span class=w>        </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span>
</span><span id=__span-248-19><a id=__codelineno-248-19 name=__codelineno-248-19 href=#__codelineno-248-19></a><span class=w>            </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">myclaim</span>
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-249-1><a id=__codelineno-249-1 name=__codelineno-249-1 href=#__codelineno-249-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>pod-definition.yaml
</span></code></pre></div> </li> <li> <p>Storage Class 的 Provisioner 選項</p> <ul> <li>e.g. Portworx, ScaleIO, CephFS</li> <li> <p>e.g. (公有雲) AWS EBS, Azure File, Azure Disk, GCP Persistent Disk <img alt src=../../../assets/pics/k8s/k8s_storage_class_yaml.png></p> </li> <li> <p>而之所以稱為 <strong>Storage Class</strong>，是因為它<strong>可以定義多個不同的 Storage Class，以便滿足不同的需求</strong> <img alt src=../../../assets/pics/k8s/k8s_storage_class_provisioner.png></p> </li> </ul> </li> </ul> <h2 id=networking>Networking<a class=headerlink href=#networking title="Permanent link">&para;</a></h2> <h3 id=networling-prerequisite>Networling Prerequisite<a class=headerlink href=#networling-prerequisite title="Permanent link">&para;</a></h3> <ul> <li> <p>Switching</p> <ul> <li>用途: 連接區域網路（LAN）中的裝置<ul> <li>兩台設備透過網路介面（interface），連接到交換機（switch）</li> </ul> </li> <li> <p><strong>檢視當前主機的網路介面</strong></p> <ul> <li>eth0: 用來連接到交換機上的網路介面 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-250-1><a id=__codelineno-250-1 name=__codelineno-250-1 href=#__codelineno-250-1></a>ip<span class=w> </span>link
</span></code></pre></div></li> </ul> </li> <li> <p><strong>檢視當前主機的 IP address</strong> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-251-1><a id=__codelineno-251-1 name=__codelineno-251-1 href=#__codelineno-251-1></a>ip<span class=w> </span>addr
</span></code></pre></div></p> </li> <li> <p><strong>新增 eth0 網路介面的 IP address</strong> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-252-1><a id=__codelineno-252-1 name=__codelineno-252-1 href=#__codelineno-252-1></a>ip<span class=w> </span>addr<span class=w> </span>add<span class=w> </span><span class=m>192</span>.168.1.10/24<span class=w> </span>dev<span class=w> </span>eth0
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-253-1><a id=__codelineno-253-1 name=__codelineno-253-1 href=#__codelineno-253-1></a>ip<span class=w> </span>addr<span class=w> </span>add<span class=w> </span><span class=m>192</span>.168.1.11/24<span class=w> </span>dev<span class=w> </span>eth0
</span></code></pre></div> </li> </ul> <p><img alt src=../../../assets/pics/k8s/networking_prerequisite_switching.png></p> </li> <li> <p>Routing</p> <ul> <li>用途: 連接兩個網路，會分配給每個網路一個 IP address，根據路由表（IP table）將封包轉發給下一個目的地</li> <li> <p>檢視當前的路由表 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-254-1><a id=__codelineno-254-1 name=__codelineno-254-1 href=#__codelineno-254-1></a>ip<span class=w> </span>route<span class=w> </span>show
</span></code></pre></div></p> </li> <li> <p>新增 IP address 到路由表 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-255-1><a id=__codelineno-255-1 name=__codelineno-255-1 href=#__codelineno-255-1></a>ip<span class=w> </span>route<span class=w> </span>add<span class=w> </span><span class=m>192</span>.168.1.0/24<span class=w> </span>via<span class=w> </span><span class=m>192</span>.168.2.1
</span></code></pre></div></p> </li> <li> <p>設定預設路由器的 IP address <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-256-1><a id=__codelineno-256-1 name=__codelineno-256-1 href=#__codelineno-256-1></a>ip<span class=w> </span>route<span class=w> </span>add<span class=w> </span>default<span class=w> </span>via<span class=w> </span><span class=m>192</span>.168.2.1
</span></code></pre></div></p> </li> </ul> <p><img alt src=../../../assets/pics/k8s/networking_prerequisite_routing.png></p> </li> <li> <p>Gateway</p> <ul> <li>用途: 將區域網路連向外部網際網路（Internet）的通道</li> </ul> </li> <li> <p>DNS</p> <ul> <li>用途: 將 IP address 轉換成 domain name</li> <li> <p>檢視靜態 DNS 設定（若這邊已查詢到相對應的 IP address &lt;-&gt; domain name，就不會到 DNS 伺服器查詢了） <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-257-1><a id=__codelineno-257-1 name=__codelineno-257-1 href=#__codelineno-257-1></a>cat<span class=w> </span>/etc/hosts
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/networking_prerequisite_dns_set_etc_hosts.png></p> </li> <li> <p>檢視當前系統所使用的 DNS 伺服器（可得知當前系統是在哪裡查詢 domain name） <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-258-1><a id=__codelineno-258-1 name=__codelineno-258-1 href=#__codelineno-258-1></a>cat<span class=w> </span>/etc/resolv.conf
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/networking_prerequisite_dns_set_etc_resolv_conf.png></p> </li> <li> <p>檢視當前預設的 DNS 解析順序 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-259-1><a id=__codelineno-259-1 name=__codelineno-259-1 href=#__codelineno-259-1></a>cat<span class=w> </span>/etc/nsswitch.conf
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/nsswitch_conf.png></p> </li> <li> <p>在小型系統中，我們或許可以手動設定每個主機的 /etc/hosts 文件; 但若是在大型系統中，需要一個集中設定的地方 =&gt; DNS 伺服器 <img alt src=../../../assets/pics/k8s/networking_prerequisite_without_dns_server.png> <img alt src=../../../assets/pics/k8s/networking_prerequisite_with_dns_server.png></p> </li> <li> <p>域名 (Domain name) <img alt src=../../../assets/pics/k8s/domain_name.png></p> <ul> <li> <p><strong>Top Level Domain (TLD)</strong>: 例如: <code>.com</code>, <code>.org</code>, <code>.net</code> <img alt src=../../assets/pics/top_level_domain.png></p> </li> <li> <p>域名階層關係 <img alt src=../../../assets/pics/k8s/domain_name_hierarchy.png></p> </li> <li> <p>域名解析流程 <img alt src=../../../assets/pics/k8s/domain_name_resolution_process.png></p> </li> </ul> </li> <li> <p>DNS 紀錄類別</p> <ul> <li>A: 將 domain name 解析成 IPv4 address</li> <li>AAAA: 將 domain name 解析成 IPv6 address</li> <li>CNAME: 將 domain name 解析成另一個 domain name <img alt src=../../../assets/pics/k8s/dns_record_types.png></li> </ul> </li> <li> <p>DNS 常用指令</p> <ul> <li> <p><code>nslookup</code>: 查詢 DNS 記錄</p> <ul> <li>注意! 這個指令只會查詢 DNS 伺服器中的紀錄; 而不會查看 <code>/etc/hosts</code> 檔案中的靜態 DNS 記錄 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-260-1><a id=__codelineno-260-1 name=__codelineno-260-1 href=#__codelineno-260-1></a>nslookup<span class=w> </span>www.google.com
</span></code></pre></div></li> </ul> <p><img alt src=../../../assets/pics/k8s/nslookup.png></p> </li> <li> <p><code>dig</code>: 詳細檢視 DNS 記錄 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-261-1><a id=__codelineno-261-1 name=__codelineno-261-1 href=#__codelineno-261-1></a>dig<span class=w> </span>www.google.com
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/dig.png></p> </li> </ul> </li> </ul> </li> <li> <p>Networking Namespace</p> <ul> <li> <p>container 僅能看到由它本身運行的 process; 而底層主機可以看到所有的 process <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-262-1><a id=__codelineno-262-1 name=__codelineno-262-1 href=#__codelineno-262-1></a>ps<span class=w> </span>aux
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/process_namespace.png></p> </li> <li> <p>建立 Linux 主機的 network namespace <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-263-1><a id=__codelineno-263-1 name=__codelineno-263-1 href=#__codelineno-263-1></a>ip<span class=w> </span>netns<span class=w> </span>add<span class=w> </span>red
</span></code></pre></div></p> </li> <li> <p>列出當前所有的 network namespace <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-264-1><a id=__codelineno-264-1 name=__codelineno-264-1 href=#__codelineno-264-1></a>ip<span class=w> </span>netns
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/create_network_namespace.png></p> </li> <li> <p>在指定的 network namespace 中執行指令 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-265-1><a id=__codelineno-265-1 name=__codelineno-265-1 href=#__codelineno-265-1></a>ip<span class=w> </span>netns<span class=w> </span><span class=nb>exec</span><span class=w> </span>red<span class=w> </span>ip<span class=w> </span>link
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/exec_network_namespace.png></p> </li> <li> <p>Step 1: 建立虛擬乙太網路連線 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-266-1><a id=__codelineno-266-1 name=__codelineno-266-1 href=#__codelineno-266-1></a>ip<span class=w> </span>link<span class=w> </span>add<span class=w> </span>veth-red<span class=w> </span><span class=nb>type</span><span class=w> </span>veth<span class=w> </span>peer<span class=w> </span>name<span class=w> </span>veth-blue
</span></code></pre></div></p> </li> <li> <p>Step 2: 將虛擬乙太網路設定到指定的 network namespace <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-267-1><a id=__codelineno-267-1 name=__codelineno-267-1 href=#__codelineno-267-1></a>ip<span class=w> </span>link<span class=w> </span><span class=nb>set</span><span class=w> </span>veth-red<span class=w> </span>netns<span class=w> </span>red
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-268-1><a id=__codelineno-268-1 name=__codelineno-268-1 href=#__codelineno-268-1></a>ip<span class=w> </span>link<span class=w> </span><span class=nb>set</span><span class=w> </span>veth-blue<span class=w> </span>netns<span class=w> </span>blue
</span></code></pre></div> </li> <li> <p>Step 3: 在指定的 network namespace 中，設定虛擬以太網路的 IP address <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-269-1><a id=__codelineno-269-1 name=__codelineno-269-1 href=#__codelineno-269-1></a>ip<span class=w> </span>-n<span class=w> </span>red<span class=w> </span>addr<span class=w> </span>add<span class=w> </span><span class=m>192</span>.168.15.1/24<span class=w> </span>dev<span class=w> </span>veth-red
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-270-1><a id=__codelineno-270-1 name=__codelineno-270-1 href=#__codelineno-270-1></a>ip<span class=w> </span>-n<span class=w> </span>blue<span class=w> </span>addr<span class=w> </span>add<span class=w> </span><span class=m>192</span>.168.15.2/24<span class=w> </span>dev<span class=w> </span>veth-blue
</span></code></pre></div> </li> <li> <p>Step 4: 在指定的 network namespace 中，啟用虛擬乙太網路連線 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-271-1><a id=__codelineno-271-1 name=__codelineno-271-1 href=#__codelineno-271-1></a>ip<span class=w> </span>-n<span class=w> </span>red<span class=w> </span>link<span class=w> </span><span class=nb>set</span><span class=w> </span>veth-red<span class=w> </span>up
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-272-1><a id=__codelineno-272-1 name=__codelineno-272-1 href=#__codelineno-272-1></a>ip<span class=w> </span>-n<span class=w> </span>blue<span class=w> </span>link<span class=w> </span><span class=nb>set</span><span class=w> </span>veth-blue<span class=w> </span>up
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/create_veth.png></p> </li> <li> <p>在指定的 network namespace 中，測試虛擬乙太網路的連線 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-273-1><a id=__codelineno-273-1 name=__codelineno-273-1 href=#__codelineno-273-1></a>ip<span class=w> </span>netns<span class=w> </span><span class=nb>exec</span><span class=w> </span>red<span class=w> </span>ping<span class=w> </span><span class=m>192</span>.168.15.2
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-274-1><a id=__codelineno-274-1 name=__codelineno-274-1 href=#__codelineno-274-1></a>ip<span class=w> </span>netns<span class=w> </span><span class=nb>exec</span><span class=w> </span>red<span class=w> </span>arp
</span></code></pre></div> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-275-1><a id=__codelineno-275-1 name=__codelineno-275-1 href=#__codelineno-275-1></a>ip<span class=w> </span>netns<span class=w> </span><span class=nb>exec</span><span class=w> </span>blue<span class=w> </span>arp
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/test_veth.png></p> </li> <li> <p>刪除虛擬乙太網路連線 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-276-1><a id=__codelineno-276-1 name=__codelineno-276-1 href=#__codelineno-276-1></a>ip<span class=w> </span>-n<span class=w> </span>red<span class=w> </span>link<span class=w> </span>del<span class=w> </span>veth-red
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-277-1><a id=__codelineno-277-1 name=__codelineno-277-1 href=#__codelineno-277-1></a>ip<span class=w> </span>-n<span class=w> </span>red<span class=w> </span>link<span class=w> </span>del<span class=w> </span>veth-blue
</span></code></pre></div> </li> <li> <p>在生產環境中，通常我們會建立一個虛擬的交換機，來連接不同的 network namespace，而不需要手動一個個建立 veth pair</p> <ul> <li>e.g. <a href>Linux Bridge</a>, <a href=https://www.openvswitch.org/ >Open vSwitch</a> <img alt src=../../../assets/pics/k8s/virtual_switch.png></li> </ul> </li> </ul> </li> <li> <p>Docker Networking: Docker 有三種網路模式</p> <ul> <li> <p><strong>None</strong>: 在 None 模式下，容器只有一個 loopback 介面，無其他網路介面 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-278-1><a id=__codelineno-278-1 name=__codelineno-278-1 href=#__codelineno-278-1></a>docker<span class=w> </span>run<span class=w> </span>--network<span class=w> </span>none<span class=w> </span>nginx
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/docker_networking_none.png></p> </li> <li> <p><strong>Host</strong>: 在 Host 模式下，容器直接使用宿主機的網路堆疊，沒有獨立的網路命名空間 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-279-1><a id=__codelineno-279-1 name=__codelineno-279-1 href=#__codelineno-279-1></a>docker<span class=w> </span>run<span class=w> </span>--network<span class=w> </span>host<span class=w> </span>nginx
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/docker_networking_host.png></p> </li> <li> <p><strong>Bridge</strong>: <strong>預設的網路模式</strong>，會建立一個 Docker 內部專用網路，用於連接 container 到 Docker 宿主機的網路</p> <ul> <li>容器之間可以透過 IP address 相互通訊</li> </ul> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-280-1><a id=__codelineno-280-1 name=__codelineno-280-1 href=#__codelineno-280-1></a>docker<span class=w> </span>run<span class=w> </span>--network<span class=w> </span>bridge<span class=w> </span>nginx
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/docker_networking_bridge.png></p> </li> <li> <p>檢視當前所有的 Docker networking <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-281-1><a id=__codelineno-281-1 name=__codelineno-281-1 href=#__codelineno-281-1></a>docker<span class=w> </span>network<span class=w> </span>ls
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/docker_network_ls.png></p> </li> <li> <p>檢視當前 Docker container 的網路命名空間 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-282-1><a id=__codelineno-282-1 name=__codelineno-282-1 href=#__codelineno-282-1></a>ip<span class=w> </span>netns
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/ip_netns.png></p> </li> <li> <p>開放 Docker container 的 port，供外部存取使用 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-283-1><a id=__codelineno-283-1 name=__codelineno-283-1 href=#__codelineno-283-1></a>docker<span class=w> </span>run<span class=w> </span>-p<span class=w> </span><span class=m>8080</span>:80<span class=w> </span>nginx
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/docker_run_export_port.png></p> </li> <li> <p>Docker 使用 iptables 的原理，來實現 traffic 的 port-forwarding 機制 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-284-1><a id=__codelineno-284-1 name=__codelineno-284-1 href=#__codelineno-284-1></a>iptables<span class=w> </span><span class=se>\</span>
</span><span id=__span-284-2><a id=__codelineno-284-2 name=__codelineno-284-2 href=#__codelineno-284-2></a><span class=w>    </span>-t<span class=w> </span>nat<span class=w> </span><span class=se>\</span>
</span><span id=__span-284-3><a id=__codelineno-284-3 name=__codelineno-284-3 href=#__codelineno-284-3></a><span class=w>    </span>-A<span class=w> </span>DOCKER<span class=w> </span><span class=se>\</span>
</span><span id=__span-284-4><a id=__codelineno-284-4 name=__codelineno-284-4 href=#__codelineno-284-4></a><span class=w>    </span>-j<span class=w> </span>DNAT<span class=w> </span><span class=se>\</span>
</span><span id=__span-284-5><a id=__codelineno-284-5 name=__codelineno-284-5 href=#__codelineno-284-5></a><span class=w>    </span>--dport<span class=w> </span><span class=m>8080</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-284-6><a id=__codelineno-284-6 name=__codelineno-284-6 href=#__codelineno-284-6></a><span class=w>    </span>--to-destination<span class=w> </span><span class=m>172</span>.18.0.6:80
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/docker_iptables.png></p> </li> <li> <p>檢視 Docker 當前所有的 iptables 規則 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-285-1><a id=__codelineno-285-1 name=__codelineno-285-1 href=#__codelineno-285-1></a>iptables<span class=w> </span>-nvL<span class=w> </span>-t<span class=w> </span>nat
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/docker_iptables_rule.png></p> </li> </ul> </li> <li> <p>Container Network Interface (CNI)</p> <ul> <li> <p>是一個標準，用來規範容器運行時的網路設定 <img alt src=../../../assets/pics/k8s/container_network_interface.png> <img alt src=../../../assets/pics/k8s/cni_standard.png></p> </li> <li> <p>第三方 Network Plugin 供應商</p> <ul> <li>e.g. Weave, Calico, Flannel, Cilium</li> <li>但是，<strong>Docker 使用 Container Network Model (CNM)</strong> 來處理網路問題，而不是使用 CNI <img alt src=../../../assets/pics/k8s/docker_networking_cnm.png></li> </ul> </li> </ul> </li> <li> <p>K8s 叢集必須開放哪些 ports？</p> <ul> <li> <p>一般情況 <img alt src=../../../assets/pics/k8s/k8s_networking_structure.png></p> </li> <li> <p>多個 Master Node 之間的 etcd 需要交換資訊，可以開放 port 2380 供 etcd client 使用 <img alt src=../../../assets/pics/k8s/k8s_networking_etcd_client_port.png></p> </li> <li> <p>K8s 官方文件要求開放的 ports <img alt src=../../../assets/pics/k8s/k8s_docs_required_ports.png></p> </li> </ul> </li> </ul> <h3 id=pod-networking>Pod Networking<a class=headerlink href=#pod-networking title="Permanent link">&para;</a></h3> <ul> <li> <p>可以使用 K8s 官方推薦的第三方插件（plugin），來實現 Pod 的網路連接</p> <ul> <li>每個 Pod 都必須擁有一個 IP address</li> <li>在同一個 Node 中的所有 Pod 都必須能互相通訊</li> <li>在不同 Node 中的 Pod 也必須能互相通訊，而不需要透過 NAT <img alt src=../../../assets/pics/k8s/k8s_networking_plugin.png></li> </ul> </li> <li> <p>可以將所有關於設定 Pod 連線的指令，寫成一個 bash script <img alt src=../../../assets/pics/k8s/k8s_networking_net_script.png></p> </li> <li> <p>實務上，比較好的做法是在設定路由器作為 default Gateway，來連接不同的 Node</p> <ul> <li>如此，我們就會有一個虛擬網路（<code>10.244.0.0/16</code>），可以串連所有的 Node <img alt src=../../../assets/pics/k8s/k8s_networking_gateway.png></li> </ul> </li> <li> <p>實務上，我們需要一個標準、自動化的 K8s networking 設定方式 =&gt; 採用 CNI 標準</p> <ul> <li>分成 ADD, DEL 兩個主要部份<ul> <li>ADD: 在 k8s networking 中，新增 container</li> <li>DEL: 從 k8s networking 中，移除 container</li> </ul> </li> </ul> </li> <li> <p>運用 CNI 標準，快速設定 container 的網路連接</p> <ul> <li>CNI 設定檔的路徑: <code>/etc/cni/net.d</code></li> <li>CNI 指令檔的路徑: <code>/opt/cni/bin</code> (e.g. <code>net-script.sh</code>)</li> <li>執行指令: <code>./net-script.sh add &lt;container-name&gt; &lt;namespace&gt;</code> <img alt src=../../../assets/pics/k8s/k8s_networking_cni_config.png></li> </ul> </li> <li> <p>參考連結: <a href=https://kubernetes.io/docs/concepts/cluster-administration/addons/ >K8s 官方文件: Installing Addons</a></p> </li> </ul> <h3 id=cni-in-k8s>CNI in K8s<a class=headerlink href=#cni-in-k8s title="Permanent link">&para;</a></h3> <ul> <li>設定 CNI<ul> <li>建立 container runtime: containerd, cri-o</li> <li>選擇 container network plugin: weaveworks, flannel, cilium, VMware NSC<ul> <li>路徑: <code>/opt/cni/bin</code></li> </ul> </li> <li>參考設定檔: 要使用哪個 plugin？ 該如何使用 plugin？<ul> <li>路徑: <code>bridge.conflist</code>, <code>flannel.conflist</code> <img alt src=../../../assets/pics/k8s/configuring_cni.png> <img alt src=../../../assets/pics/k8s/view_kubelet_options.png></li> </ul> </li> </ul> </li> </ul> <h3 id=cni-weaveworks>CNI-weaveworks<a class=headerlink href=#cni-weaveworks title="Permanent link">&para;</a></h3> <ul> <li> <p>Weaveworks 是一個 CNI plugin，用來實現 K8s 叢集的網路連接</p> <ul> <li>功能: 提供網路連接、網路安全、網路監控等功能</li> <li>Weave Net 在 K8s 中會以 DaemonSet 的形式部署。因為 DaemonSet 能確保在 K8s 集群中的每個節點上都有運行一個 Pod，這對於網路插件而言是必要的。網路插件需要在每個節點上運行，以便管理該節點上所有 container 的網路設定 <img alt src=../../../assets/pics/k8s/cni_weaveworks_architecture.png></li> </ul> </li> <li> <p>部署 weavework 插件 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-286-1><a id=__codelineno-286-1 name=__codelineno-286-1 href=#__codelineno-286-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span><span class=s2>&quot;https://cloud.weave.works/k8s/net?k8s-version=</span><span class=k>$(</span>kubectl<span class=w> </span>version<span class=w> </span><span class=p>|</span><span class=w> </span>base64<span class=w> </span><span class=p>|</span><span class=w> </span>tr<span class=w> </span>-d<span class=w> </span><span class=s1>&#39;\n&#39;</span><span class=k>)</span><span class=s2>&quot;</span>
</span></code></pre></div></p> </li> <li> <p>檢視部署好的 weave net <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-287-1><a id=__codelineno-287-1 name=__codelineno-287-1 href=#__codelineno-287-1></a>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>–n<span class=o>=</span>kube-system
</span></code></pre></div></p> </li> <li> <p>可透過 log 來檢查部署 weave net 時的錯誤訊息 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-288-1><a id=__codelineno-288-1 name=__codelineno-288-1 href=#__codelineno-288-1></a>kubectl<span class=w> </span>logs<span class=w> </span>weave-net-5gcmb<span class=w> </span>weave<span class=w> </span>–n<span class=o>=</span>kube-system
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/weaveworks_peer.png></p> </li> </ul> <h3 id=ip-address-management-weaveworks>IP address management-weaveworks<a class=headerlink href=#ip-address-management-weaveworks title="Permanent link">&para;</a></h3> <ul> <li>根據 CNI 標準的要求，網路插件必須能管理每個 container 的 IP address <img alt src=../../../assets/pics/k8s/ip_address_management_cni_standard.png> <img alt src=../../../assets/pics/k8s/ip_address_management_weaveworks.png></li> </ul> <h3 id=dns-in-k8s>DNS in K8s<a class=headerlink href=#dns-in-k8s title="Permanent link">&para;</a></h3> <ul> <li>Service DNS 紀錄 (FQDN)</li> <li>Pod DNS 紀錄 (FQDN) <img alt src=../../../assets/pics/k8s/k8s_dns_fqdn.png></li> </ul> <h3 id=ingress>Ingress<a class=headerlink href=#ingress title="Permanent link">&para;</a></h3> <ul> <li> <p>前情提要: 關於將外部流量引導到 K8s 叢集中的 Pod 的方法</p> <ul> <li> <p>使用 NodePort Service</p> <ul> <li>域名解析：<code>www.my-online-store.com</code> 被解析到一個節點的 IP address <node-ip></li> <li>NodePort 服務 <code>wear-service</code> 開放 port 38080</li> <li>外部使用者的存取流程: 使用者存取 <code>http://my-online-store.com:38080</code> 時，該請求被轉發到 NodePort 服務 wear-service，然後再路由到後端的 Pod <img alt src=../../../assets/pics/k8s/ingress_nodeport_service.png></li> </ul> </li> <li> <p>使用負載平衡（Load Balancer）</p> <ul> <li>可透過多個 GCP Load Balancer 服務，存取不同的 Service（e.g. <code>wear-service</code>, <code>video-service</code>） <img alt src=../../../assets/pics/k8s/ingress_gcp_load_balancer.png></li> </ul> </li> </ul> </li> <li> <p>用途: 用來管理外部流量進入 K8s 叢集</p> <ul> <li>透過 Ingress Controller 來管理流量</li> <li>Ingress Controller 會根據 Ingress 資源的設定，來將流量導向到指定的 Service</li> <li>K8s 叢集預設並不提供 Ingress Controller，因此我們需要自行部署 Ingress Controller<ul> <li>僅需一次性設定 NodePort Service 或 Load Balancer，使其可以供外部存取 K8s 叢集中的 Service 即可 <img alt src=../../../assets/pics/k8s/ingress_nodeport.png> <img alt src=../../../assets/pics/k8s/ingress_load_balancer.png></li> </ul> </li> </ul> </li> <li> <p>Ingress Controller: 首先，必須在 K8s 叢集中部署一個 Ingress Controller 用來管理 Ingress Resource 的控制器，它負責監聽 Ingress Resource 的變更，並根據 Ingress 規則將流量路由到相應的 Service 上</p> <ul> <li>常見的 Ingress Controller: GCP Cloud Load Balancing, Nginx, HAProxy, Traefik, Contour, Istio <img alt src=../../../assets/pics/k8s/ingress_controller.png></li> </ul> </li> <li> <p>Ingress Resource: 部署好 Ingress Controller 之後，需要設定 Ingress Resource 來定義具體的路由規則。Ingress Resource 會設定如何將外部 HTTP 和 HTTPS 請求路由到 K8s 叢集內的 Service 上 <img alt src=../../../assets/pics/k8s/ingress_controller_and_ingress_resource.png></p> </li> <li> <p>建立 Ingress Controller 的流程</p> <ul> <li> <p>Step 1: 建立 ConfigMap <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-289-1><a id=__codelineno-289-1 name=__codelineno-289-1 href=#__codelineno-289-1></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
</span><span id=__span-289-2><a id=__codelineno-289-2 name=__codelineno-289-2 href=#__codelineno-289-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-289-3><a id=__codelineno-289-3 name=__codelineno-289-3 href=#__codelineno-289-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-289-4><a id=__codelineno-289-4 name=__codelineno-289-4 href=#__codelineno-289-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx-configuration</span>
</span></code></pre></div></p> </li> <li> <p>Step 2: 建立 Deployment <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-290-1><a id=__codelineno-290-1 name=__codelineno-290-1 href=#__codelineno-290-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id=__span-290-2><a id=__codelineno-290-2 name=__codelineno-290-2 href=#__codelineno-290-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id=__span-290-3><a id=__codelineno-290-3 name=__codelineno-290-3 href=#__codelineno-290-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-290-4><a id=__codelineno-290-4 name=__codelineno-290-4 href=#__codelineno-290-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ingress-controller</span>
</span><span id=__span-290-5><a id=__codelineno-290-5 name=__codelineno-290-5 href=#__codelineno-290-5></a>
</span><span id=__span-290-6><a id=__codelineno-290-6 name=__codelineno-290-6 href=#__codelineno-290-6></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-290-7><a id=__codelineno-290-7 name=__codelineno-290-7 href=#__codelineno-290-7></a><span class=w>    </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id=__span-290-8><a id=__codelineno-290-8 name=__codelineno-290-8 href=#__codelineno-290-8></a><span class=w>    </span><span class=nt>selector</span><span class=p>:</span>
</span><span id=__span-290-9><a id=__codelineno-290-9 name=__codelineno-290-9 href=#__codelineno-290-9></a><span class=w>        </span><span class=nt>matchLabels</span><span class=p>:</span>
</span><span id=__span-290-10><a id=__codelineno-290-10 name=__codelineno-290-10 href=#__codelineno-290-10></a><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress</span>
</span><span id=__span-290-11><a id=__codelineno-290-11 name=__codelineno-290-11 href=#__codelineno-290-11></a><span class=w>    </span><span class=nt>template</span><span class=p>:</span>
</span><span id=__span-290-12><a id=__codelineno-290-12 name=__codelineno-290-12 href=#__codelineno-290-12></a><span class=w>        </span><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-290-13><a id=__codelineno-290-13 name=__codelineno-290-13 href=#__codelineno-290-13></a><span class=w>            </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-290-14><a id=__codelineno-290-14 name=__codelineno-290-14 href=#__codelineno-290-14></a><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress</span>
</span><span id=__span-290-15><a id=__codelineno-290-15 name=__codelineno-290-15 href=#__codelineno-290-15></a><span class=w>        </span><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-290-16><a id=__codelineno-290-16 name=__codelineno-290-16 href=#__codelineno-290-16></a><span class=w>            </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ingress-serviceaccount</span>
</span><span id=__span-290-17><a id=__codelineno-290-17 name=__codelineno-290-17 href=#__codelineno-290-17></a><span class=w>            </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-290-18><a id=__codelineno-290-18 name=__codelineno-290-18 href=#__codelineno-290-18></a><span class=w>                </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress-controller</span>
</span><span id=__span-290-19><a id=__codelineno-290-19 name=__codelineno-290-19 href=#__codelineno-290-19></a><span class=w>                    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.21.0</span>
</span><span id=__span-290-20><a id=__codelineno-290-20 name=__codelineno-290-20 href=#__codelineno-290-20></a><span class=w>                    </span><span class=c1># 設定 Nginx Ingress Controller 的參數</span>
</span><span id=__span-290-21><a id=__codelineno-290-21 name=__codelineno-290-21 href=#__codelineno-290-21></a><span class=w>                    </span><span class=nt>args</span><span class=p>:</span>
</span><span id=__span-290-22><a id=__codelineno-290-22 name=__codelineno-290-22 href=#__codelineno-290-22></a><span class=w>                    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class="l l-Scalar l-Scalar-Plain">/nginx-ingress-controller</span>
</span><span id=__span-290-23><a id=__codelineno-290-23 name=__codelineno-290-23 href=#__codelineno-290-23></a><span class=w>                    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class="l l-Scalar l-Scalar-Plain">--configmap=$(POD_NAMESPACE)/nginx-configuration</span>
</span><span id=__span-290-24><a id=__codelineno-290-24 name=__codelineno-290-24 href=#__codelineno-290-24></a><span class=w>                </span><span class=nt>env</span><span class=p>:</span>
</span><span id=__span-290-25><a id=__codelineno-290-25 name=__codelineno-290-25 href=#__codelineno-290-25></a><span class=w>                </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">POD_NAME</span>
</span><span id=__span-290-26><a id=__codelineno-290-26 name=__codelineno-290-26 href=#__codelineno-290-26></a><span class=w>                    </span><span class=nt>valueFrom</span><span class=p>:</span>
</span><span id=__span-290-27><a id=__codelineno-290-27 name=__codelineno-290-27 href=#__codelineno-290-27></a><span class=w>                        </span><span class=nt>fieldRef</span><span class=p>:</span>
</span><span id=__span-290-28><a id=__codelineno-290-28 name=__codelineno-290-28 href=#__codelineno-290-28></a><span class=w>                            </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">metadata.name</span>
</span><span id=__span-290-29><a id=__codelineno-290-29 name=__codelineno-290-29 href=#__codelineno-290-29></a><span class=w>                </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">POD_NAMESPACE</span>
</span><span id=__span-290-30><a id=__codelineno-290-30 name=__codelineno-290-30 href=#__codelineno-290-30></a><span class=w>                    </span><span class=nt>valueFrom</span><span class=p>:</span>
</span><span id=__span-290-31><a id=__codelineno-290-31 name=__codelineno-290-31 href=#__codelineno-290-31></a><span class=w>                        </span><span class=nt>fieldRef</span><span class=p>:</span>
</span><span id=__span-290-32><a id=__codelineno-290-32 name=__codelineno-290-32 href=#__codelineno-290-32></a><span class=w>                            </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">metadata.namespace</span>
</span><span id=__span-290-33><a id=__codelineno-290-33 name=__codelineno-290-33 href=#__codelineno-290-33></a><span class=w>            </span><span class=nt>ports</span><span class=p>:</span>
</span><span id=__span-290-34><a id=__codelineno-290-34 name=__codelineno-290-34 href=#__codelineno-290-34></a><span class=w>                </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
</span><span id=__span-290-35><a id=__codelineno-290-35 name=__codelineno-290-35 href=#__codelineno-290-35></a><span class=w>                    </span><span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id=__span-290-36><a id=__codelineno-290-36 name=__codelineno-290-36 href=#__codelineno-290-36></a><span class=w>                </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https</span>
</span><span id=__span-290-37><a id=__codelineno-290-37 name=__codelineno-290-37 href=#__codelineno-290-37></a><span class=w>                    </span><span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
</span></code></pre></div></p> </li> <li> <p>Step 3: 建立 Service Account，以設定正確的 Roles, ClusterRoles, RoleBindings 權限 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-291-1><a id=__codelineno-291-1 name=__codelineno-291-1 href=#__codelineno-291-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>ingress-sa.yaml
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/ingress_controller_configmap_and_serviceaccount.png></p> </li> <li> <p>Step 4: 設定 Ingress 的 NodePort Service，供開放外部存取使用 <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-292-1><a id=__codelineno-292-1 name=__codelineno-292-1 href=#__codelineno-292-1></a><span class=c1># service-Nodeport.yaml</span>
</span><span id=__span-292-2><a id=__codelineno-292-2 name=__codelineno-292-2 href=#__codelineno-292-2></a>
</span><span id=__span-292-3><a id=__codelineno-292-3 name=__codelineno-292-3 href=#__codelineno-292-3></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-292-4><a id=__codelineno-292-4 name=__codelineno-292-4 href=#__codelineno-292-4></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
</span><span id=__span-292-5><a id=__codelineno-292-5 name=__codelineno-292-5 href=#__codelineno-292-5></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-292-6><a id=__codelineno-292-6 name=__codelineno-292-6 href=#__codelineno-292-6></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ingress</span>
</span><span id=__span-292-7><a id=__codelineno-292-7 name=__codelineno-292-7 href=#__codelineno-292-7></a>
</span><span id=__span-292-8><a id=__codelineno-292-8 name=__codelineno-292-8 href=#__codelineno-292-8></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-292-9><a id=__codelineno-292-9 name=__codelineno-292-9 href=#__codelineno-292-9></a><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
</span><span id=__span-292-10><a id=__codelineno-292-10 name=__codelineno-292-10 href=#__codelineno-292-10></a><span class=w>    </span><span class=nt>ports</span><span class=p>:</span>
</span><span id=__span-292-11><a id=__codelineno-292-11 name=__codelineno-292-11 href=#__codelineno-292-11></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id=__span-292-12><a id=__codelineno-292-12 name=__codelineno-292-12 href=#__codelineno-292-12></a><span class=w>        </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id=__span-292-13><a id=__codelineno-292-13 name=__codelineno-292-13 href=#__codelineno-292-13></a><span class=w>        </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</span><span id=__span-292-14><a id=__codelineno-292-14 name=__codelineno-292-14 href=#__codelineno-292-14></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
</span><span id=__span-292-15><a id=__codelineno-292-15 name=__codelineno-292-15 href=#__codelineno-292-15></a>
</span><span id=__span-292-16><a id=__codelineno-292-16 name=__codelineno-292-16 href=#__codelineno-292-16></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
</span><span id=__span-292-17><a id=__codelineno-292-17 name=__codelineno-292-17 href=#__codelineno-292-17></a><span class=w>        </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
</span><span id=__span-292-18><a id=__codelineno-292-18 name=__codelineno-292-18 href=#__codelineno-292-18></a><span class=w>        </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</span><span id=__span-292-19><a id=__codelineno-292-19 name=__codelineno-292-19 href=#__codelineno-292-19></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https</span>
</span><span id=__span-292-20><a id=__codelineno-292-20 name=__codelineno-292-20 href=#__codelineno-292-20></a>
</span><span id=__span-292-21><a id=__codelineno-292-21 name=__codelineno-292-21 href=#__codelineno-292-21></a><span class=w>    </span><span class=nt>selector</span><span class=p>:</span>
</span><span id=__span-292-22><a id=__codelineno-292-22 name=__codelineno-292-22 href=#__codelineno-292-22></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress</span>
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-293-1><a id=__codelineno-293-1 name=__codelineno-293-1 href=#__codelineno-293-1></a>kubectl<span class=w> </span>create<span class=w> </span>-f<span class=w> </span>service-Nodeport.yaml
</span></code></pre></div> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-294-1><a id=__codelineno-294-1 name=__codelineno-294-1 href=#__codelineno-294-1></a>kubectl<span class=w> </span>get<span class=w> </span>services
</span></code></pre></div> </li> </ul> </li> <li> <p>建立 Ingress Resource 的兩種策略 <img alt src=../../../assets/pics/k8s/ingress_resource_two_strategies.png> <img alt src=../../../assets/pics/k8s/ingress_resource_rules_and_path.png></p> <ul> <li> <p>策略 1: 2 Rules and 1 Path each <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-295-1><a id=__codelineno-295-1 name=__codelineno-295-1 href=#__codelineno-295-1></a><span class=c1># ingress-wear-watch.yaml</span>
</span><span id=__span-295-2><a id=__codelineno-295-2 name=__codelineno-295-2 href=#__codelineno-295-2></a>
</span><span id=__span-295-3><a id=__codelineno-295-3 name=__codelineno-295-3 href=#__codelineno-295-3></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
</span><span id=__span-295-4><a id=__codelineno-295-4 name=__codelineno-295-4 href=#__codelineno-295-4></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id=__span-295-5><a id=__codelineno-295-5 name=__codelineno-295-5 href=#__codelineno-295-5></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-295-6><a id=__codelineno-295-6 name=__codelineno-295-6 href=#__codelineno-295-6></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ingress-wear-watch</span>
</span><span id=__span-295-7><a id=__codelineno-295-7 name=__codelineno-295-7 href=#__codelineno-295-7></a>
</span><span id=__span-295-8><a id=__codelineno-295-8 name=__codelineno-295-8 href=#__codelineno-295-8></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-295-9><a id=__codelineno-295-9 name=__codelineno-295-9 href=#__codelineno-295-9></a><span class=w>    </span><span class=c1># 2 Rules</span>
</span><span id=__span-295-10><a id=__codelineno-295-10 name=__codelineno-295-10 href=#__codelineno-295-10></a><span class=w>    </span><span class=nt>rules</span><span class=p>:</span>
</span><span id=__span-295-11><a id=__codelineno-295-11 name=__codelineno-295-11 href=#__codelineno-295-11></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">wear.my-online-store.com</span>
</span><span id=__span-295-12><a id=__codelineno-295-12 name=__codelineno-295-12 href=#__codelineno-295-12></a><span class=w>        </span><span class=nt>http</span><span class=p>:</span>
</span><span id=__span-295-13><a id=__codelineno-295-13 name=__codelineno-295-13 href=#__codelineno-295-13></a><span class=w>            </span><span class=c1># 1 Path each</span>
</span><span id=__span-295-14><a id=__codelineno-295-14 name=__codelineno-295-14 href=#__codelineno-295-14></a><span class=w>            </span><span class=nt>paths</span><span class=p>:</span>
</span><span id=__span-295-15><a id=__codelineno-295-15 name=__codelineno-295-15 href=#__codelineno-295-15></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>backend</span><span class=p>:</span>
</span><span id=__span-295-16><a id=__codelineno-295-16 name=__codelineno-295-16 href=#__codelineno-295-16></a><span class=w>                    </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">wear-service</span>
</span><span id=__span-295-17><a id=__codelineno-295-17 name=__codelineno-295-17 href=#__codelineno-295-17></a><span class=w>                    </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id=__span-295-18><a id=__codelineno-295-18 name=__codelineno-295-18 href=#__codelineno-295-18></a>
</span><span id=__span-295-19><a id=__codelineno-295-19 name=__codelineno-295-19 href=#__codelineno-295-19></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">watch.my-online-store.com</span>
</span><span id=__span-295-20><a id=__codelineno-295-20 name=__codelineno-295-20 href=#__codelineno-295-20></a><span class=w>        </span><span class=nt>http</span><span class=p>:</span>
</span><span id=__span-295-21><a id=__codelineno-295-21 name=__codelineno-295-21 href=#__codelineno-295-21></a><span class=w>            </span><span class=c1># 1 Path each</span>
</span><span id=__span-295-22><a id=__codelineno-295-22 name=__codelineno-295-22 href=#__codelineno-295-22></a><span class=w>            </span><span class=nt>paths</span><span class=p>:</span>
</span><span id=__span-295-23><a id=__codelineno-295-23 name=__codelineno-295-23 href=#__codelineno-295-23></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>backend</span><span class=p>:</span>
</span><span id=__span-295-24><a id=__codelineno-295-24 name=__codelineno-295-24 href=#__codelineno-295-24></a><span class=w>                    </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">watch-service</span>
</span><span id=__span-295-25><a id=__codelineno-295-25 name=__codelineno-295-25 href=#__codelineno-295-25></a><span class=w>                    </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/ingress_resource_2_rules_and_1_path_each.png></p> </li> <li> <p>策略 2: 1 Rule and 2 Paths <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-296-1><a id=__codelineno-296-1 name=__codelineno-296-1 href=#__codelineno-296-1></a><span class=c1># ingress-wear-watch.yaml</span>
</span><span id=__span-296-2><a id=__codelineno-296-2 name=__codelineno-296-2 href=#__codelineno-296-2></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
</span><span id=__span-296-3><a id=__codelineno-296-3 name=__codelineno-296-3 href=#__codelineno-296-3></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</span><span id=__span-296-4><a id=__codelineno-296-4 name=__codelineno-296-4 href=#__codelineno-296-4></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-296-5><a id=__codelineno-296-5 name=__codelineno-296-5 href=#__codelineno-296-5></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ingress-wear-watch</span>
</span><span id=__span-296-6><a id=__codelineno-296-6 name=__codelineno-296-6 href=#__codelineno-296-6></a>
</span><span id=__span-296-7><a id=__codelineno-296-7 name=__codelineno-296-7 href=#__codelineno-296-7></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-296-8><a id=__codelineno-296-8 name=__codelineno-296-8 href=#__codelineno-296-8></a><span class=w>    </span><span class=c1># 1 Rule</span>
</span><span id=__span-296-9><a id=__codelineno-296-9 name=__codelineno-296-9 href=#__codelineno-296-9></a><span class=w>    </span><span class=nt>rules</span><span class=p>:</span>
</span><span id=__span-296-10><a id=__codelineno-296-10 name=__codelineno-296-10 href=#__codelineno-296-10></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>http</span><span class=p>:</span>
</span><span id=__span-296-11><a id=__codelineno-296-11 name=__codelineno-296-11 href=#__codelineno-296-11></a><span class=w>        </span><span class=nt>paths</span><span class=p>:</span>
</span><span id=__span-296-12><a id=__codelineno-296-12 name=__codelineno-296-12 href=#__codelineno-296-12></a><span class=w>        </span><span class=c1># 2 Paths</span>
</span><span id=__span-296-13><a id=__codelineno-296-13 name=__codelineno-296-13 href=#__codelineno-296-13></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/wear</span>
</span><span id=__span-296-14><a id=__codelineno-296-14 name=__codelineno-296-14 href=#__codelineno-296-14></a><span class=w>            </span><span class=nt>backend</span><span class=p>:</span>
</span><span id=__span-296-15><a id=__codelineno-296-15 name=__codelineno-296-15 href=#__codelineno-296-15></a><span class=w>                </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">wear-service</span>
</span><span id=__span-296-16><a id=__codelineno-296-16 name=__codelineno-296-16 href=#__codelineno-296-16></a><span class=w>                </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span><span id=__span-296-17><a id=__codelineno-296-17 name=__codelineno-296-17 href=#__codelineno-296-17></a>
</span><span id=__span-296-18><a id=__codelineno-296-18 name=__codelineno-296-18 href=#__codelineno-296-18></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w>   </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/watch</span>
</span><span id=__span-296-19><a id=__codelineno-296-19 name=__codelineno-296-19 href=#__codelineno-296-19></a><span class=w>            </span><span class=nt>backend</span><span class=p>:</span>
</span><span id=__span-296-20><a id=__codelineno-296-20 name=__codelineno-296-20 href=#__codelineno-296-20></a><span class=w>                </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">watch-service</span>
</span><span id=__span-296-21><a id=__codelineno-296-21 name=__codelineno-296-21 href=#__codelineno-296-21></a><span class=w>                </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/ingress_resource_1_rule_2_paths.png> <img alt src=../../../assets/pics/k8s/ingress_resource_1_rule_2_paths_describe.png></p> </li> </ul> </li> <li> <p>總結（Ingress 架構圖） <img alt src=../../../assets/pics/k8s/ingress_overall_architecture.png></p> </li> </ul> <h2 id=design-k8s-cluster>Design K8s Cluster<a class=headerlink href=#design-k8s-cluster title="Permanent link">&para;</a></h2> <ul> <li> <p>目標</p> <ul> <li>學習/教育: <a href="https://minikube.sigs.k8s.io/docs/start/?arch=%2Fmacos%2Fx86-64%2Fstable%2Fbinary+download">Minikube</a>, 單一節點的 K8s 叢集（AWS, GCP, Azure）</li> <li> <p>開發/測試: 一個 master node + 多個 worker node 的多節點 K8s 叢集（AWS, GCP, Azure）, 使用 <a href=https://kubernetes.io/docs/reference/setup-tools/kubeadm/ >Kubeadm</a> 工具來快速建立叢集 <img alt src=../../../assets/pics/k8s/turnkey_solution.png></p> </li> <li> <p>生產環境: 使用三大公有雲的 K8s 代管服務（AWS, GCP, Azure）</p> <ul> <li><strong>Kops</strong> for AWS</li> <li><strong>GKE</strong> for GCP</li> <li><strong>Azure Kubernetes Service(AKS)</strong> for Azure <img alt src=../../../assets/pics/k8s/hosted_solution.png></li> </ul> </li> <li> <p>統整 <img alt src=../../../assets/pics/k8s/minikube_vs_kubeadm.png> <img alt src=../../../assets/pics/k8s/turnkey_vs_hosted_solution.png></p> </li> </ul> </li> <li> <p>架設 K8s 叢集前的考量</p> <ul> <li>部署考量<ul> <li>本地架設（On premise）</li> <li>雲端代管服務（Cloud）</li> </ul> </li> <li>節點考量<ul> <li>使用實體機器 or 虛擬機器作為 Node</li> <li>根據需求，制定 K8s 叢集的最小需求節點數（含 Master Node, Worker Node）</li> <li>Master Node vs Worker Node 分別需要幾個</li> <li><strong>最佳實踐: Master Node 不會負責處理工作需求</strong>（雖然理論上可以）</li> </ul> </li> <li>資源考量<ul> <li>儲存空間<ul> <li>需要高效能的應用程式: SSD Backed Storag</li> <li>能處理高併發連線的應用程式: Network based storage</li> <li>能讓多個 Pods 共享存取的持久性儲存空間: Persistent shared volumes</li> <li>透過 label，將指定的應用程式，分配到指定的硬碟類型的節點上</li> <li>透過 Node Selectors 來指定應用程式，佈署到指定的硬碟類型的節點上</li> </ul> </li> </ul> </li> <li>網路考量<ul> <li><a href=https://kubernetes.io/docs/concepts/cluster-administration/addons/ >K8s networking addons</a>: <strong>Weave Net</strong>, Flannel ...等</li> </ul> </li> </ul> </li> <li> <p>架設 K8s 叢集</p> <ul> <li> <p>kube-apiserver: 設計 active-active 模式，是為了確保 Master Node 與 Worker Node 能持續交流，以避免單點故障 <img alt src=../../../assets/pics/k8s/kube_apiserver_active_active_architecture.png></p> </li> <li> <p>kube-controller-manager, kube-scheduler: 設計 active-standby 模式，是為了確保 K8s 叢集狀態的一致性，以避免 Master Node 之間的競爭 <img alt src=../../../assets/pics/k8s/kube_controller_manager_active_standy_architecture.png></p> </li> <li> <p>etcd: 可選擇採用 <strong>Stacked</strong> 或 External etcd 拓樸架構</p> <ul> <li> <p>Stacked 拓樸架構: 較容易設定，但是沒有 HA 機制 <img alt src=../../assets/pics/k8s/docs/assets/pics/k8s/etcd_stacked_topology.png></p> </li> <li> <p>External etcd 拓樸架構: 較複雜設定，但是有 HA 機制 <img alt src=../../../assets/pics/k8s/external_etcd_topology.png></p> <ul> <li>kube-apiserver 需要設定連線到哪個 etcd 伺服器 <img alt src=../../../assets/pics/k8s/kube_apiserver_connect_etcd_server.png></li> </ul> </li> </ul> </li> </ul> </li> <li> <p>etcd 伺服器會採用 RAFT 共識演算法，定期選出 Leader Node，來負責寫入資料; 而其它 Follower Node 則負責讀取資料</p> <ul> <li> <p>RAFT 共識演算法: 所有節點同時啟動隨機計時器，由第一個完成的節點向其它節點發出請求，擔任 Leader Node。當獲得多數（majority）的其他節點的贊同時，該節點就會成為 Leader Node</p> <ul> <li>多數（majority）= 法定人數（quorum）: N/2 + 1 <img alt src=../../../assets/pics/k8s/raft_quorum.png></li> </ul> </li> <li> <p>節點總數是奇數 or 偶數也有差別; 此外，網路分段（network segmentation）也有影響多數（majority）的判定</p> </li> <li>最佳實踐: K8s 叢集的總節點數，採用奇數，並且使用 3, 5, 7 ... 個節點較好 <img alt src=../../../assets/pics/k8s/design_k8s_cluster_number_of_nodes.png></li> </ul> </li> </ul> <h2 id=create-k8s-cluster-using-kubeadm-tool>Create K8s cluster using kubeadm tool<a class=headerlink href=#create-k8s-cluster-using-kubeadm-tool title="Permanent link">&para;</a></h2> <ul> <li> <p>本課程的範例 K8s 叢集架構設計圖: 1 Master Node + 2 Worker Node <img alt src=../../../assets/pics/k8s/demo_k8s_architecture.png> <img alt src=../../../assets/pics/k8s/create_k8s_cluster_using_kubeadm_tool.png></p> </li> <li> <p>本課程的範例 K8s 叢集建置流程圖解 <img alt src=../../../assets/pics/k8s/create_k8s_cluster_using_kubeadm_tool_steps_illustration.png></p> <ul> <li>Step 1: 運用 Virtual Box 建立虛擬機器</li> <li>Step 2: 運用 <a href=https://www.vagrantup.com/ >Vagrant</a> 快速自動化建置虛擬機器的環境</li> <li>Step 3: <a href=https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-runtime>安裝 container runtime</a>: containerd, Docker<ul> <li>以選擇 <a href=https://kubernetes.io/docs/setup/production-environment/container-runtimes/ >containerd</a> 為例<ul> <li><strong>在 Master Node, Worker Node 都要</strong> <a href=https://kubernetes.io/docs/setup/production-environment/container-runtimes/#prerequisite-ipv4-forwarding-optional>啟用 IPv4 packet forwarding</a></li> <li><a href=https://kubernetes.io/docs/setup/production-environment/container-runtimes/#prerequisite-ipv4-forwarding-optional>驗證 <code>net.ipv4.ip_forward</code> 已設定為 1</a></li> </ul> </li> </ul> </li> <li>Step 4: <strong>在 Master Node, Worker Node 都要</strong> <a href=https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl>安裝 kubeadm, kubectl, kubelet 工具</a><ul> <li>kubeadm: 用來引導建立 K8s 叢集的指令工具</li> <li>kubectl: 用來與 K8s 叢集溝通的 CLI 命令列工具</li> <li>kubelet: 在 K8s 叢集中的所有機器上運行的元件，負責啟動 Pod、容器</li> </ul> </li> <li>Step 5: <strong>在 Master Node, Worker Node 都要</strong> <a href=https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/configure-cgroup-driver/ >安裝 cgroup driver</a>: kubelet、container runtime 都需要透過 cgroup driver 來管理硬體資源（e.g. CPU, Memory）<ul> <li>以選擇 <strong>systemd</strong> 為例 (K8s v1.22 之後，預設就是使用 systemd，所以不需要做額外設定)</li> </ul> </li> <li> <p>Step 6: <a href=https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#initializing-your-control-plane-node>初始化 Master Node</a></p> <ul> <li> <p>設定 Master Node 的共享端點，可以是 DNS 名稱, IP address, 負載平衡器的 IP address (若是要建立 2 個以上的 Master Node 才需要設定，所以是 optional 的步驟) <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-297-1><a id=__codelineno-297-1 name=__codelineno-297-1 href=#__codelineno-297-1></a>kubeadm<span class=w> </span>init<span class=w> </span>--control-plane-endpoint<span class=o>=</span>
</span></code></pre></div></p> </li> <li> <p><strong>設定 Pod network CIDR</strong> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-298-1><a id=__codelineno-298-1 name=__codelineno-298-1 href=#__codelineno-298-1></a>kubeadm<span class=w> </span>init<span class=w> </span>--pod-network-cidr<span class=o>=</span>
</span></code></pre></div></p> </li> <li> <p>設定 kubeadm 要使用的 container runtime (通常 kubeadm 會自動偵測，所以是 optional 的步驟) <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-299-1><a id=__codelineno-299-1 name=__codelineno-299-1 href=#__codelineno-299-1></a>kubeadm<span class=w> </span>init<span class=w> </span>--cri-socket<span class=o>=</span>&lt;containerd&gt;
</span></code></pre></div></p> </li> <li> <p>設定 kube-apiserver 的靜態 IP address，讓所有的 Worker Node 都能存取 kube-apiserver (通常 kubeadm 預設會使用 default gateway 的 IP address，所以是 optional 的步驟) <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-300-1><a id=__codelineno-300-1 name=__codelineno-300-1 href=#__codelineno-300-1></a>kubeadm<span class=w> </span>init<span class=w> </span>--apiserver-advertise-address<span class=o>=</span>&lt;master-node-ip-address&gt;
</span></code></pre></div></p> </li> </ul> </li> <li> <p>Step 7: 建立 kube config 檔案 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-301-1><a id=__codelineno-301-1 name=__codelineno-301-1 href=#__codelineno-301-1></a>mkdir<span class=w> </span>-p<span class=w> </span><span class=nv>$HOME</span>/.kube
</span><span id=__span-301-2><a id=__codelineno-301-2 name=__codelineno-301-2 href=#__codelineno-301-2></a>sudo<span class=w> </span>cp<span class=w> </span>-i<span class=w> </span>/etc/kubernetes/admin.conf<span class=w> </span><span class=nv>$HOME</span>/.kube/config
</span><span id=__span-301-3><a id=__codelineno-301-3 name=__codelineno-301-3 href=#__codelineno-301-3></a>sudo<span class=w> </span>chown<span class=w> </span><span class=k>$(</span>id<span class=w> </span>-u<span class=k>)</span>:<span class=k>$(</span>id<span class=w> </span>-g<span class=k>)</span><span class=w> </span><span class=nv>$HOME</span>/.kube/config
</span></code></pre></div></p> <ul> <li>確認 Master Node 是否已成功初始化 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-302-1><a id=__codelineno-302-1 name=__codelineno-302-1 href=#__codelineno-302-1></a>kubectl<span class=w> </span>get<span class=w> </span>nodes
</span></code></pre></div></li> </ul> </li> <li> <p>Step 8: <strong>在 Master Node</strong>，設定 K8s 叢集的網路連線 (CNI)</p> <ul> <li> <p>以選擇 <a href=https://kubernetes.io/docs/concepts/cluster-administration/addons/ >Weave Net</a> 為例 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-303-1><a id=__codelineno-303-1 name=__codelineno-303-1 href=#__codelineno-303-1></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>https://reweave.azurewebsites.net/k8s/&lt;k8s-version&gt;/net.yaml
</span></code></pre></div></p> </li> <li> <p><a href=https://rajch.github.io/weave/kubernetes/kube-addon#key-points>確保網路設定的一致性</a>: 若在 Worker Node 的 kube-proxy 中有設定 <code>--cluster-cidr</code> 選項 (也就是 <code>kubeadm init --pod-network-cidr=</code> 的 IP address) 的話，請確保 Weave Net 這個 DaemonSet 的環境變數 <code>IPALLOC_RANGE</code> 的 IP address 一致性 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-304-1><a id=__codelineno-304-1 name=__codelineno-304-1 href=#__codelineno-304-1></a>kubectl<span class=w> </span>edit<span class=w> </span>daemonset<span class=w> </span>weave-net<span class=w> </span>-n<span class=o>=</span>kube-system
</span></code></pre></div></p> </li> <li> <p>確認 Weave Net 這個 DaemonSet 是否已成功部署在 Master Node 上 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-305-1><a id=__codelineno-305-1 name=__codelineno-305-1 href=#__codelineno-305-1></a>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=o>=</span>kube-system
</span></code></pre></div></p> </li> </ul> </li> <li> <p>Step 9: <a href=https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#join-nodes>將 Worker Node 都加入到 K8s 叢集中</a></p> <ul> <li> <p>在 <strong>Worker Node</strong> 中執行以下指令 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-306-1><a id=__codelineno-306-1 name=__codelineno-306-1 href=#__codelineno-306-1></a>sudo<span class=w> </span>kubeadm<span class=w> </span>join<span class=w> </span>--token<span class=w> </span>&lt;token&gt;<span class=w> </span>&lt;control-plane-host&gt;:&lt;control-plane-port&gt;<span class=w> </span>--discovery-token-ca-cert-hash<span class=w> </span>sha256:&lt;hash&gt;
</span></code></pre></div></p> </li> <li> <p>確認 Worker Node 是否已成功加入 K8s 叢集 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-307-1><a id=__codelineno-307-1 name=__codelineno-307-1 href=#__codelineno-307-1></a>kubectl<span class=w> </span>get<span class=w> </span>nodes
</span></code></pre></div></p> </li> </ul> </li> </ul> </li> </ul> <h2 id=end-to-end-tests-on-k8s-cluster>End to End Tests on K8s Cluster<a class=headerlink href=#end-to-end-tests-on-k8s-cluster title="Permanent link">&para;</a></h2> <blockquote> <p>在 2020/09 月之後的 CKA 考試，不會考到 End to End Tests 的部分！ <br></p> </blockquote> <ul> <li> <p>測試 K8s 叢集的方法</p> <ul> <li> <p>手動測試</p> <ul> <li> <p>確認節點正常運行 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-308-1><a id=__codelineno-308-1 name=__codelineno-308-1 href=#__codelineno-308-1></a>kubectl<span class=w> </span>get<span class=w> </span>nodes
</span></code></pre></div></p> </li> <li> <p>確認 Pod 正常運行 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-309-1><a id=__codelineno-309-1 name=__codelineno-309-1 href=#__codelineno-309-1></a>kubectl<span class=w> </span>get<span class=w> </span>pods
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/k8s_cluster_manual_test_check_nodes_and_pods.png></p> </li> <li> <p>確認 Master Node</p> <ul> <li> <p>kube-apiserver 的運行狀態 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-310-1><a id=__codelineno-310-1 name=__codelineno-310-1 href=#__codelineno-310-1></a>service<span class=w> </span>kube-apiserver<span class=w> </span>status
</span></code></pre></div></p> </li> <li> <p>kube-controller-manager 的運行狀態 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-311-1><a id=__codelineno-311-1 name=__codelineno-311-1 href=#__codelineno-311-1></a>service<span class=w> </span>kube-controller-manager<span class=w> </span>status
</span></code></pre></div></p> </li> <li> <p>kube-scheduler 的運行狀態 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-312-1><a id=__codelineno-312-1 name=__codelineno-312-1 href=#__codelineno-312-1></a>service<span class=w> </span>kube-scheduler<span class=w> </span>status
</span></code></pre></div></p> </li> </ul> <p><img alt src=../../../assets/pics/k8s/k8s_cluster_manual_test_check_master_node.png></p> </li> <li> <p>確認 Worker Node</p> <ul> <li> <p>kubelet 的運行狀態 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-313-1><a id=__codelineno-313-1 name=__codelineno-313-1 href=#__codelineno-313-1></a>service<span class=w> </span>kubelet<span class=w> </span>status
</span></code></pre></div></p> </li> <li> <p>kube-proxy 的運行狀態 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-314-1><a id=__codelineno-314-1 name=__codelineno-314-1 href=#__codelineno-314-1></a>service<span class=w> </span>kube-proxy<span class=w> </span>status
</span></code></pre></div></p> </li> </ul> <p><img alt src=../../../assets/pics/k8s/k8s_cluster_manual_test_check_worker_node.png></p> </li> <li> <p>確認 Deployment 能成功部署 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-315-1><a id=__codelineno-315-1 name=__codelineno-315-1 href=#__codelineno-315-1></a>kubectl<span class=w> </span>run<span class=w> </span>nginx
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-316-1><a id=__codelineno-316-1 name=__codelineno-316-1 href=#__codelineno-316-1></a>kubectl<span class=w> </span>get<span class=w> </span>pods
</span></code></pre></div> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-317-1><a id=__codelineno-317-1 name=__codelineno-317-1 href=#__codelineno-317-1></a>kubectl<span class=w> </span>scale<span class=w> </span>--replicas<span class=o>=</span><span class=m>3</span><span class=w> </span>deploy/nginx
</span></code></pre></div> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-318-1><a id=__codelineno-318-1 name=__codelineno-318-1 href=#__codelineno-318-1></a>kubectl<span class=w> </span>get<span class=w> </span>pods
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/k8s_cluster_manual_test_check_deployment.png></p> </li> <li> <p>確認 Service 能正常運作 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-319-1><a id=__codelineno-319-1 name=__codelineno-319-1 href=#__codelineno-319-1></a>kubectl<span class=w> </span>expose<span class=w> </span>deployment<span class=w> </span>nginx<span class=w> </span>--port<span class=o>=</span><span class=m>80</span><span class=w> </span>--type<span class=o>=</span>NodePort
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-320-1><a id=__codelineno-320-1 name=__codelineno-320-1 href=#__codelineno-320-1></a>kubectl<span class=w> </span>get<span class=w> </span>service
</span></code></pre></div> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-321-1><a id=__codelineno-321-1 name=__codelineno-321-1 href=#__codelineno-321-1></a>curl<span class=w> </span>http://&lt;worker-node&gt;:&lt;NodePort&gt;
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/k8s_cluster_manual_test_check_service.png></p> </li> </ul> </li> <li> <p>自動化測試工具: <a href="https://github.com/kubernetes/test-infra?tab=readme-ov-file">K8s test-infra</a></p> <ul> <li> <p>能確保 K8s 叢集中的 Networking、Service、DNS 解析、Secrets、ConfigMap 均能正常運作 <img alt src=../../../assets/pics/k8s/k8s_test_infra.png> <img alt src=../../../assets/pics/k8s/k8s_test_infra_procedures.png></p> </li> <li> <p>常用指令 <img alt src=../../../assets/pics/k8s/k8s_test_infra_commands.png></p> </li> <li> <p>範例檢測結果 <img alt src=../../../assets/pics/k8s/k8s_test_infra_result_part1.png> <img alt src=../../../assets/pics/k8s/k8s_test_infra_result_part2.png></p> </li> </ul> </li> <li> <p>參考連結: <a href="https://www.youtube.com/watch?v=-ovJrIIED88&list=PL2We04F3Y_41jYdadX55fdJplDvgNGENo&index=19">KodeKloud YouTube 影片教學: Install Kubernetes from Scratch [19] - End to End Tests</a></p> </li> </ul> </li> <li> <p>參考連結</p> <ul> <li><a href=https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/ >K8s 官方文件: 運用 kubeadm 工具，快速建立 K8s 叢集</a></li> <li><a href=https://github.com/kodekloudhub/certified-kubernetes-administrator-course/blob/master/docs/11-Install-Kubernetes-the-kubeadm-way/03-Provision-VMs-with-Vagrant.md>GitHub: KodeKloud 教學如何建立 K8s 叢集</a><ul> <li>Kubeadm Clusters</li> <li>Managed Clusters (AWS EKS, Azure AKS, GCP GKE)</li> </ul> </li> <li><a href=https://github.com/mmumshad/kubernetes-the-hard-way>GitHub: KodeKloud 從 0 ~ 1 建立 K8s 叢集 (較複雜的方法)</a><ul> <li>可搭配 <a href="https://www.youtube.com/watch?v=uUupRagM7m0&list=PL2We04F3Y_41jYdadX55fdJplDvgNGENo&index=2">YouTube: KodeKloud 影片教學</a></li> </ul> </li> </ul> </li> </ul> <h2 id=troubleshooting>Troubleshooting<a class=headerlink href=#troubleshooting title="Permanent link">&para;</a></h2> <h3 id=application-failure>Application Failure<a class=headerlink href=#application-failure title="Permanent link">&para;</a></h3> <blockquote> <p>情境假設: 我們有一個兩層式架構的 Web Server, DB Server，其系統架構如下圖所示 <br></p> </blockquote> <p><img alt height=200px src=../../../assets/pics/k8s/troubleshooting_application_failure_system_architecture.png width=300px></p> <ul> <li> <p>若本身對於故障排除已有經驗的話，可以從系統架構圖中的任一環節開始進行除錯; 但若是一時間找不出頭緒的話，建議可從最源頭的地方開始進行除錯，例如: 從 Web Server 開始進行除錯</p> <ul> <li>Step 1: 檢查應用程式的狀態 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-322-1><a id=__codelineno-322-1 name=__codelineno-322-1 href=#__codelineno-322-1></a>curl<span class=w> </span>http://web-service-ip:node-port
</span></code></pre></div></li> <li> <p>Step 2: 檢查 Web Service 的狀態，是否已正確連接到 Web Pod 端點(endpoint)，並檢查 Web Service 所使用的 Selector 是否正確選取相對應 Web Pod 的 label <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-323-1><a id=__codelineno-323-1 name=__codelineno-323-1 href=#__codelineno-323-1></a>kubectl<span class=w> </span>describe<span class=w> </span>service<span class=w> </span>web-service
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/troubleshooting_application_failure_web_service.png></p> </li> <li> <p>Step 3: 檢查 Web Pod 的狀態，是否正常運行 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-324-1><a id=__codelineno-324-1 name=__codelineno-324-1 href=#__codelineno-324-1></a><span class=c1># 查看 Pod Status, Restart 次數</span>
</span><span id=__span-324-2><a id=__codelineno-324-2 name=__codelineno-324-2 href=#__codelineno-324-2></a>kubectl<span class=w> </span>get<span class=w> </span>pods
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-325-1><a id=__codelineno-325-1 name=__codelineno-325-1 href=#__codelineno-325-1></a>kubectl<span class=w> </span>describe<span class=w> </span>pod<span class=w> </span>web
</span></code></pre></div> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-326-1><a id=__codelineno-326-1 name=__codelineno-326-1 href=#__codelineno-326-1></a>kubectl<span class=w> </span>logs<span class=w> </span>web
</span></code></pre></div> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-327-1><a id=__codelineno-327-1 name=__codelineno-327-1 href=#__codelineno-327-1></a><span class=c1># 因為當前正在運行的 Pod 可能不會反應上次 Crash 的原因，因此可以加上 -f --previous 參數，來查看上次 Pod Crash 的 log 訊息</span>
</span><span id=__span-327-2><a id=__codelineno-327-2 name=__codelineno-327-2 href=#__codelineno-327-2></a>kubectl<span class=w> </span>logs<span class=w> </span>web<span class=w> </span>-f<span class=w> </span>--previous
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/troubleshooting_application_failure_web_pod.png></p> </li> <li> <p>Step 4: 最後，檢查 DB Service, DB Pod 的狀態 <img alt src=../../../assets/pics/k8s/troubleshooting_application_failure_db_service.png> <img alt src=../../../assets/pics/k8s/troubleshooting_application_failure_db_pod.png></p> </li> </ul> </li> <li> <p>參考連結: <a href=https://kubernetes.io/docs/tasks/debug/debug-application/ >K8s 官方文件: Troubleshooting Applications</a></p> </li> </ul> <h3 id=control-plane-node-failure>Control Plane Node Failure<a class=headerlink href=#control-plane-node-failure title="Permanent link">&para;</a></h3> <ul> <li> <p>Step 1: 檢查 K8s 叢集中所有節點、Pods 的運行狀態 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-328-1><a id=__codelineno-328-1 name=__codelineno-328-1 href=#__codelineno-328-1></a>kubectl<span class=w> </span>get<span class=w> </span>nodes
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-329-1><a id=__codelineno-329-1 name=__codelineno-329-1 href=#__codelineno-329-1></a>kubeclt<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>--all-namespaces
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/troubleshooting_control_plane_node_failure_check_node_and_pod_status.png></p> </li> <li> <p>Step 2: (若是使用 kubeadm 工具來建立 K8s 叢集的話)，可以使用 <code>kubectl</code> 檢查 Control Plane Node 中，所有 Pods 的運行狀態 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-330-1><a id=__codelineno-330-1 name=__codelineno-330-1 href=#__codelineno-330-1></a>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=o>=</span>kube-system
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/troubleshooting_control_plane_node_failure_check_pods_on_master_node.png></p> </li> <li> <p>Step 3: 檢查 Control Plane Node 上，所有 K8s 叢集服務的運行狀態</p> <ul> <li> <p>檢查 kube-apiserver 的運行狀態 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-331-1><a id=__codelineno-331-1 name=__codelineno-331-1 href=#__codelineno-331-1></a>service<span class=w> </span>kube-apiserver<span class=w> </span>status
</span></code></pre></div></p> </li> <li> <p>檢查 kube-controller-manager 的運行狀態 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-332-1><a id=__codelineno-332-1 name=__codelineno-332-1 href=#__codelineno-332-1></a>service<span class=w> </span>kube-controller-manager<span class=w> </span>status
</span></code></pre></div></p> </li> <li> <p>檢查 kube-scheduler 的運行狀態 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-333-1><a id=__codelineno-333-1 name=__codelineno-333-1 href=#__codelineno-333-1></a>service<span class=w> </span>kube-scheduler<span class=w> </span>status
</span></code></pre></div></p> </li> </ul> <p><img alt src=../../assets/pics/k8s/troubleshooting_control_plane_node_failure_check_k8s_cluster_services.png></p> </li> <li> <p>Step 4: 檢查 Worker Node 上的 kubelet, kube-proxy 的運行狀態 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-334-1><a id=__codelineno-334-1 name=__codelineno-334-1 href=#__codelineno-334-1></a>service<span class=w> </span>kubelet<span class=w> </span>status
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-335-1><a id=__codelineno-335-1 name=__codelineno-335-1 href=#__codelineno-335-1></a>service<span class=w> </span>kube-proxy<span class=w> </span>status
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/troubleshooting_control_plane_node_failure_check_worker_node_services.png></p> </li> <li> <p>Step 5: 檢查 Control Plane Node 上，所有運行的物件的 log 訊息</p> <ul> <li> <p>(若是使用 kubeadm 工具來部署 K8s 叢集的 Control Plan 相關物件的話)，可以使用 <code>kubectl</code> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-336-1><a id=__codelineno-336-1 name=__codelineno-336-1 href=#__codelineno-336-1></a>kubectl<span class=w> </span>logs<span class=w> </span>kube-apiserver-master<span class=w> </span>-n<span class=o>=</span>kube-system
</span></code></pre></div></p> </li> <li> <p>(若是使用 <code>SystemD</code> Service 來部署 K8s 叢集的 Control Plan 相關物件的話)，可以使用 <code>journalctl</code> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-337-1><a id=__codelineno-337-1 name=__codelineno-337-1 href=#__codelineno-337-1></a>sudo<span class=w> </span>journalctl<span class=w> </span>-u<span class=o>=</span>kube-apiserver
</span></code></pre></div></p> </li> </ul> <p><img alt src=../../assets/pics/k8s/docs/assets/pics/k8s/troubleshooting_control_plane_node_failure_check_control_plane_node_component_logs.png></p> </li> <li> <p>參考連結: <a href=https://kubernetes.io/docs/tasks/debug/debug-cluster/ >K8s 官方文件: Troubleshooting Clusters</a></p> </li> </ul> <h3 id=worker-node-failure>Worker Node Failure<a class=headerlink href=#worker-node-failure title="Permanent link">&para;</a></h3> <ul> <li> <p>Step 1: 檢查 K8s 叢集中，所有 Worker Nodes 的運行狀態 (Ready || NotReady) <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-338-1><a id=__codelineno-338-1 name=__codelineno-338-1 href=#__codelineno-338-1></a>kubectl<span class=w> </span>get<span class=w> </span>nodes
</span></code></pre></div></p> <ul> <li> <p>若某個 Worker Node 為 <strong>NotReady</strong> 狀態，則可以進一步檢視該 Worker Node 的資源運用狀態 (e.g. disk, memory) <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-339-1><a id=__codelineno-339-1 name=__codelineno-339-1 href=#__codelineno-339-1></a>kubectl<span class=w> </span>describe<span class=w> </span>node<span class=w> </span>worker-1
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/troubleshooting_worker_node_failure_describe_node.png></p> </li> <li> <p>若某個 Worker Node 為 <strong>Unknown</strong> 狀態，表示該 Worker Node 與 Control Plane Node 已失去連線，可透過 <code>LastHeartbeatTime</code> 最後一次的連線時間 <img alt src=../../../assets/pics/k8s/troubleshooting_worker_node_failure_unknown_status.png></p> </li> </ul> </li> <li> <p>Step 2: 可針對指定的 Worker Node，則可以進一步檢視該 Worker Node 的資源運用狀態 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-340-1><a id=__codelineno-340-1 name=__codelineno-340-1 href=#__codelineno-340-1></a><span class=c1># 動態顯示 Worker Node 的運行狀態，主要用於監控 CPU, Memory 的使用情況</span>
</span><span id=__span-340-2><a id=__codelineno-340-2 name=__codelineno-340-2 href=#__codelineno-340-2></a>top
</span></code></pre></div></p> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-341-1><a id=__codelineno-341-1 name=__codelineno-341-1 href=#__codelineno-341-1></a><span class=c1># 顯示 Worker Node 的硬碟使用情況，以適合人類閱讀的方式來呈現</span>
</span><span id=__span-341-2><a id=__codelineno-341-2 name=__codelineno-341-2 href=#__codelineno-341-2></a>df<span class=w> </span>-h
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/troubleshooting_worker_node_failure_top_and_df_command.png></p> </li> <li> <p>Step 3: 檢查 Worker Node 上的 kubelet 運行狀態</p> <ul> <li> <p>檢查 kubelet 是否正常運行中 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-342-1><a id=__codelineno-342-1 name=__codelineno-342-1 href=#__codelineno-342-1></a>serivce<span class=w> </span>kubelet<span class=w> </span>status
</span></code></pre></div></p> </li> <li> <p>檢視 kubelet 的運行狀態 log 訊息 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-343-1><a id=__codelineno-343-1 name=__codelineno-343-1 href=#__codelineno-343-1></a>sudo<span class=w> </span>journalctl<span class=w> </span>-u<span class=w> </span>kubelet
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/troubleshooting_worker_node_failure_check_kubelet_status.png></p> </li> <li> <p>檢查 kubelet 的 CA 憑證的有效性 (e.g. 在有效期間內、在正確的 group 中、是由正確的 CA 機構所發行) <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-344-1><a id=__codelineno-344-1 name=__codelineno-344-1 href=#__codelineno-344-1></a>openssl<span class=w> </span>x509<span class=w> </span>-in<span class=w> </span>/var/lib/kubelet/worker-1.crt<span class=w> </span>-text
</span></code></pre></div></p> </li> </ul> <p><img alt src=../../../assets/pics/k8s/troubleshooting_worker_node_failure_check_kubelet_ca.png></p> </li> </ul> <h3 id=networking-failure>Networking Failure<a class=headerlink href=#networking-failure title="Permanent link">&para;</a></h3> <ul> <li>安裝網路插件 (CNI)，例如: Weave Net, Flannel<ul> <li><a href=https://kubernetes.io/docs/concepts/cluster-administration/addons/ >K8s 官方文件: Installing Addons</a></li> </ul> </li> <li> <p>CoreDNS: K8s 叢集可使用 CoreDNS 作為 DNS 伺服器</p> <ul> <li> <p>可檢視 Corefile plugin，以 ConfigMap 的形式來設定 CoreDNS <div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-345-1><a id=__codelineno-345-1 name=__codelineno-345-1 href=#__codelineno-345-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id=__span-345-2><a id=__codelineno-345-2 name=__codelineno-345-2 href=#__codelineno-345-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
</span><span id=__span-345-3><a id=__codelineno-345-3 name=__codelineno-345-3 href=#__codelineno-345-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-345-4><a id=__codelineno-345-4 name=__codelineno-345-4 href=#__codelineno-345-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">coredns</span>
</span><span id=__span-345-5><a id=__codelineno-345-5 name=__codelineno-345-5 href=#__codelineno-345-5></a><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
</span><span id=__span-345-6><a id=__codelineno-345-6 name=__codelineno-345-6 href=#__codelineno-345-6></a><span class=nt>data</span><span class=p>:</span>
</span><span id=__span-345-7><a id=__codelineno-345-7 name=__codelineno-345-7 href=#__codelineno-345-7></a><span class=w>    </span><span class=nt>Corefile</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span>
</span><span id=__span-345-8><a id=__codelineno-345-8 name=__codelineno-345-8 href=#__codelineno-345-8></a><span class=w>        </span><span class=no>.:53 {</span>
</span><span id=__span-345-9><a id=__codelineno-345-9 name=__codelineno-345-9 href=#__codelineno-345-9></a><span class=w>            </span><span class=no>errors</span>
</span><span id=__span-345-10><a id=__codelineno-345-10 name=__codelineno-345-10 href=#__codelineno-345-10></a><span class=w>            </span><span class=no>health {</span>
</span><span id=__span-345-11><a id=__codelineno-345-11 name=__codelineno-345-11 href=#__codelineno-345-11></a><span class=w>                </span><span class=no>lameduck 5s</span>
</span><span id=__span-345-12><a id=__codelineno-345-12 name=__codelineno-345-12 href=#__codelineno-345-12></a><span class=w>            </span><span class=no>}</span>
</span><span id=__span-345-13><a id=__codelineno-345-13 name=__codelineno-345-13 href=#__codelineno-345-13></a><span class=w>            </span><span class=no>ready</span>
</span><span id=__span-345-14><a id=__codelineno-345-14 name=__codelineno-345-14 href=#__codelineno-345-14></a><span class=w>            </span><span class=no>kubernetes cluster.local in-addr.arpa ip6.arpa {</span>
</span><span id=__span-345-15><a id=__codelineno-345-15 name=__codelineno-345-15 href=#__codelineno-345-15></a><span class=w>                </span><span class=no>pods insecure</span>
</span><span id=__span-345-16><a id=__codelineno-345-16 name=__codelineno-345-16 href=#__codelineno-345-16></a><span class=w>                </span><span class=no>fallthrough in-addr.arpa ip6.arpa</span>
</span><span id=__span-345-17><a id=__codelineno-345-17 name=__codelineno-345-17 href=#__codelineno-345-17></a><span class=w>                </span><span class=no>ttl 30</span>
</span><span id=__span-345-18><a id=__codelineno-345-18 name=__codelineno-345-18 href=#__codelineno-345-18></a><span class=w>            </span><span class=no>}</span>
</span><span id=__span-345-19><a id=__codelineno-345-19 name=__codelineno-345-19 href=#__codelineno-345-19></a><span class=w>            </span><span class=no>prometheus :9153</span>
</span><span id=__span-345-20><a id=__codelineno-345-20 name=__codelineno-345-20 href=#__codelineno-345-20></a><span class=w>            </span><span class=no>forward . /etc/resolv.conf</span>
</span><span id=__span-345-21><a id=__codelineno-345-21 name=__codelineno-345-21 href=#__codelineno-345-21></a><span class=w>            </span><span class=no>cache 30</span>
</span><span id=__span-345-22><a id=__codelineno-345-22 name=__codelineno-345-22 href=#__codelineno-345-22></a><span class=w>            </span><span class=no>loop</span>
</span><span id=__span-345-23><a id=__codelineno-345-23 name=__codelineno-345-23 href=#__codelineno-345-23></a><span class=w>            </span><span class=no>reload</span>
</span><span id=__span-345-24><a id=__codelineno-345-24 name=__codelineno-345-24 href=#__codelineno-345-24></a><span class=w>            </span><span class=no>loadbalance</span>
</span><span id=__span-345-25><a id=__codelineno-345-25 name=__codelineno-345-25 href=#__codelineno-345-25></a><span class=w>        </span><span class=no>}</span>
</span></code></pre></div></p> </li> <li> <p>將 K8s 叢集外的域名，直接轉發到正確的權威 DNS 伺服器 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-346-1><a id=__codelineno-346-1 name=__codelineno-346-1 href=#__codelineno-346-1></a>proxy<span class=w> </span>.<span class=w> </span>/etc/resolv.conf
</span></code></pre></div></p> </li> <li> <p>CoreDNS 故障排除</p> <ul> <li>若 Pod 處於 pending 狀態: 檢查是否安裝了網路插件 (CNI)</li> <li> <p>若發生 CrashLoopBackOff 或錯誤狀態: 可能是 SELinux 的問題</p> <blockquote> <p>在 K8s 中，SELinux（Security-Enhanced Linux）是一種安全模組，用於控制訪問權限</p> <p>當 Kubernetes 節點上運行的 CoreDNS Pod 遇到 SELinux 問題時，可能會導致 Pod 無法啟動，出現 <code>CrashLoopBackOff</code> 或 <code>Error</code> 狀態。這些問題通常是由於舊版 Docker 與 SELinux 的不兼容性或錯誤設定所引起的 </p> </blockquote> <ul> <li> <p>法 1: 升級 Docker (將 Docker 升級到最新版本，以確保與 SELinux 的兼容性) <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-347-1><a id=__codelineno-347-1 name=__codelineno-347-1 href=#__codelineno-347-1></a>sudo<span class=w> </span>yum<span class=w> </span>update<span class=w> </span>docker
</span><span id=__span-347-2><a id=__codelineno-347-2 name=__codelineno-347-2 href=#__codelineno-347-2></a>
</span><span id=__span-347-3><a id=__codelineno-347-3 name=__codelineno-347-3 href=#__codelineno-347-3></a>sudo<span class=w> </span>systemctl<span class=w> </span>restart<span class=w> </span>docker
</span></code></pre></div></p> </li> <li> <p>法 2: 禁用 SELinux</p> <ul> <li> <p>臨時禁用 SELinux 來測試問題是否解決 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-348-1><a id=__codelineno-348-1 name=__codelineno-348-1 href=#__codelineno-348-1></a>sudo<span class=w> </span>setenforce<span class=w> </span><span class=m>0</span>
</span></code></pre></div></p> </li> <li> <p>若問題解決，可以考慮永久禁用 SELinux <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-349-1><a id=__codelineno-349-1 name=__codelineno-349-1 href=#__codelineno-349-1></a>sudo<span class=w> </span>sed<span class=w> </span>-i<span class=w> </span><span class=s1>&#39;s/^SELINUX=enforcing/SELINUX=disabled/&#39;</span><span class=w> </span>/etc/selinux/config
</span><span id=__span-349-2><a id=__codelineno-349-2 name=__codelineno-349-2 href=#__codelineno-349-2></a>
</span><span id=__span-349-3><a id=__codelineno-349-3 name=__codelineno-349-3 href=#__codelineno-349-3></a>sudo<span class=w> </span>reboot
</span></code></pre></div></p> </li> </ul> </li> <li> <p>法 3: 修改部署設定檔 <code>allowPrivilegeEscalation</code> 為 true，允許提升權限 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-350-1><a id=__codelineno-350-1 name=__codelineno-350-1 href=#__codelineno-350-1></a>kubectl<span class=w> </span>-n<span class=w> </span>kube-system<span class=w> </span>get<span class=w> </span>deployment<span class=w> </span>coredns<span class=w> </span>-o<span class=w> </span>yaml<span class=w> </span><span class=p>|</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-350-2><a id=__codelineno-350-2 name=__codelineno-350-2 href=#__codelineno-350-2></a><span class=w>    </span>sed<span class=w> </span><span class=s1>&#39;s/allowPrivilegeEscalation: false/allowPrivilegeEscalation: true/g&#39;</span><span class=w> </span><span class=p>|</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-350-3><a id=__codelineno-350-3 name=__codelineno-350-3 href=#__codelineno-350-3></a>
</span><span id=__span-350-4><a id=__codelineno-350-4 name=__codelineno-350-4 href=#__codelineno-350-4></a>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-
</span></code></pre></div></p> </li> </ul> </li> </ul> </li> <li> <p>參考連結: </p> <ul> <li><a href=https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers/ >K8s 官方文件: Customizing DNS Service</a></li> <li><a href=https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/ >K8s 官方文件: Debugging DNS Resolution</a></li> <li><a href=https://kubernetes.io/docs/tasks/debug/debug-application/debug-service/ >K8s 官方文件: Debug Services</a></li> </ul> </li> </ul> </li> <li> <p>kube-proxy</p> <ul> <li>概述<ul> <li>角色: 運行在每個節點上的網路代理，維護節點上的網路規則，允許 Pod 之間的網路通訊</li> <li>部署: 若是透過 kubeadm 工具所建立的 K8s 叢集，kube-proxy 是作為 DaemonSet 運行在每個工作節點上</li> <li>責任: 監視服務和端點，將流量路由到實際的 Pod</li> </ul> </li> <li>設定檔的路徑位置<ul> <li><code>/var/lib/kube-proxy/config.conf</code>: kube-proxy 的設定檔</li> <li>可設定 clusterCIDR, kubeproxy mode, ipvs, iptables, bindaddress, kube-config 等</li> </ul> </li> <li>kube-proxy 故障排除<ul> <li>確認 kube-proxy pod 在 kube-system 命名空間中是正常運行的</li> <li>檢查 kube-proxy 的 log 訊息</li> <li>驗證 configmap 與其設定檔內容的正確性、一致性</li> <li>確認 kube-config 有在 configmap 中定義</li> <li>確認 kube-proxy 在容器內是正常運行的 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-351-1><a id=__codelineno-351-1 name=__codelineno-351-1 href=#__codelineno-351-1></a>netstat<span class=w> </span>-plan<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>kube-proxy
</span></code></pre></div></li> </ul> </li> </ul> </li> </ul> <h2 id=exam-information>Exam Information<a class=headerlink href=#exam-information title="Permanent link">&para;</a></h2> <ul> <li>考試內容<ul> <li><img alt src=../../../assets/pics/k8s/cncf_cka_exam_domain.png></li> </ul> </li> <li>考試時間: 2 小時</li> <li>考試類型: 遠端監考</li> <li>考試期間: 可以查看 K8s 官方文件的指令</li> <li>價格: 395 美金<ul> <li>20% 折扣碼: <code>20KODE</code></li> </ul> </li> <li>一年內可以免費重考一次</li> <li>證照有效期限: 3 年</li> <li>考試前需先通過 <a href=https://syscheck.bridge.psiexams.com/ >PSI Online Proctoring System Check</a> 檢驗，確認線上考試環境已符合考試需求</li> <li>參考資料<ul> <li><a href=https://www.cncf.io/training/certification/cka/ >CNCF-CKA 報名考試</a></li> <li><a href=https://docs.linuxfoundation.org/tc-docs/certification/tips-cka-and-ckad>CNCF-CKA 考試要求</a></li> </ul> </li> </ul> <h2 id=exam-tips>Exam Tips<a class=headerlink href=#exam-tips title="Permanent link">&para;</a></h2> <ul> <li> <p>設定常用指令的別名 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-352-1><a id=__codelineno-352-1 name=__codelineno-352-1 href=#__codelineno-352-1></a><span class=nb>alias</span><span class=w> </span><span class=nv>k</span><span class=o>=</span>kubectl
</span></code></pre></div></p> </li> <li> <p>設定 kubectl 的自動補全功能 (auto complete) <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-353-1><a id=__codelineno-353-1 name=__codelineno-353-1 href=#__codelineno-353-1></a><span class=nb>source</span><span class=w> </span>&lt;<span class=o>(</span>kubectl<span class=w> </span>completion<span class=w> </span>bash<span class=o>)</span>
</span></code></pre></div></p> </li> <li> <p>檢視 K8s 叢集中各項資源的縮寫名稱 (shortnames, 是否屬於 Namespaced 的物件) <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-354-1><a id=__codelineno-354-1 name=__codelineno-354-1 href=#__codelineno-354-1></a>kubectl<span class=w> </span>api-resources
</span></code></pre></div></p> <p><img alt src=../../../assets/pics/k8s/kubectl_api_resources.png></p> </li> <li> <p>根據 CLI 上的指令與選項，快速建立 YAML 範本: </p> <ul> <li><code>--image</code>: 指定 container image</li> <li><code>--dry-run=client</code>: 告訴 kubectl 執行命令，但不會實際建立 Pod，只是模擬執行</li> <li><code>-o=yaml</code>: 指定輸出格式為 YAML</li> <li><code>&gt; filename.yaml</code>: 將執行結果輸出 &amp; 儲存到指定檔案，以便後續使用 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-355-1><a id=__codelineno-355-1 name=__codelineno-355-1 href=#__codelineno-355-1></a>kubectl<span class=w> </span>run<span class=w> </span>nginx<span class=w> </span>--image<span class=o>=</span>nginx<span class=w> </span>--dry-run<span class=o>=</span>client<span class=w> </span>-o<span class=o>=</span>yaml<span class=w> </span>&gt;<span class=w> </span>nginx-pod.yaml
</span></code></pre></div></li> <li>參考資料: <a href=https://kubernetes.io/docs/reference/kubectl/conventions/ >kubectl Usage Conventions</a></li> </ul> </li> <li>考試時，建議使用宣告式語法來操作 K8s 物件 <img alt src=../../../assets/pics/k8s/declarative_commands_for_exam_tips.png></li> <li><code>--watch</code>: 實時監控 K8s 叢集狀態 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-356-1><a id=__codelineno-356-1 name=__codelineno-356-1 href=#__codelineno-356-1></a>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>--watch
</span></code></pre></div></li> <li> <p><code>wc -l</code>: 計算指定檔案中的行數</p> <ul> <li>wc = word count</li> </ul> <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-357-1><a id=__codelineno-357-1 name=__codelineno-357-1 href=#__codelineno-357-1></a>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>--selector<span class=w> </span><span class=nv>env</span><span class=o>=</span>dev<span class=w> </span>--no-headers<span class=w> </span><span class=p>|</span><span class=w> </span>wc<span class=w> </span>-l
</span></code></pre></div> <p><img alt src=../../../assets/pics/k8s/exam_tips_wc.png></p> </li> <li> <p><code>--command</code>: 用於指定容器的指令</p> <ul> <li>Tips: <code>--command</code> 後面接的是對於容器的指令，因此習慣上我們會把 <code>--command</code> 放在最後面才宣告 <div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-358-1><a id=__codelineno-358-1 name=__codelineno-358-1 href=#__codelineno-358-1></a>kubectl<span class=w> </span>run<span class=w> </span>static-busybox<span class=w> </span>--image<span class=o>=</span>busybox<span class=w> </span>--dry-run<span class=o>=</span>client<span class=w> </span>-o<span class=o>=</span>yaml<span class=w> </span>--command<span class=w> </span>--<span class=w> </span>sleep<span class=w> </span><span class=m>1000</span>
</span></code></pre></div></li> </ul> </li> <li> <p>在 CKA 考試期間，我們不會知道自己下指令的結果是否正確？ 因此，我們必須自己驗證結果。舉例說明如下</p> <ul> <li>Q: 題目要求我們根據指定的 container image 建立一個 Pod<ul> <li>A: 我們可以透過 <code>kubectl describe pod &lt;pod-name&gt;</code> 來檢視 Pod 的詳細資訊，以確認 Pod 是否正確建立</li> </ul> </li> </ul> </li> </ul> <h2 id=reference>Reference<a class=headerlink href=#reference title="Permanent link">&para;</a></h2> <ul> <li><a href=https://kubernetes.io/docs/home/ >Kubernetes 官方文件</a></li> <li><a href="https://github.com/kodekloudhub/certified-kubernetes-administrator-course?tab=readme-ov-file">GitHub: KodeKloud CKA learning notes</a></li> <li><a href=https://uklabs.kodekloud.com/courses/labs-certified-kubernetes-administrator-with-practice-tests/ >KodeKloud 線上模擬練習環境</a></li> </ul> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> 回到頂端 </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2023 ~ Hans Tsai </div> </div> <div class=md-social> <a href=https://github.com/hans-tsai target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["announce.dismiss", "content.code.annotate", "content.code.copy", "content.tooltips", "navigation.sections", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u8907\u88fd", "clipboard.copy": "\u8907\u88fd", "search.result.more.one": "\u6b64\u9801\u5c1a\u6709 1 \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.more.other": "\u6b64\u9801\u5c1a\u6709 # \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.none": "\u6c92\u6709\u7b26\u5408\u7684\u9805\u76ee", "search.result.one": "\u627e\u5230 1 \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.other": "\u627e\u5230 # \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.placeholder": "\u6253\u5b57\u9032\u884c\u641c\u5c0b", "search.result.term.missing": "\u7f3a\u5c11\u5b57\u8a5e", "select.version": "\u9078\u64c7\u7248\u672c"}}</script> <script src=../../../assets/javascripts/bundle.af256bd8.min.js></script> <script src=../../../javascripts/mathjax.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js></script> <script src=../../../assets/javascripts/custom.a678ee80.min.js></script> </body> </html>